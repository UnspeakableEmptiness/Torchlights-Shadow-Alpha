const audioContext=new(window.AudioContext||window.webkitAudioContext);class Envelope{constructor(e,t,n){this.func=e,this.grainsize=t,this.duration=n}}class SoundManager{constructor(e,t){this.context=e,this.masterGainNode=e.createGain(),this.masterGainNode.gain.value=1,this.masterAmbientGainNode=e.createGain(),this.masterAmbientGainNode.gain.value=1,this.limiter=e.createDynamicsCompressor(),this.masterGainNode.connect(this.limiter),this.masterAmbientGainNode.connect(this.limiter),this.limiter.connect(this.context.destination),this.sources=Array(t),this.ambientsources=Array(t),this.oldestsource=0,this.nextsource=0,this.oldestambientsource=0,this.nextambientsource=0;for(let n=0;n<this.sources.length;n++)this.sources[n]=new SoundSource(this.context,this);for(let i=0;i<this.ambientsources.length;i++)this.ambientsources[i]=new SoundSource(this.context,this);this.limiter.threshold.value=0,this.limiter.knee.value=0,this.limiter.ratio.value=20,this.limiter.attack.value=0,this.limiter.release.value=.25}requestSource(){let e=this.sources[this.oldestsource];return e.soundmaker&&(e.output.disconnect(),e.soundmaker.stop(),e.buffer=null),this.nextsource=e,this.oldestsource++,this.oldestsource>=this.sources.length&&(this.oldestsource=0),e}addEffect(e){this.effectschain||(this.effectschain=[]),this.effectschain.push(e),this.updateRouting()}updateRouting(){let e=this.masterGainNode;for(let t=0;t<this.effectschain.length;t++){let n=this.effectschain[t];e.connect(n),e=n}e.connect(this.limiter)}requestAmbientSource(){let e=this.ambientsources[this.oldestambientsource];return e.soundmaker&&(e.output.disconnect(),e.soundmaker.stop(),e.buffer=null),this.nextambientsource=e,this.oldestambientsource++,this.oldestambientsource>=this.ambientsources.length&&(this.oldestambientsource=0),e}playSound(){this.soundmaker=this.nextsource,this.soundmaker.start(),this.soundmaker.output.connect(this.masterGainNode)}playAmbientSound(){this.ambientsoundmaker=this.nextambientsource,this.ambientsoundmaker.start(),this.ambientsoundmaker.output.connect(this.masterAmbientGainNode)}}class SoundSource{constructor(e,t,n,i,s,a,o,l,c){this.context=e,this.soundManager=t,this.type=n,this.freq=i,this.env=s,this.vol=a||1,this.fx=[],this.fxnodes=[],o&&(this.fx=o.slice()),this.overtones=[],l&&(this.overtones=l.slice()),this.overtonenoisemakers=[],this.overtonesoundmakers=[],this.freqmod=[],c&&(this.freqmod=c.slice()),this.gainNode=e.createGain(),this.limiter=this.context.createDynamicsCompressor(),this.masterGainNode=e.createGain(),this.output=this.masterGainNode,this.limiter.threshold.value=0,this.limiter.knee.value=0,this.limiter.ratio.value=10,this.limiter.attack.value=.003,this.limiter.release.value=.25}start(){this.masterGainNode.gain.value=this.vol,this.output.disconnect(),this.gainNode.disconnect(),this.soundmaker&&this.soundmaker.disconnect();let e=this.gainNode;this.gainNode.gain.value=0,this.gainNode.gain.setValueAtTime(0,this.context.currentTime);for(let t=0;t<this.fxnodes.length;t++){let n=this.fxnodes[t];n.disconnect(),n.buffer=null}this.fxnodes=[];for(let i=0;i<this.fx.length;i++){let s=this.fx[i];this.fxnodes.push(s()),e.connect(this.fxnodes[i]),e=this.fxnodes[i]}if(e.connect(this.masterGainNode),"noise"===this.type||"lowpass-noise"===this.type||"lowpass-noise-white"===this.type){let a=this.context.sampleRate*this.env.duration,o=this.context.createBuffer(1,a,this.context.sampleRate),l=o.getChannelData(0);if("lowpass-noise-white"===this.type)for(let c=0;c<a;c++)l[c]=2*Math.random()-1;else{let h=0,d=0,u=Array(50).fill(0);for(let $=0;$<a;$++){let p=2*Math.random()-1;d-=u[$%50],u[$%50]=p;let m=(d+=p)/50;l[$]=(h+.02*m)/1.02,h=l[$],l[$]*=3.5}}if(this.noise=this.context.createBufferSource(),this.noise.buffer=o,this.noise.loop=!0,this.soundmaker=this.noise,"lowpass-noise"===this.type||"lowpass-noise-white"===this.type){let f=this.context.createBiquadFilter();f.type="lowpass",f.frequency.value=this.freq,this.lowpassFilter=f,this.soundmaker.connect(this.lowpassFilter),this.lowpassFilter.connect(this.gainNode)}else this.soundmaker.connect(this.gainNode)}else this.soundmaker=this.context.createOscillator(this.type,this.freq),this.soundmaker.type=this.type,this.soundmaker.frequency.value=this.freq,this.soundmaker.connect(this.gainNode);this.soundmaker.start(),this.env?(this.gainNode.gain.value=0,modulateparam(this.env,this.gainNode.gain,this.context,1),this.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime+this.env.duration)):console.log("error this sound played with no envelope"),this.freqmod&&("lowpass-noise"!==this.type&&"noise"!==this.type&&"lowpass-noise-white"!==this.type&&modulateparam(this.freqmod,this.soundmaker.frequency,this.context,this.freq),("lowpass-noise"==this.type||"lowpass-noise-white"==this.type)&&modulateparam(this.freqmod,this.lowpassFilter.frequency,this.context,this.freq));for(let _=0;_<this.overtonenoisemakers.length;_++){let g=this.overtonenoisemakers[_];g.disconnect(),g.stop()}for(let w=0;w<this.overtonesoundmakers.length;w++){let b=this.overtonesoundmakers[w];b instanceof OscillatorNode&&b.stop(),b.disconnect()}if(this.overtonenoisemakers=[],this.overtonesoundmakers=[],this.overtones)for(let v=0;v<this.overtones.length;v++)"noise"!==this.type&&"lowpass-noise"!==this.type&&"lowpass-noise-white"!==this.type?(this.overtonesoundmakers.push(this.context.createOscillator(this.type)),this.overtonesoundmakers[v].start()):("lowpass-noise"==this.type||"lowpass-noise-white"==this.type)&&(this.overtonenoisemakers.push(this.context.createBufferSource()),this.overtonenoisemakers[v].buffer=this.noise.buffer,this.overtonenoisemakers[v].loop=!0,this.overtonesoundmakers.push(this.context.createBiquadFilter()),this.overtonenoisemakers[v].connect(this.overtonesoundmakers[v]),this.overtonenoisemakers[v].start()),this.overtonesoundmakers[v].frequency.setValueAtTime(this.freq*this.overtones[v],this.context.currentTime),this.overtonesoundmakers[v].connect(this.gainNode),this.freqmod&&(this.overtonesoundmakers[v].frequency.value=this.freq*this.overtones[v],modulateparam(this.freqmod,this.overtonesoundmakers[v].frequency,this.context,this.freq*this.overtones[v]))}}function modulateparam(e,t,n,i,s=!0){let{grainsize:a,duration:o,func:l}=e;t.cancelScheduledValues(n.currentTime);for(let c=0;c<o;c+=a*(.5*Math.random()+.5))t.linearRampToValueAtTime(l(c)*i,n.currentTime+c)}const soundManager=new SoundManager(audioContext,10);let verb=createReverb(audioContext,1)(),lowpass=createLowpassFilter(audioContext,1e4)(),delaychain=createDelayChain(audioContext,.25,.75,[lowpass,verb])();soundManager.effectschain=[delaychain],soundManager.updateRouting();const envelopes={random1sec:new Envelope(e=>Math.random(),.01,1),crack:new Envelope(e=>1,.01,.2),stab:new Envelope(e=>1,.01,.1),boom:new Envelope(e=>1,.1,.5),oldcrack:new Envelope(adsrconvert([.01,.05,1,.02],.01),.01,.3),rainfall:new Envelope(e=>Math.random(),.1,20),fire:new Envelope(e=>adsrconvert([3,.05,1,.02],90)(e)*(Math.random()/2+.5),.03,6),randomboom:new Envelope(e=>1*Math.random(),.1,1),randomstab:new Envelope(e=>Math.random()*Math.min(1,10*e),.1,.2),linearfall:new Envelope(e=>Math.max(1-e,.1),.2,1),linearfallhalf:new Envelope(e=>Math.max(1-4*e,0),.01,.5),negabsval:new Envelope(linearspike(1),.1,1)};let sounds={caveambience:[100,"lowpass-noise",envelopes.fire,[createReverb(audioContext,5)],new Envelope(e=>.5*Math.random()+.5,.1,1),[2,4,8],.25],deepspookybong:[100,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.01,1),[createReverb(audioContext,10)],new Envelope(e=>.1*Math.random()+.95,.1,1),[2.1],.1],highshrillbing:[1e3,"sine",new Envelope(linearspike(1),.01,1),[createReverb(audioContext,10)],new Envelope(e=>.1*Math.random()+.95,.1,1),[2.1],.1],footstep2:[100,"sine",envelopes.oldcrack,[createReverb(audioContext,.5)],null,[.5]],footstep:[500,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**.3*Math.random()**2,linearspike(.1)(Math.max(e-.15,0))**.3*Math.random()**2),.015,.3),[],null,[],.25],footstepverb:[500,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**.3*Math.random()**2,linearspike(.1)(Math.max(e-.15,0))**.3*Math.random()**2),.015,.3),[createReverb(audioContext,.5)],null,[],.25],weirdtone:[440,"sine",envelopes.random1sec,[],envelopes.randomboom,[2,4]],weirdnoise:[500,"lowpass-noise",envelopes.random1sec,[]],footsteptap:[200,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**5*Math.random()/2,linearspike(.1)(Math.max(e-.15,0))**5*Math.random()/2),.005,.3),[],null,[1.1,1.2,1.3,2],.5],footsteptapverb:[200,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**5,linearspike(.1)(Math.max(e-.15,0))**5*Math.random()/2),.005,.3),[createReverb(audioContext,.5)],null,[1.1,1.2,1.3,2],.25],frogribbit:[1e3,"sine",new Envelope(e=>Math.max(linearspike(.1)(e)**25,linearspike(.1)(Math.max(e-.15,0))**25),.01,.3),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],softsine:[400,"sine",envelopes.negabsval,[]],arrowwhoosh:[400,"lowpass-noise-white",new Envelope(linearspike(.8),.01,.3),[],new Envelope(e=>Math.max(1-4*e,.5),.2,.5),[2]],arrowwhistle:[200,"sine",new Envelope(e=>linearspike(.8)(e)*Math.random(),.1,.3),[createReverb(audioContext,.2),createLowpassFilter(audioContext,200)],new Envelope(e=>Math.max(1-4*e,.8),.2,.5),[.9,.95,1.05,1.1]],arrowthudnoise:[150,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[createPause(audioContext,.2)],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],arrowthudtone:[150,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2),createPause(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],clubwhoosh:[400,"lowpass-noise-white",new Envelope(linearspike(.8),.01,.3),[],new Envelope(e=>Math.max(1-4*e,.5),.2,.5),[2]],clubwhoom:[200,"sine",new Envelope(e=>linearspike(.2)(e)*Math.random(),.1,.2),[createReverb(audioContext,.2),createLowpassFilter(audioContext,200)],new Envelope(e=>Math.max(1-4*e,.8),.2,.5),[.9,.95,1.05,1.1]],clubhitnoise:[100,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-5*e,0),.01,.4),[createDistortion(audioContext,.5),createPause(audioContext,.2)],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],clubhittone:[50,"sine",new Envelope(e=>Math.max(1-5*e,0),.01,.4),[createReverb(audioContext,.2),createPause(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],clubhitcrack:[100,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-2.5*e,0)*Math.random()**10,.005,.2),[createPause(audioContext,.2)],new Envelope(e=>1+1*e*Math.random(),.01,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2,4,8,16,32,64,128],.1],swordswingbig:[200,"lowpass-noise-white",new Envelope(linearspike(.4),.1,.4),[],new Envelope(e=>Math.max(1-6*e,.5)),[]],swordswingsmall:[400,"lowpass-noise-white",new Envelope(linearspike(.2),.1,.2),[],new Envelope(e=>Math.max(1-12*e,.25)),[]],swordswingxs:[600,"lowpass-noise-white",new Envelope(linearspike(.15),.1,.15),[],new Envelope(e=>Math.max(1-18*e,.2)),[]],swordswingsmallverb:[400,"lowpass-noise-white",new Envelope(linearspike(.2),.1,.2),[createReverb(audioContext,.5)],new Envelope(e=>Math.max(1-12*e,.25)),[]],deepthudnoise:[25,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-5*e,0),.01,.4),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],deepthudtone:[25,"sine",new Envelope(e=>Math.max(1-5*e,0),.01,.4),[createReverb(audioContext,.4)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],medthudnoise:[50,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],medthudtone:[50,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],drumtemplate:[50,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.1),[createReverb(audioContext,1)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],stringplucktemplate:[600,"sine",new Envelope(e=>Math.max(1-3*e,0),.01,.5),[createReverb(audioContext,.2)],new Envelope(e=>Math.max(1-4*e,.25),.005,.5),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],stringsine:[440,"sine",new Envelope(linearspike(1),.01,1),[createReverb(audioContext,.2)],new Envelope(e=>.95+.025*Math.random(),.1,1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2]],highthudnoise:[150,"lowpass-noise",new Envelope(e=>3*e**.01*Math.max(1-10*e,0),.01,.2),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],highthudnoiseverb:[150,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2)],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],highthudtone:[150,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],bassdrum:[100,"sine",new Envelope(e=>linearspike(.08)(e)*Math.random(),.01,.1),[createReverb(audioContext,2)],null,[1.1,1.2,.5],2],snaredrum:[200,"lowpass-noise-white",new Envelope(e=>linearspike(.04)(e)*Math.random(),.01,.1),[],null,[1.1,1.2,.5],2],whee:[2e3,"lowpass-noise",new Envelope(linearspike(.5),.01,.5),[],new Envelope(linearspike(.5),.01,.5),[]],goblinchat:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[],new Envelope(e=>Math.random()**2*2,5e-4,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.01],goblinchatverb:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,5e-4,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.01],goblinchat2:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[],new Envelope(e=>Math.random()**2*2,.002,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.02],goblinchat2old:[400,"sine",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**2,.05,1.5),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,.002,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],goblinchat3old:[600,"sine",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**2,.05,1.5),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,.003,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],something:[2,"noise",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random(),5e-5,1.5),[createReverb(audioContext,.1)],new Envelope(e=>5*Math.random(),.01,1.5)],goblinchatnoise:[800,"lowpass-noise-white",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**4,.05,1.5),[],new Envelope(e=>Math.random()**2*2,.0025,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],goblinscream:[400,"sine",new Envelope(e=>linearspike(1.5)(e)**.01,.05,1.5),[],new Envelope(e=>Math.random()**2*2,.0025,1.5),[1.5,1.6,.5,.6,.4,.3],.05],goblinyelpold:[800,"sine",new Envelope(e=>linearspike(.25)(e)**.01,.005,.25),[],new Envelope(e=>Math.random()**2*2,5e-4,.5),[1.5,1.6,.5,.6,.4,.3],.01],goblindeath:[800,"sine",new Envelope(e=>e**.2*(1-e)*Math.random()**.5,.01,1),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/4)*Math.random()*2,.005,5),[1.5,1.6,.5,.6,.4,.3],.05],ogredeath:[400,"sine",new Envelope(e=>e**.2*(1-e)*Math.random()**.5,.01,1),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/4)*Math.random()*2,.005,5),[1.4,1.2,.5,.6,.4,.3],.05],goblinshriek:[1200,"sine",new Envelope(e=>e**.2*(1-e/2)*Math.random()**.5,.01,2),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/6)*Math.random()*2,.005,5),[1.5,1.6,.5,.6,.4,.3],.05],deathshriek:[1200,"sine",new Envelope(e=>e**.2*(1-e/5)*Math.random()**.5,.01,5),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/6)*Math.random()*2,.005,5),[1.5,1.6,.5,.6,.4,.3],.05],goblinyelp:[800,"sine",new Envelope(e=>linearspike(.25)(e)**.01,.005,.25),[],new Envelope(e=>Math.random()**2*2,.005,.5),[1.5,1.6,.5,.6,.4,.3],.01],rustle:[500,"lowpass-noise-white",envelopes.randomstab,[]],rustleverb:[500,"lowpass-noise-white",envelopes.randomstab,[createReverb(audioContext,.5)]],eeesound:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,300)],null,[.5,2,3,4,5,6,7,8,9,10,12]],eeesound2:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,2200)],null,[.5,2,3,4,5,6,7,8,9,10,12]],eeesound3:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,3e3)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,1e3)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound2:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,1300)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound3:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,2400)],null,[.5,2,3,4,5,6,7,8,9,10,12]],sine:[75,"sine",new Envelope(e=>linearspike(.08)(e)*Math.random(),.01,.1),[createDistortion(audioContext,25)]],bowstring:[100,"lowpass-noise-white",new Envelope(e=>linearspike(1)(e)*Math.random()**10,5e-4,1),[],new Envelope(e=>Math.min(Math.max((10*e)**2,0),25),.1,1),[],.1],treecreakinginthewind:[100,"lowpass-noise-white",new Envelope(e=>linearspike(5)(e)**4*Math.random()**.5,15e-5,5)],tap:[100,"lowpass-noise-white",new Envelope(e=>linearspike(.5)(e)**4*Math.random()**.5,2e-4,.5)],sworddraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.5)(e)*Math.random()**.2,.01,1),[],new Envelope(e=>Math.min(200*(e+1),75),.01,1),[.5,1/4],.05],swordring:[800,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.5)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.01],swordring2:[800/3,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.75)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.1],swordring3:[200,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.5)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.025],shortsworddraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.35)(e)*Math.random()**.2,.01,.5),[],new Envelope(e=>Math.min(300*(e+1),100),.01,.5),[],.05],daggerdraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.25)(e)*Math.random()**.4,.01,.5),[],new Envelope(e=>Math.min(400*(e+1),100),.01,.5),[],.05],daggerdraw2:[2e3,"lowpass-noise-white",new Envelope(e=>10*linearspike(.25)(e)*Math.random()**.4,.01,.5),[],new Envelope(e=>Math.min(1*e,5),.01,.5),[],.05],puncture:[2500,"lowpass-noise-white",new Envelope(e=>linearspike(.25)(e)*Math.random()**.3,.01,.5),[],new Envelope(e=>1-2*e,.01,.5),[],.1],spurt1:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**2*Math.random()**2,.001,1),[createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[1.1,1.2,1.3,2,4,8],.1],spurt2:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**2*Math.random()**2,.001,1),[createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[6,12],.1],spurt1verb:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**4*Math.random()**2,.001,1),[createReverb(audioContext,.2),createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[1.1,1.2,1.3,2,4,8],.5],spurt2verb:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**4*Math.random()**2,.001,1),[createReverb(audioContext,.2),createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[6,12],.5],woodbreaking:[100,"lowpass-noise-white",new Envelope(e=>(1-e/.7)*Math.random()**(2*e),15e-5,.7),[],new Envelope(e=>(e+1)*Math.random(),.01,.7),[1.1,1.5,2,4],.2],woodbreaking2:[100,"lowpass-noise-white",new Envelope(e=>(1-e/2)*Math.random()**(10*e+1),.01,2),[createReverb(audioContext,.1)],new Envelope(e=>Math.max(Math.random()**4*16,.5),.01,1.5),[1.1,1.5,2,4],.2],woodbreakingdeep:[50,"lowpass-noise-white",new Envelope(e=>(1-e/.7)*Math.random()**(2*e),15e-5,.7),[],new Envelope(e=>(e+1)*Math.random(),.01,.7),[.5,1.1,1.5,2],.2],woodbreaking2deep:[50,"lowpass-noise-white",new Envelope(e=>(1-e/2)*Math.random()**(10*e+1),.01,2),[createReverb(audioContext,.1)],new Envelope(e=>Math.max(Math.random()**4*16,.5),.01,1.5),[.5,1.1,1.5,2],.2]};function linearspike(e){return function(t){return 0==t||t>e?0:t<=e/2?t/(e/2):1-(t-e/2)/(e/2)}}let allsounds=Object.values(sounds).slice();const soundeffects={allsounds:allsounds,footstep:[sounds.footstep],footsteptap:[sounds.footsteptap],arrowflight:[sounds.arrowthudnoise,sounds.arrowthudtone,sounds.swordswingsmall,sounds.swordswingsmallverb],swordswing:[sounds.swordswingsmall,sounds.swordswingsmallverb],swordhit:[sounds.swordswingsmall,sounds.swordswingsmallverb,sounds.highthudtone,sounds.highthudnoise],clubswing:[sounds.clubwhoom,sounds.clubwhoosh],clubhit:[sounds.clubhitcrack,sounds.clubhitnoise,sounds.clubhittone,sounds.clubwhoom,sounds.clubwhoosh],woodbreaking:[sounds.woodbreaking,sounds.woodbreaking2],woodbreakingdeep:[sounds.woodbreakingdeep,sounds.woodbreaking2deep],caveambience:[sounds.caveambience],deepspookybong:[sounds.deepspookybong],highshrillbing:[sounds.highshrillbing],bassdrum:[sounds.bassdrum],highthud:[sounds.highthudtone,sounds.highthudnoise],medthud:[sounds.medthudtone,sounds.medthudnoise],deepthud:[sounds.deepthudtone,sounds.deepthudnoise],goblinchat:[sounds.goblinchat,sounds.goblinchatverb,sounds.goblinchat2],goblinyelp:[sounds.goblinyelp],goblindeath:[sounds.goblindeath],ogredeath:[sounds.ogredeath],goblinscream:[sounds.goblinscream],goblinshriek:[sounds.goblinshriek],deathshriek:[sounds.deathshriek],aaasound:[sounds.aaasound,sounds.aaasound2,sounds.aaasound3],eeesound:[sounds.eeesound,sounds.eeesound2,sounds.eeesound3],sworddraw:[sounds.sworddraw,sounds.swordring,sounds.swordring2,sounds.swordring3],bowdraw:[sounds.bowstring],shortsworddraw:[sounds.shortsworddraw],daggerdraw:[sounds.daggerdraw],daggerdraw2:[sounds.daggerdraw2],tap:[sounds.tap],puncture:[sounds.puncture,sounds.spurt1,sounds.spurt2,sounds.spurt1verb,sounds.spurt2verb]};function playsoundeffect(e){for(let t=0;t<e.length;t++){let[n,i,s,a,o,l,c]=e[t],h=soundManager.requestSource();h.freqmod=null,h.overtones=[],o&&(h.freqmod=o),l&&(h.overtones=l.slice()),h.vol=1,void 0!==c&&(h.vol=c),h.freq=null,h.freq=n,h.type=null,h.type=i,h.env=null,h.env=s,h.fx=[],a&&(h.fx=a.slice()),soundManager.playSound()}}function playambientsound(e){for(let t=0;t<e.length;t++){let[n,i,s,a,o,l,c]=e[t],h=soundManager.requestAmbientSource();h.freqmod=null,h.overtones=[],o&&(h.freqmod=o),l&&(h.overtones=l.slice()),h.vol=.2,c&&(h.vol=c/5),h.freq=null,h.freq=n,h.type=null,h.type=i,h.env=null,h.env=s,h.fx=[],a&&(h.fx=a.slice()),soundManager.playAmbientSound()}}function adsrconvert([e,t,n,i],s){let a=s-(e+t+i);return function(s){return s<0?0:s>=0&&s<=e?s/e:s>e&&s<=e+t?1-(s-e)/t*(1-n):s>e+t&&s<=e+t+a?n:s>e+t+a&&s<=e+t+a+i?n*(1-(s-(e+t+a))/i):0}}function calculateGain(e,t,n){let i=t/2/1024,s=new Float32Array(1024),a=new Float32Array(1024),o=new Float32Array(1024);for(let l=0;l<1024;l++)s[l]=l*i;e.getFrequencyResponse(s,a,o);let c=0,h=0;for(let d=0;d<1024;d++)c+=1,h+=a[d];let u=c*i*n,$=h*i*n;return Math.sqrt(u/$)}function createReverb(e,t=2){return function(){let n=e.createConvolver(),i=e.sampleRate,s=i*t,a=e.createBuffer(2,s,i),o=a.getChannelData(0),l=a.getChannelData(1);for(let c=0;c<s;c++)o[c]=(2*Math.random()-1)*Math.pow(1-c/s,2),l[c]=(2*Math.random()-1)*Math.pow(1-c/s,2);return n.buffer=a,n.normalize=!0,n}}function createDistortion(e,t){return function(){let n=e.createWaveShaper();return n.curve=makeSoftClippingCurve(t),n}}function makeDistortionCurve(e){let t="number"==typeof e?e:50,n=new Float32Array(44100),i=Math.PI/180;for(let s=0;s<44100;++s){let a=2*s/44100-1;n[s]=(3+t)*a*20*i/(Math.PI+t*Math.abs(a))}return n}function makeSoftClippingCurve(e){let t="number"==typeof e?e:50,n=new Float32Array(44100);for(let i=0;i<44100;++i){let s=2*i/44100-1;n[i]=s/(1+t*Math.abs(s))}return n}function makeExponentialDistortionCurve(e){let t="number"==typeof e?e:50,n=new Float32Array(44100);for(let i=0;i<44100;++i){let s=2*i/44100-1;n[i]=(1-Math.exp(-t*Math.abs(s)))*(s<0?-1:1)}return n}function createDelay(e,t=1,n=.5){return function(){let i=e.createDelay(),s=e.createGain();return s.gain.value=n,i.connect(s),s.connect(i),i.delayTime.value=t,s}}function createPause(e,t=1,n=0){return function(){let i=e.createDelay(),s=e.createGain();return s.gain.value=n,i.connect(s),s.connect(i),i.delayTime.value=t,i}}function createDelayChain(e,t=1,n=.5,i){return function(){let s=e.createDelay(),a=e.createGain();a.gain.value=n,s.connect(a);let o=a;for(let l=0;l<i.length;l++){let c=i[l];o.connect(c),o=c}return o.connect(s),s.delayTime.value=t,a}}function createLowpassFilter(e,t){return function(){let n=e.createBiquadFilter();return n.frequency.setValueAtTime(t,e.currentTime),n.type="lowpass",n}}function createBandpassFilter(e,t){return function(){let n=e.createBiquadFilter();return n.type="bandpass",n.frequency.value=t,n.Q.value=1,n}}class ambientSound{constructor(e,t,n){this.sound=e,this.mincadence=t,this.maxcadence=n,this.lastplayed=0,this.thiscadence=t+Math.random()*(n-t),this.randomize=!0}}let ambientsounds=[new ambientSound(soundeffects.caveambience,5e3,7e3),new ambientSound(soundeffects.deepspookybong,5e3,15e3),new ambientSound(soundeffects.bassdrum,1500,1500)];function updateambientsound(){for(let e=0;e<ambientsounds.length;e++){let t=ambientsounds[e];performance.now()-t.lastplayed>t.thiscadence&&(!0==t.randomize&&(t.sound[0][0]=1e3*Math.random()),playambientsound(t.sound),t.lastplayed=performance.now(),t.thiscadence=t.mincadence+Math.random()*(t.maxcadence-t.mincadence))}}ambientsounds[2].randomize=!1;class character{constructor(e,t,n,i,s,a,o,l,c,h,d,u){this.pos=[],this.pos=e.slice(),this.name=t,this.stats=n.slice()||[0,0,0],this.maxhp=i,this.hp=i,this.tcmax=s.slice(),this.tcmax.length<4&&(this.tcmax[3]=1),this.tc=this.tcmax.slice(),this.pc=a,this.symbol=o,this.dead=!1,this.actionqueue=[],this.target=e.slice(),this.color=l.slice(),this.ac=c,this.traits=h.map(e=>new trait(e.name,e.trigger,e.effect,e.active,e.passive,this)),this.conditions=[],this.condresists=[],this.unarmed=new Unarmed,this.equipment=[],d&&d.length>0&&(this.equipment=d.slice()||[]),this.primaryitem=this.unarmed,this.secondaryitem=this.unarmed,this.offhanditem=this.unarmed,this.ammunition={};let $=this;this.equipment.forEach(function(e){$.addItem(e,!0)}),this.specialattack=u||null,this.lightsources=[],this.index=characterindex,characterindex++,this.visibletiles=[],!0==this.pc?playercs.push(this):nonpcs.push(this)}damage(e){if(0==e)return;let t=0;if(this.ownedelements){let n="";for(let i=0;i<this.ownedelements.length;i++){let s=this.ownedelements[i];!(s.lifespan[0]<now)&&(s.lifespan[0]=0,n+=s.symbol)}isNaN(t=parseInt(n))&&(t=0)}else this.ownedelements=[];let a=(e+t).toString();for(let o=0;o<this.ownedelements.length;o++){let l=this.ownedelements[o],[c,h]=l.pos;newgrid[c][h].uiElements=newgrid[c][h].uiElements.filter(e=>e!=l)}this.ownedelements=adduilabel(a,this.pos,[128,0,0],1,!0),this.hp-=e,this.hp<=0&&!1==this.dead&&this.die(),this.bleed()}bleed(){let e=new blood;newgrid[this.pos[0]][this.pos[1]].addFluid(e)}heal(e){this.hp+=e,adduilabel(e.toString(),this.pos,[0,128,0],1,!0,!1,!1,!0,1)}die(){let[e,t]=this.pos;this.actionqueue=[];let n=null;this.deathsound&&(n=this.deathsound);let i=new action("Die",e=>e,[0,0,0],0,this.pos,this,this.pos,[],n,6);this.actionqueue.push(i),move(this),this.dead=!0,adduilabel("x",this.pos,[128,0,0],0,!0,!1,!1,!1),this.color[1]*=.5,this.color[2]*=.5,this.color[0]*=.5;let s=new corpse("Corpse",this.symbol,convertColortoAbs(this.color).map((e,t)=>e*[.5,.1,.1][t]),null,0,!0,0);s.destructable=!1,newgrid[this.pos[0]][this.pos[1]].addObject(s),this.dropAll(),newgrid[this.pos[0]][this.pos[1]].character=null}addItem(e,t=!1){if(e instanceof Ammunition){this.addAmmo(e.basename,e.number);return}if(this.primaryitem&&this.primaryitem.basename==e.basename&&this.primaryitem.stacksize>this.primaryitem.number)this.primaryitem.number++,this.primaryitem.name=`${this.primaryitem.basename}(${this.primaryitem.number})`,t||adduilabel(this.primaryitem.name,this.pos,this.color,1,!0);else if(this.secondaryitem&&this.secondaryitem.basename==e.basename&&this.secondaryitem.stacksize>this.secondaryitem.number)this.secondaryitem.number++,this.secondaryitem.name=`${this.secondaryitem.basename}(${this.secondaryitem.number})`,t||adduilabel(this.secondaryitem.name,this.pos,this.color,1,!0);else{if(this.secondaryitem.name==this.unarmed.name&&this.itemSwap(),this.drop(),this.primaryitem=e,e.ammotype){let n=this.ammunition[e.ammotype];n||(n=0),e.name=`${e.basename}(${n})`}t||adduilabel(this.primaryitem.name,this.pos,this.color,1,!0)}}itemSwap(){let e=this.primaryitem;this.primaryitem=this.secondaryitem,this.secondaryitem=e}drop(e="primaryitem"){let[t,n]=this.pos,i=this[e];if(i&&i.basename!=this.unarmed.basename){if(i.ammotype){let s=this.ammunition[i.ammotype];if(this.ammunition[i.ammotype]=0,s){let a=new i.ammoconstructor;a.number=s,newgrid[t][n].addObject(a),i.name=i.basename}}newgrid[t][n].addObject(i),i.drop(),this[e]=this.unarmed}}dropoffhand(){this.drop("offhanditem")}dropAll(){this.drop(),this.drop("secondaryitem"),this.drop("offhanditem")}removeItem(e){this.primaryitem.basename==e.basename?(this.primaryitem.number--,this.primaryitem.number<=0?this.primaryitem=this.unarmed:adduilabel(this.primaryitem.number.toString(),this.pos,this.color,1,!0),1==this.primaryitem.number?this.primaryitem.name=this.primaryitem.basename:this.primaryitem.number>1&&(this.primaryitem.name=`${this.primaryitem.basename}(${this.primaryitem.number})`)):this.secondaryitem.basename==e.basename?(this.secondaryitem.number--,this.secondaryitem.number<=0?this.secondaryitem=this.unarmed:adduilabel(this.secondaryitem.number.toString(),this.pos,this.color,1,!0),1==this.secondaryitem.number?this.secondaryitem.name=this.secondaryitem.basename:this.secondaryitem.number>1&&(this.secondaryitem.name=`${this.secondaryitem.basename}(${this.secondaryitem.number})`)):this.offhanditem.basename==e.basename&&(this.offhanditem.number--,this.offhanditem.number<=0?this.offhanditem=this.unarmed:adduilabel(this.offhanditem.number.toString(),this.pos,this.color,1,!0),1==this.offhanditem.number?this.offhanditem.name=this.offhanditem.basename:this.offhanditem.number>1&&(this.offhanditem.name=`${this.offhanditem.basename}(${this.offhanditem.number})`))}removeAmmo(e){this.ammunition[e]--,adduilabel(this.ammunition[e].toString(),this.pos,this.color,1,!0),this.updateAmmo()}addAmmo(e,t){!this.ammunition[e]||this.ammunition[e]<=0?this.ammunition[e]=t:this.ammunition[e]+=t,adduilabel(this.ammunition[e].toString(),this.pos,this.color,1,!0),this.updateAmmo()}updateAmmo(){let e=[this.primaryitem,this.secondaryitem,this.offhanditem],t=this;e.forEach(function(e){if(e.ammotype){let n=`${e.basename}`;t.ammunition[e.ammotype]||(t.ammunition[e.ammotype]=0),n+=`(${t.ammunition[e.ammotype]})`,e.reloading&&(verbose?e.reloaded?n+="(loaded)":n+="(unloaded)":e.reloaded||(n+="*")),e.name=n}})}getatkbonus(e=this.primaryitem){let t=e.bonus+this.stats[e.stat];return t}getdamage(){let e=this.primaryitem,t=e.bonus+this.stats[e.stat],n=roll(e.damagedie,t);return n}getavdamage(e=this.primaryitem){if(0==e.damagedie)return[0,0];let t=e.bonus+this.stats[e.stat],n=[1+t,e.damagedie+t];return n}getrange(e){return(e||(e=this.primaryitem),e.ammotype&&!this.ammunition[e.ammotype])?0:e.range}getminrange(e){return(e||(e=this.primaryitem),e.ammotype&&!this.ammunition[e.ammotype])?0:e.minrange}getvisibletiles(){let[e,t]=this.pos,n=this,i=[],s=[],a=new Set;s.push(newgrid[e][t]);let o=0;for(let l=0;l<this.visibletiles.length;l++){let c=this.visibletiles[l];c.removevisiblecharacter(n)}for(;s.length>0&&o<1e4;){o++;let h=s.pop(),[d,u]=h.pos;if(newgrid[d][u].readOpacity()>=1)continue;let $=dist([e,t],[d,u]);if($>enemysightrange)continue;let[p,m]=[0,0],[f,_]=[0,0],g=newgrid[e][t].elevation,w=newgrid[d][u].elevation;if(1>drawLine3D([e,t,g+1],[d,u,w])){i.push(h),h.addvisiblecharacter(n);let b=`${h.pos[0]},${h.pos[1]}`;if(n.knowntiles[b]=turncounter,$<enemysightrange)for(let v=0;v<8;v++){[p,m]=directions[v],[f,_]=[d+p,u+m];let k=`${f},${_}`;!a.has(k)&&newgrid[f]&&newgrid[f][_]&&(a.add(k),s.push(newgrid[f][_]))}}else if(g!==w&&1>drawline([e,t],[d,u],!0))for(let S=d-1;S<=d+1;S++)for(let A=u-1;A<=u+1;A++){let C=`${S},${A}`;!a.has(C)&&newgrid[S]&&newgrid[S][A]&&(a.add(C),s.push(newgrid[S][A]))}}this.visibletiles=i}getplayerviewold(){let[e,t]=this.pos,n=[e,t],i=[],s={},a=[];a.push(newgrid[e][t]);let o=0;class l{constructor(e,t,n){this.min=e,this.max=t,this.distance=n,this.left=null,this.right=null}}class c{constructor(){this.root=null}insert(e,t,n){let i=new l(e,t,n);null===this.root?this.root=i:this.root=this._insert(this.root,i)}_insert(e,t){return t.min<e.min?null===e.left?e.left=t:e.left=this._insert(e.left,t):null===e.right?e.right=t:e.right=this._insert(e.right,t),e}find(e){return this._find(this.root,e)}_find(e,t){return null===e?null:t>=e.min&&t<=e.max?e.distance:t<e.min?this._find(e.left,t):this._find(e.right,t)}findMaxDistanceInRange(e,t){return this._findMaxDistanceInRange(this.root,e,t)}_findMaxDistanceInRange(e,t,n){if(null===e||e.max<t||e.min>n)return -99;if(e.min>=t&&e.max<=n)return e.maxDistance;let i=-99;return e.min<=n&&e.max>=t&&(i=e.distance),i=Math.max(i,this._findMaxDistanceInRange(e.left,t,n),this._findMaxDistanceInRange(e.right,t,n))}}let h=Array(360).fill(99);function d(e,t){let[n,i]=e,[s,a]=t,o=[[s-.5,a-.5],[s+.5,a-.5],[s-.5,a+.5],[s+.5,a+.5]].map(([e,t])=>{let s=Math.atan2(t-i,e-n)*(180/Math.PI);return Math.round(s=(s+360)%360)}),l=Math.min(...o),c=Math.max(...o);return Math.abs(l-c)>270?[l,l,chebyshevDistance(e,t)]:[l,c,chebyshevDistance(e,t)]}function u(e){let[t,i]=e.pos,s=d(n,e.pos);console.log(h);let a=h.findMaxDistanceInRange(s[0],s[1]);return!!(a>=s[2])||-99===a}function $(e){let t=d(n,e.pos);for(let i=t[0];i<=t[1];i++)if(t[2]<=h[i])return!0;return!1}for(;a.length>0&&o<5e3;){let p=a.shift(),[m,f]=p.pos;if(o++,i.push(p),!1!=$(p)){if(1>p.readOpacity())for(let _=m-1;_<=m+1;_++)for(let g=f-1;g<=f+1;g++)s[_]||(s[_]={}),s[_][g]||(s[_][g]=1,a.push(newgrid[_][g]));if(p.readOpacity()>=1){let w=d(n,p.pos);for(let b=w[0];b<=w[1];b++)h[b]=Math.min(h[b],w[2])}}}return i.forEach(function(e){}),i}getplayerview(){let[e,t]=this.pos,n=[e,t];newgrid[e][t].elevation;let i=[],s={},a=[];a.push(newgrid[e][t]);let o=0,l=Array(360).fill(99);function c(e,t){let[n,i]=e,[s,a]=t,o=[[s-.5,a-.5],[s+.5,a-.5],[s-.5,a+.5],[s+.5,a+.5]],[l,c]=[0,0],h,d,u=[];for(let $=0;$<4;$++)[l,c]=o[$],d=((d=(h=Math.atan2(c-i,l-n))*(180/Math.PI))+360)%360,u[$]=Math.round(d);let p=Math.min(...u),m=Math.max(...u);return Math.abs(p-m)>270?[p,p,chebyshevDistance(e,t)]:[p,m,chebyshevDistance(e,t)]}function h(e){let t=c(n,e.pos);for(let i=t[0];i<=t[1];i++)if(t[2]<=l[i])return!0;return!1}for(;a.length>0;){let d=a.shift(),[u,$]=d.pos;if(o++,i.push(d),!1!=h(d)){if(1>d.readOpacity(void 0,n))for(let p=u-1;p<=u+1;p++)for(let m=$-1;m<=$+1;m++)s[p]||(s[p]={}),s[p][m]||(s[p][m]=1,a.push(newgrid[p][m]));if(d.readOpacity(void 0,n)>=1){let f=c(n,d.pos);for(let _=f[0];_<=f[1];_++)l[_]=Math.min(l[_],f[2])}}}return i}getplayerviewnew(){}}class playerCharacter extends character{constructor(e,t,n,i,s,a,o,l,c,h,d,u){super(e,t,n,i,s,a,o,l,c,h,d,u),this.reactions=[attackofop,overwatch,autopickup,block],this.level=1,this.recalculatehealth(),this.cantwohand=!0}levelup(){if(this.level++,2==this.level){let e=this.specialattack,t=function(t,n){let i=e.bind(this),s=extraattack.bind(this);return s(i(t,n),n)};this.specialattack=t}this.primarystat||(this.primarystat=0),this.secondarystat||(this.secondarystat=2),this.stats[this.primarystat]++,this.level%2==1&&this.stats[this.secondarystat]++,this.recalculatehealth()}recalculatehealth(){let e=this.maxhp;this.maxhp=2*this.stats[2],this.maxhp+=Math.max(this.stats[2],1)*this.level;let t=this.maxhp-e;t>0&&(this.hp+=t)}hear(e,t){if(t<1||this.dead&&!(!0==gameover&&deathcharacter==this)||!0===e.heard)return;let n=this,[i,s]=e.pos;e.heard=!0;let a=[];e.soundeffect&&(a=e.soundeffect.slice());let o=[];if(a.forEach(function(n,i){o[i]=[],o[i]=n.slice(),void 0===o[i][6]&&(o[i][6]=1),0!==o[i][6]&&(o[i][6]*=Math.max(Math.min((t/e.volume)**.5,1),.1))}),!0==e.origin.pc){playsoundeffect(o);return}if(!1==newgrid[i][s].visible){setTimeout(()=>{adduilabel("^",e.pos,n.color,0,!0,!1,!1,!0,1),playsoundeffect(o)},(e.volume-t)*50);return}playsoundeffect(o)}die(){super.die();let e=!0;for(let t=0;t<playercs.length;t++)!0!==playercs[t].dead&&(e=!1);e&&(gameover=!0,deathcharacter=this)}}class Fugitive extends playerCharacter{constructor(e){super(e,"Fugitive",statblocks.Exile,6,[4,1,1],!0,"@",[0,32,0],14,[],[],sneakattackpermute);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.primarystat=1,this.specialattack=n}}class Huntsman extends playerCharacter{constructor(e){super(e,"Huntsman",statblocks.Wanderer,6,[4,1,1],!0,"@",[128,96,64],14,[],[],sharpshooterpermute);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.primarystat=1,this.specialattack=n}}class Stalker extends playerCharacter{constructor(e){super(e,"Stalker",statblocks.Stalker,6,[4,1,2],!0,"@",[12,12,12],14,[],[],e=>e);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.primarystat=1,this.specialattack=n,this.reactions.push(ambush)}}class Skirmisher extends playerCharacter{constructor(e){super(e,"Skirmisher",statblocks.Skirmisher,6,[4,1,1],!0,"@",[0,16,32],14,[],[],disengagepermute);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this),a=jumpattack.bind(this);return a(s(i(e,n),n),n)};this.primarystat=1,this.specialattack=n,this.reactions.push(evade)}}class Deserter extends playerCharacter{constructor(e){super(e,"Deserter",statblocks.Deserter,9,[4,1,1],!0,"@",[128,128,128],14,[],[],torchbearerpermute),this.offhanditem=new Torch(300);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.specialattack=n}}class Berserker extends playerCharacter{constructor(e){super(e,"Berserker",statblocks.Berserker,9,[4,1,1],!0,"@",[160,64,32],14,[],[],savageattack);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.primarystat=2,this.secondarystat=0,this.specialattack=n}}class Hellion extends playerCharacter{constructor(e){super(e,"Hellion",statblocks.Hellion,9,[4,1,1],!0,"@",[64,0,8],14,[],[],chargeattackpermute);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.specialattack=n}}class Standard_Bearer extends playerCharacter{constructor(e){super(e,"Standard Bearer",statblocks.Standard_Bearer,6,[4,1,1],!0,"@",[64,64,16],14,[],[],inciteattack);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.specialattack=n}}class Sentinel extends playerCharacter{constructor(e){super(e,"Sentinel",statblocks.Sentinel,9,[4,1,1],!0,"@",[64,96,96],14,[],[],e=>e);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.specialattack=n,this.reactions=this.reactions.filter(e=>e!==block),this.primarystat=2,this.secondarystat=0,this.reactions.push(defender),this.reactions.push(riposte)}}class ShieldMaiden extends playerCharacter{constructor(e){super(e,"Shield Maiden",statblocks.ShieldMaiden,9,[4,1,2],!0,"@",[64,96,96],14,[],[],shieldbash);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.primarystat=2,this.secondarystat=0,this.specialattack=n,this.reactions.push(defender)}}class Ranger extends playerCharacter{constructor(e){super(e,"Ranger",statblocks.Ranger,6,[4,1,1],!0,"@",[64,128,64],14,[],[],e=>e);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpluspermute.bind(this);return s(i(e,n),n)};this.specialattack=n}}class Duelist extends playerCharacter{constructor(e){super(e,"Duelist",statblocks.Ranger,6,[4,1,1],!0,"@",[64,128,96],14,[],[],e=>e);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.reactions.push(parry),this.primaryitem=new Dagger,this.offhanditem=new Dagger,this.specialattack=n}}class Maledict extends playerCharacter{constructor(e){super(e,"Maledict",statblocks.Exile,6,[4,1,1],!0,"@",[32,0,0],14,[],[],bloodattack);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.specialattack=n}}class Prisoner extends playerCharacter{constructor(e){super(e,"Prisoner",statblocks.Prisoner,6,[4,1,1],!0,"@",[64,32,0],10,[],[],e=>e);let t=this.specialattack,n=function(e,n){let i=t.bind(this),s=dualwieldpermute.bind(this);return s(i(e,n),n)};this.specialattack=n}}class enemy extends character{constructor(e,t,n,i,s,a,o,l,c,h,d,u,$){super(e,t,n,i,s,a,o,l,c,h,d,$),this.startingpos=e.slice(),this.knowntiles={},this.tasks=[],this.knownenemies=[],this.activetask,this.huntmap,this.huntedcharacters={},this.knowncharacters={},this.visiblecharacters={},this.utilityfunctions=[],this.actions=[],this.reactions=u||[],this.reactions.push(moralecheck),this.hp+=Math.round(4*Math.random()),this.maxhp=this.hp,this.morale=3*this.maxhp,this.actions=[moveusecase,attackusecase,dashusecase,chatusecase,standgroundusecase,alertusecase],this.states=[new State("idle",defaultidle,null,[0,3]),new State("hostile",defaulthostile,defaulttemperment,[0,1]),new State("hunting",defaulthunting,null,[0]),new State("fleeing",defaultfleeing,null,[0,1,5])],this.updatestate(),this.deathsound=soundeffects.goblindeath,spot(this)}damage(e){super.damage(e),this.moraledamage(e)}moraledamage(e){this.morale-=e,this.morale<=0&&(this.state=this.states[3]),this.morale>0&&(this.state=this.states[1]);let t=this.maxhp-this.hp,n=3*this.maxhp-4*t;this.morale=Math.min(n,this.morale)}updatestate(){let e=this;this.state||(this.state=this.states[0]);let t=!1,n=!1;Object.values(e.visiblecharacters).forEach(function(i){let s=i.character;s.pc!=e.pc&&(t=!0,n=!0)}),!1==t&&Object.values(e.knowncharacters).forEach(function(t){let i=t.character;i.pc!=e.pc&&(console.log(t),console.log(t.lastseen),adduilabel("!",t.lastseen,[256,256,256],0,!0,!1,!1,!0),n=!0)}),this.state.name==this.states[0].name&&!0==n&&(this.state=this.states[1],this.actionqueue=[],addconditiondynamic(conditions.Surprised,!0,this)()),this.state.name==this.states[1].name&&!1==n?(this.huntmap=null,this.state=this.states[2],this.actionqueue=[]):this.state.name==this.states[2].name&&!0==t&&(this.state=this.states[1],this.actionqueue=[])}hear(e,t){let n=this;if(e.origin!=n){if(e.origin.pc!==this.pc)this.visiblecharacters[e.origin.index]=new CharacterMemory(e.origin,e.origin.pos.slice()),this.knowncharacters[e.origin.index]=new CharacterMemory(e.origin,e.origin.pos.slice()),this.updatestate();else if("Attack"==e.content||"Miss"==e.content){let[i,s]=e.pos,a;newgrid[i][s].character&&newgrid[i][s].character.pc!==this.pc&&(a=newgrid[i][s].character),a&&(this.visiblecharacters[a.index]=new CharacterMemory(a,a.pos.slice()),this.knowncharacters[a.index]=new CharacterMemory(a,a.pos.slice())),this.updatestate()}else if("Alert"==e.content||"Huh?"==e.content){if(e.origin.knowncharacters){let o=!1;Object.values(e.origin.knowncharacters).forEach(function(e){let t=e.character,i=e.lastseen;if((!n.visiblecharacters[t.index]||n.visiblecharacters[t.index].time<e.time)&&t.pc!==n.pc){let s=new CharacterMemory(t,i);n.visiblecharacters[t.index]=s,n.knowncharacters[t.index]=s,n.state.name==n.states[0].name&&(o=!0)}}),o&&n.updatestate()}else console.log("trying to alert, but don't know any enemies")}}}getrange(e=this.primaryitem){let t=super.getrange(e);return!0==e.throwable&&e.number<2&&(this.primaryitem.name==this.unarmed.name||this.secondaryitem.name==this.unarmed.name)&&(t=1.9),e.ammotype&&!this.ammunition[e.ammotype]&&(t=0),t}update(){if(this.state.name==this.states[3].name){let e=Object.values(this.visiblecharacters);for(let t=0;t<e.length;t++)e[t].character.pc==this.pc&&this.moraledamage(-1)}}}class Human extends enemy{constructor(e,t,n,i){super(e,t,statblocks.Goblin,4,[4,1,1],!1,"@",n,10,[],i,[spot,attackofop])}getvisibletiles(){let[e,t]=this.pos,n=this,i=[],s=[],a=new Set;s.push(newgrid[e][t]);let o=0;for(let l=0;l<this.visibletiles.length;l++){let c=this.visibletiles[l];c.removevisiblecharacter(n)}for(;s.length>0&&o<1e3;){o++;let h=s.shift(),[d,u]=h.pos;if(1>drawLine3D([e,t,newgrid[e][t].elevation+1],[d,u,newgrid[d][u].elevation])){let $=`${h.pos[0]},${h.pos[1]}`;if(newgrid[d][u].lightlevel>0&&(i.push(h),h.addvisiblecharacter(n),n.knowntiles[$]=turncounter),dist([e,t],[d,u])<enemysightrange)for(let p=d-1;p<=d+1;p++)for(let m=u-1;m<=u+1;m++){let f=`${p},${m}`;!a.has(f)&&newgrid[p]&&newgrid[p][m]&&(a.add(f),s.push(newgrid[p][m]))}}else if(drawline([e,t],[d,u],!0))for(let _=d-1;_<=d+1;_++)for(let g=u-1;g<=u+1;g++){let w=`${_},${g}`;!a.has(w)&&newgrid[_]&&newgrid[_][g]&&(a.add(w),s.push(newgrid[_][g]))}}this.visibletiles=i}}class Bandit extends Human{constructor(e){super(e,"Bandit",[64,64,32],[]),this.offhanditem=new Torch(25)}}class Goblin extends enemy{constructor(e,t,n,i){t||(t="Goblin"),n||(n=[150,125,0]),i||(i=Math.random()>.5?[new Shiv]:[new Club]),super(e,t,statblocks.Goblin,4,[5,1,1],!1,"g",n,8,[],i,[spot,attackofop,lightsensitive],darkattackpermute)}}class Goblin_Dagger extends Goblin{constructor(e){let t;super(e,"Goblin",[150,125,0],[t=Math.random()>.5?new Dagger(1):new Javelin(1)])}}class Goblin_Swordsman extends Goblin{constructor(e){let t=[];Math.random()>.5?t.push(new Shortsword):t.push(new Scimitar),Math.random()>.5&&t.push(new Dagger(randomNumber(2,1))),super(e,"Goblin Swordsman",[150,125,0],t),Math.random()>.5&&(this.offhanditem=new Shield,this.reactions.push(block))}}class Goblin_Spearman extends Goblin{constructor(e){super(e,"Goblin Spearman",[150,125,0],[new Spear]),Math.random()>.5&&(this.offhanditem=new Shield,this.reactions.push(block))}}class Hobgoblin extends Goblin{constructor(e){super(e,"Hobgoblin",[100,15,15],[]),.25>Math.random()?this.primaryitem=new Longsword:.33>Math.random()?(this.primaryitem=new Longbow,this.ammunition.Arrow=5+Math.ceil(5*Math.random())):.5>Math.random()?this.primaryitem=new Mace:this.primaryitem=new Battleaxe,this.maxhp+=7,this.hp=this.maxhp}}class Hobgoblin_Warlord extends Hobgoblin{constructor(e){super(e),this.name="Hobgoblin Warlord",this.primaryitem=this.unarmed,this.secondaryitem=this.unarmed,this.offhanditem=this.unarmed;let t=[[Handaxe,Shield],[]];this.primaryitem=new t[0][0],this.offhanditem=new t[0][1],this.maxhp+=7,this.hp=this.maxhp;let n=this.specialattack,i=function(e,t){let i=n.bind(this),s=dualwieldpermute.bind(this);return s(i(e,t),t)};this.specialattack=i,this.reactions.push(block)}}class Goblin_Longbow extends Goblin{constructor(e){super(e,"Goblin Archer",[100,150,0],[]),this.ammunition.Arrow=randomNumber(5,2),this.primaryitem=new Longbow}}class Goblin_Shortbow extends Goblin{constructor(e){super(e,"Goblin Archer",[100,150,0],[]),this.ammunition.Arrow=randomNumber(5,2),this.primaryitem=new Shortbow}}class Goblin_Wargmaster extends Goblin{constructor(e){let t;super(e,"Goblin",[150,125,0],[t=Math.random()>.5?new Dagger(1):new Javelin(1)]);let n=new Warg_Tame(e),i=new Leash;n.master=this,n.leash=i,newgrid[e[0]][e[1]].addCharacter(n),newgrid[e[0]][e[1]].addObject(i)}}class Goblin_Hivequeen extends Goblin{constructor(e){super(e,"Goblin Hive Queen",[128,128,128],[new Athame(1)]),this.ac=12,this.maxhp*=3,this.hp=this.maxhp,this.shriekcooldown=-3,this.offhanditem=new Light("Glowing Jade",".",[.6,.4,.6]),this.offhanditem.lightsources=[new lightsource(null,[256,164,256],[1,1,1],2)],this.deathsound=soundeffects.deathshriek}damage(e){super.damage(e),!0!=this.dead&&this.Shriek()}Shriek(){if(turncounter-this.shriekcooldown<3)return;this.shriekcooldown=turncounter;let e=this.color,[t,n]=this.pos;hear(new Sound([t,n],16,this,"Shriek",soundeffects.goblinshriek),16,0,[6,4,6]),adduilabel("Shriek",this.pos,e,1,!0);for(let i=t-10;i<t+10;i++)for(let s=n-10;s<n+10;s++)newgrid[i]&&newgrid[i][s]&&10>dist([t,n],[i,s])&&(newgrid[i][s].objects.length>0&&Math.random()>.5&&"Spawning Membrane"==newgrid[i][s].objects[0].name&&newgrid[i][s].objects[0].damage(1),null!==newgrid[i][s].character&&newgrid[i][s].character.pc!==this.pc&&addconditiondynamic(conditions.Stunned,!0,newgrid[i][s].character)())}die(){let[e,t]=this.pos;super.die();for(let n=e-25;n<e+25;n++)for(let i=t-25;i<t+25;i++)if(newgrid[n]&&newgrid[n][i]){let s=newgrid[n][i].character;null!=s&&(s instanceof Goblin||s instanceof Ogre||s instanceof Giant)&&(s.pc=Math.round(1e3*Math.random())+2)}won=!0}}class Necromancer extends enemy{constructor(e){super(e,"Necromancer",[0,0,0],16,[4,1,1],3,"@",[256,256,256],10,[],[new Athame],[spot,attackofop])}damage(e){super.damage(e),!0!==this.dead&&this.raiseDead()}raiseDead(){let[e,t]=this.pos;for(let n=e-5;n<e+5;n++)for(let i=t-5;i<t+5;i++)if(newgrid[n]&&newgrid[n][i]&&newgrid[n][i].objects.length>0){let s=newgrid[n][i].objects[0];s instanceof corpse&&!s.burning&&!s.burnt&&(s.break(),newgrid[n][i].addCharacter(new Zombie([n,i])))}}}class Zombie extends enemy{constructor(e){super(e,"Zombie",[0,0,0],8,[3,1,0],3,"z",[64,128,32],10,[],[],[])}}class ElderSpider extends enemy{constructor(e){super(e,"Elder Spider",[0,2,0],18,[5,1,1],2,"S",[48,0,16],14,[],[],[spot,attackofop]),this.primaryitem.specialeffect=conditionattackpermute(conditions.Poisoned),this.secondaryitem.name="Web",this.secondaryitem.ammotype="Web",this.ammunition.Web=10,this.secondaryitem.minrange=3,this.secondaryitem.range=10,this.secondaryitem.specialeffect=function(e,t){let[n,i]=t,s=function(){newgrid[n][i].addObject(new Spiderweb),newgrid[n][i].addObject(new Spiderweb),newgrid[n][i].addObject(new Spiderweb)};return e.onhiteffects.push(s),e.onmisseffects.push(s),e}}}class GiantSpider extends enemy{constructor(e){super(e,"Giant Spider",[0,0,0],9,[5,1,1],2,"s",[24,24,24],10,[],[],[spot,attackofop]),this.primaryitem.specialeffect=conditionattackpermute(conditions.Poisoned),this.secondaryitem.name="Web",this.secondaryitem.ammotype="Web",this.ammunition.Web=1,this.secondaryitem.minrange=3,this.secondaryitem.range=5,this.secondaryitem.specialeffect=function(e,t){let[n,i]=t,s=function(){newgrid[n][i].addObject(new Spiderweb),newgrid[n][i].addObject(new Spiderweb),newgrid[n][i].addObject(new Spiderweb)};return e.onhiteffects.push(s),e.onmisseffects.push(s),e}}}class SpiderBroodMother extends enemy{constructor(e){super(e,"Spider Brood Mother",[0,0,0],9,[5,1,1],2,"s",[64,24,64],10,[],[],[spot,attackofop]),this.secondaryitem.name="Web",this.secondaryitem.ammotype="Web",this.ammunition.Web=1,this.secondaryitem.minrange=3,this.secondaryitem.range=5,this.secondaryitem.specialeffect=function(e,t){let[n,i]=t,s=function(){newgrid[n][i].addObject(new Spiderweb),newgrid[n][i].addObject(new Spiderweb),newgrid[n][i].addObject(new Spiderweb)};return e.onhiteffects.push(s),e.onmisseffects.push(s),e}}die(){let[e,t]=this.pos;for(let n=0;n<4;n++)newgrid[e][t].addCharacter(new Spiderling([e,t]));super.die()}}class Spiderling extends enemy{constructor(e){super(e,"Spiderling",[0,0,0],3,[3,1,1],2,"s",[48,48,48],8,[],[],[spot,attackofop])}}class Ogre extends enemy{constructor(e){super(e,"Ogre",[3,0,4],12,[3,1,1],!1,"o",[150,125,0],8,[],[new Warhammer],[spot,attackofop],darkattackpermute),this.deathsound=soundeffects.ogredeath,this.large=!0}}class Giant extends enemy{constructor(e){super(e,"Giant",[3,0,4],24,[3,1,1],!1,"G",[150,125,0],8,[],[new Polehammer],[spot,attackofop],darkattackpermute),Math.random()>.33&&(Math.random()>.5?this.primaryitem=new Halberd:this.primaryitem=new Greatsword),this.deathsound=soundeffects.ogredeath,this.large=!0}}class Skulker extends enemy{constructor(e){super(e,"Skulker",[0,2,0],5,[10,1,1],!1,"s",[32,32,32],12,[],[new Bolas(randomNumber(3,1))],[spot,attackofop,lightsensitive],darkattackpermute),this.secondaryitem=new Kukri}}class Wolf extends enemy{constructor(e){super(e,"Wolf",[0,0,0],5,[8,2,1],2,"w",[64,64,64],8,[],[new Dagger],[spot,attackofop])}}class Warg extends enemy{constructor(e){super(e,"Warg",[0,0,0],5,[8,1,1],2,"w",[96,64,64],8,[],[],[spot,attackofop])}}class Warg_Tame extends enemy{constructor(e){super(e,"Warg",[0,0,0],5,[8,1,1],!1,"w",[96,64,64],8,[],[],[spot,attackofop])}}class Carrion_Insect extends enemy{constructor(e){super(e,"Carrion Insect",[0,0,0],5,[8,2,1],2,"c",[128,128,128],8,[],[],[spot,attackofop])}}class State{constructor(e,t,n,i){this.name=e,this.utilityfunction=t,this.temperment=n||function(){return 0},this.actions=[],i&&(this.actions=i.slice())}}class CharacterMemory{constructor(e,t){this.character=e,this.lastseen=t.slice(),this.time=turncounter}getage(){return turncounter-this.time}}class Statblock{constructor(e,t,n){this.strength=e,this.dexterity=t,this.constitution=n}}class lightsource{constructor(e,t,n,i){this.pos=e,this.color=t,this.lightpref=n,this.radiance=i||2}}class uielement{constructor(e,t,n,i,s,a,o){this.symbol=e||"",this.color=t,this.pos=n,this.animation=i||!1,this.symbol||(this.symbol="$"),this.ui=s||!1,this.lifespan=a||null,this.tooltip=o}}class PriorityQueue{constructor(e){this.array=[],this.comparator=e}enqueue(e){let t=0,n=this.array.length;for(;t<n;){let i=Math.floor((t+n)/2);0>this.comparator(this.array[i],e)?t=i+1:n=i}this.array.splice(t,0,e)}dequeue(){return this.array.shift()}isEmpty(){return 0===this.array.length}}class condition{constructor(e,t,n,i,s,a,o){this.name=e,this.starteffect=t||(()=>{}),this.turneffect=n||(()=>{}),this.duration=i,this.resistance=s,this.character=o||null,this.endeffect=a}}class trait{constructor(e,t,n,i,s,a){this.name=e,this.trigger=t,this.effect=n,this.character=a||null,this.passive=i||!1,this.active=s||!1}}class trigger{constructor(e,t,n){this.isactive=e,this.ispassive=t,this.cb=n}}class action{constructor(e,t,n,i,s,a,o,l,c,h){this.name=e,this.target=s.slice(),this.func=t,this.character=a,this.cost=n.slice(),this.range=i||1.9,this.pos=o||null,this.warnings=[],l&&(this.warnings=l.slice()),this.soundeffect=c,this.loudness=h||1,this.reactable=!0}}class Move extends action{constructor(e,t,n,i,s,a,o,l){super(e,t,n,i,s,a,o,l);let[c,h]=this.target;if(this.cost[0]=newgrid[c][h].moveCost,this.pos&&this.character&&this.target){checkforaoomove(this.pos,this.target,this.character)&&this.warnings.push("!");let d=newgrid[c][h].gethazards(a.pc);d.some(e=>e>0)&&this.warnings.push("!")}if(this.loudness=6,this.character.state&&(this.character.state.name,this.character.states[0].name),this.soundeffect=soundeffects.footstep,newgrid[c][h].absorbtionBase==materials.stone&&(this.soundeffect=soundeffects.footsteptap),!0==a.large&&(this.soundeffect=soundeffects.deepthud,this.loudness=12),"Maledict"==a.name&&newgrid[c][h].fluids.length>0)for(let u of newgrid[c][h].fluids)"Blood"==u.name&&(this.cost=[0,0,0])}}class Sneak extends Move{constructor(e,t,n,i,s,a,o,l){super(e,t,n,i,s,a,o,l),this.loudness=1}}class Fall extends action{constructor(e,t,n){super("Fall",movefunc,[0,0,0],1,e,t,n),this.reactable=!0,this.func=function(){let[n,i]=e;newgrid[n][i].character&&newgrid[n][i].character.damage(1);let s=!0;!1===movefunc.bind(this)(!0)?(s=!1,t.damage(1)):newgrid[n][i].moveCost>1&&addconditiondynamic(conditions.Prone,!0,t)(),newgrid[n][i].objects.length>0&&newgrid[n][i].objects.forEach(e=>e.damage(1))}}}class Attack extends action{constructor(e,t,n,i,s,a,o,l){if(super(e,t,n,i,s,a,o,l),!0==this.character.primaryitem.reloading){let c=this.func,h=this,d=this.character.primaryitem;!1==this.character.primaryitem.reloaded?(this.func=reloadfunc,!0==a.pc&&(verbose&&this.warnings.push("Click to reload"),this.warnings.push("Unloaded"))):this.func=function(e,t){!0!==e&&(d.reloaded=!1);let n=c.bind(h),i=n(e,t);return e||!1===i?d.reloaded=!0:d.reloaded=!1,i}}let u=this.character.primaryitem;u.ammotype&&!this.character.ammunition[u.ammotype]&&!0==a.pc&&this.warnings.push(`No ${u.ammotype}s`);let[$,p]=this.target.slice();this.loudness=12}}class Jump extends action{constructor(e,t,n,i){chebyshevDistance(t,i),super("Jump",jumpfunc,[0,1,0],e,t,n,i);let s=newgrid[t[0]][t[1]].elevation-newgrid[i[0]][i[1]].elevation;s<-1&&this.warnings.push("fall")}}class Kick extends Attack{constructor(e,t,n){super("Kick",null,[0,1,0],1.9,e,t,n);let i=this,s=function(e,t){return attackfunc.apply(i,[e,new Foot])};this.func=s}}class Offhandattack extends Attack{constructor(e,t,n){super("Attack",null,[0,0,0],t.offhanditem.range,e,t,n);let i=this,s=function(e,n){return attackfunc.apply(i,[e,t.offhanditem])};this.func=s}}function jumpfunc(){let e=this.character,t=newgrid[e.pos[0]][e.pos[1]],[n,i]=this.target,s=newgrid[n][i].elevation-t.elevation;if(dist(e.pos,this.target,!1,!0)>this.range)return!1;let a=bresenhamLine(e.pos,this.target);if(0==a.length||1==a.length)return!1;for(let o=0;o<a.length;o++){let l=newgrid[a[o][0]][a[o][1]];if(!1==l.traversable&&!l.slope)return!1}if(!1!==newgrid[n][i].traversable&&null==newgrid[n][i].character){if(newgrid[e.pos[0]][e.pos[1]].character=null,e.pos=[n,i],newgrid[n][i].character=this.character,removecondition(e,"Prone"),s<-1){let c=0,h=Math.floor(s/2)**2;for(let d=0;d<h;d++)c+=randomNumber(3,1);this.soundeffect=soundeffects.deepthud,this.loudness=10,addconditiondynamic(conditions.Prone,!0,e)(),this.character.damage(c)}return}if(!1!==newgrid[n][i].traversable&&null!==newgrid[n][i].character&&s<-1){newgrid[e.pos[0]][e.pos[1]].character=null,e.pos=[n,i],newgrid[n][i].addCharacter(this.character),removecondition(e,"Prone");let u=0,$=Math.floor(s/2)**2;for(let p=0;p<$;p++)u+=randomNumber(3,1);this.soundeffect=soundeffects.deepthud,this.loudness=10,addconditiondynamic(conditions.Prone,!0,e)(),this.character.damage(u),newgrid[n][i].character.damage(u);return}return e.actionqueue=[],!1}class Get extends action{constructor(e,t,n,i,s,a,o,l,c,h){super(e,t,n,i,s,a,o,l,c,h),this.reactable=!1}}class endTurn extends action{constructor(e,t,n,i,s,a,o,l){if(super(e,t,n,i,s,a,o,l),this.reactable=!1,this.pos){let[c,h]=this.pos;newgrid[c][h].objects.length>0&&newgrid[c][h].objects[0].burning&&this.warnings.push("!")}}}class Tile{constructor(e,t,n,i,s,a,o){this.name,this.absorbtionBase=t,this.symbolBase=n,this.visible=!1,this.light=[0,0,0],this.lightlevel=0,this.objects=[],this.character=null,this.uiElements=[],this.traversable=i,this.moveCost=s,this.baseMoveCost=s,this.pos=o,this.transparancy=a,this.specularity=0,this.charactersinview=[],this.fluids=[],this.elevation=0}read(e=!1){let t=this.readOpacity();procgendebug&&(this.visible=!0,this.light=[64,64,64]);let[n,i]=this.pos,s=this.light.slice();if(t>=1&&null==this.character){let a=[0,0,0],o=0;for(let l=0;l<8;l++){let[c,h]=directions[l],[d,u]=[n+c,i+h];if(!newgrid[d]||!newgrid[d][u]||!1==newgrid[d][u].visible)continue;let $=newgrid[d][u].light;if(1>newgrid[d][u].readOpacity()){let p=$[0]+$[1]+$[2];p>o&&(a[0]=$[0],a[1]=$[1],a[2]=$[2],o=p)}}s=a}let m=[0,0,0],f=[0,0,0],_="&nbsp",g=1;if(t>=1&&(g=.25),!1!==this.visible){let w=0;for(let b=0;b<3;b++)m[b]=256*(Math.max(s[b]*this.absorbtionBase[b]*g,0)*noisemap[n][i]/256)**(1/gamma),f[b]=1*m[b]/2,w+=m[b];if(w<3*memorytilebrightness){let v=3*memorytilebrightness/(w=Math.max(w,.5));for(let k=0;k<3;k++)m[k]*=v}_=this.symbolBase}if(this.fluids.length>0&&!1!==this.visible){let S=[1,1,1];this.fluids.forEach(function(e){if(e.symbol&&(_=e.symbol),null!==e.bgabsorbtion){let t=1;e.thickness&&(t=e.thickness);for(let n=0;n<t;n++)S=S.map((t,n)=>t*e.bgabsorbtion[n])}});for(let A=0;A<3;A++)m[A]=Math.max(m[A]*S[A],0),f[A]=m[A]/2}if(this.objects.length>0&&!1!==this.visible){let C=this.objects[0];if(C.symbol&&(_=C.symbol),C.absorbtion)for(let E=0;E<3;E++)m[E]=256*(Math.max(s[E]*C.absorbtion[E],0)/256);if(null!==C.bgabsorbtion)for(let z=0;z<3;z++)f[z]=s[z]*C.bgabsorbtion[z]*.5}if(null!==this.character&&!1!==this.visible){let q=this.character;if(!1!==q){let j=takeav(newgrid[n][i].light)/256;m=q.color.map(e=>Math.max(e/2,j*e)),f=f.map(e=>.75*e),_=q.symbol}}if(!0==this.seen&&!0!==this.visible&&(_=this.symbolBase,m=[memorytilebrightness,memorytilebrightness,memorytilebrightness]),!this.seen&&this.visible&&(this.seen=!0),this.uiElements.length>0)for(let W=0;W<this.uiElements.length;W++){let F=this.uiElements[W];if(!F.lifespan||!(F.lifespan[1]>=now)){if("$"===F.symbol)for(let D=0;D<3;D++)m[D]+=256*F.color[D],f[D]+=128*F.color[D];else if("^"===F.symbol){F.symbol="B7",_=F.symbol;for(let R=0;R<3;R++)m[R]=F.color[R]}else if("_"==F.symbol)for(let B=0;B<3;B++)m[B]=256*F.color[B],f[B]=256*F.color[B];else if(" "===F.symbol);else{_=F.symbol;for(let G=0;G<3;G++)m[G]=F.color[G]}!F.lifespan&&(this.uiElements.splice(W,1),W--)}}for(let M=0;M<3;M++)m[M]=Math.round(m[M]*brightnessadjust),f[M]=Math.round(f[M]*brightnessadjust);if(e)return[m,f,_];if("&nbsp"==_)return`<span 
                y = ${n}
                x = ${i}
                >&nbsp</span>`;let O=`<span 
            y=${n};
            x=${i};
            style="color: rgb(${m});background-color: rgb(${f});">${_}</span>`;return O}updateui(){for(let e=0;e<this.uiElements.length;e++){let t=this.uiElements[e];t.lifespan&&t.lifespan[0]<now&&(this.uiElements.splice(e,1),updatedsomething=!0,e--),!0==t.unrendered&&t.lifespan&&t.lifespan[1]>now&&(t.unrendered=!1,updatedsomething=!0)}}cursorread(e=!1){let t=this,n=0,i=this.character,s=!1;for(let a=0;a<this.uiElements.length;a++){let o=this.uiElements[a];if(void 0!==o.redirect&&(o.redirect.cursorread(!0),s=!0),o.tooltip&&verbose){let l=[],c=o.tooltip,h=-15+Math.min(c.length,15);for(;c.length>15;){let d=0;for(;" "!=c[15+d];){if(" "==c[15-d]){d=-d;break}d++}let u=c.slice(0,15+d);c=c.slice(15+d),l.push(u),h=Math.max(h,d)}l.push(c);let $=15+h,p=[viewportpos[0]+viewportsizey/2-2,viewportpos[1]-1];cursorpos[0],l.length,viewportpos[0];for(let m=-1;m<l.length+1;m++)adduilabel(repeatchar("_",$+2),p,[.1,.1,.1],(l.length-m)*1,!1,!1,!1,!0);for(let f=0;f<l.length;f++)adduilabel(l[f],p,o.color,(l.length-f)*1,!1,!1,!1,!0)}if(s)break}if(!s&&(this.fluids.length>0&&this.fluids.forEach(function(e){n++,adduilabel(e.name,t.pos,[64,64,64],n)}),this.objects.length>0&&this.objects.forEach(function(e){n++;let i=adduilabel(e.name,t.pos,[64,64,64],n);if(e instanceof Weapon){for(let s=0;s<i.length;s++)i[s].redirect=t;let a=[],o=0,l=`1-${e.damagedie.toString()}`;u("Damage Range"),l+=`+${activecharacternonindex.getatkbonus(e)}`,u("Bonus"),e.throwable&&(l+="(Thrown)",u()),e.twohanded&&(l+="(Two-handed)",u()),1==e.stat&&(l+="(Finnesse)",u("Bonus determined by dexterity")),e.versatile&&(l+="(Versatile)",u("Can be wielded with 1 or 2 hands")),e.light&&(l+="(Light)",u("Can be wielded in offhand")),!0==e.shove&&(l+=`(Shove${Math.max(activecharacternonindex.stats[0],1)})`,u("Shoves enemies using strength")),!0==e.trip&&(l+="(Trip)",u("Knocks enemies prone")),e.bleed&&(l+="(Bleed)",u()),e.disarm&&(l+="(Disarm)",u()),e.cleave&&(l+="(Cleave)",u("Hits multiple adjacent targets")),e.consumable&&(l+="(Consumable)",u()),n++;let c=adduilabel(l,t.pos,[64,64,64],n);for(let h=0;h<c.length;h++){let d=c[h];d.redirect=t,a[h]&&(d.tooltip=a[h])}function u(e){for(let t=o;t<l.length;t++)a.push(e);o=l.length}}if(e instanceof Shield){let $=`Dmg-${activecharacternonindex.stats[0]}`;n++,adduilabel($,t.pos,[64,64,64],n)}if(e.verbose){let p=e.verbose();n++,adduilabel(p,t.pos,[256,256,256],n)}}),null!==i)){let _=i.name,g=i.hp,w=i.pos,b=g.toString(),v=i.maxhp,k;n++,k=adduilabel(b+"/"+v,w,i.color,n);for(let S=0;S<k.length;S++)k[S].redirect=t;n++,k=adduilabel(_,w,i.color,n);for(let A=0;A<k.length;A++)k[A].redirect=t;for(let C=0;C<i.conditions.length;C++){n++;let E=i.conditions[C].name+"("+i.conditions[C].duration.toString()+")";k=adduilabel(E,w,i.color,n);for(let z=0;z<k.length;z++)k[z].redirect=t}let q=[i.primaryitem,i.secondaryitem,i.offhanditem];for(let j=0;j<3;j++){let W=q[j].name;if("Unarmed"!=W){n++,k=adduilabel(W,i.pos,i.color,n);for(let F=0;F<k.length;F++)k[F].redirect=t}}}}readOpacity(e,t){if(void 0!==e&&e<this.elevation)return 1;let n=this.transparancy;if(null!==this.character&&(void 0==e||e-1<=this.elevation)?lackscondition(conditions.Prone,this.character)&&(n=.75):this.objects.length>0&&(t&&"Fortification"==this.objects[0].name&&2>dist(t,this.pos)||(void 0==e||e<=this.elevation+1||!1==this.objects[0].traversable)&&(n-=this.objects[0].opacity)),this.fluids.length>0)for(let i=0;i<this.fluids.length;i++){let s=this.fluids[i],a=1;s.thickness&&(a=s.thickness),n*=1-s.opacity}return 1-n}addCharacter(e){if(null==this.character&&!0===this.traversable)this.character=e,e.pos=this.pos.slice();else{if(e.iterations||(e.iterations=0),e.iterations>50)return;e.iterations++;let t=shuffle(directions),n=[],[i,s]=this.pos;for(let a=0;a<t.length;a++){let[o,l]=t[a],[c,h]=[i+o,s+l];if(!newgrid[c]||!newgrid[c][h])continue;let d=newgrid[c][h];if(n.push(d),null==d.character&&!0==d.traversable){d.addCharacter(e);return}}n[0].addCharacter(e)}}addObject(e){if(e.number<=0)return;if(void 0!==e.number&&isNaN(e.number)){console.log("we tried to add this object to a tile, but it had a quantity that didn't make any sense"),console.log(e);return}if(e instanceof fluid){this.addFluid(e);return}if(!(e.number>1)||e instanceof Ammunition)e.number>1?e.name=`${e.basename}(${e.number})`:e.name=e.basename;else{e.name=e.basename,e.number--,this.addObject(new e.constructor),this.addObject(e);return}if(e.iterations>100)return;let t=this,n=!0;if((this.objects.length>0||!0!==this.traversable)&&(n=!1),!1==e.traversable&&null!==this.character&&(n=!1),n)e.iterations=0,e.pos=this.pos.slice(),this.objects.push(e),this.updateObjects(),e.initialize();else{e.iterations||(e.iterations=0),e.iterations++;let i=shuffle(directions),s=[];for(let a=0;a<i.length;a++){let[o,l]=i[a].map((e,n)=>e+t.pos[n]);if(!newgrid[o]||!newgrid[o][l])continue;let c=newgrid[o][l];if((c.traversable||!0==c.slope)&&c.elevation<=this.elevation&&(s.push(c),0==c.objects.length)){c.addObject(e);break}a==i.length-1&&s.length>0&&s[0].addObject(e)}}}removeObject(){this.objects=[],this.updateObjects()}updateObjects(){let e=this;if(this.traversable=!0,this.moveCost=this.baseMoveCost,this.objects.length>0){let t=this.objects[0];!1==t.traversable&&(this.traversable=!1),this.moveCost+=t.movecost,t.pos=this.pos.slice()}this.fluids.length>0&&this.fluids.forEach(function(t){e.moveCost+=t.movecost,t.pos=e.pos.slice()})}addFluid(e){if(e.iterations>20)return;let t=this,n=!0,i=!1;if(this.fluids.forEach(function(t){t.basename==e.basename&&(n=!1,t instanceof gas&&Math.random()>.5&&t.thickness<3&&(t.addthickness(),i=!0))}),!i){if(n)e.pos=this.pos.slice(),this.fluids.push(e),this.updateObjects(),e.initialize();else{e.iterations||(e.iterations=0),e.iterations++;let s=shuffle(directions),a=[];for(let o=0;o<s.length;o++){let[l,c]=s[o].map((e,n)=>e+t.pos[n]);if(!newgrid[l]||!newgrid[l][c])continue;let h=newgrid[l][c];if(h.traversable&&(h.elevation<=t.elevation||e instanceof gas)&&(a.push(h),0==h.fluids.length)){h.addFluid(e);break}o==s.length-1&&a.length>0&&a[0].addFluid(e)}}}}removeFluid(e){e.destroyed=!0,this.fluids=this.fluids.filter(t=>t.basename!=e.basename)}readLightsource(){let e=[];if(this.templightsources&&this.templightsources.length>0){let t=this.templightsources[0][0];this.templightsources[0][1]--,this.templightsources[0][1]<=0&&this.templightsources.shift(),e.push(t)}if(null!==this.character){let n=[this.character.primaryitem,this.character.offhanditem];n.forEach(function(t){t.lightsources&&t.lightsources.length>0&&t.lightsources.forEach(function(t){e.push(t)})}),this.character.lightsources&&this.character.lightsources.length>0&&e.push(this.character.lightsources[0])}if(this.objects.length>0&&this.objects[0].lightsources.length>0&&e.push(this.objects[0].lightsources[0]),this.fluids.length>0)for(let i=0;i<this.fluids.length;i++)this.fluids[i].lightsources.length>0&&e.push(this.fluids[i].lightsources[0]);return e}addTempSource(e,t){this.templightsources||(this.templightsources=[]),this.templightsources.push([e,t])}addvisiblecharacter(e){let t=!1;this.charactersinview.forEach(function(n){n.index==e.index&&(t=!0)}),!1==t&&this.charactersinview.push(e)}removevisiblecharacter(e){for(let t=0;t<this.charactersinview.length;t++)if(this.charactersinview[t].index==e.index){this.charactersinview.splice(t,1);break}}gethazards(e){let t=[0,0];return this.objects.length>0&&this.objects.forEach(function(n){!1===n.revealed&&!0==e||(t=t.map((e,t)=>e+n.hazards[t]))}),this.fluids.length>0&&this.fluids.forEach(function(e){t=t.map((t,n)=>t+e.hazards[n])}),t}}class object{constructor(e,t,n,i,s,a,o,l,c,h){this.name=e,this.symbol=t,this.absorbtion=n,this.bgabsorbtion=i||null,this.opacity=s||0,this.traversable=a,this.movecost=o||0,this.action=l||null,this.effects=c||[],this.lightsources=h||[],this.pos=[],this.ac=0,this.pc=!1,this.destructable=!1,this.durability=1,this.hp=1,this.basename=e,this.baseabsorbtion=n,this.basesymbol=t,this.burnduration=1,this.flammable=!1,this.hazards=[0,0],!1==this.traversable&&(this.immovable=!0)}damage(e){if(this.destructable&&!this.destroyed){let t=Math.floor(e/this.durability);this.hp-=t;adduilabel(t.toString(),this.pos,convertAbstoColor(this.baseabsorbtion),1,!0,!1,!1,!1),this.hp<=0&&this.break()}}break(){let[e,t]=this.pos;newgrid[e][t].objects.shift(),this.destroyed=!0,this.remnants&&this.remnants.forEach(function(n){n instanceof fluid?newgrid[e][t].addFluid(n):newgrid[e][t].addObject(n)}),this.burning&&this.spreadfire(),hear(new Sound(this.pos,10,this,null,soundeffects.woodbreaking)),newgrid[e][t].updateObjects()}addRemnants(){this.remnants=[];for(let e=0;e<2;e++){let t=new Wreckage(this);this.remnants.push(t)}}initialize(){this.destructable&&this.addRemnants();let e=directionsincl.slice();for(let t=0;t<e.length;t++){let[n,i]=e[t].map((e,t)=>e+this.pos[t]);if(!newgrid[n]||!newgrid[n][i])continue;let s=newgrid[n][i];s.objecttriggers||(s.objecttriggers=[]),s.objecttriggers.push(this)}}react(e,t,n,i){!this.destroyed&&"Miss"==n.soundcontent&&1>=chebyshevDistance(n.target,this.pos)&&Math.random()>.75&&this.damage(1),i||"Move"!=n.name&&"Attack"!=n.name||0!=chebyshevDistance(n.target,this.pos)||this.destroyed||!this.burning||0!=chebyshevDistance(t.pos,this.pos)||t.damage(1)}burn(){if(this.burning||this.burnt||!this.flammable)return;this.name=`Burning ${this.basename}`,this.hazards=this.hazards.map((e,t)=>e+[1,5][t]),this.burning=!0,this.lightsources.push(new lightsource(this.pos,[128,128,128],[2.5,1.5,1],2)),this.absorbtion=materials.fire,null!=this.bgabsorbtion&&(this.bgabsorbtion=materials.fire);let[e,t]=this.pos;newgrid[e][t].character&&!1==newgrid[e][t].character.dead&&newgrid[e][t].character.damage(5),envobjects.push(this)}update(){if(this.burning&&!this.destroyed){let[e,t]=this.pos;null!==newgrid[e][t].character&&newgrid[e][t].character.damage(5);for(let n=0;n<4;n++)newgrid[e][t].addFluid(new smoke);this.spreadfire(),this.destructable&&(this.damage(1),this.destroyed||envobjects.push(this)),this.burnduration-=1,this.burnduration>0?envobjects.push(this):(this.lightsources=[],this.burning=!1,this.burnt=!0,this.name=`charred ${this.basename}`,this.hazards=[0,0],this.absorbtion=[0,0,0],null!=this.bgabsorbtion&&(this.bgabsorbtion=[.2,.2,.2]))}}spreadfire(){for(let e=0;e<directions.length;e++){let[t,n]=directions[e].map((e,t)=>e+this.pos[t]);if(!newgrid[t]||!newgrid[t][n])continue;let i=newgrid[t][n];i.objects.length>0&&!i.objects[0].burning&&i.objects[0].burn(),i.fluids&&i.fluids.length>0&&i.fluids.forEach(function(e){e.burning||e.burnt||e.burn()})}}move(e){let[t,n]=this.pos,[i,s]=this.pos.map((t,n)=>t-e[n]);if(!newgrid[i]||!newgrid[i][s])return;let a=newgrid[i][s].character;for(;!0==newgrid[i][s].slope;)[i,s]=[i,s].map((t,n)=>t-e[n]);let o=newgrid[i][s].elevation-newgrid[t][n].elevation,l=o**2,c=this.hp;!0==newgrid[i][s].traversable&&(newgrid[t][n].removeObject(),newgrid[i][s].addObject(this),o<-1&&this.damage(l)),null!==a&&(o<-1&&a.damage(Math.min(l,c)),this.movecost>0&&addconditiondynamic(conditions.Prone,!0,a)())}}class Item extends object{constructor(e,t,n){super(e,t,n,null,0,!0),this.name=e,this.symbol=t,this.absorbtion=n||[1,1,1]}stow(){}draw(){}drop(){}}class Weapon extends Item{constructor(e,t,n,i,s,a,o,l,c,h,d,u){super(e,t,n),this.range=s||1.9,this.bonus=a||0,this.damagedie=o||1,this.stat=l||0,this.minrange=c||0,this.drawsound=h||soundeffects.daggerdraw2,this.hitsound=d||soundeffects.swordhit,this.misssound=u||soundeffects.swordswing,this.stacksize=1,this.number=1,this.twohanded=!1}addRemnants(){this.remnants=[new BrokenWeapon(this)]}}class BrokenWeapon extends object{constructor(e){let t=`Broken ${e.name}`,n=e.symbol,i=e.absorbtion,s=e.bgabsorbtion,a=e.opacity;super(t,n,i,s,a,!0)}}class Unarmed extends Weapon{constructor(){super("Unarmed",null,null,null,1.9,0,1,0,0,null,null,null)}}class Foot extends Unarmed{constructor(){super("Unarmed",null,null,null,1.9,0,0,0,0,null,null,null),this.specialeffect=kickattackpermute}}class Kukri extends Weapon{constructor(){super("Kukri","&#x0192",materials.metal,actions.Attack,1.9,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.light=!0,this.specialeffect=conditionattackpermute(conditions.Bleeding),this.bleed=!0}}class Dagger extends Weapon{constructor(e){super("Dagger","&#x2020",materials.metal,actions.Attack,3.5,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.throwable=!0,this.number=e||1,this.light=!0,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Runic_Dagger extends Weapon{constructor(e){super("Runic Dagger","&#x2020",materials.metal,actions.Attack,3.5,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.throwable=!0,this.number=e||1,this.light=!0,e>1&&(this.name=`${this.basename}(${this.number})`),this.lightsources.push(new lightsource([0,0],[256,256,256],[1.5,1.5,1.5],3))}}class Shiv extends Weapon{constructor(){super("Shiv","&#x2020",materials.metal,actions.Attack,1.9,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.light=!0}}class Athame extends Weapon{constructor(e){super("Athame","&#x2020",[.2,.2,.2],actions.Attack,3.5,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.throwable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=conditionattackpermute(conditions.Bleeding),this.light=!0,this.bleed=!0}}class Javelin extends Weapon{constructor(e){super("Javelin","-",materials.wood,actions.Attack,3.5,0,2,0,0,soundeffects.tap,soundeffects.arrowflight),this.stacksize=3,this.throwable=!0,this.number=e||1,this.light=!0,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Club extends Weapon{constructor(){super("Club","|",materials.wood,actions.Attack,1.9,0,2,0,null)}}class Greatclub extends Weapon{constructor(){super("Greatclub","|",materials.wood,actions.Attack,1.9,0,4,0,null),this.twohanded=!0}}class Longsword extends Weapon{constructor(){super("Longsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.versatile=!0}}class Runic_Longsword extends Weapon{constructor(){super("Runic Longsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.versatile=!0,this.lightsources.push(new lightsource([0,0],[256,256,256],[1.5,1.5,1.5],3))}}class Greatsword extends Weapon{constructor(){super("Greatsword","/",materials.metal,actions.Attack,1.9,0,10,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.twohanded=!0}}class Runic_Greatsword extends Weapon{constructor(){super("Runic Greatsword","/",materials.metal,actions.Attack,1.9,0,10,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.twohanded=!0,this.lightsources.push(new lightsource([0,0],[256,256,256],[1.5,1.5,2],3))}}class Speedsword extends Weapon{constructor(){super("Speedsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let n=function(){e.character.tc[2]>0&&(e.character.tc[2]--,e.character.tc[1]++)};return e.onhiteffects.push(n),e.onmisseffects.push(n),e}}}class Shortsword extends Weapon{constructor(){super("Shortsword","/",materials.metal,actions.Attack,1.9,0,4,1,null,soundeffects.shortsworddraw),this.light=!0}}class Scimitar extends Weapon{constructor(){super("Scimitar","/",materials.metal,actions.Attack,1.9,0,4,0,null,soundeffects.shortsworddraw),this.light=!0}}class Rapier extends Weapon{constructor(){super("Rapier","/",materials.metal,actions.Attack,1.9,0,4,1,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let n=function(e){if(e<=0)return;let[n,i]=t,s=newgrid[n][i].character;s&&(s.drop(),s.drop("offhanditem"))};return e.onhiteffects.push(n),e.modbreakdown.push("Disarm"),e},this.disarm=!0}}class Katana extends Weapon{constructor(){super("Katana","/",materials.metal,actions.Attack,1.9,0,1,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=conditionattackpermute(conditions.Bleeding),this.bleed=!0}}class Punching_Red_Glove_Expanding_Arm_Kapow extends Weapon{constructor(){super("Punching Red Glove Expanding Arm Kapow","/",materials.metal,actions.Attack,1.9,0,1,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let n=function(){let[n,i]=t,s=newgrid[n][i].character,a=e.pos.slice(),o=t.map((e,t)=>a[t]-e);if(s)for(let l=0;l<1;l++){let c=s.pos.map((e,t)=>e-o[t]);s.actionqueue.push(new action("Fall",movefunc,[0,0,0],1,c,s,t)),move(s)}};return e.onhiteffects.push(n),e}}}class Handaxe extends Weapon{constructor(){super("Handaxe","/",materials.metal,actions.Attack,1.9,0,2,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.light=!0,this.cleave=!0}}class Runic_Handaxe extends Weapon{constructor(){super("Runic Handaxe","/",materials.metal,actions.Attack,1.9,0,2,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.light=!0,this.cleave=!0,this.lightsources.push(new lightsource([0,0],[256,256,256],[1.5,1.5,1.5],3))}}class Battleaxe extends Weapon{constructor(){super("Battleaxe","/",materials.metal,actions.Attack,1.9,0,4,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.versatile=!0,this.cleave=!0}}class Greataxe extends Weapon{constructor(){super("Greataxe","/",materials.metal,actions.Attack,1.9,0,8,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.twohanded=!0,this.cleave=!0}}class Warhammer extends Weapon{constructor(){super("Warhammer","T",materials.metal,actions.Attack,1.9,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=conditionattackpermute(conditions.Prone),this.versatile=!0,this.trip=!0}}class Greathammer extends Weapon{constructor(){super("Greathammer","T",materials.metal,actions.Attack,1.9,0,8,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=conditionattackpermute(conditions.Prone),this.twohanded=!0,this.trip=!0}}class Mace extends Weapon{constructor(){super("Mace","T",materials.metal,actions.Attack,1.9,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=shoveattackpermute,this.versatile=!0,this.shove=!0}}class Maul extends Weapon{constructor(){super("Maul","T",materials.metal,actions.Attack,1.9,0,8,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=shoveattackpermute,this.twohanded=!0,this.shove=!0}}class Spear extends Weapon{constructor(){super("Spear","-",materials.wood,actions.Attack,2.5,0,2,0,0,soundeffects.tap),this.versatile=!0}}class Pike extends Weapon{constructor(){super("Pike","/",materials.metal,actions.Attack,2.5,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.twohanded=!0}}class Halberd extends Weapon{constructor(){super("Halberd","/",materials.metal,actions.Attack,2.5,0,4,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.twohanded=!0,this.cleave=!0,this.reach=!0}}class Glaive extends Weapon{constructor(){super("Glaive","/",materials.metal,actions.Attack,2.5,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.twohanded=!0,this.cleave=!0,this.reach=!0}}class Polehammer extends Weapon{constructor(){super("Polehammer","T",materials.metal,actions.ProneAttack,2.5,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=conditionattackpermute(conditions.Prone),this.twohanded=!0,this.trip=!0}}class Ammunition extends object{constructor(e,t,n){super(e,t,n,null,0,!0,0,null,null,null)}}class Arrow extends Ammunition{constructor(e){super("Arrow","&#x02D7",materials.wood),this.stacksize=15,this.throwable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Bolt extends Ammunition{constructor(e){super("Bolt","&#x02D7",materials.wood),this.stacksize=15,this.throwable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Longbow extends Weapon{constructor(){super("Longbow",")",materials.wood,actions.Attack,7.9,0,4,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.ranged=!0}}class Cleavebow extends Weapon{constructor(){super("Cleavebow",")",materials.wood,actions.Attack,7.9,0,4,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.specialeffect=cleaveattack}}class Recurve_Bow extends Weapon{constructor(){super("Recurve Bow","}",materials.wood,actions.Attack,8.9,0,6,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.ranged=!0,this.specialeffect=function(e,t){for(let n=e.modbreakdown.length-1;n>=0;n--){if("Half Cover-10"==e.modbreakdown[n]){e.modbreakdown.splice(n,1),e.extrinsmod+=2,e.percenthitchance+=10,e.avdamageac10+=.1*takeav(e.damagerange);continue}if("Three Quarters Cover-25"==e.modbreakdown[n]){e.modbreakdown.splice(n,1),e.extrinsmod+=5,e.percenthitchance+=25,e.avdamageac10+=.25*takeav(e.damagerange);continue}}e.percenthitchance=Math.min(e.percenthitchance,100);let i=function(){let n=bresenhamLine(e.pos,t),i=n.map(e=>newgrid[e[0]][e[1]]);i.forEach(function(t){if(t.character&&t.character.pc!==e.character.pc){let n=e,i=t.character;100*Math.random()<n.percenthitchance&&i?i.damage(randomNumber(n.damagerange[1],n.damagerange[0])):adduilabel("Miss",t.pos,[128,128,128],1,!0,!1)}})};return e.onhiteffects.push(i),e.onmisseffects.push(i),e}}}class Double_Recurve_Bow extends Weapon{constructor(){super("Recurve Bow","}",materials.wood,actions.Attack,8.9,0,8,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.specialeffect=function(e,t){for(let n=e.modbreakdown.length-1;n>=0;n--){if("Half Cover-10"==e.modbreakdown[n]){e.modbreakdown.splice(n,1),e.extrinsmod+=2,e.percenthitchance+=10,e.avdamageac10+=.1*takeav(e.damagerange);continue}if("Three Quarters Cover-25"==e.modbreakdown[n]){e.modbreakdown.splice(n,1),e.extrinsmod+=5,e.percenthitchance+=25,e.avdamageac10+=.25*takeav(e.damagerange);continue}}e.percenthitchance=Math.min(e.percenthitchance,100);let i=function(){let n=bresenhamLine(e.pos,t),i=n.map(e=>newgrid[e[0]][e[1]]);i.forEach(function(t){if(t.character&&t.character.pc!==e.character.pc){let n=e,i=t.character;100*Math.random()<n.percenthitchance&&i?i.damage(randomNumber(n.damagerange[1],n.damagerange[0])):adduilabel("Miss",t.pos,[128,128,128],1,!0,!1)}})},s=function(){let n=new Attack("Attack",attackfunc,[0,0,0,1],e.character.getrange(e.weapon),t,e.character,e.pos);e.character.actionqueue.push(n)};return e.onhiteffects.push(i),e.onmisseffects.push(i),e.onhiteffects.push(s),e.onmisseffects.push(s),e}}}class Shortbow extends Weapon{constructor(){super("Shortbow",")",materials.wood,actions.Attack,6.9,0,2,1,1.9,soundeffects.bowdraw),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.ranged=!0}}class Handcrossbow extends Weapon{constructor(){super("Hand Crossbow",")",materials.wood,actions.Attack,6.9,0,2,1,1.9,soundeffects.bowdraw),this.ammotype="Bolt",this.ammoconstructor=Bolt,this.light=!0,this.ranged=!0}}class Heavy_Crossbow extends Weapon{constructor(){super("Heavy Crossbow",")",materials.wood,actions.Attack.slice(),7.9,0,6,1,1.9,soundeffects.bowdraw),this.ammotype="Bolt",this.ammoconstructor=Bolt,this.ranged=!0,this.reloading=!0,this.reloaded=!1,this.specialeffect=conditionattackpermute(conditions.Prone),this.trip=!0}}class Bolas extends Weapon{constructor(e){super("Bolas","%",materials.wood,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){let[n,i]=t,s=function(e){e>=1&&addconditiondynamic(conditions.Prone,!0,newgrid[n][i].character)()};return e.onhiteffects.push(s),e.damagerange=[1,1],newgrid[n][i].character&&lackscondition(conditions.Prone,newgrid[n][i].character)&&(e.avdamageac10+=5),e},this.trip=!0}}class OilFlask extends Weapon{constructor(e){super("Oil Flask",",",materials.mud,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.woodbreaking),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){let[n,i]=t,s=function(){for(let e=0;e<9;e++)newgrid[n][i].addFluid(new oil);newgrid[n][i].fluids.forEach(e=>e.burn())};return e.onhiteffects.push(s),e.onmisseffects.push(s),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class SmokeBomb extends Weapon{constructor(e){super("Smoke Bomb",",",materials.mud,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){let[n,i]=t,s=function(){for(let e=0;e<200;e++)newgrid[n][i].addFluid(new smoke)};return e.onhiteffects.push(s),e.onmisseffects.push(s),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class CaltropsBag extends Weapon{constructor(e){super("Caltrops Bag",".",materials.wood,actions.Attack,50.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){1==e.errors.length&&"No Target"==e.errors[0]&&(e.errors=[]);let[n,i]=t,s=function(){for(let e=0;e<8;e++)newgrid[n][i].addObject(new Caltrops)};return e.onhiteffects.push(s),e.onmisseffects.push(s),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class FlashPowder extends Weapon{constructor(e){super("Flash Powder",".",materials.wood,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){1==e.errors.length&&"No Target"==e.errors[0]&&(e.errors=[]);let[n,i]=t,s=function(){for(let e=1;e<10;e+=2)newgrid[n][i].addTempSource(new lightsource(this.pos,[256,256,256,],[e,.6*e,.4*e],3),1);for(let t=10;t>1;t-=2)newgrid[n][i].addTempSource(new lightsource(this.pos,[256,256,256,],[t,.6*t,.4*t],3),1);updatelightmap(),updatetraitspassive()};return e.onhiteffects.push(s),e.onmisseffects.push(s),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class Grenade extends Weapon{constructor(e){super("Grenade","&#x2020",materials.metal,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`);let t=this;this.specialeffect=function(e,n){let[i,s]=n,a=function(){[...directions,[0,0]].forEach(function(e){let[i,s]=e.map((e,t)=>e+n[t]),a=newgrid[i][s],o=a.character;a.objects.length>0&&a.objects.forEach(e=>e.damage(10)),rangedanimate(n,[i,s],convertAbstoColor(t.absorbtion)),o&&!0!==o.dead&&o.damage(10),a.addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null))}),adduilabel("*",n,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)};return e.onhiteffects.push(a),e.onmisseffects.push(a),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class Bonfire extends object{constructor(){super("Fire Pit","*",[.2,.2,.2],null,.25,!1,null,null,null,null,null),this.destructable=!1}initialize(){super.initialize(),this.action=actions.Interact}interact(e){this.lit?e.heal(e.maxhp-e.hp):this.burn()}burn(){this.lit=!0,this.name="Bonfire",this.absorbtion=materials.fire,this.lightsources.push(new lightsource(this.pos,[256,256,256],[2.5,1.5,1],2))}}class Brazier extends object{constructor(){super("Brazier","o",materials.metal,null,.25,!1,null,null),this.flammable=!0,this.burnduration=1/0,this.immovable=!1}burn(){this.name=`Lit ${this.basename}`,this.basename=`Lit ${this.basename}`,this.burning=!0,this.lightsources.push(new lightsource(this.pos,[256,256,256],[2.5,1.5,1],2))}}class corpse extends object{constructor(e,t,n,i,s,a,o,l,c,h,d){super(e,t,n,i,s,a,o,l,c,h,d),this.flammable=!0}initialize(){super.initialize(),envobjects.push(this),newgrid[this.pos[0]][this.pos[1]].addFluid(new blood("Blood","",[0,0,0],materials.blood,0,!0,0))}update(){super.update();let[e,t]=this.pos;newgrid[e][t],Math.random()>.5&&newgrid[e][t].addFluid(new blood("Blood","",[0,0,0],[.5,.1,.1],0,!0,0)),Math.random()>.25&&envobjects.push(this)}}class explodingBarrel extends object{constructor(){super("Barrel","2022",materials.wood),this.destructable=!0}break(){super.break(),this.explode()}explode(){let e=this,[t,n]=this.pos;for(let i=1;i<10;i+=2)newgrid[t][n].addTempSource(new lightsource(this.pos,[256,256,256,],[i,.6*i,.4*i],3),1);for(let s=10;s>1;s-=2)newgrid[t][n].addTempSource(new lightsource(this.pos,[256,256,256,],[s,.6*s,.4*s],3),1);updatetraitspassive(),directions.forEach(function(t){let[n,i]=t.map((t,n)=>t+e.pos[n]),s=newgrid[n][i],a=s.character;s.objects.length>0&&s.objects.forEach(e=>e.damage(10)),rangedanimate(e.pos,[n,i],convertAbstoColor(e.absorbtion)),a&&!0!==a.dead&&a.damage(10)}),adduilabel("*",e.pos,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)}}class door extends object{constructor(e=!1){super("Door","+",materials.wood,null,1,!1,0,actions.Open),Math.random()>.6&&(this.locked=!0),this.locked=!1,this.durability=2,this.hp=2,this.destructable=!0,this.flammable=!0,this.immovable=!1}open(){if(this.locked)return!1;this.action=null,this.opacity=0,this.traversable=!0,this.movecost=0,this.symbol="/"}move(){this.open();let[e,t]=this.pos;newgrid[e][t].updateObjects()}}class Window extends object{constructor(){super("Window","=",materials.wood,null,0,!1,null)}}class Pit extends object{constructor(){super("","",null,null,0,!1,null)}initialize(){let[e,t]=this.pos;newgrid[e][t].elevation-=5,newgrid[e-1][t].elevation-=5,newgrid[e+1][t].elevation-=5,newgrid[e][t-1].elevation-=5,newgrid[e][t+1].elevation-=5}}class wolfCage extends object{constructor(e,t,n,i,s,a,o,l,c,h,d){super(e,t,n,i,s,a,o,l,c,h,d)}break(){this.freeWolf(),super.break()}freeWolf(){let[e,t]=this.pos;newgrid[e][t].addCharacter(new Wolf([e,t]))}}class WargPost extends object{constructor(){super("Post","2022",materials.wood,null,.25,!1,null,null,null,[])}initialize(){super.initialize();let[e,t]=this.pos;this.warg=new Warg([e,t]);for(let n=0;n<1;n++)newgrid[e][t].addCharacter(this.warg);envobjects.push(this)}update(){!0!==this.destroyed&&envobjects.push(this);for(let e=0;e<this.warg.conditions.length;e++){let t=this.warg.conditions[e];if("Restrained"==t.name){t.duration=1;return}}addconditiondynamic(conditions.Restrained,!1,this.warg)()}break(){removecondition(this.warg,"Restrained"),super.break()}}class Spawning_Membrane extends object{constructor(){super("Spawning Membrane","&#x03A9",[.5,.5,.5],null,.5,!1,null,null,null),this.creature=[Goblin_Dagger,Goblin_Shortbow,Ogre,Giant][randomNumber(4)],this.lightsources=[new lightsource(null,[128,8,64],[1,1,1],1)],this.destructable=!0,this.flammable=!0}initialize(){super.initialize();let[e,t]=this.pos;newgrid[e][t].addFluid(new LarvalFluid),newgrid[e][t].addFluid(new LarvalFluid),newgrid[e][t].addFluid(new LarvalFluid),newgrid[e][t].addFluid(new LarvalFluid)}addRemnants(){this.remnants=[new LarvalFluid,new LarvalFluid,new LarvalFluid,new LarvalFluid,new LarvalFluid]}damage(e){this.damageinit=e,this.break()}break(){this.freeCreature(),super.break()}freeCreature(){let[e,t]=this.pos,n=new this.creature([e,t]);n.primaryitem=n.unarmed,n.hp=Math.round(n.hp/(4/3)),Math.random()>.5&&addconditiondynamic(conditions.Bleeding,!0,n)(),newgrid[e][t].addCharacter(n),n.damage(this.damageinit)}}class Spawning_Membrane_Special extends object{constructor(e){super("Spawning Membrane","&#x03A9",[.5,.5,.5],null,.5,!1,null,null,null),this.creature=e,this.lightsources=[new lightsource(null,[128,8,64],[1,1,1],1)],this.destructable=!0,this.flammable=!0}verbose(){return playercs.length>3||!verbose?"":"Break to free ally"}getnewplayercharacter(){let e=[Fugitive,Huntsman,Berserker,Standard_Bearer,Ranger,Sentinel,Maledict,ShieldMaiden,Hellion,Sentinel];for(let t=0;t<e.length;t++)for(let n=0;n<playercs.length;n++)e[t]&&playercs[n]instanceof e[t]&&(e.splice(t,1),t--);return playercs.length>3?Goblin:e.length>2*ngplus?e[2*ngplus]:Prisoner}initialize(){super.initialize();let[e,t]=this.pos;newgrid[e][t].addFluid(new LarvalFluid),newgrid[e][t].addFluid(new LarvalFluid),newgrid[e][t].addFluid(new LarvalFluid),newgrid[e][t].addFluid(new LarvalFluid)}addRemnants(){this.remnants=[new LarvalFluid,new LarvalFluid,new LarvalFluid,new LarvalFluid,new LarvalFluid]}damage(e){this.damageinit=e,this.break()}break(){this.freeCreature(),super.break()}freeCreature(){this.creature||(this.creature=this.getnewplayercharacter());let[e,t]=this.pos,n=new this.creature([e,t]);addconditiondynamic(conditions.Stunned,!0,n)(),newgrid[e][t].addCharacter(n)}}class spikeTrap extends object{constructor(){super("Spike Trap",";",materials.metal),this.destructable=!0,this.hp=2,this.flammable=!0,this.revealed=!1,this.hazards=[1,0]}react(e,t,n){if(super.react(e,t,n),!0!==this.destroyed){let[i,s]=this.pos,a=newgrid[i][s].lightlevel>2,o=!1==this.revealed,l=!0==t.pc,c=1>=chebyshevDistance(t.pos,[i,s]);a&&o&&l&&c&&(this.reveal(),!0==activecharacternonindex.pc&&(activecharacternonindex.actionqueue=[],bufferedinputs=[]));let h=newgrid[i][s].character;null!==h&&(h.damage(roll(3,0)),this.break())}}reveal(){adduilabel("!",this.pos,[256,0,0],0,!0,!1,!1,!1),this.symbol=";",this.absorbtion=materials.metal,this.revealed=!0,this.name="Spike Trap"}initialize(){super.initialize();let[e,t]=this.pos;this.absorbtion=null,this.symbol="",this.name=""}}class Light extends Item{constructor(e,t,n){super(e,t,n)}}class oilLamp extends Light{constructor(){super("Oil Lamp","&#9827",materials.metal),this.lightsources.push(new lightsource(null,[256,256,256],[1,.5,.25],2)),this.destructable=!0,this.flammable=!0}break(){super.break(),this.setFire()}addRemnants(){super.addRemnants();let[e,t]=this.pos;newgrid[e][t];for(let n=0;n<1;n++){let i=new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null);i.destructable=!1,i.burnduration=5,this.remnants.push(i)}}setFire(){let[e,t]=this.pos,n=newgrid[e][t];n.fluids.forEach(e=>e.burn())}explode(){let e=this,[t,n]=this.pos;for(let i=1;i<10;i+=2)newgrid[t][n].addTempSource(new lightsource(this.pos,[256,256,256,],[i,.6*i,.4*i],3),1);for(let s=10;s>1;s-=2)newgrid[t][n].addTempSource(new lightsource(this.pos,[256,256,256,],[s,.6*s,.4*s],3),1);updatetraitspassive(),directions.forEach(function(t){let[n,i]=t.map((t,n)=>t+e.pos[n]),s=newgrid[n][i],a=s.character;s.objects.length>0&&s.objects.forEach(e=>e.damage(10)),rangedanimate(e.pos,[n,i],convertAbstoColor(e.absorbtion)),a&&!0!==a.dead&&a.damage(10)}),adduilabel("*",e.pos,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)}initialize(){super.initialize()}}class Shield extends Item{constructor(){super("Shield","&#x03B8",materials.wood)}}class Torch extends Weapon{constructor(e){super("Torch","|",materials.wood,null,5),this.lit=!0,this.lightsources=[],this.baselightsource=new lightsource([0,0],[256,256,256],[2.5,1.5,1],3),this.updatelight(),e&&(this.fuel=e),this.maxfuel=e,this.removeFuel(0),this.name=`Torch ${this.fuel}`,this.throwable=!0;let t=this;this.specialeffect=function(e,[n,i]){let s=function(){!0===t.lit&&(t.removeFuel(10),newgrid[n][i].objects.length>0&&newgrid[n][i].objects[0].burn())};return e.onhiteffects.push(s),e.onmisseffects.push(s),e},envobjects.push(this)}update(){!0===this.lit&&this.removeFuel(1),this.fuel>0&&envobjects.push(this)}removeFuel(e=1){this.fuel-=e,this.name=`Torch ${this.fuel}`,this.fuel<=0?this.extinguish():this.fuel<100&&(this.baselightsource.lightpref=[1.875,1.135,.75],this.baselightsource.radiance=2,this.updatelight())}updatelight(){!0===this.lit&&(this.lightsources[0]=this.baselightsource),!1===this.lit&&(this.lightsources=[])}extinguish(){this.lightsources=[],this.basename="Spent Torch",this.name=this.basename,this.lit=!1}stow(){!0==this.lit&&(this.removeFuel(5),this.lit=!1),this.updatelight()}drop(){this.removeFuel(5),this.updatelight()}draw(){this.fuel>0&&(this.lit=!0),this.updatelight()}}class Sarcophagus extends object{constructor(){super("Sarcophagus","I",materials.stone,null,.5,!1),this.destructable=!0}break(){let[e,t]=this.pos,n;n=Math.random()>.66?.5>Math.random()?.5>Math.random()?new Longsword:new Battleaxe:new Halberd:Math.random()>.5?.5>Math.random()?new Shortsword:new Athame:Math.random<.5?new Longbow:new Recurve_Bow,newgrid[e][t].addObject(n),super.break()}}class Chest extends object{constructor(){super("Chest","2022",materials.wood,null,.5,!1),this.destructable=!0}break(){let[e,t]=this.pos,n;n=Math.random()>.66?.5>Math.random()?.5>Math.random()?new Longsword:new Battleaxe:new Halberd:Math.random()>.5?.5>Math.random()?new Rapier:new Athame:new Longbow,newgrid[e][t].addObject(n),super.break()}}class Rock extends object{constructor(){super("Rock","2022",materials.stone,null,.25,!1,null,null),this.durability=10,this.destructable=!0}}class Leash extends object{constructor(){super("Rope","*",materials.wood,null,0,!0,null,null),this.durability=10,this.destructable=!0}}class oilBarrel extends object{constructor(){super("Barrel","2022",materials.wood),this.destructable=!0,this.flammable=!0}addRemnants(){super.addRemnants();let[e,t]=this.pos;newgrid[e][t];for(let n=0;n<10;n++){let i=new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null);i.destructable=!1,i.burnduration=5,this.remnants.push(i)}}}class Chair extends object{constructor(){super("Chair","&#X043F",materials.wood,null,.1,!0,2),this.destructable=!0,this.flammable=!0}}class Statue extends object{constructor(){super("Statue","&#X03A9",materials.marble,null,.5,!1)}}class Fortification extends object{constructor(){super("Fortification","#",materials.stone,null,1,!1)}}class WoodWall extends object{constructor(){super("","#",materials.wood,null,1,!1,null,null,[],[]),this.flammable=!0,this.destructable=!0,this.durability=1,this.hp=10,this.burnduration=99}}class Bed extends object{constructor(){super("Bed","0",materials.wood,null,.2,!0,2),this.destructable=!0,this.flammable=!0}}class Wreckage extends object{constructor(e){let t=e.absorbtion,n=e.flammable;super("Wreckage",randomSymbol(["/","\\"]),t,null,0,!0,0),this.flammable=n}}class TallGrass extends object{constructor(){super("Grass","&#x222B",materials.moss,null,.5,!0,1),this.flammable=!0,this.destructable=!0}}class GlowingMushroom extends object{constructor(){super("Mushroom",",",[1,0,1],null,.25,!0,1),this.flammable=!0,this.lightsources.push(new lightsource(this.pos,[64,64,64],[1,.75,1],1))}}class Table extends object{constructor(){super("Table","&#X20B8",materials.wood,null,.2,!0,2),this.destructable=!0,this.flammable=!0}}class Spiderweb extends object{constructor(){super("Spiderweb","*",[.6,.6,.6],null,0,!0,0,null,null,null),this.hazards=[1,0],this.durability=2,this.destructable=!0,this.immovable=!0}react(e,t,n){if(super.react(e,t,n),!0!==this.destroyed){let[i,s]=this.pos,a=newgrid[i][s].character;null!==a&&(addconditiondynamic(conditions.Restrained,!0,a)(),this.break())}}addRemnants(){this.remnants=[]}}class PitTrap extends object{constructor(){super("Pit Trap","*",[.6,.6,.6],null,0,!0,0,null,null,null),this.durability=2,this.hazards=[1,0]}react(e,t,n){if(super.react(e,t,n),!0!==this.destroyed){let[i,s]=this.pos;if(n.target[0]==i&&n.target[1]==s){for(let a=0;a<4;a++){let[o,l]=this.pos.map((e,t)=>e+cardinaldirections[a][t]);newgrid[o]&&newgrid[o][l]&&(newgrid[o][l].elevation=-1)}newgrid[i][s].elevation=-2,elevupdate(),this.break()}}}addRemnants(){this.remnants=[]}initialize(){super.initialize();let[e,t]=this.pos;this.absorbtion=newgrid[e][t].absorbtionBase,this.symbol="",this.name=""}}class PitTrapBig extends object{constructor(){super("Pit Trap","*",[.6,.6,.6],null,0,!0,0,null,null,null),this.durability=2,this.hazards=[1,0]}react(e,t,n){if(super.react(e,t,n),!0!==this.destroyed){let[i,s]=this.pos,[a,o]=this.pos;if(n.target[0]==i&&n.target[1]==s){for(let l=0;l<directionsextra.length;l++){let[c,h]=this.pos.map((e,t)=>e+directionsextra[l][t]);newgrid[c]&&newgrid[c][h]&&(newgrid[c][h].elevation=-2),chebyshevDistance([c,h],[a,o])>1&&(newgrid[c][h].elevation=-1)}newgrid[i][s].elevation=-2,elevupdate(),this.break()}}}addRemnants(){this.remnants=[]}initialize(){super.initialize();let[e,t]=this.pos;this.absorbtion=newgrid[e][t].absorbtionBase,this.symbol="",this.name=""}}class fluid extends object{constructor(e,t,n,i,s,a,o,l,c,h,d){super(e,t,n,i,s,a,o,l,c,h,d)}break(){let[e,t]=this.pos,n=this;newgrid[e][t].fluids=newgrid[e][t].fluids.filter(e=>e.basename!==n.basename),this.destroyed=!0}}class liquid extends fluid{constructor(e,t,n,i,s,a,o,l,c,h,d){super(e,t,n,i,s,a,o,l,c,h,d)}}class oil extends liquid{constructor(e,t,n,i,s,a,o,l,c,h,d){super("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null),this.flammable=!0,this.burnduration=4}burn(){this.burning||this.burnt||(super.burn(),this.spreadfire())}}class Water extends liquid{constructor(){super("Water","~",materials.water,materials.water,0,!0,1,null,null),this.flammable=!1,this.destructable=!1}}class LarvalFluid extends liquid{constructor(){super("Larval Fluid","~",null,[.5,.5,.5],0,!0,1,null,null),this.flammable=!0,this.destructable=!1}}class blood extends liquid{constructor(e,t,n,i,s,a,o,l,c,h,d){super("Blood","",[0,0,0],[.5,.1,.1],0,!0,0),this.destructable=!1,this.flammable=!1}}class Caltrops extends object{constructor(){super("Caltrops","%",materials.metal),this.hazards=[1,0],this.durability=2}react(e,t,n){if(!0!==this.destroyed){let[i,s]=this.pos,a=newgrid[i][s].character;null!==a&&(a.damage(1),this.break())}}addRemnants(){this.remnants=[]}}class gas extends fluid{constructor(e,t,n,i,s,a,o,l,c,h,d){super(e,t,n,i,s,a,o,l,c,h,d),this.thickness=1}addthickness(){this.thickness++,this.thickness>1&&(this.name=`Thick ${this.basename}`)}removeThickness(){if(!this.destroyed){if(this.thickness--,this.thickness<1){let[e,t]=this.pos,n=newgrid[e][t];n.removeFluid(this)}this.thickness<2&&(this.name=this.basename)}}}class smoke extends gas{constructor(){super("Smoke","",[.1,.1,.1],[.2,.2,.2],.3,!0,0,null,null,null),this.flammable=!1}update(){if(super.update(),Math.random()>.75&&this.removeThickness(),!0!==this.destroyed&&envobjects.push(this),this.thickness>1){this.choking=!0,this.hazards=[1,0];let[e,t]=this.pos,n=newgrid[e][t],i=n.character;i&&i.damage(1),Math.random()>.5&&(this.removeThickness(),newgrid[e][t].addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null)))}else this.choking=!1}initialize(){super.initialize(),envobjects.push(this)}removeThickness(){super.removeThickness(),this.thickness<2&&(this.hazards=[0,0],this.choking=!1)}}class AttackRoll{constructor(e,t,n,i,s){this.character=e,this.weapon=i,i instanceof Weapon||(this.weapon=e.unarmed),this.action=s;let a=e.getavdamage(i);i||(i=e.primaryitem);let[o,l]=t,c=0,h=e.getatkbonus(i),d=[],u=[],$=newgrid[o][l].character;$&&$.pc==e.pc&&($=null),(null==$||$.pc==e.pc)&&($=newgrid[o][l].objects[0]);let p=dist(n,t,!1,!0);i.ammotype&&!e.ammunition[i.ammotype]&&u.push(`No ${i.ammotype}s`),i.twohanded&&e.offhanditem&&e.offhanditem.basename!==e.unarmed.basename&&u.push("Need two free hands"),i instanceof Weapon||u.push("Not a Weapon");let m=newgrid[t[0]][t[1]].elevation,f=newgrid[n[0]][n[1]].elevation,_=[t[0],t[1],m],g=[n[0],n[1],f+1],w=drawLine3D(g,_);if(w>=1?u.push("Something in the way"):e.getrange(i)<p&&u.push("Out of range"),$){if(i.versatile&&e.offhanditem&&e.offhanditem.basename==e.unarmed.basename&&e.cantwohand&&(a[1]+=2,d.push("two handed+2max")),1===chebyshevDistance(n,[o,l])){let b=[o,l].map((e,t)=>e-(n[t]-e)),v=newgrid[b[0]][b[1]];v&&v.character&&v.character.pc==e.pc&&v.character!==e&&(d.push("Flanked+10"),c+=2)}!1!=$.pc||$.visiblecharacters&&$.visiblecharacters[e.index]||(d.push("Unaware+50"),c+=10),!0==$.pc&&!1==newgrid[n[0]][n[1]].visible&&(d.push("Unaware+50"),c+=10),i.range>1.9&&w>0&&(w>=.5?(d.push("Three Quarters Cover-25"),c-=5):(d.push("Half Cover-10"),c-=2)),newgrid[o][l].lightlevel<2&&(d.push("Dim Light-10"),c-=2),dist(n,t)<i.minrange&&(d.push("Too Close-25"),c-=5),!1==lackscondition(conditions.Stunned,$)&&(d.push("Stunned+25"),c+=5),!1==lackscondition(conditions.Prone,$)&&(d.push("Prone+25"),c+=5),!1==lackscondition(conditions.Restrained,$)&&(d.push("Restrained+30"),c+=6),!1==lackscondition(conditions.Asleep,$)&&(d.push("Asleep+50"),c+=10),!1==lackscondition(conditions.Surprised,$)&&(d.push("Surprised+10"),c+=2);let k=newgrid[n[0]][n[1]],S=newgrid[o][l],A=k.elevation-S.elevation;A>1&&(d.push("High Ground+10"),c+=2),A<-1&&(d.push("Low Ground-10"),c-=2)}this.defender=$;let C;$&&(C=$.ac);let E=Math.min((1-(C-(h+c))/20)*100,100),z=h+c,q=takeav(a)*(10+z)/20;if(this.pos=n,this.percenthitchance=E,this.damagerange=a,this.avdamageac10=q,this.intrinsmod=h,this.extrinsmod=c,this.defenderac=C,this.modbreakdown=d,this.errors=u,this.onhiteffects=[],this.aftereffects=[],i.onhiteffects&&(this.onhiteffects=i.onhiteffects.slice()),this.onmisseffects=[],i.onmisseffects&&(this.onmisseffects=i.onmisseffects.slice()),!0==i.throwable){let j=this.character,W=function(){if(dist(j.pos,[o,l])>1.9){e.removeItem(i);let t=newgrid[o][l],[s,a]=[o,l],[c,h]=n,[d,u]=[o-c,l-h];for(;!1==t.traversable&&!1==t.slope;)t=newgrid[s][a],Math.abs(d)>0&&(s-=Math.sign(d)),Math.abs(u)>0&&(a-=Math.sign(u));i.number>0?t.addObject(new i.constructor):(i.number=1,t.addObject(i))}};this.onhiteffects.push(W),this.onmisseffects.push(W),p>1.9&&(this.action.internalwarning=!0)}if(!0==i.consumable){let F=()=>e.removeItem(i);this.onhiteffects.push(F),this.onmisseffects.push(F)}if(i.ammotype){let D=[()=>e.removeAmmo(i.ammotype)];this.onhiteffects.push(...D),this.onmisseffects.push(...D)}}}function attackfunc(e=!1,t=null,n){t||(t=this.character.primaryitem);let i=e=>e;if(null!=this.character.specialattack&&(i=this.character.specialattack),!0==e){let s=i(new AttackRoll(this.character,this.target,this.pos,t,this),this.target);return null!=t.specialeffect&&(s=t.specialeffect(s,this.target)),s}let[a,o]=this.target,l=[];newgrid[a][o].character&&newgrid[a][o].character.pc!==this.character.pc&&l.push(newgrid[a][o].character),newgrid[a][o].objects.length&&l.push(newgrid[a][o].objects[0]);let c=0,h=l[0],d=i(new AttackRoll(this.character,this.target,this.pos,t,this),this.target);if(n&&(d=n(d,[a,o])),null!=t.specialeffect&&(d=t.specialeffect(d,this.target)),0!==d.errors.length&&!1==e){for(let u=0;u<d.errors.length;u++)c++,adduilabel(d.errors[u],this.character.pos,[128,128,128],c,!0,!1,!1,!1);return this.character.actionqueue=[],!1}if(0===d.errors.length&&!1==e){let $;if($=!!(100*Math.random()<d.percenthitchance)&&!!h,d.prehitpermute&&d.prehitpermute.length)for(let p=0;p<d.prehitpermute.length;p++){let m=d.prehitpermute[p];[d,$]=m(d,$)}if(rangedanimate(this.character.pos,this.target,convertAbstoColor(t.absorbtion)),$){let f=randomNumber(d.damagerange[1]+1,d.damagerange[0]);for(let _=0;_<d.onhiteffects.length;_++)d.onhiteffects[_](f);c++,h&&h.damage(f);for(let g=0;g<d.aftereffects.length;g++)d.aftereffects[g](f);t.hitsound&&(this.soundeffect=t.hitsound),this.soundcontent="Attack",this.hit=!0,h&&!0==h.dead&&(this.killingblow=!0)}else{c++,this.soundcontent="Miss",t.misssound&&(this.soundeffect=t.misssound);for(let w=0;w<d.onmisseffects.length;w++)d.onmisseffects[w]()}if(!h||!(h instanceof character))return;for(let b=0;b<d.modbreakdown.length;b++){c++;let v=d.modbreakdown[b],k=[128,128,128];for(let S=0;S<v.length;S++)"+"==v.charAt(S)&&(k=[0,64,0]),"-"==v.charAt(S)&&(k=[64,0,0]);v.length>5&&"react"==v.slice(0,5)&&(v=v.slice(5,v.length),k=[32,32,64]),adduilabel(v,[a,o],k,c,!0,!1)}}}class Sound{constructor(e,t,n,i,s){this.pos=e,this.volume=t,this.origin=n,this.content=i||null,this.soundeffect=s}}function updatecharacters(){characters=[...playercs,...nonpcs]}function updatecharactershere(){nonpcshere=[],objectshere=[];for(let e=viewportpos[0]-dontcaredistance;e<=viewportpos[0]+dontcaredistance;e++)for(let t=viewportpos[1]-dontcaredistance;t<=viewportpos[1]+dontcaredistance;t++){if(e<0||e>=mapsizey||t<0||t>=mapsizex)continue;null!==newgrid[e][t].character&&!0!==newgrid[e][t].character.pc&&nonpcshere.push(newgrid[e][t].character);let n=newgrid[e][t].objects;for(let i=0;i<n.length;i++){let s=n[i];objectshere.push(s)}}}function lightcheck(e,t){return function(){let[n,i]=this.character.pos;return!0==e?newgrid[n][i].lightlevel>=t:newgrid[n][i].lightlevel<=t}}function hostileallycheck(){let[e,t]=this.character.pos;for(let n=0;n<nonpcshere.length;n++){let i=nonpcshere[n];if("idle"!==i.state&&1>drawline([e,t],i.pos)&&(e!==i.pos[0]||t!==i.pos[1]))return this.character.target=i.target,console.log(`${this.character.target} is the new target of this character, it should be the same as ${i.target}`),!0}}function hostilecheck(){}function friendlyadjacent(){[y,x]=this.character.pos;for(let e=y-1;e<=y+1;e++)for(let t=x-1;t<=x+1;t++)if(null!==newgrid[e][t].character&&(e!=y||t!=x)&&newgrid[e][t].name==this.character.name)return!0;return!1}function addcondition(e,t){return function(){let n=new condition(e.name,e.starteffect,e.turneffect,e.duration,e.resistance,e.endeffect,this.character);!0==lacksresistance(n,this.character)&&!0==lackscondition(n,this.character)&&(this.character.conditions.push(n),this.character.conditions[this.character.conditions.length-1].starteffect(),t&&adduilabel(n.name,n.character.pos,[128,128,0],1,!0),!0==n.resistance&&this.character.condresists.push(n.name),updateGrid())}}function addconditiondynamic(e,t,n){return function(){if(!(n instanceof character))return;let i=new condition(e.name,e.starteffect,e.turneffect,e.duration,e.resistance,e.endeffect,n);!0==lacksresistance(i,n)&&!0==lackscondition(i,n)&&(n.conditions.push(i),n.conditions[n.conditions.length-1].starteffect(),t&&adduilabel(i.name,i.character.pos,i.character.color,1,!0,!1,!1),!0==i.resistance&&n.condresists.push(i.name))}}function lacksresistance(e,t){for(let n of t.condresists)if(n==e.name)return!1;return!0}function lackscondition(e,t){if(!t.conditions)return!0;for(let n of t.conditions)if(n.name==e.name)return!1;return!0}function skipturn(){let[e,t]=this.character.pos;adduilabel("!",[e,t],[128,128,0],0,!0,!1,!1,!1),this.character.tc=[0,0,0]}function skipturnandyelp(){let[e,t]=this.character.pos;if(adduilabel("!",[e,t],[128,128,0],0,!0,!1,!1,!1),!0!==this.character.pc){let n=new action("Huh?",chatfunc,[0,0,1],0,this.character.pos,this.character,this.character.pos,null,soundeffects.goblinyelp);n.loudness=15,this.character.actionqueue.push(n),move(this.character)}this.character.tc=[0,0,0]}function moralecheck(e,t,n,i){if(i||!n)return;let[s,a]=n.target;if("Attack"==n.name){let o=1;t.pc==e.pc?o=-3:!0==n.hit&&e.moraledamage(1*o)}"Die"==n.name&&t.pc==e.pc&&e.moraledamage(5)}function losemove(){let[e,t]=this.character.pos;adduilabel("+",[e,t],[128,128,0],0,!0,!1,!1,!1),this.character.tc[0]=0,this.character.tc[2]=0,this.character.actionqueue=[]}function takedamage(e=1){return function(){this.character.damage(e)}}function damagebonus(e){return function(){this.character.damagebonus+=e,console.log(`damage bonus of ${this.character.damagebonus}`)}}function tohitbonus(e){return function(){this.character.tohitbonus+=e}}function becomehostile(){let e=null;for(let t=0;t<playercs.length;t++)!1!==drawline(this.character.pos,playercs[t].pos)&&!1==playercs[t].dead&&(null==e?e=playercs[t]:dist(this.character.pos,playercs[t].pos)<dist(this.character.pos,e.pos)&&(e=playercs[t]));null!=e&&(this.character.target=e.pos.slice(),this.character.state,this.character.state)}function becomehostilelowesthp(){let e=null;for(let t=0;t<playercs.length;t++)!1!==drawline(this.character.pos,playercs[t].pos)&&!1==playercs[t].dead&&(null==e?e=playercs[t]:playercs[t].hp<e.hp&&(e=playercs[t]));null!=e&&(this.character.target=e.pos.slice(),this.character.state,"agro"!=this.character.state&&(this.character.state="agro"))}function movefunc(e=!1){let t=this.character,n=newgrid[t.pos[0]][t.pos[1]],[i,s]=this.target,a=newgrid[i][s].elevation-n.elevation;if(!1!==newgrid[i][s].traversable&&null==newgrid[i][s].character){if(a<=1&&(newgrid[t.pos[0]][t.pos[1]].character=null,t.pos=[i,s],newgrid[i][s].character=this.character,e||removecondition(t,"Prone"),a<-1)){let o=0,l=Math.floor(a/2)**2;for(let c=0;c<l;c++)o+=randomNumber(3,1);this.soundeffect=soundeffects.deepthud,this.loudness=5,addconditiondynamic(conditions.Prone,!0,t)(),this.character.damage(o)}return}if(!1!==newgrid[i][s].traversable&&null!==newgrid[i][s].character&&a<-1){if(newgrid[t.pos[0]][t.pos[1]].character=null,t.pos=[i,s],newgrid[i][s].addCharacter(this.character),removecondition(t,"Prone"),a<-1){let h=0,d=Math.floor(a/2)**2;for(let u=0;u<d;u++)h+=randomNumber(3,1);this.soundeffect=soundeffects.deepthud,this.loudness=10,addconditiondynamic(conditions.Prone,!0,t)(),this.character.damage(h),newgrid[i][s].character.damage(h)}return}return t.actionqueue=[],!1}function endturnfunc(){this.character.tc[0]=0,this.character.tc[1]=0}function digfunc(){let[e,t]=this.target;newgrid[e][t]=new Tile(...tiletypes.RoughStoneFloor,[e,t]),Math.random()>.95&&newgrid[e][t].addCharacter(new Dwarf([e,t]))}function chatfunc(){}function switchweapon(){char=this.character;let e=char.primaryitem;char.primaryitem=char.secondaryitem,char.secondaryitem=e,e.stow(),char.primaryitem.draw(),adduilabel(char.primaryitem.name,char.pos,char.color,1,!0,!1),char.primaryitem.drawsound&&(this.soundeffect=char.primaryitem.drawsound),this.loudness=1}function switchweaponalt(){char=this.character;let e=char.offhanditem;if(char.offhanditem=char.primaryitem,char.primaryitem=e,adduilabel(char.primaryitem.name,char.pos,char.color,1,!0,!1),char.primaryitem.drawsound&&(this.soundeffect=char.primaryitem.drawsound),this.loudness=1,char.offhanditem.number>1){let t=new char.offhanditem.constructor;char.offhanditem.number--,char.drop("offhanditem"),char.offhanditem=t}}function getfunc(){char=this.character;let e=newgrid[char.pos[0]][char.pos[1]].objects.shift();e.drawsound&&(this.soundeffect=e.drawsound),char.addItem(e)}function leavefunc(){let e=this.character;e.drop()}function leavefuncoffhand(){let e=this.character;e.dropoffhand()}function darkattackpermute(e){let t=e;for(let n=0;n<e.modbreakdown.length;n++)"Dim Light-10"==e.modbreakdown[n]&&(t.extrinsmod+=4,t.percenthitchance+=20,e.modbreakdown[n]="Dim Light+10",t.avdamageac10=takeav(t.damagerange)*((10+(t.intrinsmod+t.extrinsmod))/20));return t}function sneakattackpermute(e){return 1!==e.weapon.stat?(verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Sneak attack requires finnesse weapon"),e):!0!==e.weapon.throwable&&e.weapon.range>1.9?(verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Sneak attack requires melee or thrown weapon"),e):e.character.offhanditem&&e.character.offhanditem.basename!==e.character.unarmed.basename?(verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Sneak attack requires free offhand"),e):(e.damagerange=e.damagerange.map(t=>t+Math.max(0,e.extrinsmod)),e.extrinsmod>0&&(e.modbreakdown.push(`Sneak Attack+${e.extrinsmod}dmg`),e.action.loudness=3),e)}function torchbearerpermute(e){let t=e.character,n=t.offhanditem,i=e.weapon;return n.lightsources.length>0&&!0==i.versatile||i.lightsources.length>0?(e.damagerange[1]+=1,e.modbreakdown.push("Torchbearer+1max"),e):0==n.lightsources.length?(verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Torchbearer requires lightsource"),e):(!0!==i.versatile&&verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Torchbearer requires versatile"),e)}function shoveattackpermute(e,t){let n=e.character.stats[0],i=Math.max(n,1),s=function(n){if(n<=0)return;let[s,a]=t,o=newgrid[s][a].character,l=e.pos.slice(),c=t.map((e,t)=>l[t]-e);if(c=c.map((e,t)=>Math.sign(e)),o)for(let h=0;h<i;h++){let d=o.pos.map((e,t)=>e-c[t]);for(;!0==newgrid[d[0]][d[1]].slope;)c=newgrid[d[0]][d[1]].delta,d=d.map((e,t)=>e-c[t]);o.actionqueue.unshift(new Fall(d,o,t)),move(o)}else(obj=newgrid[s][a].objects[0])&&!obj.immovable&&obj.move(c)};return e.modbreakdown.push(`Shove(${i})`),e.onhiteffects.push(s),e}function kickattackpermute(e,t){let n=e.character,i=function(){let[n,i]=t,s=newgrid[n][i].character,a=e.pos.slice(),o=t.map((e,t)=>a[t]-e);if(o=o.map((e,t)=>Math.sign(e)),s)for(let l=0;l<Math.max(e.character.stats[0],1);l++){let c=s.pos.map((e,t)=>e-o[t]);for(;!0==newgrid[c[0]][c[1]].slope;)o=newgrid[c[0]][c[1]].delta,c=c.map((e,t)=>e-o[t]);s.actionqueue.unshift(new Fall(c,s,t)),move(s)}else(obj=newgrid[n][i].objects[0])&&!obj.immovable&&obj.move(o)},s=function(e,i){let[s,a]=t;return newgrid[s][a].character&&newgrid[s][a].character==n?[e,i]:newgrid[s][a].character&&newgrid[s][a].character.pc==n.pc?[e,!0]:[e,i]};return e.damagerange=[0,0],e.onhiteffects.push(i),e.prehitpermute||(e.prehitpermute=[]),e.prehitpermute.push(s),e}function reloadfunc(e,t){let n=this.character;this.target,this.pos,t||(t=n.primaryitem);let i=this;if(e){let s=attackfunc.bind(i),a=s(e,t);return a}if(!0!==t.reloading){let o=attackfunc.bind(i),l=o(e,t);return l}return i.soundeffect=soundeffects.bowdraw,i.target=i.character.pos.slice(),t.reloaded=!0,adduilabel("Reload",n.pos,n.color,1,!0,!1,!1,!0),n.updateAmmo(),!0}function dualwieldpermute(e,t){let[n,i]=t;if(!newgrid[n][i].character||newgrid[n][i].character.pc==e.character.pc||e.action.cost[1]<1)return e;let s=e.character,a=e.weapon,o=e.character.offhanditem,[l,c]=e.character.pos;if(o instanceof Weapon&&!(o instanceof Unarmed)&&a instanceof Weapon&&!(a instanceof Unarmed)&&!0==o.light){let h=new Offhandattack(t,s,e.pos),d=t.slice(),u=findtarget(s,o,t,h,[l,c]);u[0]&&(d=u[0]),h.target=d;let $=function(){let n=new Offhandattack(t,s,e.character.pos),i=t.slice(),a=findtarget(s,o,t,n,[l,c]);a[0]&&(i=a[0]),n.target=i;0==n.func(!0).errors.length&&e.character.actionqueue.unshift(n)},p=h.func(!0);e.aftereffects.push($),e.onmisseffects.push($),0==p.errors.length&&(e.avdamageac10+=p.avdamageac10,e.modbreakdown.push("Offhand Attack"))}return e}function dualwieldpluspermute(e,t){if(e.action.cost[1]<1&&!e.action.specialtag)return e;let n=!0;(e.action.specialtag||!0!==e.weapon.light)&&(n=!1);let i=e.character,s=e.weapon,a=e.character.offhanditem,[o,l]=e.character.pos;if(a instanceof Weapon&&!(a instanceof Unarmed)&&s instanceof Weapon&&!(s instanceof Unarmed)&&!0==a.light){let c=new Offhandattack(t,i,e.pos),h=t.slice(),d=findtarget(i,a,t,c,[o,l]);d[0]&&(h=d[0]),c.target=h;let u=function(){let s=new Offhandattack(t,i,e.pos),c=t.slice(),h=findtarget(i,a,t,s,[o,l]);h[0]&&(c=h[0]),s.target=c;let d=s.func(!0);!0==n&&(s.specialtag=!0),0==d.errors.length&&e.character.actionqueue.unshift(s)},$=c.func(!0);e.aftereffects.push(u),e.onmisseffects.push(u),0==$.errors.length&&(e.avdamageac10+=$.avdamageac10,e.modbreakdown.push("Offhand Attack"))}return e}function cleaveattack(e,t){let[n,i]=t;if(!newgrid[n][i].character||newgrid[n][i].character.pc==e.character.pc||e.action.cost[1]<1&&e.action.specialtag)return e;let s=e.character,a=e.weapon,[o,l]=e.character.pos,c=[],h=new Attack("Attack",attackfunc,[0,0,0],a.range,t,s,[o,l]);h.specialtag=!0,c=findtarget(s,a,void 0,h,[o,l]);for(let d=0;d<c.length;d++){let[u,$]=c[d];u==t[0]&&$==t[1]&&(c.splice(d,1),d--)}let p=function(){let n=e.character,i=e.weapon,[s,a]=e.character.pos,o=[],l=new Attack("Attack",attackfunc,[0,0,0],i.range,t,n,[s,a]);l.specialtag=!0,o=findtarget(n,i,void 0,l,[s,a]);for(let c=0;c<o.length;c++){let[h,d]=o[c];h==t[0]&&d==t[1]&&(o.splice(c,1),c--),chebyshevDistance([h,d],t)>1&&(o.splice(c,1),c--)}for([ly,lx]of o){let u=new Attack("Attack",attackfunc,[0,0,0],i.range,[ly,lx],n,[s,a]);u.specialtag=!0,e.character.actionqueue.unshift(u)}};if(e.action.specialtag)e.modbreakdown=[];else if(e.aftereffects.push(p),e.onmisseffects.push(p),c.length>0){for(let m=0;m<c.length;m++){let f=c[m],_=new Attack("Attack",attackfunc,[0,0,0],1.9,f,e.character,e.action.pos);_.specialtag=!0;let g=_.func(!0);0==g.errors.length&&(e.avdamageac10+=g.avdamageac10)}e.modbreakdown.push(`${c.length+1}targets`)}return e}function extraattack(e,t){let[n,i]=t;if(e.action.cost[1]<1)return e;let s=e.character,a=e.weapon,[o,l]=e.character.pos.slice();if((!newgrid[n][i].character||newgrid[n][i].character.pc==e.character.pc)&&!1!==a.reloaded)return e;let c=new Attack("Attack",attackfunc,[0,0,0],a.range,t,e.character,e.character.pos),h=findtarget(s,a,t,c),d=t.slice();h[0]&&(d=h[0]),c.target=d.slice();let u=function(){let n=e.character,i=e.weapon,[s,a]=e.character.pos.slice(),o=new Attack("Attack",attackfunc,[0,0,0],i.range,t,n,[s,a]),l=findtarget(n,i,t,o),c=t.slice();l[0]&&(c=l[0]),o.target=c.slice();0==o.func(!0).errors.length&&e.character.actionqueue.unshift(o)};return e.aftereffects.push(u),e.onmisseffects.push(u),e.modbreakdown.push("Extra Attack"),e}function inciteattack(e,t){let n=e.character,i=function(){n.actionqueue.unshift(new action("Warcry",warcry,[0,0,0],0,n.pos,n,n.pos))};return e.onhiteffects.push(i),e}function warcry(){let e=this.character,t=getsquare(e.pos,10),n=gettiles(t),i=[];for(let s=0;s<n.length;s++){let a=n[s];!(dist(e.pos,a.pos)>10)&&a.character&&a.character.pc==e.pc&&i.push(a.character)}adduilabel("Warcry",e.pos,e.color,1,!0,!1,!1,!0);for(let o=0;o<i.length;o++){let l=i[o];if(l==e)continue;let c=new action("Incite",incite,[0,0,0],10,l.pos,e,e.pos);e.actionqueue.unshift(c)}}function incite(){let[e,t]=this.target,n=this.character,i=newgrid[e][t].character;if(!(i.tc[2]<1)&&(adduilabel("*",i.pos,n.color,0,!0,!1,!1,!1),i&&i.pc==n.pc)){let s=findtarget(i);if(s.length>0){let a=new Attack("Attack",attackfunc,[0,0,1],i.getrange(),s[0],i,i.pos);0==a.func(!0).errors.length&&canAffordAction(a,i)&&(i.actionqueue=[a],move(i))}}}function findtarget(e,t,n,i,s){void 0===t&&(t=e.primaryitem);let a=t.range,o=Math.ceil(a);void 0===s&&(s=e.pos);let[l,c]=s.slice(),h=[l,c],d=[];n&&(h=n.slice());let u=newgrid[h[0]][h[1]].character,$=new Attack("Attack",attackfunc,[0,1,0],a,h,e,[l,c]);void 0!==i&&($=i);let p=$.func(!0),m=p.avdamageac10;if(u&&u.pc!=e.pc&&!(p.errors.length>0))return[n];m=0;for(let f=l-o;f<=l+o;f++)if(!(f<0)&&!(f>=mapsizey))for(let _=c-o;_<=c+o;_++){if(_<0||_>=mapsizex)continue;let g=newgrid[f][_].character;if(!g||g.pc==e.pc)continue;$.target=[f,_];let w=$.func(!0,t);0==w.errors.length&&d.push([[f,_],w.avdamageac10])}d.sort((e,t)=>t[1]-e[1]);for(let b=0;b<d.length;b++)d[b]=d[b][0];return d}function chargeattackpermute(e,t){if(!0==e.weapon.ranged||e.action.cost[1]<1||1!==e.errors.length||"Out of range"!==e.errors[0])return e;let n=e.action.character,[i,s]=e.action.pos,[a,o]=n.pos;if(i!==a||s!==o)return e;let l=2*e.action.character.tcmax[0]+2;if(dist(e.action.pos,t)>l)return e;let c=bresenhamLine(e.action.pos,t),h=!1,d=0,u=2*e.character.tc[0];for(let $=1;$<c.length-1;$++){let[p,m]=c[$];if(d++,!1==newgrid[p][m].traversable||null!==newgrid[p][m].character||isNaN(d)||d>u)break;$==c.length-2&&(h=!0)}if(c.length<6&&(h=!1),!1==h)return e;if(1==e.errors.length&&"Out of range"==e.errors[0]){e.errors=[];let f=function(n,i){let[s,a]=e.character.pos,[o,l]=t,h=!0;for(;1!==chebyshevDistance([s,a],t);){if(0==c.length){h=!1;break}let[d,u]=c.shift(),$=new Move("Move",movefunc,[0,0,0],1,[d,u],e.action.character,e.action.character.pos);$.reactable=!1,$.cost[0]=0,e.character.actionqueue=[$],move(e.character),[s,a]=e.character.pos.slice()}return!0!==h?(console.log("we failed somewhere"),[n,!1]):(e.action.character.tc[0]=0,[n,i])};e.prehitpermute||(e.prehitpermute=[]),e.prehitpermute.push(f)}return c.length<6&&(e.action.internalwarning=!0),e.modbreakdown.push("Charge+2dmg"),e.damagerange[0]+=2,e.damagerange[1]+=2,e}function jumpattack(e,t){let n=1==e.errors.length&&"Out of range"==e.errors[0],i=!0==e.weapon.throwable&&dist(e.action.pos,t)>1.9;if(n||i&&(0==e.errors.length||n)){let s=e.character,a=Math.max(e.character.stats[0],2),o=getsquare(e.action.pos,a);for(let l=o.length-1;l>=0;l--){let c=o[l];(dist(e.action.pos,c)>a||!1==newgrid[c[0]][c[1]].traversable||null!==newgrid[c[0]][c[1]].character)&&o.splice(l,1)}let h=gettiles(o),d,u=99,$=bresenhamLine(e.action.pos,t),[p,m]=$[$.length-2];for(let f=0;f<h.length;f++){let _=h[f],[g,w]=_.pos;if(g==p&&w==m){d=_;break}let b=dist(_.pos,t);!(b<1)&&b<u&&(d=_,u=b)}if(1>=chebyshevDistance(d.pos,t)&&dist(e.action.pos,d.pos)<=a){i&&(e.action.internalwarning=!1),e.errors=[],e.modbreakdown.push("Jump attack");let v=function(e,t){let n=new Jump(a,d.pos,s,s.pos);return n.cost=[0,0,0],s.actionqueue=[n],move(s),[e,t]};e.prehitpermute||(e.prehitpermute=[]),e.prehitpermute.push(v)}}return e}function disengagepermute(e,t){if(e.action.cost[1]<1&&!0!==e.action.specialdisengagetag)return e;let n=function(){let n=e.character,[i,s]=n.pos,[a,o]=t;if(!newgrid[a][o].character||newgrid[a][o].character.pc==e.character.pc||chebyshevDistance([i,s],[a,o])>1)return;let[l,c]=[a-i,o-s],[h,d]=[i-l,s-c];if(!newgrid[h]||!newgrid[h][d])return;newgrid[h][d];let u=Math.min(Math.max(n.stats[1],1),3),$=[];for(let p=0;p<u;p++){let m=new Move("Move",movefunc,[0,0,0],1.9,[h,d],n,[i,s]);m.func=function(){let e=movefunc.bind(m),t=e();return!1!==t&&(n.tc[0]+=1),t},m.reactable=!1,m.cost=[0,0,0],$.unshift(m),h-=l,d-=c}for(let f=0;f<u;f++)n.actionqueue.unshift($[f])};return e.onhiteffects.push(n),e.onmisseffects.push(n),e}function sharpshooterpermute(e){return e.weapon.range>1.9&&!0==e.weapon.ranged&&!e.weapon.throwable&&(e.modbreakdown.some(e=>"Half Cover-10"==e||"Three Quarters Cover-25"==e)?verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Clear Shot requires no cover"):(e.extrinsmod+=3,e.percenthitchance+=15,e.percenthitchange=Math.min(e.percenthitchance,100),e.damagerange=e.damagerange.map(e=>e+2),e.avdamageac10+=1,e.modbreakdown.push("Clear Shot+15+2dmg"))),e}function savageattack(e,t){let n=!1,i=e.character;(e.weapon.twohanded||e.weapon.versatile)&&i.offhanditem.basename==i.unarmed.basename&&0==e.weapon.stat?(n=!0,e.percenthitchance+=e.damagerange[1],e.percenthitchance=Math.min(e.percenthitchance,100),e.modbreakdown.push(`Savage Attack+${e.damagerange[1]}`)):verbose&&e.modbreakdown.push("Savage Attack Requires Two-Handed Weapon");let s=newgrid[t[0]][t[1]].character,a=function(t){s&&s.hp<=t&&(e.character.tc[0]+=2)};return n&&e.onhiteffects.push(a),e}function bloodattack(e,t){if(e.action.cost[1]<1)return e;if(!0!==e.weapon.bleed)return verbose&&e.modbreakdown.push("Exsanguinate requires bleed weapon"),e;let[n,i]=t,s=newgrid[n][i].character;if(!s)return e;let a=function(t){for(let a=0;a<3;a++)s.bleed();let o=[[n,i]];for(let l=0;l<o.length;l++){let[c,h]=o[l];for(let d=0;d<8;d++){let[u,$]=directions[d],[p,m]=[c+u,h+$],f=!1,_;if(newgrid[p][m].fluids.length>0)for(let g=0;g<newgrid[p][m].fluids.length;g++){let w=newgrid[p][m].fluids[g];"Blood"==w.name&&!0!=w.electrified&&(f=!0,_=newgrid[p][m].fluids[g])}f&&(o.push([p,m]),_.electrified=!0)}}for(let b=0;b<o.length;b++){let[v,k]=o[b],S=newgrid[v][k];for(let A=0;A<S.fluids.length;A++)S.fluids[A].electrified&&(S.fluids[A].electrified=!1);if(S.character&&S.character.pc!==e.character.pc&&S.character!=s){let C=Math.ceil(t/2);S.character.damage(C),addconditiondynamic(conditions.Bleeding,!0,S.character)(),adduilabel("*",S.pos,e.character.color,0,!0,!0,!1,!1)}}};return e.modbreakdown.push("Exsanguinate"),e.onhiteffects.push(a),e}function shieldbash(e,t){let n=e.action.character,[i,s]=t,a=e.weapon;if(!(n.offhanditem instanceof Shield)||chebyshevDistance(e.action.pos,t)>1)return e;if(0==a.stat){let o=advanceattack.bind(e.action);return o(e,t)}if(1==a.stat){let l=feintattack.bind(e.action);return l(e,t)}return e}function advanceattack(e,t){let n=e.action.character,i=n.stats[0],s=newgrid[t[0]][t[1]].character;if(!s)return e;e.modbreakdown.push(`Advance(${i})`);let a=function(){for(let e=0;e<i;e++){let[t,a]=n.pos,[o,l]=s.pos,[c,h]=[o-t,l-a],[d,u]=[o+c,l+h],$=new Fall([d,u],s,[o,l]);s.actionqueue=[$],move(s);let p=new Move("Move",movefunc,[0,0,0],1.9,[o,l],n,[t,a]);p.cost=[0,0,0],p.reactable=!1,n.actionqueue=[p],n.actionqueue.unshift(p),move(n)}};return e.onhiteffects.push(a),e}function feintattack(e,t){let n=e.action.character,i=n.stats[1],s=newgrid[t[0]][t[1]],a=s.character,o=newgrid[n.pos[0]][n.pos[1]];if(!a)return e;e.modbreakdown.push(`Feint(${i})`);let l=function(){o.character=a,a.pos=o.pos.slice(),s.character=n,n.pos=s.pos.slice();for(let e=0;e<i;e++){let[t,l]=n.pos,[c,h]=a.pos,[d,u]=[c-t,h-l],[$,p]=[c+d,h+u],m=new Fall([$,p],a,[c,h]);a.actionqueue=[m],move(a);let f=new Move("Move",movefunc,[0,0,0],1.9,[c,h],n,[t,l]);f.cost=[0,0,0],f.reactable=!1,n.actionqueue=[f],n.actionqueue.unshift(f),move(n)}};return e.onhiteffects.push(l),e}function forcemove(){}function rangedanimate([e,t],[n,i],s){let a=linecharacter([e,t],[n,i]),o=bresenhamLine([e,t],[n,i]);o.shift(),addanimation(o,[a],s)}function linecharacter([e,t],[n,i]){let s=Math.abs(t-i),a=Math.abs(e-n);return symbol=s>2*a?"-":a>2*s?"|":Math.sign(t-i)==Math.sign(e-n)?"\\":"/"}function linecharacterdiagonalpreference([e,t],[n,i]){let s=Math.abs(t-i),a=Math.abs(e-n);return symbol=s==2*a?"-":a==2*s?"|":Math.sign(t-i)==Math.sign(e-n)?"\\":"/"}function conditionattackpermute(e){return function(t,[n,i]){return(target=newgrid[n][i].character)&&t.onhiteffects.push(function(t){!(t<=0)&&addconditiondynamic(e,!0,target)()}),t}}function grenadeattack(){let[e,t]=this.target,n=Math.floor(1);for(let i=e-n;i<=e+n;i++)for(let s=t-n;s<=t+n;s++)null!==newgrid[i][s].character&&newgrid[i][s].character.pc!==this.character.pc&&newgrid[i][s].character.damage(10)}function restfunc(){let e=this.character,[t,n]=e.pos;!0===e.pc&&(addconditiondynamic(conditions.Resting,!0,e)(),restcheck(),!0==e.pc&&(e.actionqueue=[],playerendturn()))}function dashfunc(){let e=this.character;e.tc[0]+=e.tcmax[0];let[t,n]=e.pos;adduilabel("Dash",e.pos,e.color,1,!0)}function standgroundfunc(){let e=this.character;e.tc[1]+=e.tcmax[1];let[t,n]=e.pos;adduilabel("Stand Ground",e.pos,e.color,1,!0)}function checkforaoomove([e,t],[n,i],s){for(let a=e-1;a<=e+1;a++)for(let o=t-1;o<=t+1;o++)if(newgrid[a][o]&&newgrid[a][o].character&&newgrid[a][o].character.pc!==s.pc&&dist([n,i],[a,o])>1.8&&newgrid[a][o].character.tc[2]>0)return!0;return!1}function checkforaooattack([e,t],[n,i],s){for(let a=e-1;a<=e+1;a++)for(let o=t-1;o<=t+1;o++)if(newgrid[a][o]&&newgrid[a][o].character&&newgrid[a][o].character.pc!==s.pc&&dist([e,t],[n,i])>1.8&&newgrid[a][o].character.tc[2]>0)return!0;return!1}function startoverwatch(){let e=this.character;if(e.tc[2]<1)return!1;e.tc[0]=0,e.tc[1]=0,addconditiondynamic(conditions.Overwatch,!0,e)(),this.soundeffect=this.character.primaryitem.drawsound}function overwatch(e,t,n,i){if(i||lackscondition(conditions.Overwatch,e)||!t||t.pc==e.pc)return;let s=e,[a,o]=s.pos,l=s.getrange(),[c,h]=t.pos,d=newgrid[c][h].character;if(null!==d&&d.pc!==s.pc&&!0==newgrid[c][h].visible){let u=actions.Attack,$=new Attack(...u,l,[c,h],s,s.pos);if($.cost=[0,0,1],$.func(!0).errors.length>0)return;canAffordAction($,s)&&(removecondition(e,"Overwatch"),s.actionqueue.push($),move(s)),canAffordAction($,s);return}}function ambush(e,t,n,i){if(!i||!indarkness||!n||"Attack"!=n.name||!(t.pc!==e.pc))return;console.log(e.tc);let s=e,[a,o]=s.pos,l=s.getrange(),[c,h]=t.pos,d=newgrid[c][h].character;if(null!==d&&d.pc!==s.pc&&!0==newgrid[c][h].visible){let u=actions.Attack,$=new Attack(...u,l,[c,h],s,s.pos);if($.cost=[0,0,1],$.func(!0).errors.length>0)return;canAffordAction($,s)&&(adduilabel("Ambush",s.pos,s.color,1,!0,!1,!1,!0),s.actionqueue.push($),move(s)),canAffordAction($,s);return}}function indarkness(){return!0}function removecondition(e,t){for(let n=e.conditions.length-1;n>=0;n--)e.conditions[n].name==t&&e.conditions.splice(n,1)}function open(){let[e,t]=this.target,n=newgrid[e][t].objects[0];if(n.open){if(!1===n.open())return adduilabel("Locked",this.character.pos,this.character.color,1,!0,!1),!1;adduilabel("Open",this.character.pos,this.character.color,1,!0,!1),newgrid[e][t].updateObjects()}}function interact(){let[e,t]=this.target,n=newgrid[e][t].objects[0];n.interact(this.character)}function canAffordAction(e,t){return!t.tc.some((t,n)=>t<e.cost[n])}function burn(){let e=this.character;e.damage(1)}function objectburn(e){let[t,n]=e.pos,i=newgrid[t][n].character;null!==i&&addconditiondynamic(conditions.Burning,!0,i)()}function generatehuntmap(e,t,n=5){class i{constructor(e,t,n){this.pos=e.slice(),this.parent=t,this.utility=n}}let[s,a]=e,o=new PriorityQueue((e,t)=>t.utility-e.utility);o.enqueue(new i([s,a],null,30));let l={},c=0,h=0;for(;!o.isEmpty()&&h<5e3;){h++;let d=o.dequeue();c=Math.abs(d.utility-10);let u=d.pos,[$,p]=u;l[$]||(l[$]={}),!l[$][p]&&(l[$][p]=d.utility,directions.forEach(function(n){let s=u.map((e,t)=>e+n[t]);if(newgrid[s[0]]&&void 0!==newgrid[s[0]][s[1]]){let a=newgrid[s[0]][s[1]],c=a.moveCost;t.knowntiles[`${s[0]},${s[1]}`]&&(t.knowntiles[`${s[0]},${s[1]}`],chebyshevDistance(s,e)>1&&(c+=10)),!0==a.traversable?o.enqueue(new i(a.pos,d,d.utility-c)):(l[s[0]]||(l[s[0]]={}),l[s[0]][s[1]]||(l[s[0]][s[1]]=-100))}else l[s[0]]||(l[s[0]]={}),l[s[0]][s[1]]||(l[s[0]][s[1]]=-100)}))}return l}function updatehuntmap(e,t){t.visibletiles.forEach(function(t){let[n,i]=t.pos;newgrid[n][i].traversable&&e[n]&&void 0!==e[n][i]&&(e[n][i]=0)})}function generatefleemap(e,t,n){class i{constructor(e,t,n){this.pos=e.slice(),this.parent=t,this.distance=n}}let s=new PriorityQueue((e,t)=>e.distance-t.distance);Object.values(e).forEach(function(e){let t=new i(e.lastseen,null,0);s.enqueue(t)});let a={};for(;!s.isEmpty()&&!((thisnode=s.dequeue()).distance>n);){let o=thisnode.pos,[l,c]=o;void 0===a[`${l},${c}`]&&(directions.forEach(function(e){let t=o.map((t,n)=>t+e[n]);if(newgrid[t[0]]&&newgrid[t[0]][t[1]]){let n=newgrid[t[0]][t[1]];if(!0==n.traversable&&void 0===a[`${t[0]},${t[1]}`]){let l=new i(t,thisnode,thisnode.distance+n.moveCost+.1*Math.random());s.enqueue(l)}}}),a[`${l},${c}`]=thisnode.distance)}return a}function moveusecase(e,t,n){e.tc[0],e.tc[1];let i=[],[s,a]=e.pos;for(let o=0;o<8;o++){let[l,c]=directions[o],[h,d]=[s+l,a+c],u;if(!newgrid[h]||!newgrid[h][d]||null!==(u=newgrid[h][d]).character)continue;let $=newgrid[s][a].elevation-newgrid[h][d].elevation;if(Math.abs($)>1)continue;if(newgrid[h][d].objects.length>0&&null!=newgrid[h][d].objects[0].action){let p=newgrid[h][d].objects[0],m=p.action,f=new action(...m,[h,d],t,e.pos);if("Open"==f.name&&!p.locked){let _=new ActionNode(e.pos,f,e.tc.slice(),e.hazards,e.damagepotential,e,n),g=new Move("Move",movefunc,[1,0,0],1,[h,d],t,e.pos),w=subtractcost(g,e.tc),b=g.warnings.length;i.push(new ActionNode([h,d],g,w,e.hazards+b,e.damagepotential,_,n))}continue}if(!newgrid[h][d].traversable)continue;let v=new Move("Move",movefunc,[1,0,0],null,[h,d],t,e.pos),k=subtractcost(v,e.tc),S=v.warnings.length;i.push(new ActionNode([h,d],v,k,e.hazards+S,e.damagepotential,e,n))}return i}function digusecase(e,t,n){e.tc[0],e.tc[1];let i=[],[s,a]=e.pos;for(let o=0;o<directions.length;o++){let[l,c]=e.pos.map((e,t)=>e+directions[o][t]);if(newgrid[l]&&newgrid[l][c]&&!1==newgrid[l][c].traversable){let h=new action("Dig",digfunc,[0,1,0,0],1.9,[l,c],t,[s,a]),d=subtractcost(h,e.tc),u=new ActionNode([s,a],h,d,[],0,e,n);i.push(u)}}return i}function stompusecase(e,t,n){let i=e.tc[0];e.tc[1];let s=[],[a,o]=e.pos;if(i>0){for(let l=a-1;l<=a+1;l++)if(newgrid[l])for(let c=o-1;c<=o+1;c++){if(!newgrid[l][c]||!0!==newgrid[l][c].traversable||null!==newgrid[l][c].character||c==o&&l==a)continue;let h=new Move("Move",movefunc,[1,0,0],null,[l,c],t,e.pos);h.loudness=20;let d=subtractcost(h,e.tc),u=h.warnings.length;!d.some(e=>e<0,d)&&s.push(new ActionNode([l,c],h,d,e.hazards+u,e.damagepotential,e,n))}}return s}function alertusecase(e,t,n){e.tc[0];let i=e.tc[1],s=[],[a,o]=e.pos,l=new action("Alert",chatfunc,[0,1,0],0,e.pos,t,e.pos,[],soundeffects.goblinyelp);l.loudness=20;let c=new ActionNode(e.pos,l,subtractcost(l,e.tc),e.hazards,e.damagepotential,e,n);return i>=1&&s.push(c),s}function chatusecase(e,t,n){e.tc[0];let i=e.tc[1],s=[],[a,o]=e.pos,l=new action("Chat",chatfunc,[0,1,0],0,e.pos,t,e.pos,[],soundeffects.goblinchat);l.loudness=20;let c=new ActionNode(e.pos,l,subtractcost(l,e.tc),e.hazards,e.damagepotential,e,n);return i>=1&&s.push(c),s}function attackusecase(e,t,n){e.tc[0],e.tc[1];let i=e.activeweapon,s=[],[a,o]=e.pos;if(!t.knownenemies||0==t.knownenemies.length)return s;for(let l=0;l<t.knownenemies.length;l++){let c=t.knownenemies[l],h=c.character,d=c.lastseen,[u,$]=e.pos,p=newgrid[u][$].elevation,[m,f]=d,_=newgrid[m][f].elevation;if(1>drawLine3D([u,$,p+1],[m,f,_])&&!1==h.dead&&dist(e.pos,d,!0)<t.getrange(i)){let g=new Attack("Attack",attackfunc,[0,1,0],t.getrange(i),d,t,e.pos),w=g.func(!0,e.activeweapon),b=subtractcost(g,e.tc),v=g.warnings.length;0==w.errors.length&&s.push(new ActionNode(e.pos,g,b,e.hazards+v,e.damagepotential+w.avdamageac10,e,n))}let k=new action("Switch Weapon",switchweapon,[0,0,0],0,e.pos,t,e.pos),S=t.secondaryitem,A=new ActionNode(e.pos,k,e.tc.slice(),e.hazards,e.damagepotential,e,e.parentutility,S);if(1>drawLine3D([u,$,p+1],[m,f,_])&&!1==h.dead&&dist(e.pos,h.pos,!0)<t.getrange(S)){let C=new Attack("Attack",attackfunc,[0,1,0],t.getrange(S),h.pos,t,e.pos),E=C.func(!0,S),z=subtractcost(C,e.tc),q=C.warnings.length;0==E.errors.length&&s.push(new ActionNode(e.pos,C,z,e.hazards+q,e.damagepotential+E.avdamageac10,A,n,S))}}return s}function dashusecase(e,t,n){let i=e.tc[0],s=e.tc[1],a=[],[o,l]=e.pos;if(s>0&&i<=0){let c=new action("Dash",dashfunc,[0,t.tcmax[1],0],0,t.pos,t,e.pos),h=subtractcost(c,e.tc);h[0]+=t.tcmax[0];let d=new ActionNode(e.pos,c,h,e.hazards,e.damagepotential,e,n);a.push(d)}return a}function standgroundusecase(e,t,n){let i=e.tc[0],s=e.tc[1],a=[],[o,l]=e.pos;if(0==s&&i==t.tcmax[0]){let c=new action("Stand Ground",standgroundfunc,[t.tcmax[0],0,0],0,t.pos,t,e.pos),h=subtractcost(c,e.tc);h[1]+=t.tcmax[1];let d=new ActionNode(e.pos,c,h,e.hazards,e.damagepotential,e,n);a.push(d)}return a}function defaultidle(e,t){return Math.random()>.99?1e3:0}function defaulthostile(e,t){let[n,i]=e.pos;newgrid[n][i],null==e.parentnode&&(t.knownenemies=[],Object.values(t.visiblecharacters).forEach(function(e){e.character.pc!==t.pc&&t.knownenemies.push(e)}),t.hostilemap=generatefleemap(t.knownenemies,t,80));let s=0,a=e.hazards;newgrid[n][i].gethazards()[1]>0&&a++;let o=e.damagepotential,l=defaulttemperment(e,t);return s-=100*a,s+=10*o,s+=l}function defaulthunting(e,t){let[n,i]=e.pos,s=0;if(null!==e.parentnode&&(s=e.parentutility),null!=e.parentnode||t.huntmap)null==e.parentnode&&updatehuntmap(t.huntmap,t);else{let a=99,o;Object.values(t.huntedcharacters).forEach(function(t){let n=t.lastseen;t.character;let i=chebyshevDistance(e.pos,n)+4*t.getage();i<a&&(a=i,o=t)}),o&&(t.hunted=o,t.huntmap=generatehuntmap(o.lastseen,t,20))}return t.huntmap&&t.huntmap[n]&&t.huntmap[n][i]?t.huntmap[n][i]:chebyshevDistance([n,i],t.pos)+3*Math.random()}function defaultfleeing(e,t){let[n,i]=e.pos,s=0;return(null==e.parentnode&&(t.knownenemies=[],Object.values(t.visiblecharacters).forEach(function(e){e.character.pc!==t.pc&&t.knownenemies.push(e)}),t.fleemap=generatefleemap(t.knownenemies,t,80)),t.fleemap&&t.fleemap[`${n},${i}`])?(s+=t.fleemap[`${n},${i}`],e.hazards>0&&(s-=e.hazards),e.damagepotential>0&&(s+=e.damagepotential),s>10&&e.action&&"Alert"==e.action.name&&(s+=20),s):1e3}function defaulttemperment(e,t){let n=e.activeweapon,[i,s]=e.pos,a=9999,o=Math.floor(t.getrange(n)),l,c;for(let h=0;h<t.knownenemies.length;h++){(l=t.knownenemies[h]).character;let d=l.lastseen;(c=Math.floor(dist(d,[i,s])))<a&&(a=c)}let u=Math.abs(c-o);a<=t.getminrange(n)&&(u=50);let $=t.hostilemap[`${i},${s}`];return void 0===$&&($=99),-(u=Math.max(u,$-o))}function fleeingtemperment(e,t){let[n,i]=e.pos,s=9999;return t.knownenemies.forEach(function(e){e.character;let t=e.lastseen,a=Math.floor(dist(t,[n,i]));a<s&&(s=a)}),-s}function spot(e,t,n){if(t&&t.index==e.index||t&&t.pc==e.pc)return;e.getvisibletiles(),e.visiblecharacters={};for(let i=0;i<e.visibletiles.length;i++){let s=e.visibletiles[i],[a,o]=s.pos;if(null!==s.character&&!s.character.dead){let l=s.character,c=l.pos.slice();t&&l.index==t.index&&"Move"==n.name&&(c=n.target),e.visiblecharacters[l.index]=new CharacterMemory(l,c.slice()),!0==l.pc&&e.knowncharacters[l.index]&&(e.knowncharacters[l.index].lastseen[0]!=e.visiblecharacters[l.index].lastseen[0]||e.knowncharacters[l.index].lastseen[1]!=e.visiblecharacters[l.index].lastseen[1])&&(e.actionqueue=[]),e.knowncharacters[l.index]||!0!=l.pc||(e.actionqueue=[]),e.knowncharacters[l.index]=new CharacterMemory(l,c.slice())}}let h=Object.keys(e.knowncharacters);for(let d=0;d<h.length;d++){let u=h[d];if(!e.visiblecharacters[u]&&e.knowncharacters[u].character.pc!==e.pc){if(drawline(e.pos,e.knowncharacters[u].lastseen)>=1){let $=e.knowncharacters[u].character,p=e.knowncharacters[u].lastseen;e.visiblecharacters[u]=new CharacterMemory($,p)}else{let m=e.knowncharacters[u].character,f=e.knowncharacters[u].lastseen;e.huntedcharacters[u]=new CharacterMemory(m,f),delete e.knowncharacters[u],e.actionqueue=[]}}}e.updatestate()}function attackofop(e,t,n){if(!t||t.pc==e.pc)return;let i=!1,s=!1;if(1==chebyshevDistance(t.pos,e.pos)&&"Move"==n.name&&chebyshevDistance(n.target,e.pos)>1?i=!0:1==chebyshevDistance(t.pos,e.pos)&&"Attack"==n.name&&chebyshevDistance(n.target,t.pos)>1&&!0==t.primaryitem.ranged&&(s=!0),!i&&!s)return;let a=new Attack("Attack",attackfunc,[0,0,1],e.getrange(),t.pos,e,e.pos);e.actionqueue.length>0&&(console.log("this enemy is making a reaction, and their action queue wasn't empty"),console.log(e),e.actionqueue=[]),canAffordAction(a,e)&&(e.actionqueue.push(a),move(e))}function defender(e,t,n){let[i,s]=e.pos;if(t&&t.pc!=e.pc&&"Attack"===n.name&&e.offhanditem instanceof Shield&&1===chebyshevDistance([i,s],n.target)){if(1==chebyshevDistance([i,s],t.pos)){let a=n.target.slice();n.target=[i,s],adduilabel("*",a,[32,32,64],0,!0,!1,!1,!1);return}{let o=function(t,n){return t.prehitpermute||(t.prehitpermute=[]),t.prehitpermute.push(function(n,i){return e.tc[2]>0&&!0==i&&(t.damagerange[0]-=e.stats[0],t.damagerange[0]=Math.max(t.damagerange[0],0),t.damagerange[1]-=e.stats[0],t.damagerange[1]=Math.max(t.damagerange[1],0),t.modbreakdown=[`reactBlocked-${e.stats[0]}dmg`],adduilabel("*",e.pos,[32,32,64],0,!0,!1,!1,!1),e.tc[2]--),[n,i]}),t};n.func=function(e,t){return attackfunc.apply(n,[e,t,o])}}}}function riposte(e,t,n){let[i,s]=e.pos;if(!t||t.pc==e.pc||"Attack"!==n.name||!(e.offhanditem instanceof Shield)||chebyshevDistance([i,s],n.target)>0)return;let a=function(n,a){return n.prehitpermute||(n.prehitpermute=[]),n.prehitpermute.push(function(a,o){if(e.tc[2]>0&&!0==o){n.damagerange[0]-=e.stats[0],n.damagerange[0]=Math.max(n.damagerange[0],0),n.damagerange[1]-=e.stats[0],n.damagerange[1]=Math.max(n.damagerange[1],0),n.modbreakdown=[`reactBlocked-${e.stats[0]}dmg`],e.tc[2]--;let l=new Attack("Attack",attackfunc,[0,0,0],e.getrange,t.pos,e,[i,s]);0==l.func(!0).errors.length&&(e.actionqueue.unshift(l),move(e))}return[a,o]}),n};n.func=function(e,t){return attackfunc.apply(n,[e,t,a])}}function block(e,t,n){let[i,s]=e.pos;if(!t||t.pc==e.pc||"Attack"!==n.name||!(e.offhanditem instanceof Shield)||chebyshevDistance([i,s],n.target)>0)return;let a=function(t,n){return t.prehitpermute||(t.prehitpermute=[]),t.prehitpermute.push(function(n,i){if(e.tc[2]>0&&!0==i){let s=Math.max(1,e.stats[0]);t.damagerange[0]-=e.stats[0],t.damagerange[0]=Math.max(t.damagerange[0],0),t.damagerange[1]-=e.stats[0],t.damagerange[1]=Math.max(t.damagerange[1],0),t.modbreakdown=[`reactBlocked-${s}dmg`],e.tc[2]--}return[n,i]}),t};n.func=function(e,t){return attackfunc.apply(n,[e,t,a])}}function parry(e,t,n){let[i,s]=e.pos;if(!t||t.pc==e.pc||"Attack"!==n.name||!(e.offhanditem instanceof Weapon)||!e.offhanditem.light||chebyshevDistance([i,s],n.target)>0)return;let a=function(t,n){return t.prehitpermute||(t.prehitpermute=[]),t.prehitpermute.push(function(n,i){if(e.tc[2]>0&&!0==i){let s=Math.max(1,e.stats[1]);t.damagerange[0]-=s,t.damagerange[0]=Math.max(t.damagerange[0],0),t.damagerange[1]-=s,t.damagerange[1]=Math.max(t.damagerange[1],0),t.modbreakdown=[`reactParry-${s}dmg`],e.tc[2]--}return[n,i]}),t};n.func=function(e,t){return attackfunc.apply(n,[e,t,a])}}function evade(e,t,n,i=!1){if(!i)return;let[s,a]=e.pos;if(!t||t.pc==e.pc||"Attack"!==n.name||n.target[0]!==s||n.target[1]!==a||e.tc[2]<1)return;let[o,l]=t.pos,[c,h]=[Math.sign(o-s),Math.sign(l-a)],[d,u]=[s-c,a-h],$=new Move("Move",movefunc,[0,0,1],1,[d,u],e,[s,a]);$.reactable=!1,$.cost=[0,0,1],e.actionqueue=[$],move(e)}function lightsensitive(e,t,n){let[i,s]=e.pos;newgrid[i][s].lightlevel>2&&addconditiondynamic(conditions.Stunned,!0,e)()}function autopickup(e,t,n){let[i,s]=e.pos;if(newgrid[i][s].objects.length>0&&(newgrid[i][s].objects[0]instanceof Weapon||newgrid[i][s].objects[0]instanceof Ammunition)){let a=newgrid[i][s].objects[0],o=[e.primaryitem,e.secondaryitem],l=!1;o.forEach(function(t){!0!=l&&(t.number<t.stacksize&&a.basename==t.basename||t.ammotype==a.basename)&&(0==e.actionqueue.length?(l=!0,e.actionqueue.unshift(new Get("Get",getfunc,[0,0,0],0,e.pos,e,e.pos)),move(e)):e.actionqueue.length>0&&"Get"!==e.actionqueue[0].name&&(l=!0,e.actionqueue.unshift(new Get("Get",getfunc,[0,0,0],0,e.pos,e,e.pos))))})}}function spot2([e,t]){let n=newgrid[e][t],i=[];i.push(n);let s={};visiblecharacters=[];let a=0;for(;i.length>0&&a<400;){a++;let o=i.shift(),[l,c]=o.pos;if(!1!==drawline([l,c],[e,t])){null!==o.character&&(l!==e||c!==t)&&visiblecharacters.push(o.character);for(let h=l-1;h<=l+1;h++)for(let d=c-1;d<=c+1;d++)s[h]||(s[h]={}),s[h][d]||(s[h][d]=1,i.push(newgrid[h][d]))}}return visiblecharacters}function hear(e,t=!0,n=0,i){if(chebyshevDistance(e.pos,viewportpos)>e.volume+20)return[];class s{constructor(e,t){this.pos=e,this.volume=t}}let[a,o]=e.pos,l=[],c=new s(e.pos,e.volume),h=new PriorityQueue((e,t)=>t.volume-e.volume);h.enqueue(c);let d=new Set,u=0,$=!1;!0==e.origin.pc&&($=!0);let p=[];for(n=0,!0==newgrid[a][o].visible&&($=!0);!h.isEmpty()&&u<900;){u++;let m=h.dequeue(),[f,_]=m.pos,g=newgrid[f][_],w=g.character,b=`${f},${_}`;if(!d.has(b)&&(d.add(b),m.volume>=1))for(let v of(p.push([f,_,m.volume]),null!==w&&(!0==w.pc&&($=!0,0==n&&(n=(e.volume-m.volume)*50)),l.push(w),t&&w.hear(e,m.volume)),directions)){let[k,S]=[m.pos[0]+v[0],m.pos[1]+v[1]],A=`${k},${S}`;if(newgrid[k]&&newgrid[k][S]&&!d.has(A)){let C=1;!1==newgrid[k][S].traversable&&newgrid[k][S].readOpacity()>=1&&!newgrid[k][S].slope&&(C=5),0!==Math.abs(k-f)&&0!==Math.abs(S-_)&&(C*=1.4),h.enqueue(new s([k,S],m.volume-C))}}}if(!0==newgrid[a][o].visible&&(n=0),!0==$){if(!0!==e.heard&&t){let E;for(let z=0;z<playercs.length;z++)!1==playercs[z].dead||!0==gameover&&playercs[z]==deathcharacter?E||(E=playercs[z]):E&&dist(E.pos,[a,o])<dist(playercs[z].pos,[a,o])&&(E=playercs[z]),void 0!=E&&E.hear(e,1)}for(let q=0;q<p.length;q++){let[j,W,F]=p[q];if(!0==newgrid[j][W].visible){let D=[F/100,F/100,F/100];i&&(D=[i[0]*F/100,i[1]*F/100,i[2]*F/100]),adduilabel("$",[j,W],D,0,!0,!1,!1,!1,.2,(e.volume-F)*50+n),updatedsomething=!0}}}return performance.now(),l}function evaluateposition(e){let[t,n]=[0,0];for(let i=0;i<e.length;i++)[t,n]=e[i]}function dist(e,t,n=!1,i=!1){let s=Math.abs(e[0]-t[0]),a=Math.abs(e[1]-t[1]),o=0;return(void 0===newgrid[t[0]]||void 0===newgrid[t[0]][t[1]]||void 0===newgrid[e[0]]||void 0===newgrid[e[0]][e[1]])&&console.trace(),n||(o=newgrid[t[0]][t[1]].elevation-newgrid[e[0]][e[1]].elevation),i&&(o=Math.max(o,0)),Math.sqrt(s**2+a**2+o**2)}function repeatchar(e,t){let n="";for(let i=0;i<t;i++)n+=e;return n}function addLineBreaks(e,t){let n="";for(let i=0;i<e.length;i++)n+=e[i],(i+1)%t==0&&i!==e.length-1&&(n+="<br>");return n}function roll(e,t){return randomNumber(e,1)+t}function randomNumber(e,t=0){return Math.floor(Math.random()*(e-t)+t)}function bresenhamLine([e,t],[n,i]){let s=[],a=Math.abs(n-e),o=Math.abs(i-t),l=e<n?1:-1,c=t<i?1:-1,h=a-o;for(;s.push([e,t]),e!==n||t!==i;){let d=2*h;d>-o&&(h-=o,e+=l),d<a&&(h+=a,t+=c)}return s}function shuffle(e){let t=e.length,n,i=e.slice();for(;t>0;)n=Math.floor(Math.random()*t),t--,[i[t],i[n]]=[i[n],i[t]];return i}function deepCopy3D(e){return e.map(e=>e.map(e=>e.map(e=>e)))}function deepCopySubArray3D(e,t,n,i,s){let a=[];for(let o=n;o<=s;o++){a[o-n]=[];for(let l=t;l<=i;l++){a[o-n][l-t]=[];for(let c=0;c<e[0][0].length;c++)a[o-n][l-t][c]=e[o][l][c]}}return a}function deepCopySubArray2D(e,t,n,i,s){let a=[];for(let o=n;o<=s;o++){a[o-n]=[];for(let l=t;l<=i;l++)a[o-n][l-t]=e[o][l]}}function deepCopy2D(e){let t=[];for(let n=0;n<e.length;n++){t[n]=[];for(let i=0;i<e[0].length;i++)t[n][i]=e[n][i]}return t}function partialFill(e,t,n,i,s,a){for(let o=n;o<s;o++)for(let l=i;l<a;l++)e[l][o]=t}function shadowslope([e,t],[n,i]){let s=-Math.abs(i-t)/Math.abs(n-e);chebyshevDistance([e,t],[n,i]);let a=[n+s/Math.sqrt(1+s**2),i+1/Math.sqrt(1+s**2)];a[1],a[0]}function randomSymbol(e){let t=e.length,n=randomNumber(t+1,1)-1;return e[n]}function takeav(e){return e.reduce((e,t)=>e+t)/e.length}function manhattanDistance(e,t){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])}function convertColortoAbs(e){let t=e.map(e=>e/256);return t}function convertAbstoColor(e){let t=e.map(e=>256*e);return t}function getsquare([e,t],n){let i=0,s=0,a=2*n+1,o=[];for(let l=0;l<a*a;l++)s=l%a,o.push([e+s-n,t+(i=Math.floor(l/a))-n]);return o}function gettiles(e){let t=[],n=0,i=0;for(let s=0;s<e.length;s++)[n,i]=e[s],!(n<0)&&!(n>=mapsizey)&&(i<0||i>=mapsizex||t.push(newgrid[n][i]));return t}function randomint(e,t){return e>t&&([e,t]=[t,e]),Math.floor(Math.random()*(t-e+1))+e}function chebyshevDistance(e,t){let[n,i]=e,[s,a]=t;return Math.max(Math.abs(s-n),Math.abs(a-i))}function combineFunctions(e,t){let n=e.bind(this),i=t.bind(this);return()=>{n(),i()}}const conditions={Stunned:new condition("Stunned",skipturn,skipturn,1,!0),Stunnedlite:new condition("Stunned",skipturn,skipturn,1,!1),Surprised:new condition("Surprised",skipturnandyelp,skipturn,1,!0),Prone:new condition("Prone",losemove,losemove,1,!1),Poisoned:new condition("Poisoned",()=>{},takedamage(1),2,!1),Bleeding:new condition("Bleeding",()=>{},takedamage(1),3,!1),Unconscious:new condition("Unconscious",skipturn,1,!1),Confident:new condition("Confident",damagebonus(2),null,2,!1,damagebonus(-2)),Blind:new condition("Blinded",null,null,1,!1,null,null),Burning:new condition("Burning",burn,null,0,!1,null),OnFire:new condition("On Fire",burn,burn,3,!1,null),Overwatch:new condition("Overwatch",null,null,0,!1,null),Resting:new condition("Resting",()=>{},()=>{},0,!1,()=>{}),Restrained:new condition("Restrained",skipturn,skipturn,1,!1),Asleep:new condition("Asleep",skipturn,skipturn,1,!1)},keybindings=["c - Credits","m - open map","ctrl+click - move all","D - toggle auto-dash","S - toggle auto-stand-ground","A - toggle auto-advance-turn","V - toggle verbose tool-tips","k - kick","j - jump","X - switch hands","L - leave offhand Item","l - leave item","x - switch weapons","g - get Item","o - overwatch","s - stand ground","d - dash","a - aim attack","1,2,3 - switch characters","space - advance turn","click - move",],keytooltips=["","","move all party members in order toward the cursor","automatically use the dash action when running out of move","automatically use the stand-ground action when out of actions","automatically advance turn to the next party member when out of move and actions","enables in-depth tool-tips","shove a character a number of tiles equal to the attacking character's strength","jump to a tile within a distance dependant on the jumping character's strength","switch primary and offhand items","leave the item in the character's offhand","leave the item in the character's main hand","switch primary and secondary items","get an item on the ground underneath a character","use an action to prepare an attack as a reaction during enemy turn (reaction required)","trade a character's max move for an additonal action","trade an action to add a character's max move","aim an attack - displays modifiers to the attack and allows the use of thrown or consumable weapons","switch active character to a particular character","advance from one party member's turn to the next or from the last party member's turn to the enemy turn","move the active character to the location of the cursor",];let procgendebug=!1,characterindex=0,cornershadows=!1,partiallos=!1,memorytilebrightness=6;const dontcaredistance=50,enemysightrange=30,playersightrange=30,mapsizex=400,mapsizey=208;let shrink=1,mult=1,viewportsizex=48*mult,viewportsizey=24*mult,fontsize=26/mult;const enemypool=[Goblin,Goblin_Dagger,Goblin_Swordsman,Goblin_Spearman,Hobgoblin,Ogre,Skulker,Giant,],clickfuncs={Raise:function([e,t]){let n=newgrid[e][t].elevation;newgrid[e][t]=new Tile(...tiletypes.RoughStoneFloor,[e,t]),newgrid[e][t].elevation=n+1},Lower:function([e,t]){let n=newgrid[e][t].elevation;newgrid[e][t]=new Tile(...tiletypes.RoughStoneFloor,[e,t]),newgrid[e][t].elevation=n-1},Clear:([e,t])=>newgrid[e][t]=new Tile(...tiletypes.DirtFloor,[e,t]),Wall:([e,t])=>newgrid[e][t]=new Tile(...tiletypes.CavernWall,[e,t])};let clickfunc=clickfuncs.Lower;const directionsincl=[[0,0],[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],],directions=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],],cardinaldirections=[[-1,0],[1,0],[0,-1],[0,1],],directionsextra=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],[2,0],[2,1],[2,-1],[-2,0],[-2,1],[-2,-1],[0,2],[1,2],[-1,2],[0,-2],[1,-2],[-1,-2],],directionsextraincl=[[0,0],[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],[2,0],[2,1],[2,-1],[-2,0],[-2,1],[-2,-1],[0,2],[1,2],[-1,2],[0,-2],[-1,-2],[-1,-2],],materials={metal:[.5,.5,.5],water:[.1,.25,.35],stone:[.6,.6,.6],dirt:[.7,.5,.4],mud:[.3,.2,.2],abyss:[0,0,0],crystal:[3,3,3],brick:[1,1,1],moss:[.3,.6,.2],wood:[.5,.25,.2],fire:[1,.25,.1],marble:[1,1,1],bone:[1,1,1],blood:[1,0,0]},tiletypes={Water:["Water",materials.water,"~",!0,2,1],DirtFloor:["Dirt Floor",materials.dirt,"B7",!0,1,1],StoneFloor:["Stone Floor",materials.stone,"B7",!0,1,1],CavernWall:["Cavern Wall",materials.stone,"#",!1,null,0],MossFloor:["Moss Floor",materials.moss,"201D",!0,1,1],RoughStoneFloor:["Rough Stone Floor",materials.stone,"B7",!0,1,1],RoughStoneWall:["Rough Stone Wall",materials.stone,"=",!1,null,0],SmoothstoneFloor:["Smooth Stone Floor",materials.stone,"0060",!0,1,1],MossyWall:["Mossy Wall",materials.moss,"#",!1,null,0],WoodFloor:["Wood Floor",materials.wood,"B7",!0,1,1],WoodWall:["Wood Wall",materials.wood,"#",!1,null,0],MudFloor:["Mud Floor",materials.mud,"B7",!0,1,1],MudWall:["Mud Wall",materials.mud,"#",!1,null,0]},tiletypesarr=[tiletypes.Water,tiletypes.DirtFloor,tiletypes.StoneFloor,tiletypes.CavernWall,tiletypes.MossFloor,tiletypes.RoughStoneFloor,tiletypes.RoughStoneWall],actions={SwitchWeapon:["Switch Weapon",switchweapon,[0,0,0],],HalfAttack:["Attack",attackfunc,[0,.5,0]],Attack:["Attack",attackfunc,[0,1,0]],Open:["Open",open,[0,0,0],1.9],Dash:["Dash",dashfunc,[0,1,0]],Interact:["Interact",interact,[0,0,0],1.9]},statblocks={Deserter:[3,0,3],Hellion:[3,0,3],Ranger:[2,2,2],Standard_Bearer:[2,2,2],Exile:[1,2,2],Wanderer:[1,2,2],Skirmisher:[1,2,2],Stalker:[1,2,2],Maledict:[1,2,2],Berserker:[3,0,3],Sentinel:[3,0,3],ShieldMaiden:[2,2,3],Prisoner:[1,1,1],Goblin:[0,0,0]};let baselightrange=6,invlightrange=1/baselightrange,brightnessadjust=2,viewportoffsety=0,viewportoffsetx=0,throttleRate=10,lastCall=0,enemyturnstart=0,soundoffset=2.5,now=0,lastframe=0,frameticker=20,timeticker=0,checkedframe=!1,blankpixelcount=0,noiseupdateticker=0;const noiseupdaterate=100,noisethreshold=.5,waterthreshhold=.6,noiseamount=.1,lightflickerthreshhold=.8,tileabsorbs=[materials.water,materials.dirt,materials.stone,materials.stone,materials.moss,materials.stone,materials.stone,materials.crystal,materials.abyss,];let diffgens=2;const cdiff=.05;let gamma=1.4,ticktimer=100,renderedlastframe=!0,updatedlighting=!0,updatedsomething=!0,renderqueue=[];function updatelightmap(){let[e,t,n,i]=getlightingsize();updatelos(e,t,n,i),updatelighting(e,t,n,i),updatediffusion(e,t,n,i)}function getlightingsize(){let e=viewportpos[1]-viewportsizex/2-4,t=viewportpos[0]-viewportsizey/2-4,n=viewportpos[1]+viewportsizex/2+4,i=viewportpos[0]+viewportsizey/2+4;return t<0&&(t=0,i=viewportsizey+4),i>mapsizey&&(i=mapsizey,t=mapsizey-(viewportsizey+4)),e<0&&(e=0,n=viewportsizex+4),n>mapsizex&&(n=mapsizex,e=mapsizex-(viewportsizex+4)),[e,t,n,i]}function updatelos(e,t,n,i){for(let s=t;s<i;s++)for(let a=e;a<n;a++)newgrid[s][a].visible=!1;for(let o=t;o<i;o++)for(let l=e;l<n;l++){if(newgrid[o][l].readOpacity()>=1){newgrid[o][l].visible=!0;continue}newgrid[o][l].los=!1;for(let c=0;c<playercs.length;c++){if(!0==playercs[c].dead&&!1==gameover||!0==gameover&&!playercs[c]==deathcharacter)continue;let h=drawLine3D([...playercs[c].pos,newgrid[playercs[c].pos[0]][playercs[c].pos[1]].elevation+1],[o,l,newgrid[o][l].elevation]);if(h<1){newgrid[o][l].visible=!0;for(let d=o-1;d<=o+1;d++)if(d>0&&d<mapsizey)for(let u=l-1;u<=l+1;u++)u>0&&u<mapsizex&&2>Math.abs(newgrid[o][l].elevation-newgrid[d][u].elevation)&&(newgrid[d][u].visible=!0)}h&&(newgrid[o][l].los=!0)}}}function updatelighting(e,t,n,i,s=!1){let a=[],o=[];for(let l=t;l<i;l++)for(let c=e;c<n;c++){let h=[];h=newgrid[l][c].readLightsource();for(let d=0;d<h.length;d++){let u=h[d];u.pos=[l,c],a.push(u)}}let $;for(let p=t;p<i;p++)for(let m=e;m<n;m++){if($=newgrid[p][m],!1==s&&($.light=null),$.lightlevel=0,!1!==$.visible){for(let f=0;f<a.length;f++){let _=a[f],[g,w]=_.pos;if(Math.abs(g-p)>_.radiance*baselightrange+2||Math.abs(w-m)>_.radiance*baselightrange+2)continue;let[b,v]=getlighting(p,m,a[f]);if(v=Math.max(v,newgrid[p][m].lightlevel),$.lightlevel=v,!s){if(null===$.light){$.light=b;continue}$.light[0]+=b[0],$.light[1]+=b[1],$.light[2]+=b[2]}}0==$.lightlevel&&o.push($)}null===$.light&&($.light=[0,0,0])}if(s)return;let k=[];for(let S=0;S<o.length;S++)($=o[S]).lightlevel<1&&($.visible=!1,k.push($));let[A,C]=[0,0],[E,z]=[0,0],q=[];for(let j=0;j<k.length;j++){let[W,F]=($=k[j]).pos;for(let D=0;D<20;D++){if([A,C]=directionsextra[D],[E,z]=[W+A,F+C],E<0||E>=mapsizey||z<0||z>=mapsizex)continue;let R=0;D>7&&(R=drawline([W,F],[E,z])),!(R>=1)&&!0==newgrid[E][z].visible&&1>newgrid[E][z].readOpacity()&&q.push($)}}for(let B=0;B<q.length;B++)($=q[B]).visible=!0;for(let G=0;G<playercs.length;G++){let M=playercs[G];if(M.dead)continue;let[O,T]=M.pos;for(let L=0;L<20;L++){let[P,N]=directionsextraincl[L],[H,I]=[O+P,T+N];if(H>i||H<t||I>n||I<e||newgrid[H][I].lightlevel>=1)continue;let U=Math.max(1,Math.round(dist([H,I],M.pos))),Q=0;L>8&&(Q=drawline(M.pos,[H,I],!1,!0)),Q<1&&(newgrid[H][I].visible=!0,newgrid[H][I].light[0]+=16/U,newgrid[H][I].light[1]+=16/U,newgrid[H][I].light[2]+=16/U)}}}function prunesightmap(e,t,n,i){for(let s=t;s<i;s++)for(let a=e;a<n;a++){if(newgrid[s][a].lightlevel<1&&!1!==newgrid[s][a].visible){procgendebug||(newgrid[s][a].visible=!1);for(let o=s-2;o<=s+2;o++)if(o>0&&o<mapsizey){for(let l=a-2;l<=a+2;l++)if(newgrid[o]&&newgrid[o][l]&&!(newgrid[o][l].lightlevel<1)&&l>0&&l<mapsizex){let c=drawline([s,a],[o,l]);if(1>newgrid[o][l].readOpacity()&&c<1){newgrid[s][a].visible=!0;break}}}}if(newgrid[s][a].lightlevel<1||!1==newgrid[s][a].visible)for(let h=0;h<playercs.length;h++){let d=playercs[h];if(d.dead)continue;let u=dist([s,a],d.pos);if(u>=3.5)continue;let $=Math.max(1,Math.round(u));1>drawline(d.pos,[s,a],!1,!0)&&(newgrid[s][a].visible=!0,newgrid[s][a].light[0]+=16/$,newgrid[s][a].light[1]+=16/$,newgrid[s][a].light[2]+=16/$)}}}function updatediffusion(e,t,n,i){let s=directions.length,a=[0,0,0],o=[0,0,0],l=0,c=[];for(let h=0;h<diffgens;h++){c=[];for(let d=t;d<i;d++)for(let u=e;u<n;u++){let $=newgrid[d][u].light,p=newgrid[d][u].absorbtionBase,m=newgrid[d][u].elevation,f=[0,0,0];if(!(newgrid[d][u].readOpacity()>=1)){for(let _=0;_<s;_++){let g=directions[_],[w,b]=[g[0]+d,g[1]+u];if(newgrid[w]&&newgrid[w][b]){if(!1==newgrid[w][b].visible||newgrid[w][b].readOpacity()>=1)continue;let v=newgrid[w][b].light,k=newgrid[w][b].absorbtionBase;for(let S=0;S<3;S++)a[S]=.05*v[S]*k[S],o[S]=.05*$[S]*p[S];if(l=(o[0]+o[1]+o[2])/3,m<=newgrid[w][b].elevation)for(let A=0;A<3;A++)f[A]+=a[A]}}c.push(newgrid[d][u]),c.push(f)}}for(let C=0;C<c.length;C+=2){let E=c[C],z=c[C+1];E.light[0]+=z[0],E.light[1]+=z[1],E.light[2]+=z[2]}}}function getlighting(e,t,n){let i=[n.color[0],n.color[1],n.color[2]],[s,a]=n.pos,o=n.lightpref,l=n.pos,c=newgrid[n.pos[0]][n.pos[1]],h=c.elevation+1,d=dist([e,t],[s,a]),u=newgrid[e][t].elevation;h!==newgrid[e][t].elevation&&(d=Math.sqrt(d**2+Math.abs(h-u)**2));let $=Math.min(Math.round(n.radiance-(d-1)/baselightrange),n.radiance);if($<=0)return[[0,0,0],0];let p=drawLine3D([...l,h],[e,t,u]);if(p>=1)return[[0,0,0],0];$=Math.round(n.radiance-(d-1)*(1+p)/baselightrange);for(let m=0;m<3;m++)i[m]=Math.round(i[m]*noisemap[s][a]*(1/((d/o[m])**2+.5))*(1-p));return[i,$]}function generate(){if(tutorial){tutorialgen();return}playercs=[],nonpcs=[];let[e,t]=region2gen(mapsizey,mapsizex,30,160),n=perlinNoise(mapsizex,mapsizey,5),i=!1;for(let s=0;s<t.length;s++){i=!1;let a=t[s];if(a.hotdepth>0)continue;let[o,l]=a.pos,c=a.roomgrid;for(let h=0;h<c.length;h++)for(let d=0;d<c[0].length;d++){let[u,$]=[h+o,d+l];a.boss||a.bossbuffer||a.origin?((1==c[h][d]||2==c[h][d]||3==c[h][d]||4==c[h][d])&&(newgrid[u][$]=new Tile(...tiletypes.MudFloor,[u,$])),!1==newgrid[u][$].traversable&&0==newgrid[u][$].objects.length&&5==c[h][d]&&(newgrid[u][$]=new Tile(...tiletypes.MudWall,[u,$]))):((1==c[h][d]||2==c[h][d]||3==c[h][d]||4==c[h][d])&&(4==e[u][$]&&n[u][$]>.1?(newgrid[u][$]=new Tile(...tiletypes.DirtFloor,[u,$]),n[u][$]>.2&&(newgrid[u][$]=new Tile(...tiletypes.MossFloor,[u,$])),n[u][$]>.3&&Math.random()<n[u][$]?newgrid[u][$].addObject(new TallGrass):n[u][$]>.4&&newgrid[u][$].addFluid(new Water)):(a.dungeon?newgrid[u][$]=new Tile(...tiletypes.SmoothstoneFloor,[u,$]):newgrid[u][$]=new Tile(...tiletypes.StoneFloor,[u,$]),n[u][$]>.3&&(newgrid[u][$]=new Tile(...tiletypes.MossFloor,[u,$])))),!0===i&&0!==c[h][d]&&6!==c[h][d]&&(newgrid[u][$].elevation=2,(2==c[h][d]||3==c[h][d]||4==c[h][d])&&(newgrid[u][$]=new Tile(...tiletypes.DirtFloor,[u,$]),newgrid[u][$].elevation=1)),!1==newgrid[u][$].traversable&&0==newgrid[u][$].objects.length&&n[u][$]>.3&&(newgrid[u][$]=new Tile(...tiletypes.MossyWall,[u,$])))}for(let p=0;p<a.doors.length;p++){let[m,f]=a.doors[p],[_,g]=[m+o,f+l];newgrid[_][g].addObject(new door([_,g]))}let[w,b]=a.pos;for(let v=0;v<a.spawnpoints.length;v++){let[k,S]=a.spawnpoints[v],[A,C]=[k+w,S+b],E=a.enemies[v];switch(E){case 0:newgrid[A][C].addCharacter(new Deserter([A,C]));break;case 1:newgrid[A][C].addCharacter(new Goblin([A,C]));break;case 2:Math.random()>.33?newgrid[A][C].addCharacter(new Goblin_Dagger([A,C])):newgrid[A][C].addCharacter(new Goblin_Shortbow([A,C]));break;case 3:switch(Math.floor(4*Math.random())){case 1:newgrid[A][C].addCharacter(new Goblin_Shortbow([A,C]));break;case 2:newgrid[A][C].addCharacter(new Goblin_Spearman([A,C]));break;case 3:newgrid[A][C].addCharacter(new Goblin_Swordsman([A,C]))}break;case 4:switch(Math.floor(4*Math.random())){case 0:newgrid[A][C].addCharacter(new Skulker([A,C]));break;case 1:newgrid[A][C].addCharacter(new Ogre([A,C]));break;default:newgrid[A][C].addCharacter(new Hobgoblin([A,C]))}break;case 5:newgrid[A][C].addCharacter(new Goblin_Hivequeen([A,C]));break;case 6:newgrid[A][C].addObject(new Spawning_Membrane([A,C]));break;case 7:newgrid[A][C].addObject(new Chest([A,C]));break;case 8:newgrid[A][C].addCharacter(new Giant([A,C]));break;case 9:newgrid[A][C].addObject(new spikeTrap([A,C]));break;case 10:newgrid[A][C].addCharacter(new Hobgoblin_Warlord([A,C]));break;case 11:newgrid[A][C].addObject(new Spawning_Membrane_Special)}}for(let z=0;z<a.pittiles.length;z++){let[q,j]=a.pittiles[z],[W,F]=[q+w,j+b];newgrid[W][F]=new Tile(...tiletypes.StoneFloor,[W,F]),newgrid[W][F].elevation=-2}}activecharacternonindex=playercs[0]}function tutorialgen(){newgrid[100][200].addCharacter(new Deserter([100,200])),newgrid[90][200].addCharacter(new Goblin([90,200])),activecharacternonindex=playercs[0]}let successes=0,failures=0,diterations=0,dtime_partial=0;function region1gen(...e){return generatenoise(...e,[[10,1]])}function region2gen(...e){return generatenoise(...e,[[5,1],[9,1]])}function generatenoise(e,t,n,i=50,s){class a{constructor(){this.enemies=[],this.neighborsnonindex=[],this.neighbors=[],this.spawnpoints=[],this.walls=[],this.walltiles=[],this.pittiles=[],this.doors=[],this.maxhotdepth=0}generategrid(){let e=[],t=this.tiles.concat(this.walltiles),[n,i]=[999,0],[s,a]=[999,0];for(let o=0;o<t.length;o++){let[l,c]=t[o];c<n&&(n=c),c>i&&(i=c),l<s&&(s=l),l>a&&(a=l)}let h=i-n+1,d=a-s+1;for(let u=0;u<d;u++){e[u]=[];for(let $=0;$<h;$++)e[u][$]=0}for(let p=0;p<this.tiles.length;p++){let[m,f]=this.tiles[p];e[m-s][f-n]=1}for(let _=0;_<this.walltiles.length;_++){let[g,w]=this.walltiles[_];e[g-s][w-n]=5}this.pos=[s,n],this.roomgrid=e}updateneighbors(){let e=this.roomgrid,[t,n]=this.pos;for(let i=0;i<this.neighborsnonindex.length;i++){let s=this.edges[this.neighbors[i]],a=this.neighborsnonindex[i],o=!1,l=!1,c=1;a.depth<=this.depth&&(o=!0),a.depth>=this.depth&&(l=!0),o&&(c+=1),l&&(c+=2);let[h,d]=[0,0];for(let u=0;u<s.length;u++)d+=s[u][1],h+=s[u][0];let[$,p]=[h/s.length,d/s.length];s=s.sort(([e,t],[n,i])=>v([e,t],[$,p])-v([n,i],[$,p]));for(let m=0;m<1;m++){let[f,_]=s[m];e[f-t][_-n]=c}}let g=!0;for(let w=0;w<this.roomgrid.length;w++)for(let b=0;b<this.roomgrid[0].length;b++)(3==this.roomgrid[w][b]||4==this.roomgrid[w][b])&&(g=!1);function v([e,t],[n,i]){return Math.sqrt((e-n)**2+(t-i)**2)}this.deadend=g}findspawnpoints(){let e=this.depth,t=3,n=0;if(e<4)for(t=Math.min(3,e);n<t;){let i=Math.ceil(2*Math.random());this.enemies.push(i),n+=i}else if(e<8)for(t=Math.min(6,e);n<t;){let s=Math.ceil(3*Math.random());this.enemies.push(s),n+=s}else for(t=6;n<t;){let a=Math.ceil(4*Math.random());this.enemies.push(a),n+=a}if(this.dungeon&&!this.ruins){this.enemies.push(Math.min(4,e)),this.enemies.push(Math.min(4,e)),Math.random()>.5&&this.enemies.push(7);for(let o=0;o<4;o++)this.enemies.push(9)}this.boss&&(this.enemies=[5,6,6,6,6,6,6,6,6,6,6,6,6,6]),this.bossbuffer&&(this.enemies.push(6),this.enemies.push(6),this.enemies.push(6),this.enemies.push(6),this.enemies.push(6)),this.miniboss&&this.enemies.push(Math.min(4,e)),this.halfboss&&(this.enemies.push(8),this.enemies.push(7),this.enemies.push(11)),this.origin&&(this.enemies=[0,11,11]);let l=[],c=[],h=this.roomgrid.length,d=this.roomgrid[0].length;for(let u=0;u<h;u++){l[u]=[];for(let $=0;$<d;$++)(2==this.roomgrid[u][$]||4==this.roomgrid[u][$])&&c.push([u,$]),l[u][$]=null}let p=0;for(let m=0;m<c.length;m++){let f=c[m];for(let _=0;_<f;_++){let[g,w]=c.shift();if(void 0!==l[g]&&void 0!==l[g][w]&&null===l[g][w]&&1===this.roomgrid[g][w]){l[g][w]=p;for(let b=0;b<4;b++){let[v,k]=directions[b],[S,A]=[g+v,w+k];c.push([S,A])}}}p++}for(let C=0;C<this.enemies.length;C++){this.enemies[C];let E,z;for(let q=0;q<h;q++)for(let j=0;j<d;j++){if(1!==this.roomgrid[q][j]||void 0===l[q][j])continue;let W=0;W=Math.abs(l[q][j]-5);let F=!1,D;for(let R=0;R<this.spawnpoints.length;R++){let[B,G]=this.spawnpoints[R];G==j&&B==q&&(F=!0),W+=D=Math.max(-4,-Math.sqrt(Math.max(Math.abs(G-j),Math.abs(B-q))))}!F&&((W=Math.random())<z||void 0===z)&&(E=[q,j],z=W)}E&&this.spawnpoints.push(E)}}getrandomtile(){let e=Math.floor(Math.random()*this.roomgrid.length),t=Math.floor(Math.random()*this.roomgrid[0].length);return 0==this.roomgrid[e][t]?this.getrandomtile():[e,t]}evaluate([e,t]){let n=999,i=[[e,t]],s=this.roomgrid,a={};for(;i.length>0;){let[o,l]=i.shift();if(a[`${o},${l}`]||!s[o]||!s[o][l])continue;let c=Math.abs(o-e)+Math.abs(l-t);0!==s[o][l]&&(2!=s[o][l]||n<c||(n=c),a[`${o},${l}`]=1,i.push([o+1,l]),i.push([o-1,l]),i.push([o,l+1]),i.push([o,l-1]))}return-Math.abs(n-3)}restructure(){let e=this;this.walls=[];let t=this.roomgrid,n=[],i=0,s=0;if(t.length,t[0].length,!this.dungeon&&!this.miniboss||this.boss||this.bossbuffer||this.origin){let a=[],o=[],l=[];for(let c=0;c<this.roomgrid.length;c++){a[c]=[];for(let h=0;h<this.roomgrid[0].length;h++)a[c][h]=0}for(let d=0;d<this.roomgrid.length;d++)for(let u=0;u<this.roomgrid[0].length;u++)if(5==t[d][u]&&0==a[d][u]){l=[],(o=[]).push([d,u]);let $=!0;for(;o.length>0&&!0==$;){let[p,m]=o.shift();for(let f=0;f<4;f++){let[_,g]=cardinaldirections[f],[w,b]=[p+_,m+g];if(void 0===t[w]||void 0===t[w][b]){$=!1;continue}5==t[w][b]&&0==a[w][b]&&(o.push([w,b]),l.push([w,b]),a[w][b]=1),(5!==t[w][b]&&1!==t[w][b]||2==a[w][b])&&($=!1)}}if(!0==$&&l.length>15)for(let v=0;v<l.length;v++){let[k,S]=l[v];a[k][S]=2,this.pittiles.push([k,S])}else for(let A=0;A<l.length;A++){let[C,E]=l[A];a[C][E]=2}}}else{for(let z=0;z<this.roomgrid.length;z++)for(let q=0;q<this.roomgrid[0].length;q++)2==t[z][q]||3==t[z][q]||4==t[z][q]?n.push([z,q]):1==t[z][q]?(i++,s++,t[z][q]=0):5==t[z][q]?(s++,t[z][q]=0):0==t[z][q]&&(t[z][q]=6);let[j,W]=n.shift(),F=[[j,W]],D=[],R=[],B=0;for(;F.length>0||n.length>0||B<i/2;){let G=!1;for(;0==F.length&&R.length>0;){n.length>0&&(n[0],R=ei(R));Y(R.shift()),F.length>0&&successes++}if(0==F.length&&D.length>0){let M=n[0];void 0!==M&&D.sort(([e,t],[n,i])=>es([e,t],M)-es([n,i],M));let O=D.shift();Y(O),F.push(O),F.length>0?(failures++,G=!0):successes++}let[T,L]=F.shift();if(1==t[T][L])continue;t[T][L]=1,B++;for(let P=0;P<n.length;P++){let[N,H]=n[P];if(N==T&&H==L){n.splice(P,1);break}}let I=ei(cardinaldirections);for(let U=0;U<4;U++){let[Q,K]=I[U],[J,V]=[T+Q,L+K],[X,Z]=[T+2*Q,L+2*K];if(void 0!==t[J]&&void 0!==t[J][V]&&6!=t[J][V]){if(0!==t[J][V]&&1!==t[J][V]&&5!==t[J][V])F.push([J,V]);else if(0==t[J][V]||5==t[J][V]){if(D.push([J,V,[Q,K]]),void 0===t[X]||void 0===t[X][Z]||6==t[X][Z])continue;1==t[X][Z]&&Math.random()>.5&&this.ruins?F.push([J,V,[Q,K]]):R.push([J,V,[Q,K]])}}}}function Y([n,i,[s,a]]){let o=2,l=2;Math.random()>.5&&(l++,o++);let c=4,h=!1;Math.random()>.5&&(c=5,h=!0);let d=!0,u=[],$=[],p=!0;for(;!0==d&&Math.max(o,l)<=c;){!0==h&&(l=o=Math.max(o,l));let[m,f]=[n+s*l,i+a*o],_=[],g=[];for(let w=m-l;w<=m+l;w++){for(let b=f-o;b<=f+o;b++){if(h&&es([w,b],[m,f])>=l)continue;let v=Math.abs(b-f),k=Math.abs(w-m);if(void 0===t[w]||void 0===t[w][b]||1==t[w][b]){d=!1;break}if(v>=o||k>=l)6!==t[w][b]&&g.push([w,b]);else{if(6==t[w][b]){d=!1;break}_.push([w,b])}}if(!d)break}Math.random()>.5?(o++,l++):Math.random()>.5?o++:l++,d&&(p=!1,$=g.slice(),u=_.slice())}if(!p){for(let S=0;S<u.length;S++){let[A,C]=u[S];t[A][C]=2}for(let E=0;E<$.length;E++){let[z,q]=$[E];t[z][q]=5}let j=[],W=[[n,i]];for(;W.length>0;){let[D,R]=W.shift(),[B,G]=[D+s,R+a],[M,O]=[D-s,R-a];if(D<2||D>t.length-2||R<2||R>t[0].length-2||void 0===t[D]||void 0===t[D][R])continue;let T=!1;if(2==t[B][G]&&1==t[M][O]&&(T=!0),!T)continue;let L=!1;for(let P=0;P<j.length;P++){let N=j[P];N[0]==D&&N[1]==R&&(L=!0)}if(!L){j.push([D,R]);for(let H=0;H<4;H++){let[I,U]=cardinaldirections[H],[Q,K]=[D+I,R+U];W.push([Q,K])}}}let J=(j=ei(j)).length,V=5>Math.max(o,l);V||(J=1),0==j.length&&(j=[[n,i]]);for(let X=0;X<J;X++){let Z=j[X];F.push(Z),V||e.ruins||e.doors.push(Z)}}}}function ee([e,t],[n,i]){let s=[],a=Math.abs(n-e),o=Math.abs(i-t),l=e<n?1:-1,c=t<i?1:-1,h=a-o;for(;s.push([e,t]),e!==n||t!==i;){let d=2*h;d>-o&&(h-=o,e+=l),d<a&&(h+=a,t+=c)}return s}function et(e,t){let[n,i]=e,[s,a]=t;return Math.max(Math.abs(s-n),Math.abs(a-i))}function en(e,t){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])}function ei(e){let t=e.length,n,i=e.slice();for(;t>0;)n=Math.floor(Math.random()*t),t--,[i[t],i[n]]=[i[n],i[t]];return i}function es([e,t],[n,i]){return Math.sqrt((e-n)**2+(t-i)**2)}}}let o=[];for(let l=0;l<s.length;l++){let[c,h]=s[l],d=perlinNoise(t,e,c);o.push(d)}let u=[],$=[],p=[],m=[];for(let f=0;f<e;f++){p[f]=[],u[f]=[],$[f]=[];for(let _=0;_<t;_++){u[f][_]=0;let g=0;g+=Math.max(_-(t-n),0)/n,g+=Math.max(f-(e-n),0)/n,g+=Math.max(-_+n,0)/n,g+=Math.max(-f+n,0)/n;let w=0;w+=Math.max(_-(t-4*n),0)/(4*n),w+=Math.max(f-(e-4*n),0)/(4*n),w+=Math.max(-_+4*n,0)/(4*n),w+=Math.max(-f+4*n,0)/(4*n),p[f][_]=0;for(let b=0;b<o.length;b++){let[v,k]=s[b];u[f][_]+=o[b][f][_]*k+g+w/16}$[f][_]=null}}let S=0,A=(e-2*n)*(t-2*n)/2.5,[C,E]=[e/2,t/2],[z,q]=[C,E];for(;u[z][q]>.15;){let j=ef(cardinaldirections);for(let W=0;W<1;W++)z+=j[W][0],q+=j[W][1]}let F=[[z,q]],D=[],R=!1,B=0;for(;(S<A||!1==R)&&S<9999999;){let G;if(D.length>B)G=D[B],B++;else{let M=1,O=0;for(let T=0;T<F.length;T++){let[L,P]=F[T],N=u[L][P];if(N<.15){G=F.splice(T,1)[0];break}N<M&&(M=N,O=T),T==F.length-1&&(G=F.splice(O,1)[0])}}if(!G)break;let[H,I]=G;function U([n,i]){if(0!=n&&!(n>=e-1)&&0!=i&&!(i>=t-1)&&0==p[n][i]){p[n][i]=1,u[n][i]>.15?(R=!0,p[n][i]=1):R=!1,u[n][i]<.15-.1&&(p[n][i]=4);let s=ef(cardinaldirections);for(let a=0;a<4;a++){let[o,l]=s[a],[c,h]=[n+o,i+l];0==p[c][h]&&(u[c][h]<.15?D.push([c,h]):F.push([c,h]))}S++}}U(G)}[$,[tx,ty]]=ep([[z,q]]);let[Q,K]=[tx,ty],[J,[V,X]]=ep([[tx,ty]]),Z=[];!function n(i,s){for(let o=0;o<e;o++){m[o]=[];for(let l=0;l<t;l++)m[o][l]=null}let c=[...i],h=ep(c),d=h[0],u=h[1],$=h[2],f=h[3];for(;c.length<=s;){let _=em(d,[u],$,f);d=_[0],u=_[1],$=_[2],f=_[3],c.push(u)}let g=[];for(let w=0;w<c.length;w++){let[b,v]=c[w];m[b][v]=w,Z[w]=new a,Z[w].grid=p,Z[w].tiles=[[b,v]],g.push([b,v])}let k=g.slice(),S=[];for(let A=0;A<k.length;A++){let[C,E]=k[A],z=m[C][E],q=ef(cardinaldirections);for(let j=0;j<4;j++){let[W,F]=q[j],[D,R]=[C+W,E+F],B=m[D][R];null===B&&(0!==p[D][R]?(m[D][R]=z,Z[z].tiles.push([D,R]),k.push([D,R])):(m[D][R]=z,Z[z].walltiles.push([D,R]),S.push([D,R]))),0===p[D][R]||null===m[D][R]||m[D][R]===z||(Z[z].edgetiles||(Z[z].edgetiles=[]),Z[z].edgetiles.push([C,E]),Z[z].edges||(Z[z].edges={}),Z[z].edges[B]||(Z[z].edges[B]=[]),Z[z].edges[B].push([C,E]),Z[z].neighbors||(Z[z].neighbors=[]),Z[z].neighbors.includes(B)||(Z[z].neighbors.push(B),Z[z].neighborsnonindex.push(Z[B])),Z[B].neighbors.includes(z)||(Z[B].neighbors.push(z),Z[B].neighborsnonindex.push(Z[z])))}}let G=S.slice();for(let M=0;M<G.length;M++){let[O,T]=G[M],L=m[O][T];for(let P=0;P<4;P++){let[N,H]=cardinaldirections[P],[I,U]=[O+N,T+H];void 0!==m[I]&&void 0!==m[I][U]&&m[I][U]!==L&&null===m[I][U]&&(m[I][U]=L,Z[L].walltiles.push([I,U]),Z[L].walltiles.length<Z[L].tiles.length&&G.push([I,U]))}}for(let Q=0;Q<Z.length;Q++)Z[Q].generategrid()}([[Q,K],[V,X]],i);let Y=function e([t,n],[i,s],a,o){let l=0,c=[];for(;c.length<o;){c=[];let h=[[i,s]],d=[];for(let u=0;u<a.length;u++){d[u]=[];for(let $=0;$<a[0].length;$++)d[u][$]=a[u][$]}for(;h.length>0;){let[p,m]=h.shift();c.push([p,m]);for(let f=0;f<4;f++){let[_,g]=cardinaldirections[f],[w,b]=[p+_,m+g];9999!==d[w][b]&&(d[w][b]<d[p][m]||Math.random()<l)&&h.push([w,b])}d[p][m]=null}l<.4?l+=.1:l+=.01}return c}([Q,K],[V,X],J,S/3),ee,et;for(let en=0;en<Y.length;en++){let[ei,es]=Y[en];Z[m[ei][es]].onhotpath=!0,en==Y.length-1&&(Z[m[ei][es]].origin=!0,ee=Z[m[ei][es]]),0==en&&(Z[m[ei][es]].boss=!0,et=Z[m[ei][es]])}(function e(t,n,i){t.depth=n;for(let s=0;s<t.neighbors.length;s++){let a=Z[t.neighbors[s]];(void 0===a.depth||a.depth>n+1)&&e(a,n+1,t)}})(ee,0),function e(t,n,i){t.hotdepth=0,!0==t.onhotpath&&(t.hotdepth=0);for(let s=0;s<t.neighbors.length;s++){let a=Z[t.neighbors[s]];(void 0===a.hotdepth||a.hotdepth>t.hotdepth+1)&&e(a,t.hotdepth+1,t)}}(ee,0),function e(){let t=!0,n=0;for(;!0==t&&n<100;){t=!1;for(let i=0;i<Z.length;i++){let s=Z[i];s.maxhotdepth<s.hotdepth&&(s.maxhotdepth=s.hotdepth,t=!0);for(let a=0;a<s.neighbors.length;a++){let o=Z[s.neighbors[a]];o.maxhotdepth<s.maxhotdepth&&0!==o.maxhotdepth&&(o.maxhotdepth=s.maxhotdepth,t=!0)}}n++}}();let ea=et.depth,er=Math.ceil(ea/2);for(let eo=0;eo<Z.length;eo++){let el=Z[eo];el.depth==er&&!0==el.onhotpath?el.halfboss=!0:1==Math.abs(el.depth-er)&&!0==el.onhotpath&&(el.halfbossbuffer=!0),el.depth>ea*(3/4)&&!0==el.onhotpath&&(el.bossbuffer=!0)}for(let ec=0;ec<Z.length;ec++){let eh=Z[ec];eh.dungeon=Math.random()>.8,!0===eh.halfboss&&(eh.dungeon=!0),!0===eh.halfbossbuffer&&(eh.dungeon=!0),eh.dungeon&&!eh.halfboss&&!eh.halfbossbuffer&&(Math.random()>.5||eh.depth<ea/3)&&(eh.ruins=!0),eh.miniboss=eh.hotdepth>2&&eh.maxhotdepth==eh.hotdepth,eh.dungeon&&Math.random()>.75&&(eh.miniboss=!0),eh.updateneighbors(),eh.restructure(),eh.findspawnpoints()}for(let ed=0;ed<Z.length;ed++)Z[ed].updateneighbors();function eu([e,t],[n,i],s){let[a,o]=[n,i],l=[];for(;0!==s[a][o];){l.push([a,o]);for(let c=0;c<4;c++){let[h,d]=directions[c],[u,$]=[a+h,o+d];if(9999!==s[u][$]&&s[u][$]<s[a][o]){[a,o]=[u,$];break}}}return l}function e$([e,t],[n,i],s){let a=[],o=[[n,i]];for(;o.length>0;){let[l,c]=o.shift();a.push([l,c]);for(let h=0;h<4;h++){let[d,u]=cardinaldirections[h],[$,p]=[l+d,c+u];9999!==s[$][p]&&s[$][p]<s[l][c]&&o.push([$,p])}s[l][c]=null}return a}function ep(n){let i=[];for(let s=0;s<e;s++)i[s]=new Uint16Array(t).fill(9999);return em(i,n)}function em(n,i,s,a){dtiles=i.slice(),steps=0;let[o,l]=[0,0],[c,h]=[0,0],d=0,u=0;for(;;){let $=dtiles.length;for(;u<$;){if([c,h]=dtiles[u],!a&&0==p[c][h]||(d=n[c][h],a&&9999==d)){u++;continue}d>steps&&(n[c][h]=steps,a&&(s[a[c][h]+2]=steps),dtiles.push([c,h+1]),dtiles.push([c,h-1]),dtiles.push([c+1,h]),dtiles.push([c-1,h])),u++}if(steps++,dtiles.length==$)break}if(!s){s=[],a=[];let m,f=e,_=t;for(let g=0;g<f;g++){a[g]=[],m=n[g];for(let w=0;w<_;w++)9999!=(d=m[w])&&(a[g][w]=s.length,s.push(g),s.push(w),s.push(n[g][w]))}}let b=performance.now(),v=0,k=0,S=0,A=s.length;for(let C=2;C<A;C+=3)(d=s[C])>v&&(h=s[C-1],c=s[C-2],v=d,k=c,S=h);let E=performance.now()-b;return dtime_partial+=E,[n,[k,S],s,a]}function ef(e){let t=e.length,n,i=e.slice();for(;t>0;)n=Math.floor(Math.random()*t),t--,[i[t],i[n]]=[i[n],i[t]];return i}return[p,Z]}function perlinNoise(e,t,n){let i={rand_vect:function(){let e=2*Math.random()*Math.PI;return{x:Math.cos(e),y:Math.sin(e)}},dot_prod_grid:function(e,t,n,i){let s,a={x:e-n,y:t-i};this.gradients[n]||(this.gradients[n]=[]);let o=this.gradients[n][i];return o?s=o:(s=this.rand_vect(),this.gradients[n][i]=s),a.x*s.x+a.y*s.y},smootherstep:function(e){return 6*e**5-15*e**4+10*e**3},smoothstep:function(e){return -2*e**3+3*e**2},interp:function(e,t,n){return t+this.smoothstep(e)*(n-t)},seed:function(){this.gradients={}},get:function(e,t){let n=Math.floor(e),i=Math.floor(t),s=this.dot_prod_grid(e,t,n,i),a=this.dot_prod_grid(e,t,n+1,i),o=this.dot_prod_grid(e,t,n,i+1),l=this.dot_prod_grid(e,t,n+1,i+1),c=this.interp(e-n,s,a),h=this.interp(e-n,o,l);return this.interp(t-i,c,h)}},s=Math.random();i.seed(s);let a=[];for(let o=0;o<t;o++){a[o]=[];for(let l=0;l<e;l++)a[o][l]=i.get((o+s)/n,(l+s)/n)}return a}gameText=document.getElementById("game-text"),canvas=document.getElementById("myCanvas");const ctx=canvas.getContext("2d"),ratio=window.devicePixelRatio;let width=window.innerWidth,height=window.innerHeight;canvas.width=width*ratio,canvas.height=height*ratio,canvas.style.width=width+"px",canvas.style.height=height+"px";const offscreen=document.createElement("canvas"),offCtx=offscreen.getContext("2d");function getMousePos(e,t){var n=e.getBoundingClientRect();return[t.clientY-n.top,t.clientX-n.left]}canvas.addEventListener("mousemove",function(e){updatedsomething=!0;let t=getMousePos(canvas,e),n;((newpos=[viewportpos[0]+Math.floor(t[0]/fontsize)-viewportsizey/2,viewportpos[1]+Math.floor(t[1]/fontsize)-viewportsizex/2])[0]!==cursorpos[0]||newpos[1]!==cursorpos[1])&&(cursorpos[0]=newpos[0],cursorpos[1]=newpos[1])}),canvas.addEventListener("mousedown",e=>{if(keyglossary=!1,!0!=controllock&&0==e.button){if(e.ctrlKey){moveallplayers();return}if(!1==controllock&&!1==uilock&&moveplayer(),!1==controllock&&!0==uilock&&"attack"==uilocktype){let t=playercs[activecharacter],n=new Attack(...actions.Attack,t.getrange(),cursorpos,t,t.pos),i=n.func(!0);canAffordAction(n,t)&&0==i.errors.length&&(t.actionqueue.push(n),playertick(t)),uilock=!1}if(!1==controllock&&!0==uilock&&"jump"==uilocktype){let s=activecharacternonindex,a=Math.max(s.stats[0]+.5,2),o=new Jump(a,cursorpos,s,s.pos);s.actionqueue.push(o),canAffordAction(s.actionqueue[0],s)&&playertick(s),uilock=!1}if(!1==controllock&&!0==uilock&&"kick"==uilocktype){let l=activecharacternonindex,c=new Kick(cursorpos,l,l.pos);l.actionqueue.push(c),canAffordAction(l.actionqueue[0],l)&&playertick(l),uilock=!1}}}),document.addEventListener("keydown",function(e){if(!0==uilock&&"map"==uilocktype&&("<"===e.key&&xstep<4&&(xstep+=.5,ystep+=.5,updatemap()),">"===e.key&&xstep>1&&(xstep-=.5,ystep-=.5,updatemap()),"ArrowLeft"===e.key&&viewfinderpos[1]>4*xstep&&(viewfinderpos[1]-=Math.ceil(4*xstep),updatemap()),"ArrowRight"===e.key&&viewfinderpos[1]<mapsizex-4*xstep&&(viewfinderpos[1]+=Math.ceil(4*xstep),updatemap()),"ArrowUp"===e.key&&viewfinderpos[0]>4*ystep&&(viewfinderpos[0]-=Math.ceil(4*ystep),updatemap()),"ArrowDown"===e.key&&viewfinderpos[0]<mapsizey-4*ystep&&(viewfinderpos[0]+=Math.ceil(4*ystep),updatemap())),e.repeat)return;("r"===e.key&&gameover||won)&&(won&&ngplus++,won=!1,gameover=!1,uilock=!1,controllock=!1,gridinit(),updatelighting());let t=activecharacternonindex;if(!0==controllock){!0==activecharacternonindex.pc&&(activecharacternonindex.actionqueue=[],bufferedinputs=[]);return}if("Space"===e.code||" "===e.key){if(e.ctrlKey&&!1==controllock)for(;!1==controllock;)playerendturn();else!1==controllock&&playerendturn()}if("Control"==e.key&&(ctrl=!0),"m"==e.key&&(!1==uilock?(uilock=!0,uilocktype="map",updatedsomething=!0):(uilock=!1,updatedsomething=!0)),"c"==e.key&&(!1==uilock?(uilock=!0,uilocktype="credits",updatedsomething=!0):(uilock=!1,updatedsomething=!0)),"o"==e.key&&(uilock&&(uilock=!1),!1==controllock&&!1==uilock&&t.tc[1]>=1&&(t.actionqueue=[],t.actionqueue.push(new action("Overwatch",startoverwatch,[0,1,0],0,t.pos,t,t.pos)),move(t))),"j"==e.key&&(r=playercs[activecharacter],t.tc[1]>=1&&(!1==uilock?(uilock=!0,updatedsomething=!0):(uilock=!1,updatedsomething=!0)),uilocktype="jump"),"k"==e.key&&(r=playercs[activecharacter],t.tc[1]>=1&&(!1==uilock?(uilock=!0,updatedsomething=!0):(uilock=!1,updatedsomething=!0)),uilocktype="kick"),"d"===e.key&&!1==controllock&&t.tc[1]>=1&&(t.actionqueue.push(new action("Dash",dashfunc,[0,1,0],0,t.pos,t,t.pos)),playertick(t)),"s"===e.key&&!1==controllock&&t.tc[0]>=t.tcmax[0]&&(t.actionqueue.push(new action("Stand Ground",standgroundfunc,[t.tcmax[0],0,0],0,t.pos,t,t.pos)),playertick(t)),"a"===e.key&&!1==controllock){let n=playercs[activecharacter];n.tc[1]>=1&&(!1==uilock?(uilock=!0,updatedsomething=!0):(uilock=!1,updatedsomething=!0)),uilocktype="attack"}if("D"===e.key&&((autodash=!autodash)?adduilabel("auto-dash enabled",activecharacternonindex.pos,[128,128,128],0,!0):adduilabel("auto-dash disabled",activecharacternonindex.pos,[128,128,128],0,!0)),"S"===e.key&&((autosg=!autosg)?adduilabel("auto-stand-ground enabled",activecharacternonindex.pos,[128,128,128],0,!0):adduilabel("auto-stand-ground disabled",activecharacternonindex.pos,[128,128,128],0,!0)),"V"===e.key&&((verbose=!verbose)?adduilabel("verbose tool-tips enabled",activecharacternonindex.pos,[128,128,128],0,!0):adduilabel("verbose tool-tip disabled",activecharacternonindex.pos,[128,128,128],0,!0)),"A"===e.key&&((autoadv=!autoadv)?adduilabel("auto-advance enabled",activecharacternonindex.pos,[128,128,128],0,!0):adduilabel("auto-advance disabled",activecharacternonindex.pos,[128,128,128],0,!0)),"x"===e.key&&!1===controllock){let i=playercs[activecharacter],s=new action(...actions.SwitchWeapon,0,i.pos,i,i.pos);i.actionqueue.push(s),playertick()}if("X"===e.key&&!1===controllock){let a=playercs[activecharacter],o=[0,0,0];"Unarmed"!==a.primaryitem.name&&(o=[0,1,0]);let l=new action("Switch Weapon",switchweaponalt,o,0,a.pos,a,a.pos);a.actionqueue.push(l),playertick()}if("g"===e.key&&!1===controllock&&!1===uilock){let c=playercs[activecharacter];newgrid[c.pos[0]][c.pos[1]].objects.length>0&&newgrid[c.pos[0]][c.pos[1]].objects[0]instanceof Item&&(c.actionqueue.push(new action("Get",getfunc,[0,0,0],0,c.pos,c,c.pos)),playertick())}if("l"===e.key&&!1===controllock&&!1===uilock){let h=playercs[activecharacter];h.actionqueue.push(new action("Leave",leavefunc,[0,0,0],0,h.pos,h,h.pos)),playertick()}if("L"===e.key&&!1===controllock&&!1===uilock){let d=playercs[activecharacter];d.actionqueue.push(new action("Leave",leavefuncoffhand,[0,0,0],0,d.pos,d,d.pos)),playertick()}if("+"===e.key&&brightnessadjust<5.1&&(brightnessadjust+=.1,console.log(brightnessadjust),updatedsomething=!0),"-"===e.key&&brightnessadjust>.4&&(brightnessadjust-=.1,console.log(brightnessadjust),updatedsomething=!0),"?"===e.key?(keyglossary=!keyglossary,updatedsomething=!0):"Shift"!=e.key&&(keyglossary=!1,updatedsomething=!0),!isNaN(e.key)){let u=e.key-1;u>-1&&playercs.length>0&&playercs.length>u&&playercs[u]&&!1==playercs[u].dead&&(uilock=!1,activecharacter=u,activecharacternonindex=playercs[u],updateGrid())}}),document.addEventListener("keyup",function(e){"Control"==e.key&&(ctrl=!1)});let viewportpos=[0,0],gameover=!1,won=!1,deathcharacter=null,cursorpos=[0,0],keyglossary=!1,itemmap=[],newgrid=[],noisemap=Array(mapsizey).fill(null).map(()=>Array(mapsizex).fill(1)),nonpcshere=[],objectshere=[],envobjects=[],playercs=[],nonpcs=[],turncounter=0,activecharacter=0,activecharacternonindex=null,tickcounter=0,ctrl=!1,autodash=!1,autosg=!1,autoadv=!1,bufferedinputs=[],controllock=!1,uilock=!1,uilocktype="",map=[],ngplus=0,traversemap=[],xstep=2,ystep=2,viewfinderpos=[0,0],tutorial=!1,verbose=!0,lightsources=[],messageQueue=[],isProcessing=!1;function gridinit(){for(let e=0;e<mapsizey;e++){newgrid[e]=[];for(let t=0;t<mapsizex;t++)newgrid[e][t]=0}envobjects=[],score=0;for(let n=0;n<mapsizey;n++)for(let i=0;i<mapsizex;i++)newgrid[n][i]||(newgrid[n][i]=new Tile(...tiletypesarr[3],[n,i])),tutorial&&(newgrid[n][i]=new Tile(...tiletypesarr[2],[n,i]));generate(),updatecharacters();for(let s=0;s<mapsizey;s++)for(let a=0;a<mapsizex;a++);let[o,l]=[mapsizey/2,mapsizex/2];elevupdate(),updateGrid(),updatecharactershere(),updateGrid(),0==ngplus&&adduilabel("Press ? for controls",viewportpos,[256,256,256],0,!0,!1,!1,!0,5),ngplus>0&&adduilabel(`Party number ${ngplus+1}`,viewportpos,[256,256,256],0,!0,!1,!1,!0,5),drawGrid(!0),nonpcs.forEach(function(e){spot(e)}),updatemap()}function updatemap(){traversemap.length||function e(){for(let t=0;t<mapsizey;t++){traversemap[t]=[];for(let n=0;n<mapsizex;n++)traversemap[t][n]=0}let[i,s]=playercs[0].pos;for(let a=0;a<mapsizey;a++)for(let o=0;o<mapsizex;o++)!0==newgrid[a][o].traversable&&(traversemap[a][o]=1),!0==newgrid[a][o].slope&&(traversemap[a][o]=1),newgrid[a][o].objects.length>0&&(traversemap[a][o]=1);let l=0;for(;;){l++;let c=!1,h=[];for(let d=0;d<mapsizey;d++)for(let u=0;u<mapsizex;u++)if(1==traversemap[d][u])for(let $=0;$<4;$++){let[p,m]=directions[$],[f,_]=[d+p,u+m];void 0!==traversemap[f]&&void 0!==traversemap[f][_]&&0==traversemap[f][_]&&h.push([d,u])}for(let g=0;g<h.length;g++){let[w,b]=h[g],v=[];for(let k=0;k<8;k++){let[S,A]=directions[k],[C,E]=[w+S,b+A];void 0!==traversemap[C]&&void 0!==traversemap[C][E]&&0!==traversemap[C][E]&&v.push([E,C])}if(v.length>1){let[z,q]=v.shift(),j=[[z,q]];for(;j.length>0&&v.length>0;){let[W,F]=j.shift();for(let D=0;D<4;D++){let[R,B]=directions[D],[G,M]=[W+R,F+B];for(let O=0;O<v.length;O++){let[T,L]=v[O];if(G==T&&M==L){v.splice(O,1),j.push([G,M]);break}}}}v.length>0||(traversemap[w][b]=0,c=!0)}else 0==v.length&&(traversemap[w][b]=0,c=!0)}if(!c)break}}();let e=[];for(let t=0;t<viewportsizey;t++){map[t]=[];for(let n=0;n<viewportsizex;n++){map[t][n]=[.02,.02,.02];let i=!1,s=[0,0,0],a=[],o=!1,l=!1;for(let c=0;c<ystep;c++)for(let h=0;h<xstep;h++){let[d,u]=[viewfinderpos[0]-ystep*viewportsizey/2,viewfinderpos[1]-xstep*viewportsizex/2],[$,p]=[d+t*ystep+c,u+n*xstep+h];if([$,p]=[Math.floor($),Math.floor(p)],newgrid[$]&&newgrid[$][p]){if(!newgrid[$][p].seen)continue;if(1==traversemap[$][p]&&(l=!0),!0==newgrid[$][p].traversable&&(!o||l)){if(i=!0,a.push(newgrid[$][p].absorbtionBase.slice()),symbol=newgrid[$][p].symbolBase,newgrid[$][p].character&&!0==newgrid[$][p].visible){let m=newgrid[$][p].character,f=!1;for(let _=0;_<e.length;_++)if(e[_]==m){f=!0;break}f||e.push(newgrid[$][p].character)}}else if(!l){o=!0;let g=newgrid[$][p].absorbtionBase.slice();for(let w=0;w<3;w++)g[w]=g[w]/4;a=[g]}}}for(let b=0;b<a.length;b++)for(let v=0;v<3;v++)s[v]+=a[b][v]/(2*a.length);s[0]*=.9,s[1]*=.7,s[2]*=.5,i&&(map[t][n]=s.slice()),o&&(map[t][n]=s.slice())}}for(let k=0;k<e.length;k++){let S=e[k],[A,C]=[S.pos[0]-viewfinderpos[0],S.pos[1]-viewfinderpos[1]];A=Math.floor(A/ystep)+viewportsizey/2,C=Math.floor(C/xstep)+viewportsizex/2;let E=S.color.slice();E.push(S.symbol),map[A][C][3]=E}let[z,q]=viewfinderpos,[j,W]=[viewportsizey/2,viewportsizex/2]}function elevupdate(){for(let e=0;e<mapsizey;e++)for(let t=0;t<mapsizex;t++){if(!newgrid[e][t].traversable)continue;let n=[e,t],i=[],s=[],a=[],o=[];if(cardinaldirections.forEach(function(a){let[o,l]=a.map((e,t)=>e+n[t]);newgrid[o]&&newgrid[o][l]&&newgrid[o][l].traversable&&newgrid[e][t].elevation-newgrid[o][l].elevation<=-2&&(i.push(o),s.push(l))}),directions.forEach(function(i){let[s,l]=i.map((e,t)=>e+n[t]);newgrid[s]&&newgrid[s][l]&&newgrid[s][l].traversable&&newgrid[e][t].elevation-newgrid[s][l].elevation<=-2&&(a.push(s),o.push(l))}),i.length>0){if(!0==newgrid[e][t].ramp)break;let l=[takeav(a),takeav(o)];newgrid[e][t].traversable=!1,newgrid[e][t].slope=!0,newgrid[e][t].symbolBase=linecharacter([e,t],l),newgrid[e][t].delta=[Math.ceil(Math.abs(l[0]-e))*Math.sign(l[0]-e),Math.ceil(Math.abs(l[1]-t))*Math.sign(l[1]-t)]}}for(let c=0;c<mapsizey;c++)for(let h=0;h<mapsizex;h++){let d=newgrid[c][h],u=d.elevation,$=[],p=[];if(cardinaldirections.forEach(function(e){let[t,n]=e.map((e,t)=>e+[c,h][t]);newgrid[t]&&newgrid[t][n]&&(newgrid[t][n].elevation==u-1&&$.push([t,n]),newgrid[t][n].elevation==u+1&&p.push([t,n]))}),p.length>0&&$.length>0){let m=!1;newgrid[c][h].traversable&&(newgrid[c][h].ramp=!0,p.forEach(function([e,t]){$.forEach(function([n,i]){let s=e-n,a=t-i;2==s&&0==a&&(newgrid[c][h].traversable=!0,newgrid[c][h].symbolBase="&#25B2",m=!0),-2==s&&0==a&&(newgrid[c][h].traversable=!0,newgrid[c][h].symbolBase="&#25BC",m=!0),2==a&&0==s&&(newgrid[c][h].traversable=!0,newgrid[c][h].symbolBase="&#25C0",m=!0),-2==a&&0==s&&(newgrid[c][h].traversable=!0,newgrid[c][h].symbolBase="&#25B6",m=!0)})}),!1==m&&(newgrid[c][h].traversable=!0,newgrid[c][h].symbolBase="*"))}}}function alinedraw(e,t,n){if(!playercs[activecharacter]||!e||0==e.length)return;let i=translateAStoAQ(e,n),s=n.tc.slice(),a=n.pos,o=!1;for(let l=0;l<i.length;l++){let[c,h]=i[l].target;if(l>0&&(a=i[l-1].target),s[0]-i[l].cost[0]<0&&s[1]>0&&!0==autodash&&(s[0]+=n.tcmax[0],s[1]-=1,o=!0),!(s[0]>=i[l].cost[0])||!(s[1]>=i[l].cost[1]))return s;{if("Move"==i[l].name){let d=[.25*(cost=i[l].cost[0])**2,.25,.25];!0==o&&(d[0]=d[0],d[1]=d[1],d[2]=d[2]/2),adduilabel("$",[c,h],d,0,!1)}if("Attack"==i[l].name){let u=bresenhamLine(a,i[l].target),$=linecharacter(a,i[l].target);for(let p=1;p<u.length;p++){let[m,f]=u[p];adduilabel($,[m,f],[1,1,1],0,!1)}}let _=32*Math.sin(now/100)+96;0!==i[l].warnings.length&&adduilabel(i[l].warnings[0],i[l].pos,[_,0,0],1,!1,!1),s=s.map((e,t)=>e-i[l].cost[t])}if(l==i.length-1)return s}}function addanimation(e,t,n,i=.5,s=!0,a=!1,o=0){let l=e.length;for(let c=0;c<l;c++){let[h,d]=e[c];if(!newgrid[h]||!newgrid[h][d])continue;let u=t[c%t.length];(!0==newgrid[h][d].visible||!0==a)&&newgrid[h][d].uiElements.push(new uielement(u,n,e[c],s,a,[now+o+1e3*i,now+o]))}updatedsomething=!0}function noiseupdate(){if(procgendebug)return;let e=viewportpos[1]-Math.floor(viewportsizex/2),t=viewportpos[0]-Math.floor(viewportsizey/2),n=viewportpos[1]+Math.floor(viewportsizex/2),i=viewportpos[0]+Math.floor(viewportsizey/2);t<0&&(t=0,i=viewportsizey),i>mapsizey&&(i=mapsizey,t=mapsizey-viewportsizey),e<0&&(e=0,n=viewportsizex),n>mapsizex&&(n=mapsizex,e=mapsizex-viewportsizex);let s=!1;for(let a=t;a<i;a++)for(let o=e;o<n;o++)if(!1!==newgrid[a][o].visible){let l=takeav(newgrid[a][o].light)/256,c=newgrid[a][o].readLightsource();if(Math.random()>.5+l**.05*.5){let h=.9+.2*Math.random();noisemap[a][o]=h}for(let d=0;d<c.length;d++){let u=c[d];if(u&&(Math.random()>.8||1==u.radiance&&Math.random()>.5)){s=!0;let $=.9+.2*Math.random();noisemap[a][o]=$}}}s?updatedlighting=!0:updatedsomething=!0,updateambientsound()}function updateGrid(){if(gameover)return;let e=function e(){let t=[],n=[],i=[];for(let s=0;s<playercs.length;s++)if(!1==playercs[s].dead){n.push(playercs[s].pos[0]),i.push(playercs[s].pos[1]);break}if(0!=n.length)return[Math.round(takeav(n)),Math.round(takeav(i))]}();if(e&&dist(e,viewportpos)>2){let t=viewportpos[0]-e[0],n=viewportpos[1]-e[1];viewportpos[0]=e[0],viewportpos[1]=e[1],cursorpos[0]-=t,cursorpos[1]-=n,updatedsomething=!0,viewportpos[0]-viewportsizey/2<0&&(viewportpos[0]=viewportsizey/2),viewportpos[1]-viewportsizex/2<0&&(viewportpos[1]=viewportsizex/2),viewportpos[0]+viewportsizey/2>mapsizey&&(viewportpos[0]=mapsizey-viewportsizey/2),viewportpos[1]+viewportsizex/2>mapsizex&&(viewportpos[1]=mapsizex-viewportsizex/2)}viewfinderpos=viewportpos.slice(),updatemap()}function updateconditions(e){for(let t=e.conditions.length-1;t>=0;t--)e.conditions[t].duration--,e.conditions[t].duration<=-1?(null!=e.conditions[t].endeffect&&e.conditions[t].endeffect(),e.conditions.splice(t,1)):e.conditions[t].turneffect()}function updatetraitspassive(){for(let e=0;e<nonpcshere.length;e++){let t=nonpcshere[e];if(!0!==t.dead)for(let n=0;n<t.traits.length;n++){let i=t.traits[n];!0==i.passive&&!0==i.trigger()&&i.effect()}}for(let s=0;s<playercs.length;s++){let a=playercs[s];if(!0!=a.dead)for(let o=0;o<a.traits.length;o++){let l=a.traits[o];!0==l.passive&&!0==l.trigger()&&l.effect()}}for(let c=0;c<objectshere.length;c++){let h=objectshere[c];for(let d=0;d<h.effects.length;d++){let u=h.effects[d];u(h)}}}function updatetraitsactive(e){for(let t=0;t<e.traits.length;t++){let n=e.traits[t];!0==n.active&&!0==n.trigger()&&n.effect()}}function startplayerturn(){if(won)controllock=!0;else if(gameover){enemyturn();return}let e,t=!1;for(let n=0;n<playercs.length;n++)!1==(e=playercs[n]).dead&&(t=!0),e.tc=e.tcmax.slice(),updateconditions(e);t?playerturn():(controllock=!0,gameover=!0)}function playerturn(){0==activecharacter&&turncounter++,!0==(pc=playercs[activecharacter]).dead&&playerendturn(),controllock=!1,activecharacternonindex=playercs[activecharacter]}function playertick(){if(gameover)return;controllock=!0;let e=playercs[activecharacter];if(e.hp<=0&&(e.dead=!0),!0==e.dead){playerendturn();return}if(e.actionqueue.length>0){let t=1;canAffordAction(e.actionqueue[0],e)?(e.actionqueue[1]&&e.actionqueue[1].cost[1]>0&&"Dash"!==e.actionqueue[1].name&&(t=2.5),e.actionqueue[0].cost[1]>0&&"Dash"!==e.actionqueue[0].name&&(t=2.5),move(e),updatetraitspassive()):e.actionqueue=[],setTimeout(playertick,ticktimer*t),updateGrid();return}playercs[activecharacter].actionqueue=[],0==playercs[activecharacter].actionqueue.length&&(0==playercs[activecharacter].tc[0]&&0==playercs[activecharacter].tc[1]&&0==bufferedinputs.length&&autoadv?playerendturn():releasecontrollock())}function releasecontrollock(){controllock=!1,triggerbufferedinput()}function playerendturn(){if(updatetraitspassive(),updatecharactershere(),uilock=!1,!1==gameover&&++activecharacter<playercs.length){if(!0==playercs[activecharacter].dead){playerendturn();return}playerturn();return}activecharacter=0,controllock=!0,updateEnvironment(),setTimeout(enemyturn,ticktimer)}function restcheck(){let e=0;playercs.forEach(function(t){(!0!==lackscondition(conditions.Resting,t)||!0==t.dead||!0!==lackscondition(conditions.Overwatch,t))&&e++}),e==playercs.length&&playercs.forEach(function(e){!e.dead&&e.hp<e.maxhp&&(e.heal(e.maxhp-e.hp),directions.forEach(function(t){let[n,i]=t.map((t,n)=>t+e.pos[n]);if(newgrid[n][i].objects.length>0){let s=newgrid[n][i].objects[0];s instanceof bonfire&&s.extinguish()}}))})}function updateEnvironment(){let e=envobjects.slice();for(envobjects=[];e.length>0;){let t=e.shift();t.update()}}function enemyturn(){if(0==activecharacter&&(enemyturnstart=performance.now()),activecharacter>=nonpcshere.length){activecharacter=0,startplayerturn();return}let e=nonpcshere[activecharacter];if(activecharacternonindex=e,activecharacter++,manhattanDistance(e.pos,viewportpos)<dontcaredistance&&!1==e.dead){e.tc=e.tcmax.slice(),tickcounter=0,updateconditions(e),e.update(),updatetraitsactive(e),function e(t){let n=1;if(++tickcounter>20){t.actionqueue=[],enemyturn();return}if(t.hp<=0&&(t.dead=!0),!0==t.dead){enemyturn();return}if(t.tc[0]>0||t.tc[1]>0){if(t.actionqueue.length>0){if(canAffordAction(t.actionqueue[0],t)){t.actionqueue[1]&&"End Turn"==t.actionqueue[1].name&&!0==gameover&&(n=Math.round(50*Math.random())),t.actionqueue[0].cost[1]>0&&"Dash"!=t.actionqueue[0].name&&(n=5),(!t.actionqueue[1]||t.actionqueue[1].cost[1]>0&&"Dash"!=t.actionqueue[1].name)&&(n=5);let[i,s]=t.actionqueue[0].target;!0!==newgrid[t.pos[0]][t.pos[1]].visible&&!0!==newgrid[i][s].visible&&(n=0),move(t)}else{t.actionqueue=[],enemyturn();return}}else{let a=planturn(t);if(a.length>0){if(t.actionqueue=a.slice(),t.actionqueue.push(new endTurn("End Turn",endturnfunc,[0,0,0],0,t.pos,t,t.pos)),t.actionqueue.length<2){enemyturn();return}}else{t.actionqueue=[],enemyturn();return}}}t.tc[0]>0||t.tc[1]>0?(!0!==newgrid[t.pos[0]][t.pos[1]].visible&&(n=0),t.actionqueue[0]&&t.actionqueue[0].loudness&&t.actionqueue[0].loudness>=chebyshevDistance(viewportpos,t.pos)&&(n=Math.max(1,n)),setTimeout(function(){e(t),updateGrid()},ticktimer*n)):(t.actionqueue=[],enemyturn())}(e);return}enemyturn()}function aStar(e,t,n=100,i=0){let s=mapsizey,a=mapsizex;function o(n,i){let o=!0;return null!==newgrid[n][i].character&&(n!==e[0]||i!==e[1])&&(n!==t[0]||i!==t[1])&&(o=!1),n>=0&&i>=0&&n<s&&i<a&&!0===newgrid[n][i].traversable&&!0==o}let l=new PriorityQueue((e,t)=>e.f-t.f),c=Array(s).fill(null).map(()=>Array(a).fill(1/0)),[h,d]=e;c[h][d]=0,l.enqueue({x:d,y:h,f:0});let u=bresenhamLine(e,t),$=1,p=0;for(;!l.isEmpty();){let m=l.dequeue();if(m.x===t[1]&&m.y===t[0]||dist([m.y,m.x],t)<=i){let f=[],_=m;for(;_;)f.push([_.y-e[0],_.x-e[1]]),_=_.parent;return f.pop(),f.reverse()}if(u.length>=$-1&&(m.y!=u[$-1][0]||m.x!=u[$-1][1])&&(u=bresenhamLine([m.y,m.x],t),$=1),p>n)break;for(let[g,w]of directions){let b=m.y+w,v=m.x+g;if(o(b,v)&&2>Math.abs(newgrid[b][v].elevation-newgrid[m.y][m.x].elevation)){let k=c[m.y][m.x]+newgrid[m.y][m.x].moveCost;if(k<c[b][v]){c[b][v]=k;let S=Math.abs(b-t[0]),A=Math.abs(v-t[1]),C;C=S>A?S+.9*A:A+.9*S,u.length>$&&b==u[$][0]&&v==u[$][1]&&(C=-.1);let E=k+C;l.enqueue({x:v,y:b,f:E,parent:m})}}}$++,p++}return null}function translateAStoAQ(e,t,n=!1){let i=[],s=[];if(e)for(let a=0;a<e.length;a++)s.push(e[a].map((e,n)=>e+t.pos[n])),0==a?i.push(e[a]):i.push(e[a].map((t,n)=>t-e[a-1][n]));let[o,l]=t.pos;s.length>0&&([o,l]=s[s.length-1]);let c=newgrid[o][l].character,h=newgrid[cursorpos[0]][cursorpos[1]].objects[0],d=!1,u=!1;null!==c&&c.pc!==t.pc&&!1==n&&(d=!0),h&&!1==d&&null!==h.action&&(u=!0);let $=[];if(d&&(t.primaryitem.consumable||t.primaryitem.ammotype&&!t.ammunition[t.primaryitem.ammotype]))return $;let p=t.pos,m;u&&dist(p,h.pos)<h.action[3]&&$.push(new action(...h.action,h.pos,t,p));for(let f=0;f<i.length;f++){f>0&&(p=s[f-1]),m=s[f];let _,g;if(d&&(g=(_=new Attack("Attack",attackfunc,[0,1,0],t.getrange(),c.pos,t,p)).func(!0)),d&&0==g.errors.length&&!_.internalwarning){$.push(_);break}if(u&&dist(p,h.pos)<h.action[3]){$.push(new action(...h.action,h.pos,t,p));break}{let w=[newgrid[s[f][0]][s[f][1]].moveCost,0,0];t.specialmove?$.push(new t.specialmove("Move",movefunc,w,1,s[f],t,p)):$.push(new Move("Move",movefunc,w,1,s[f],t,p))}}return $}function moveplayer(e=!1,t=[0,0]){let[n,i]=cursorpos;e&&([n,i]=t);let s=newgrid[n][i];if(s.character&&!0==s.character.pc&&!e){activecharacternonindex=s.character;for(let a=0;a<playercs.length;a++)playercs[a].index==activecharacternonindex.index&&(activecharacter=a);return!1}if(!1==s.seen)return!1;let o=aStar(playercs[activecharacter].pos,[n,i],500),l=null;if(s.objects.length>0&&null==s.character){let c=s.objects[0];null!==c.action&&(o=aStar(playercs[activecharacter].pos,[n,i],500,1.9),l=c.action)}if(!o)return!1;playercs[activecharacter].actionqueue=translateAStoAQ(o,playercs[activecharacter]).slice(),null!==l&&playercs[activecharacter].actionqueue.push(new action(...l,[n,i],playercs[activecharacter]));let h=0;for(let d=0;d<playercs[activecharacter].actionqueue.length;d++)h+=playercs[activecharacter].actionqueue[d].cost[0];let u=0;for(let $=0;$<playercs[activecharacter].actionqueue.length;$++)u+=playercs[activecharacter].actionqueue[$].cost[1];if(!0==autodash&&h>playercs[activecharacter].tc[0]&&playercs[activecharacter].tc[1]>=1&&playercs[activecharacter].actionqueue.unshift(new action("Dash",dashfunc,[0,1,0],0,playercs[activecharacter].pos,playercs[activecharacter])),!0==autosg&&u>playercs[activecharacter].tc[1]&&h<=playercs[activecharacter].tc[0]-playercs[activecharacter].tcmax[0]&&playercs[activecharacter].tc[0]>=playercs[activecharacter].tcmax[0]&&playercs[activecharacter].actionqueue.unshift(new action("Stand Ground",standgroundfunc,[playercs[activecharacter].tcmax[0],0,0],0,playercs[activecharacter].pos,playercs[activecharacter])),playercs[activecharacter].actionqueue.length>0)return playertick(),!0}function moveallplayers(){for(let e=0;e<playercs.length;e++){let t=playercs[e],n=cursorpos.slice();!1==t.dead&&bufferedinputs.push(function(){activecharacter=e,activecharacternonindex=playercs[e];moveplayer(!0,n)||(bufferedinputs=[])})}triggerbufferedinput()}function triggerbufferedinput(){let e=bufferedinputs.shift();e&&e()}function move(e){if(!0==e.dead)return;let[t,n]=e.pos,i=e.actionqueue.shift(),[s,a]=i.target;if(!i)return;let o=e.tc.slice();if(!(e.tc[2]<i.cost[2])){if(e.tc[2]-=i.cost[2],i instanceof Attack&&i.func(!0).errors.length>0&&(i.reactable=!1),i.reactable&&c(newgrid[t][n],e,i,!0),!(e.tc[0]<i.cost[0])&&!(e.tc[1]<i.cost[1])&&(!e.tc[3]||!i.cost[3]||!(e.tc[3]<i.cost[3]))){if(e.tc[0]-=i.cost[0],e.tc[1]-=i.cost[1],i.cost[3]&&(e.tc[3]-=i.cost[3]),!0==e.dead);else if(!1!==i.func()){if(i.reactable&&c(newgrid[s][a],e,i,!1),i.loudness){let l=new Sound(i.target,i.loudness,e,i.name);i.soundcontent&&(l.content=i.soundcontent),i.soundeffect&&(l.soundeffect=i.soundeffect),hear(l)}}else e.tc=o.slice();updatedsomething=!0,updatedlighting=!0}}function c(e,t,n,i=!1){let[s,a,o,l]=getlightingsize();updatelighting(s,a,o,l,!0);let c=[],h=[],d=[e,newgrid[n.target[0]][n.target[1]]],u=d.length;for(let $=0;$<u;$++){let p=d[$];for(let m=0;m<p.charactersinview.length;m++){let f=p.charactersinview[m];if(!0==f.pc||!0==f.dead);else{let _=!1;for(let g=0;g<c.length;g++)if(c[g]==f){_=!0;break}_||c.push(f)}}if(!0==p.visible){let w=playercs.length;for(let b=0;b<w;b++){if(!0==playercs[b].dead)continue;let v=playercs[b],k=!1;for(let S=0;S<c.length;S++)if(c[S]==v){k=!0;break}k||c.push(v)}}if(p.objecttriggers)for(let A=0;A<p.objecttriggers.length;A++){let C=p.objecttriggers[A],E=!1;for(let z=0;z<h.length;z++)if(h[z]==C){E=!0;break}E||h.push(C)}}for(let q=0;q<c.length;q++){let j=c[q];for(let W=0;W<j.reactions.length;W++)(0,j.reactions[W])(j,t,n,i)}for(let F=0;F<h.length;F++)h[F].react(null,t,n,i);for(let D=0;D<t.reactions.length;D++)(0,t.reactions[D])(t,null,null,i)}}function adduilabel(e,t,n,i,s=!1,a=!1,o=!1,l,c=1,h=0,d){let[u,$]=t,p=[];if(!newgrid[u]||!newgrid[u][$])return p;let m=!0;if(!0===newgrid[u][$].visible||l){let f=Math.ceil(e.length/2-1);o&&(f=0),!0==a&&(f=0);let _=!0;e.length&&0!=e.length&&" "!=e[0]&&"$"!=e[0]&&"^"!=e[0]||(m=!1),(!0!==s||!1==l)&&(m=!1);let g=0;for(;!0==_&&g<10;){for(let w=0;w<e.length;w++){let[b,v]=[u-i,$-f+w];if(!newgrid[b]||!newgrid[b][v])break;for(let k=0;k<newgrid[b][v].uiElements.length;k++){let S=newgrid[b][v].uiElements[k];if(m&&S.canbeblocked){let A=Math.sign(b-viewportpos[0]);0==A&&(A=1),_=!0,i+=1}}if(!0!==s||!0==l){if(b>viewportpos[0]+viewportsizey/2){_=!0,i++;break}if(v>viewportpos[1]+viewportsizex/2-1){_=!0,f++;break}if(b<viewportpos[0]-viewportsizey/2){_=!0,i--;break}if(v<viewportpos[1]-viewportsizex/2){_=!0,f--;break}}}g++}if(!1==s){let C;for(let E=0;E<e.length;E++){let[z,q]=[u-i,$-f+E];newgrid[z]&&newgrid[z][q]&&!(viewportpos[0]+viewportsizey/2-1<z)&&!(viewportpos[1]+viewportsizex/2-1<q)&&!(viewportpos[0]-viewportsizey/2>z)&&(viewportpos[1]-viewportsizex/2>q||(C=new uielement(e.charAt(E),n,[z,q],!1,!1,null,d),p.push(C),newgrid[z][q].uiElements.push(C)))}}else if(!0==s){line=[],updatedsomething=!0;for(let j=0;j<e.length;j++)line.push([u-i,$-f+j]);let W=line.length,F;for(let D=0;D<W;D++){let[R,B]=line[D];if(!newgrid[R]||!newgrid[R][B])continue;let G=e[D%e.length],M=now+h,O=now+h+1e3*c;F=new uielement(G,n,line[D],s,l,[O,M]),newgrid[R][B].uiElements.push(F),h>0&&(F.unrendered=!0),p.push(F)}}}return p.length>0&&p.forEach(e=>e.canbeblocked=m),p}function drawGrid(e=!1){if(now=performance.now(),requestAnimationFrame(function(){drawGrid(!0),now-noiseupdateticker>100&&(noiseupdate(),noiseupdateticker=performance.now())}),now-lastCall<throttleRate)return;Math.floor(now/1e3)>lastframe&&(frameticker=0,lastframe=now/1e3),lastCall=now;let t=!1;e&&updatedlighting&&(updatelightmap(),updatedlighting=!1,t=!0);let n=viewportpos[1]-Math.floor(viewportsizex/2),i=viewportpos[0]-Math.floor(viewportsizey/2),s=viewportpos[1]+Math.floor(viewportsizex/2),a=viewportpos[0]+Math.floor(viewportsizey/2);for(let o=i;o<a;o++)if(!(o<0)&&!(o>=mapsizey))for(let l=n;l<s;l++)l<0||l>=mapsizex||newgrid[o][l].updateui();if(!1==updatedsomething&&!1==t)return;if(keyglossary){let c,h,d;for(d=0;d<keybindings.length;d++)c=keybindings[d],keytooltips[d]&&verbose&&(h=keytooltips[d]),adduilabel(c,[viewportpos[0],viewportpos[1]-viewportsizex/2],[128,128,128],-(viewportsizey/2)+d+2,!1,!1,!0,!0,void 0,void 0,h);ngplus>0&&adduilabel(`party number ${ngplus+1}`,[viewportpos[0],viewportpos[1]-viewportsizex/2],[128,128,128],-(viewportsizey/2)+d+2,!1,!1,!0,!0,void 0,void 0,h)}width=window.innerWidth,height=window.innerHeight,offscreen.width=window.innerWidth*ratio,offscreen.height=window.innerHeight*ratio,offscreen.style.width=width+"px",offscreen.style.height=height+"px",offscreen.getContext("2d").scale(ratio,ratio);let u;if(!1==controllock){let $=activecharacternonindex;if(adduilabel("$",$.pos,[0,.25,0],0,!1,!1,!1,!0),newgrid[cursorpos[0]]&&newgrid[cursorpos[0]][cursorpos[1]]&&!0==newgrid[cursorpos[0]][cursorpos[1]].seen&&!1==uilock){for(let p=0;p<playercs.length;p++)!0!=playercs[p].dead&&ctrl&&p!==activecharacter&&alinedraw(aStar(playercs[p].pos,cursorpos),playercs[p].tc,playercs[p]);u=alinedraw(aStar(playercs[activecharacter].pos,cursorpos),playercs[activecharacter].tc,playercs[activecharacter])}}if(!0==uilock){if("attack"==uilocktype||"kick"==uilocktype){let m=!1,f=activecharacternonindex;f.tc[1]<1&&(uilock=!1);let _=20,g=20,w=f.getminrange();for(let b=f.pos[0]-g;b<=f.pos[0]+g;b++)for(let v=f.pos[1]-g;v<=f.pos[1]+g;v++){if(void 0!==newgrid[b]&&void 0!==newgrid[b][v])!(new Attack(...actions.Attack,f.getrange(),[b,v],f,f.pos).func(!0).errors.length>0)&&dist(f.pos,[b,v],!1,!0)<=_&&adduilabel("$",[b,v],[.2,.2,.1],0,!1,!1,!1,!0)}let k=new Attack(...actions.Attack,f.getrange(),cursorpos,f,f.pos);"kick"==uilocktype&&(k=new Kick(cursorpos,f,f.pos));k.func(!0).errors.length,k.warnings.length>0&&adduilabel(k.warnings[0],f.pos,[64,64,64],1,!1,!1,!1,!0),_=k.range,g=Math.ceil(k.range);let S=k.func(!0);if(S.errors&&0==S.errors.length){let A=bresenhamLine(f.pos,cursorpos),C=linecharacter([A[0][0],A[0][1]],[A[A.length-1][0],A[A.length-1][1]]);if(dist(f.pos,cursorpos,!0)<=_&&dist(f.pos,cursorpos,!0)>w){A.shift();for(let E=0;E<A.length;E++){let[z,q]=A[E],j=[0,0,0];newgrid[z][q].readOpacity(void 0,f.pos)>0&&(j=[128,0,0]),!0==newgrid[z][q].visible&&adduilabel(C,[z,q],j,0)}}}if(newgrid[cursorpos[0]][cursorpos[1]].character&&newgrid[cursorpos[0]][cursorpos[1]].character.pc!==activecharacternonindex.pc){if((hypoattack=k.func(!0)).errors.length>0)for(let W=0;W<hypoattack.errors.length;W++);else{m=!0;let F=hypoattack.damagerange[0].toString()+"-"+hypoattack.damagerange[1].toString(),D=Math.round(hypoattack.percenthitchance).toString()+"%";adduilabel(D,cursorpos,[(1-hypoattack.percenthitchance/100)*128,hypoattack.percenthitchance/100*128,0],2,!1,!1),adduilabel(F,cursorpos,[128,0,0],1,!1,!1),ew(f.tc.map((e,t)=>e-k.cost[t]));for(let R=0;R<hypoattack.modbreakdown.length;R++){let B=hypoattack.modbreakdown[R];adduilabel(B,cursorpos,[128,128,128],R+3,!1)}}}!1==m&&ew()}if("jump"==uilocktype){let G=activecharacternonindex;G.tc[1]<1&&(uilock=!1);let M=new Jump(Math.max(G.stats[0]+.5,2),cursorpos,G,G.pos),O=M.range,T=Math.ceil(M.range);for(let L=0;L<M.warnings.length;L++){let P=32*Math.sin(now)+96;adduilabel(M.warnings[L],M.target,[P,0,0],L+1,!1,!1)}for(let N=G.pos[0]-T;N<=G.pos[0]+T;N++)for(let H=G.pos[1]-T;H<=G.pos[1]+T;H++){let I=dist(G.pos,[N,H],!1,!0);I<=Math.min(O,T)&&adduilabel("$",[N,H],[.2,.2,.1],0,!1,!1,!1,!0)}}if("map"==uilocktype)for(let U=0;U<viewportsizex*viewportsizey;U++){let[Q,K]=[i+U%viewportsizey,n+Math.floor(U/viewportsizey)],[J,V]=[Q-i,K-n],X=[0,0,0],Z=[0,0,0],Y=!1;map[J][V]&&(X=map[J][V],map[J][V][3]&&(Z=map[J][V][3],Y=!0)),adduilabel("_",[Q,K],X,0,!1,!1,!1,!0),Y&&adduilabel(Z[3],[Q,K],Z,0,!1,!1,!1,!0)}if("credits"==uilocktype){for(let ee=0;ee<viewportsizex*viewportsizey;ee++){let[et,en]=[i+ee%viewportsizey,n+Math.floor(ee/viewportsizey)];adduilabel("_",[et,en],[0,0,0],0,!1,!1,!1,!0)}let ei=["Torchlight's Shadow","","","a game by Jake Stellman",'Font - "Press Start 2p" Open Font License 2012',"","All other content, programming, audio,","visuals, and design by Jake Stellman","","For questions or feedback, contact:","jake.stellman@gmail.com",];for(let es=0;es<ei.length;es++)adduilabel(ei[es],viewportpos,[64,64,64],5-es,!1,!1,!1,!0)}}else activecharacternonindex&&ew(u);!0==activecharacternonindex.pc&&!1==controllock&&!1==uilock&&newgrid[cursorpos[0]][cursorpos[1]].cursorread(),adduilabel("x",cursorpos,[128,128,128],0,!1,!1,!1,!0),offCtx.clearRect(0,0,offscreen.width,offscreen.height),offCtx.font=`${fontsize}px 'Press Start 2P'`;let ea="",er,eo,el,ec=[];for(let eh=i;eh<a;eh++)for(let ed=n;ed<s;ed++){er=(eo=newgrid[eh][ed]).read(!0),ec.push(er);let eu=(ed-n)*fontsize,e$=(eh-i)*fontsize;el&&el[0]===er[1][0]&&el[1]===er[1][1]&&el[2]===er[1][2]||(offCtx.fillStyle=`rgb(${er[1]})`),offCtx.fillRect(eu,e$,fontsize,fontsize),el=er[1]}let ep=0;for(let em=i;em<a;em++)for(let ef=n;ef<s;ef++){for(ea=(er=ec[ep])[2];ea.length>1&&("&"==ea[0]||"#"==ea[0]||"x"==ea[0]);)ea=ea.slice(1);let e_=(ef-n)*fontsize,eg=(em-i)*fontsize;el&&el[0]===er[0][0]&&el[1]===er[0][1]&&el[2]===er[0][2]||(offCtx.fillStyle=`rgb(${er[0]})`),ea.length>1?offCtx.fillText(String.fromCharCode(parseInt(ea,16)),e_,eg+fontsize,fontsize):offCtx.fillText(ea,e_,eg+fontsize,fontsize),ep++,el=er[0]}function ew(e=activecharacternonindex.tc){if(keyglossary)return;let t=activecharacternonindex,o=t.tc.slice(),l="",c="",h="";for(let d=0;d<o[0];d++)d<e[0]?c+="o":c+="x";for(let u=o[0];u<t.tcmax[0];u++)c+=".";for(let $=0;$<o[1];$++)$<e[1]?l+="o":l+="x";for(let p=o[1];p<t.tcmax[1];p++)l+=".";for(let m=0;m<t.conditions.length;m++)h+=t.conditions[m].name;let f=viewportsizex/2,_=viewportsizey/2-1;if(won){let g=32*Math.sin(now/1e3)+96;adduilabel("The Scourge has been beaten back...",viewportpos,[g,g/2,0],0,!1,!1,!1,!0),adduilabel("New party unlocked",[viewportpos[0]+8,viewportpos[1]],[g,g/2,0],0,!1,!1,!1,!0),adduilabel("Press r to start",[viewportpos[0]+9,viewportpos[1]],[g,g/2,0],0,!1,!1,!1,!0);return}if(gameover){adduilabel("Nothing but ash remains...",viewportpos,[64,64,64],0,!1,!1,!1,!0),adduilabel("Press r to restart",[viewportpos[0]+9,viewportpos[1]],[64,64,64],0,!1,!1,!1,!0);return}if(!0===t.pc){adduilabel(l,[viewportpos[0]+_,viewportpos[1]-f],[128,0,0],1,!1,!1,!0,!0,void 0,void 0,"Actions"),adduilabel(c,[viewportpos[0]+_,viewportpos[1]-f],[0,128,0],0,!1,!1,!0,!0,void 0,void 0,"Move"),adduilabel(h,[viewportpos[0]+_,viewportpos[1]-f],[128,0,0],2,!1,!1,!0,!0);let w=t.primaryitem.name.toString(),b=[128,128,128];t.primaryitem.absorbtion&&(b=convertAbstoColor(t.primaryitem.absorbtion)),adduilabel(w,[viewportpos[0]+_,viewportpos[1]+f-w.length],b,0,!1,!1,!0,!0,void 0,void 0,"Main Hand");let v=t.secondaryitem.name.toString();b=[64,64,64],t.secondaryitem.absorbtion&&(b=convertAbstoColor(t.secondaryitem.absorbtion).map(e=>e/2)),"Unarmed"!==v&&adduilabel(v,[viewportpos[0]+_,viewportpos[1]+f-v.length],b,1,!1,!1,!0,!0,void 0,void 0,"Secondary");let k=t.offhanditem.name.toString();b=[64,64,64],t.offhanditem.absorbtion&&(b=convertAbstoColor(t.offhanditem.absorbtion).map(e=>e/2)),"Unarmed"!==k&&adduilabel(k,[viewportpos[0]+_,viewportpos[1]+f-k.length],b,2,!1,!1,!0,!0,void 0,void 0,"Offhand")}let S=playercs.slice();for(let A=i;A<a;A++)if(!(A<0)&&!(A>=mapsizey))for(let C=n;C<s;C++)C<0||C>=mapsizex||!newgrid[A][C].character||!0===newgrid[A][C].character.pc||!0!=newgrid[A][C].visible||S.push(newgrid[A][C].character);for(let E=0;E<S.length&&E<10;E++){let z=S[E],q=z.color,j=z.name,W=z.tc[1],F=z.tc[0],D=z.tc[2],R=1;if(activecharacternonindex===z?j+="<":(q=q.map(e=>e/2),R=.5),!0==z.dead)q=q.map(e=>e/2);else{let B=1,G=adduilabel(z.hp.toString()+"/"+z.maxhp.toString(),[viewportpos[0]-_,viewportpos[1]-f+B],q,-(2*E)-1,!1,!0,!1,!0,void 0,void 0,"Health");B+=G.length;let M=adduilabel(W.toString()+"/"+z.tcmax[1].toString(),[viewportpos[0]-_,viewportpos[1]-f+B],[32*R,0,0],-(2*E)-1,!1,!0,!1,!0,void 0,void 0,"Actions");B+=M.length;let O=adduilabel(F.toString()+"/"+z.tcmax[0],[viewportpos[0]-_,viewportpos[1]-f+B],[0,32*R,0],-(2*E)-1,!1,!0,!1,!0,void 0,void 0,"Move");B+=O.length;for(let T=0;T<O.length;T++){let[L,P]=activecharacternonindex.pos;O[T].redirect=newgrid[L][P]}let N=adduilabel(D.toString()+"/"+z.tcmax[2],[viewportpos[0]-_,viewportpos[1]-f+B],[16*R,16*R,32*R],-(2*E)-1,!1,!0,!1,!0,void 0,void 0,"Reactions");B+=N.length}let H=adduilabel(j,[viewportpos[0]-_,viewportpos[1]-f+1],q,-(2*E),!1,!0,!1,!0);for(let I=0;I<H.length;I++){let[U,Q]=z.pos;H[I].redirect=newgrid[U][Q]}}}renderqueue.push(offscreen),renderedlastframe=!1,renderqueue.length>0&&requestAnimationFrame(()=>{canvas.width=width*ratio,canvas.height=height*ratio,canvas.style.width=width+"px",canvas.style.height=height+"px";let e=renderqueue.shift();ctx.drawImage(e,0,0),renderedlastframe=!0,frameticker++,updatedsomething=!1,performance.now()-noiseupdateticker>100&&(noiseupdate(),noiseupdateticker=performance.now())}),uielements=[]}function drawline(e,t,n=!1){let[i,s]=e,[a,o]=t,l=newgrid[i][s].elevation,c=newgrid[a][o].elevation;if(l!==c&&!n)return drawLine3D([i,s,l],[a,o,c]);let h=Math.abs(o-s),d=Math.abs(a-i),u=s<o?1:-1,$=i<a?1:-1,p=h-d,m=s,f=i,_=0;for(;;){if(m===o&&f===a)return _;if((m!=s||f!=i)&&(_+=newgrid[f][m].readOpacity(l,e)),_>=1)return 1;let g=2*p;g>-d&&(p-=d,m+=u),g<h&&(p+=h,f+=$),g>-d&&g<h&&cornershadows&&(1==newgrid[f][m-u].readOpacity()&&(_+=.5*newgrid[f][m-u].readOpacity()),1==newgrid[f-$][m].readOpacity()&&(_+=.5*newgrid[f-$][m].readOpacity()))}}function drawLine3D(e,t){let[n,i,s]=e,[a,o,l]=t,c=Math.abs(l-s),h=Math.abs(o-i),d=Math.abs(a-n),u=s<l?1:-1,$=i<o?1:-1,p=n<a?1:-1,m=0,f=n,_=i,g=s,w,b;if(h>=d&&h>=c){w=2*d-h,b=2*c-h;for(let v=0;v<=h;v++){if(f==a&&_==o)return m;if((_!=i||f!=n)&&(m+=newgrid[f][_].readOpacity(g,e)),m>=1)return 1;w>0&&(f+=p,w-=2*h),b>0&&(g+=u,b-=2*h),w+=2*d,b+=2*c,_+=$}}else if(d>=h&&d>=c){w=2*h-d,b=2*c-d;for(let k=0;k<=d;k++){if(f==a&&_==o)return m;if((_!=i||f!=n)&&(m+=newgrid[f][_].readOpacity(g,e)),m>=1)return 1;w>0&&(_+=$,w-=2*d),b>0&&(g+=u,b-=2*d),w+=2*h,b+=2*c,f+=p}}else{w=2*d-c,b=2*h-c;for(let S=0;S<=c;S++){if(f==a&&_==o&&g==l)return m;if((_!=i||f!=n)&&(m+=newgrid[f][_].readOpacity(g,e)),m>=1)return 1;w>0&&(f+=p,w-=2*c),b>0&&(_+=$,b-=2*c),w+=2*d,b+=2*h,g+=u}}}gridinit(),updateGrid();const turndiscountrate=.5,maxturndepth=1,softturndepthcap=0;function planturn(e){performance.now(),spot(e);let t=[],n=e.state.utilityfunction,i=new ActionNode(e.pos,null,e.tc,0,0,null,-1/0,e.primaryitem),s=[i],a=i,o=n(i,e),l=0,c=0,h=Math.max(e.pos[0]-dontcaredistance,0),d=(e.pos[0],Math.max(e.pos[1]-dontcaredistance,0)),u,$=Math.min(e.pos[1]+dontcaredistance,mapsizex)-d;if("idle"==e.state.name)return[];for(let p=0;p<s.length;p++){l++;let m=s[p],[f,_]=m.pos,{tc:g,utility:w,damagepotential:b,hazards:v}=m,[k,S]=g,A=!1,C=0;if(!0==m.skip||m.parentnode&&!0==m.parentnode.skip||(S<0&&(C=Math.max(1,Math.ceil(Math.abs(S/e.tcmax[1])),C)),k<0&&(C=Math.max(1,Math.ceil(Math.abs(k/e.tcmax[0])),C)),C>1)||(C>0&&(k=Math.min((1-C)*e.tcmax[0],k),S=Math.min((1-C)*e.tcmax[1],S),m.tc[0]=k,m.tc[1]=S),C>0&&m.action.cost[1]>0))continue;let E=(f-h)*$+(_-d);t[E]||(t[E]=[]);let z=t[E],q;for(let j=0;j<z.length;j++){if(q=z[j],c++,S<=q.tc[1]&&k<=q.tc[0]&&b<=q.damagepotential&&v>=q.hazards&&w<=q.utility){A=!0;break}S>=q.tc[1]&&k>=q.tc[0]&&b>=q.damagepotential&&v<=q.hazards&&w>=q.utility&&(z.splice(j,1),j--,q.skip=!0)}if(A)continue;z.push(m),w>o&&(a=m,o=w);let W=[];for(let F=0;F<e.state.actions.length;F++)W.push(e.actions[e.state.actions[F]]);let D,R;for(let B=0;B<W.length;B++){R=(D=W[B])(m,e,w);for(let G=0;G<R.length;G++){let M=R[G];M.turndepth=C;let O=n(M,e);if(C>0){let T=O-w;O=w+T*.5**C}M.utility=O,s.push(M)}}if(p>1e6){console.log("too many iterations"),console.log(e),console.log(s);break}}return performance.now(),function e(t){let n=[];for(;t.tc&&t.tc[0]<0;)t=t.parentnode;for(;null!=t.action;)n.unshift(t.action),t=t.parentnode;return n}(a)}function subtractcost(e,t){let n=e.cost,i=[t[0]-n[0],t[1]-n[1],t[2]-n[2]];return i}class ActionNode{constructor(e,t,n,i,s,a,o,l){this.pos=e,this.action=t,n?this.tc=n.slice():this.tc=[],this.hazards=i,this.damagepotential=s,this.parentnode=a,this.parentutility=o,this.activeweapon=l||this.parentnode.activeweapon}}