const audioContext=new(window.AudioContext||window.webkitAudioContext);class Envelope{constructor(e,t,i){this.func=e,this.grainsize=t,this.duration=i}}class SoundManager{constructor(e,t){this.context=e,this.masterGainNode=e.createGain(),this.masterGainNode.gain.value=1,this.masterAmbientGainNode=e.createGain(),this.masterAmbientGainNode.gain.value=1,this.limiter=e.createDynamicsCompressor(),this.masterGainNode.connect(this.limiter),this.masterAmbientGainNode.connect(this.limiter),this.limiter.connect(this.context.destination),this.sources=Array(t),this.ambientsources=Array(t),this.oldestsource=0,this.nextsource=0,this.oldestambientsource=0,this.nextambientsource=0;for(let i=0;i<this.sources.length;i++)this.sources[i]=new SoundSource(this.context,this);for(let s=0;s<this.ambientsources.length;s++)this.ambientsources[s]=new SoundSource(this.context,this);this.limiter.threshold.value=0,this.limiter.knee.value=0,this.limiter.ratio.value=20,this.limiter.attack.value=0,this.limiter.release.value=.25}requestSource(){let e=this.sources[this.oldestsource],t=this.oldestsource;for(;e.endtime>performance.now();)if(this.oldestsource++,!(e=this.sources[this.oldestsource])){this.oldestsource=t,e=this.sources[this.oldestsource];break}return e.soundmaker&&(e.output.disconnect(),e.soundmaker.stop(),e.buffer=null),this.nextsource=e,this.oldestsource++,this.oldestsource>=this.sources.length&&(this.oldestsource=0),e}addEffect(e){this.effectschain||(this.effectschain=[]),this.effectschain.push(e),this.updateRouting()}updateRouting(){let e=this.masterGainNode;for(let t=0;t<this.effectschain.length;t++){let i=this.effectschain[t];e.connect(i),e=i}e.connect(this.limiter)}requestAmbientSource(){let e=this.ambientsources[this.oldestambientsource];return e.soundmaker&&(e.output.disconnect(),e.soundmaker.stop(),e.buffer=null),this.nextambientsource=e,this.oldestambientsource++,this.oldestambientsource>=this.ambientsources.length&&(this.oldestambientsource=0),e}playSound(){this.soundmaker=this.nextsource,this.soundmaker.starttime=performance.now(),this.soundmaker.endtime=this.soundmaker.starttime+2e3*this.soundmaker.env.duration,this.soundmaker.start(),this.soundmaker.output.connect(this.masterGainNode)}playAmbientSound(){this.ambientsoundmaker=this.nextambientsource,this.ambientsoundmaker.start(),this.ambientsoundmaker.output.connect(this.masterAmbientGainNode)}}class SoundSource{constructor(e,t,i,s,a,n,o,l,c){this.context=e,this.soundManager=t,this.type=i,this.freq=s,this.env=a,this.vol=n||1,this.fx=[],this.fxnodes=[],o&&(this.fx=o.slice()),this.overtones=[],l&&(this.overtones=l.slice()),this.overtonenoisemakers=[],this.overtonesoundmakers=[],this.freqmod=[],c&&(this.freqmod=c.slice()),this.gainNode=e.createGain(),this.limiter=this.context.createDynamicsCompressor(),this.masterGainNode=e.createGain(),this.output=this.masterGainNode,this.limiter.threshold.value=0,this.limiter.knee.value=0,this.limiter.ratio.value=10,this.limiter.attack.value=.003,this.limiter.release.value=.25}start(){if(this.reset(),this.masterGainNode.gain.value=this.vol,"noise"===this.type||"lowpass-noise"===this.type||"lowpass-noise-white"===this.type){let e=this.context.sampleRate*this.env.duration,t=this.context.createBuffer(1,e,this.context.sampleRate),i=t.getChannelData(0);if("lowpass-noise-white"===this.type)for(let s=0;s<e;s++)i[s]=2*Math.random()-1;else{let a=0,n=0,o=Array(50).fill(0);for(let l=0;l<e;l++){let c=2*Math.random()-1;n-=o[l%50],o[l%50]=c;let h=(n+=c)/50;i[l]=(a+.02*h)/1.02,a=i[l],i[l]*=3.5}}if(this.noise=this.context.createBufferSource(),this.noise.buffer=t,this.noise.loop=!0,this.soundmaker=this.noise,"lowpass-noise"===this.type||"lowpass-noise-white"===this.type){let d=this.context.createBiquadFilter();d.type="lowpass",d.frequency.value=this.freq,this.lowpassFilter=d,this.soundmaker.connect(this.lowpassFilter),this.lowpassFilter.connect(this.gainNode)}else this.soundmaker.connect(this.gainNode)}else this.soundmaker=this.context.createOscillator(this.type,this.freq),this.soundmaker.type=this.type,this.soundmaker.frequency.value=this.freq,this.soundmaker.connect(this.gainNode);this.soundmaker.start(),this.env?(this.gainNode.gain.value=0,modulateparam(this.env,this.gainNode.gain,this.context,1),this.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime+this.env.duration)):console.log("error this sound played with no envelope"),this.freqmod&&("lowpass-noise"!==this.type&&"noise"!==this.type&&"lowpass-noise-white"!==this.type&&modulateparam(this.freqmod,this.soundmaker.frequency,this.context,this.freq),("lowpass-noise"==this.type||"lowpass-noise-white"==this.type)&&modulateparam(this.freqmod,this.lowpassFilter.frequency,this.context,this.freq));for(let u=0;u<this.overtonenoisemakers.length;u++){let $=this.overtonenoisemakers[u];$.disconnect(),$.stop()}for(let p=0;p<this.overtonesoundmakers.length;p++){let f=this.overtonesoundmakers[p];f instanceof OscillatorNode&&f.stop(),f.disconnect()}if(this.overtonenoisemakers=[],this.overtonesoundmakers=[],this.overtones)for(let m=0;m<this.overtones.length;m++)"noise"!==this.type&&"lowpass-noise"!==this.type&&"lowpass-noise-white"!==this.type?(this.overtonesoundmakers.push(this.context.createOscillator(this.type)),this.overtonesoundmakers[m].start()):("lowpass-noise"==this.type||"lowpass-noise-white"==this.type)&&(this.overtonenoisemakers.push(this.context.createBufferSource()),this.overtonenoisemakers[m].buffer=this.noise.buffer,this.overtonenoisemakers[m].loop=!0,this.overtonesoundmakers.push(this.context.createBiquadFilter()),this.overtonenoisemakers[m].connect(this.overtonesoundmakers[m]),this.overtonenoisemakers[m].start()),this.overtonesoundmakers[m].frequency.setValueAtTime(this.freq*this.overtones[m],this.context.currentTime),this.overtonesoundmakers[m].connect(this.gainNode),this.freqmod&&(this.overtonesoundmakers[m].frequency.value=this.freq*this.overtones[m],modulateparam(this.freqmod,this.overtonesoundmakers[m].frequency,this.context,this.freq*this.overtones[m]))}reset(){this.output.disconnect(),this.gainNode.disconnect(),this.soundmaker&&this.soundmaker.disconnect();let e=this.gainNode;this.gainNode.gain.value=0,this.gainNode.gain.setValueAtTime(0,this.context.currentTime);for(let t=0;t<this.fxnodes.length;t++){let i=this.fxnodes[t];i.disconnect(),i.buffer=null}this.fxnodes=[];for(let s=0;s<this.fx.length;s++){let a=this.fx[s];this.fxnodes.push(a()),e.connect(this.fxnodes[s]),e=this.fxnodes[s]}e.connect(this.masterGainNode)}}function modulateparam(e,t,i,s,a=!0){let{grainsize:n,duration:o,func:l}=e;t.cancelScheduledValues(i.currentTime);for(let c=0;c<o;c+=n*(.5*Math.random()+.5))t.linearRampToValueAtTime(l(c)*s,i.currentTime+c)}const soundManager=new SoundManager(audioContext,10);let verb=createReverb(audioContext,1)(),lowpass=createLowpassFilter(audioContext,1e4)(),delaychain=createDelayChain(audioContext,.25,.75,[lowpass,verb])();soundManager.effectschain=[delaychain],soundManager.updateRouting();const envelopes={random1sec:new Envelope(e=>Math.random(),.01,1),crack:new Envelope(e=>1,.01,.2),stab:new Envelope(e=>1,.01,.1),boom:new Envelope(e=>1,.1,.5),oldcrack:new Envelope(adsrconvert([.01,.05,1,.02],.01),.01,.3),rainfall:new Envelope(e=>Math.random(),.1,20),fire:new Envelope(e=>adsrconvert([3,.05,1,.02],90)(e)*(Math.random()/2+.5),.03,6),randomboom:new Envelope(e=>1*Math.random(),.1,1),randomstab:new Envelope(e=>Math.random()*Math.min(1,10*e),.1,.2),linearfall:new Envelope(e=>Math.max(1-e,.1),.2,1),linearfallhalf:new Envelope(e=>Math.max(1-4*e,0),.01,.5),negabsval:new Envelope(linearspike(1),.1,1)};let sounds={caveambience:[100,"lowpass-noise",envelopes.fire,[createReverb(audioContext,5)],new Envelope(e=>.5*Math.random()+.5,.1,1),[2,4,8],.25],deepspookybong:[100,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.01,1),[createReverb(audioContext,10)],new Envelope(e=>.1*Math.random()+.95,.1,1),[2.1],.1],highshrillbing:[1e3,"sine",new Envelope(linearspike(1),.01,1),[createReverb(audioContext,10)],new Envelope(e=>.1*Math.random()+.95,.1,1),[2.1],.1],footstep2:[100,"sine",envelopes.oldcrack,[createReverb(audioContext,.5)],null,[.5]],footstep:[500,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**.3*Math.random()**2,linearspike(.1)(Math.max(e-.15,0))**.3*Math.random()**2),.015,.3),[],null,[],.25],footstepverb:[500,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**.3*Math.random()**2,linearspike(.1)(Math.max(e-.15,0))**.3*Math.random()**2),.015,.3),[createReverb(audioContext,.5)],null,[],.25],weirdtone:[440,"sine",envelopes.random1sec,[],envelopes.randomboom,[2,4]],weirdnoise:[500,"lowpass-noise",envelopes.random1sec,[]],footsteptap:[200,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**5*Math.random()/2,linearspike(.1)(Math.max(e-.15,0))**5*Math.random()/2),.005,.3),[],null,[1.1,1.2,1.3,2],.5],footsteptapverb:[200,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**5,linearspike(.1)(Math.max(e-.15,0))**5*Math.random()/2),.005,.3),[createReverb(audioContext,.5)],null,[1.1,1.2,1.3,2],.25],frogribbit:[1e3,"sine",new Envelope(e=>Math.max(linearspike(.1)(e)**25,linearspike(.1)(Math.max(e-.15,0))**25),.01,.3),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],softsine:[400,"sine",envelopes.negabsval,[]],arrowwhoosh:[400,"lowpass-noise-white",new Envelope(linearspike(.8),.01,.3),[],new Envelope(e=>Math.max(1-4*e,.5),.2,.5),[2]],arrowwhistle:[200,"sine",new Envelope(e=>linearspike(.8)(e)*Math.random(),.1,.3),[createReverb(audioContext,.2),createLowpassFilter(audioContext,200)],new Envelope(e=>Math.max(1-4*e,.8),.2,.5),[.9,.95,1.05,1.1]],arrowthudnoise:[150,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[createPause(audioContext,.2)],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],arrowthudtone:[150,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2),createPause(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],clubwhoosh:[400,"lowpass-noise-white",new Envelope(linearspike(.8),.01,.3),[],new Envelope(e=>Math.max(1-4*e,.5),.2,.5),[2]],clubwhoom:[200,"sine",new Envelope(e=>linearspike(.2)(e)*Math.random(),.1,.2),[createReverb(audioContext,.2),createLowpassFilter(audioContext,200)],new Envelope(e=>Math.max(1-4*e,.8),.2,.5),[.9,.95,1.05,1.1]],clubhitnoise:[100,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-5*e,0),.01,.4),[createDistortion(audioContext,.5),createPause(audioContext,.2)],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],clubhittone:[50,"sine",new Envelope(e=>Math.max(1-5*e,0),.01,.4),[createReverb(audioContext,.2),createPause(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],clubhitcrack:[100,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-2.5*e,0)*Math.random()**10,.005,.2),[createPause(audioContext,.2)],new Envelope(e=>1+1*e*Math.random(),.01,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2,4,8,16,32,64,128],.1],swordswingbig:[200,"lowpass-noise-white",new Envelope(linearspike(.4),.1,.4),[],new Envelope(e=>Math.max(1-6*e,.5)),[]],swordswingsmall:[400,"lowpass-noise-white",new Envelope(linearspike(.2),.1,.2),[],new Envelope(e=>Math.max(1-12*e,.25)),[]],swordswingxs:[600,"lowpass-noise-white",new Envelope(linearspike(.15),.1,.15),[],new Envelope(e=>Math.max(1-18*e,.2)),[]],swordswingsmallverb:[400,"lowpass-noise-white",new Envelope(linearspike(.2),.1,.2),[createReverb(audioContext,.5)],new Envelope(e=>Math.max(1-12*e,.25)),[]],deepthudnoise:[25,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-5*e,0),.01,.4),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],deepthudtone:[25,"sine",new Envelope(e=>Math.max(1-5*e,0),.01,.4),[createReverb(audioContext,.4)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],medthudnoise:[50,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],medthudtone:[50,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],drumtemplate:[50,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.1),[createReverb(audioContext,1)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],stringplucktemplate:[600,"sine",new Envelope(e=>Math.max(1-3*e,0),.01,.5),[createReverb(audioContext,.2)],new Envelope(e=>Math.max(1-4*e,.25),.005,.5),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],stringsine:[440,"sine",new Envelope(linearspike(1),.01,1),[createReverb(audioContext,.2)],new Envelope(e=>.95+.025*Math.random(),.1,1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2]],highthudnoise:[150,"lowpass-noise",new Envelope(e=>3*e**.01*Math.max(1-10*e,0),.01,.2),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],highthudnoiseverb:[150,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2)],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],highthudtone:[150,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],bassdrum:[100,"sine",new Envelope(e=>linearspike(.08)(e)*Math.random(),.01,.1),[createReverb(audioContext,2)],null,[1.1,1.2,.5],2],snaredrum:[200,"lowpass-noise-white",new Envelope(e=>linearspike(.04)(e)*Math.random(),.01,.1),[],null,[1.1,1.2,.5],2],whee:[2e3,"lowpass-noise",new Envelope(linearspike(.5),.01,.5),[],new Envelope(linearspike(.5),.01,.5),[]],goblinchat:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[],new Envelope(e=>Math.random()**2*2,5e-4,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.01],goblinchatverb:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,5e-4,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.01],goblinchat2:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[],new Envelope(e=>Math.random()**2*2,.002,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.02],goblinchat2old:[400,"sine",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**2,.05,1.5),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,.002,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],goblinchat3old:[600,"sine",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**2,.05,1.5),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,.003,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],something:[2,"noise",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random(),5e-5,1.5),[createReverb(audioContext,.1)],new Envelope(e=>5*Math.random(),.01,1.5)],goblinchatnoise:[800,"lowpass-noise-white",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**4,.05,1.5),[],new Envelope(e=>Math.random()**2*2,.0025,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],goblinscream:[400,"sine",new Envelope(e=>linearspike(1.5)(e)**.01,.05,1.5),[],new Envelope(e=>Math.random()**2*2,.0025,1.5),[1.5,1.6,.5,.6,.4,.3],.05],goblinyelpold:[800,"sine",new Envelope(e=>linearspike(.25)(e)**.01,.005,.25),[],new Envelope(e=>Math.random()**2*2,5e-4,.5),[1.5,1.6,.5,.6,.4,.3],.01],goblindeath:[800,"sine",new Envelope(e=>e**.2*(1-e)*Math.random()**.5,.01,1),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/4)*Math.random()*2,.005,5),[1.5,1.6,.5,.6,.4,.3],.05],ogredeath:[400,"sine",new Envelope(e=>e**.2*(1-e)*Math.random()**.5,.01,1),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/4)*Math.random()*2,.005,5),[1.4,1.2,.5,.6,.4,.3],.05],goblinshriek:[1200,"sine",new Envelope(e=>e**.2*(1-e/2)*Math.random()**.5,.01,2),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/6)*Math.random()*2,.005,5),[1.5,1.6,.5,.6,.4,.3],.05],deathshriek:[1200,"sine",new Envelope(e=>e**.2*(1-e/5)*Math.random()**.5,.01,5),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/6)*Math.random()*2,.005,5),[1.5,1.6,.5,.6,.4,.3],.05],goblinyelp:[800,"sine",new Envelope(e=>linearspike(.25)(e)**.01,.005,.25),[],new Envelope(e=>Math.random()**2*2,.005,.5),[1.5,1.6,.5,.6,.4,.3],.01],rustle:[500,"lowpass-noise-white",envelopes.randomstab,[]],rustleverb:[500,"lowpass-noise-white",envelopes.randomstab,[createReverb(audioContext,.5)]],eeesound:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,300)],null,[.5,2,3,4,5,6,7,8,9,10,12]],eeesound2:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,2200)],null,[.5,2,3,4,5,6,7,8,9,10,12]],eeesound3:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,3e3)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,1e3)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound2:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,1300)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound3:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,2400)],null,[.5,2,3,4,5,6,7,8,9,10,12]],sine:[75,"sine",new Envelope(e=>linearspike(.08)(e)*Math.random(),.01,.1),[createDistortion(audioContext,25)]],bowstring:[100,"lowpass-noise-white",new Envelope(e=>linearspike(1)(e)*Math.random()**10,5e-4,1),[],new Envelope(e=>Math.min(Math.max((10*e)**2,0),25),.1,1),[],.1],treecreakinginthewind:[100,"lowpass-noise-white",new Envelope(e=>linearspike(5)(e)**4*Math.random()**.5,15e-5,5)],tap:[100,"lowpass-noise-white",new Envelope(e=>linearspike(.5)(e)**4*Math.random()**.5,2e-4,.5)],sworddraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.5)(e)*Math.random()**.2,.01,1),[],new Envelope(e=>Math.min(200*(e+1),75),.01,1),[.5,1/4],.05],swordring:[800,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.5)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.01],swordring2:[800/3,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.75)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.1],swordring3:[200,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.5)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.025],shortsworddraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.35)(e)*Math.random()**.2,.01,.5),[],new Envelope(e=>Math.min(300*(e+1),100),.01,.5),[],.05],daggerdraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.25)(e)*Math.random()**.4,.01,.5),[],new Envelope(e=>Math.min(400*(e+1),100),.01,.5),[],.05],daggerdraw2:[2e3,"lowpass-noise-white",new Envelope(e=>10*linearspike(.25)(e)*Math.random()**.4,.01,.5),[],new Envelope(e=>Math.min(1*e,5),.01,.5),[],.05],puncture:[2500,"lowpass-noise-white",new Envelope(e=>linearspike(.25)(e)*Math.random()**.3,.01,.5),[],new Envelope(e=>1-2*e,.01,.5),[],.1],spurt1:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**2*Math.random()**2,.001,1),[createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[1.1,1.2,1.3,2,4,8],.1],spurt2:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**2*Math.random()**2,.001,1),[createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[6,12],.1],spurt1verb:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**4*Math.random()**2,.001,1),[createReverb(audioContext,.2),createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[1.1,1.2,1.3,2,4,8],.5],spurt2verb:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**4*Math.random()**2,.001,1),[createReverb(audioContext,.2),createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[6,12],.5],woodbreaking:[100,"lowpass-noise-white",new Envelope(e=>(1-e/.7)*Math.random()**(2*e),15e-5,.7),[],new Envelope(e=>(e+1)*Math.random(),.01,.7),[1.1,1.5,2,4],.2],woodbreaking2:[100,"lowpass-noise-white",new Envelope(e=>(1-e/2)*Math.random()**(10*e+1),.01,2),[createReverb(audioContext,.1)],new Envelope(e=>Math.max(Math.random()**4*16,.5),.01,1.5),[1.1,1.5,2,4],.2],woodbreakingdeep:[50,"lowpass-noise-white",new Envelope(e=>(1-e/.7)*Math.random()**(2*e),15e-5,.7),[],new Envelope(e=>(e+1)*Math.random(),.01,.7),[.5,1.1,1.5,2],.2],woodbreaking2deep:[50,"lowpass-noise-white",new Envelope(e=>(1-e/2)*Math.random()**(10*e+1),.01,2),[createReverb(audioContext,.1)],new Envelope(e=>Math.max(Math.random()**4*16,.5),.01,1.5),[.5,1.1,1.5,2],.2]};function linearspike(e){return function(t){return 0==t||t>e?0:t<=e/2?t/(e/2):1-(t-e/2)/(e/2)}}const soundeffects={footstep:[sounds.footstep],footsteptap:[sounds.footsteptap],arrowflight:[sounds.arrowthudnoise,sounds.arrowthudtone,sounds.swordswingsmall,sounds.swordswingsmallverb],swordswing:[sounds.swordswingsmall,sounds.swordswingsmallverb],swordhit:[sounds.swordswingsmall,sounds.swordswingsmallverb,sounds.highthudtone,sounds.highthudnoise],clubswing:[sounds.clubwhoom,sounds.clubwhoosh],clubhit:[sounds.clubhitcrack,sounds.clubhitnoise,sounds.clubhittone,sounds.clubwhoom,sounds.clubwhoosh],woodbreaking:[sounds.woodbreaking,sounds.woodbreaking2],woodbreakingdeep:[sounds.woodbreakingdeep,sounds.woodbreaking2deep],caveambience:[sounds.caveambience],deepspookybong:[sounds.deepspookybong],highshrillbing:[sounds.highshrillbing],bassdrum:[sounds.bassdrum],highthud:[sounds.highthudtone,sounds.highthudnoise],medthud:[sounds.medthudtone,sounds.medthudnoise],deepthud:[sounds.deepthudtone,sounds.deepthudnoise],goblinchat:[sounds.goblinchat,sounds.goblinchatverb,sounds.goblinchat2],goblinyelp:[sounds.goblinyelp],goblindeath:[sounds.goblindeath],ogredeath:[sounds.ogredeath],goblinscream:[sounds.goblinscream],goblinshriek:[sounds.goblinshriek],deathshriek:[sounds.deathshriek],aaasound:[sounds.aaasound,sounds.aaasound2,sounds.aaasound3],eeesound:[sounds.eeesound,sounds.eeesound2,sounds.eeesound3],sworddraw:[sounds.sworddraw,sounds.swordring,sounds.swordring2,sounds.swordring3],bowdraw:[sounds.bowstring],shortsworddraw:[sounds.shortsworddraw],daggerdraw:[sounds.daggerdraw],daggerdraw2:[sounds.daggerdraw2],tap:[sounds.tap],puncture:[sounds.puncture,sounds.spurt1,sounds.spurt2,sounds.spurt1verb,sounds.spurt2verb]};function playsoundeffect(e){for(let t=0;t<e.length;t++){let[i,s,a,n,o,l,c]=e[t],h=soundManager.requestSource();h.freqmod=null,h.overtones=[],o&&(h.freqmod=o),l&&(h.overtones=l.slice()),h.vol=1,void 0!==c&&(h.vol=c),h.freq=null,h.freq=i,h.type=null,h.type=s,h.env=null,h.env=a,h.fx=[],n&&(h.fx=n.slice()),soundManager.playSound()}}function playambientsound(e){for(let t=0;t<e.length;t++){let[i,s,a,n,o,l,c]=e[t],h=soundManager.requestAmbientSource();h.freqmod=null,h.overtones=[],o&&(h.freqmod=o),l&&(h.overtones=l.slice()),h.vol=.2,c&&(h.vol=c/5),h.freq=null,h.freq=i,h.type=null,h.type=s,h.env=null,h.env=a,h.fx=[],n&&(h.fx=n.slice()),soundManager.playAmbientSound()}}function adsrconvert([e,t,i,s],a){let n=a-(e+t+s);return function(a){return a<0?0:a>=0&&a<=e?a/e:a>e&&a<=e+t?1-(a-e)/t*(1-i):a>e+t&&a<=e+t+n?i:a>e+t+n&&a<=e+t+n+s?i*(1-(a-(e+t+n))/s):0}}function calculateGain(e,t,i){let s=t/2/1024,a=new Float32Array(1024),n=new Float32Array(1024),o=new Float32Array(1024);for(let l=0;l<1024;l++)a[l]=l*s;e.getFrequencyResponse(a,n,o);let c=0,h=0;for(let d=0;d<1024;d++)c+=1,h+=n[d];let u=c*s*i,$=h*s*i;return Math.sqrt(u/$)}function createReverb(e,t=2){return function(){let i=e.createConvolver(),s=e.sampleRate,a=s*t,n=e.createBuffer(2,a,s),o=n.getChannelData(0),l=n.getChannelData(1);for(let c=0;c<a;c++)o[c]=(2*Math.random()-1)*Math.pow(1-c/a,2),l[c]=(2*Math.random()-1)*Math.pow(1-c/a,2);return i.buffer=n,i.normalize=!0,i}}function createDistortion(e,t){return function(){let i=e.createWaveShaper();return i.curve=makeSoftClippingCurve(t),i}}function makeDistortionCurve(e){let t="number"==typeof e?e:50,i=new Float32Array(44100),s=Math.PI/180;for(let a=0;a<44100;++a){let n=2*a/44100-1;i[a]=(3+t)*n*20*s/(Math.PI+t*Math.abs(n))}return i}function makeSoftClippingCurve(e){let t="number"==typeof e?e:50,i=new Float32Array(44100);for(let s=0;s<44100;++s){let a=2*s/44100-1;i[s]=a/(1+t*Math.abs(a))}return i}function makeExponentialDistortionCurve(e){let t="number"==typeof e?e:50,i=new Float32Array(44100);for(let s=0;s<44100;++s){let a=2*s/44100-1;i[s]=(1-Math.exp(-t*Math.abs(a)))*(a<0?-1:1)}return i}function createDelay(e,t=1,i=.5){return function(){let s=e.createDelay(),a=e.createGain();return a.gain.value=i,s.connect(a),a.connect(s),s.delayTime.value=t,a}}function createPause(e,t=1,i=0){return function(){let s=e.createDelay(),a=e.createGain();return a.gain.value=i,s.connect(a),a.connect(s),s.delayTime.value=t,s}}function createDelayChain(e,t=1,i=.5,s){return function(){let a=e.createDelay(),n=e.createGain();n.gain.value=i,a.connect(n);let o=n;for(let l=0;l<s.length;l++){let c=s[l];o.connect(c),o=c}return o.connect(a),a.delayTime.value=t,n}}function createLowpassFilter(e,t){return function(){let i=e.createBiquadFilter();return i.frequency.setValueAtTime(t,e.currentTime),i.type="lowpass",i}}function createBandpassFilter(e,t){return function(){let i=e.createBiquadFilter();return i.type="bandpass",i.frequency.value=t,i.Q.value=1,i}}class ambientSound{constructor(e,t,i){this.sound=e,this.mincadence=t,this.maxcadence=i,this.lastplayed=0,this.thiscadence=t+Math.random()*(i-t),this.randomize=!0}}let ambientsounds=[new ambientSound(soundeffects.caveambience,5e3,7e3),new ambientSound(soundeffects.deepspookybong,5e3,15e3),new ambientSound(soundeffects.bassdrum,1500,1500)];function updateambientsound(){for(let e=0;e<ambientsounds.length;e++){let t=ambientsounds[e];performance.now()-t.lastplayed>t.thiscadence&&(!0==t.randomize&&(t.sound[0][0]=1e3*Math.random()),playambientsound(t.sound),t.lastplayed=performance.now(),t.thiscadence=t.mincadence+Math.random()*(t.maxcadence-t.mincadence))}}ambientsounds[2].randomize=!1;class character{constructor(e,t,i,s,a,n,o,l,c,h,d,u){this.pos=[],this.pos=e.slice(),this.name=t,this.stats=i.slice()||[0,0,0],this.maxhp=s,this.hp=s,this.tcmax=a.slice(),this.tcmax.length<4&&(this.tcmax[3]=1),this.tc=this.tcmax.slice(),this.pc=n,this.symbol=o,this.dead=!1,this.actionqueue=[],this.target=e.slice(),this.color=l.slice(),this.ac=c,this.traits=h.map(e=>new trait(e.name,e.trigger,e.effect,e.active,e.passive,this)),this.conditions=[],this.condresists=[],this.unarmed=new Unarmed,this.equipment=[],d&&d.length>0&&(this.equipment=d.slice()||[]),this.primaryitem=this.unarmed,this.secondaryitem=this.unarmed,this.offhanditem=this.unarmed,this.ammunition={};let $=this;this.equipment.forEach(function(e){$.addItem(e,!0)}),this.specialattack=u||null,this.lightsources=[],this.index=characterindex,characterindex++,this.visibletiles=[],!0==this.pc?playercs.push(this):nonpcs.push(this)}damage(e){if(0==e)return;let t=0;if(this.ownedelements){let i="";for(let s=0;s<this.ownedelements.length;s++){let a=this.ownedelements[s];!(a.lifespan[0]<now)&&(a.lifespan[0]=0,i+=a.symbol)}isNaN(t=parseInt(i))&&(t=0)}else this.ownedelements=[];let n=(e+t).toString();for(let o=0;o<this.ownedelements.length;o++){let l=this.ownedelements[o],[c,h]=l.pos;grid[c][h].uiElements=grid[c][h].uiElements.filter(e=>e!=l)}this.ownedelements=adduilabel(n,this.pos,[128,0,0],1,!0),this.hp-=e,this.hp<=0&&!1==this.dead&&this.die(),this.bleed()}bleed(){let e=new blood;grid[this.pos[0]][this.pos[1]].addFluid(e)}heal(e){this.hp+=e,adduilabel(e.toString(),this.pos,[0,128,0],1,!0,!1,!1,!0,1)}die(){let[e,t]=this.pos;this.actionqueue=[];let i=null;this.deathsound&&(i=this.deathsound);let s=new action("Die",e=>e,[0,0,0],0,this.pos,this,this.pos,[],i,6);this.actionqueue.push(s),move(this),this.dead=!0,adduilabel("x",this.pos,[128,0,0],0,!0,!1,!1,!1),this.color[1]*=.5,this.color[2]*=.5,this.color[0]*=.5;let a=new corpse("Corpse",this.symbol,convertColortoAbs(this.color).map((e,t)=>e*[.5,.1,.1][t]),null,0,!0,0);a.destructable=!1,grid[this.pos[0]][this.pos[1]].addObject(a),this.dropAll(),grid[this.pos[0]][this.pos[1]].character=null}addItem(e,t=!1){let[i,s]=this.pos;if(e instanceof Ammunition){let a=!1,n=[this.primaryitem,this.secondaryitem,this.offhanditem];for(let o=0;o<3;o++)n[o].ammotype==e.basename&&(a=!0);if(a){this.addAmmo(e.basename,e.number);return}}if(this.primaryitem&&this.primaryitem.basename==e.basename&&this.primaryitem.stacksize>this.primaryitem.number){if(1!=e.number&&e.number){for(;this.primaryitem.number<this.primaryitem.stacksize&&e.number>0;)e.number--,this.primaryitem.number++;e.number>0&&grid[i][s].addObject(e)}else this.primaryitem.number++;this.primaryitem.name=`${this.primaryitem.basename}(${this.primaryitem.number})`,t||adduilabel(this.primaryitem.name,this.pos,this.color,1,!0)}else if(this.secondaryitem&&this.secondaryitem.basename==e.basename&&this.secondaryitem.stacksize>this.secondaryitem.number){if(1!=e.number&&e.number){for(;this.secondaryitem.number<this.secondaryitem.stacksize&&e.number>0;)e.number--,this.secondaryitem.number++;e.number>0&&grid[i][s].addObject(e)}else this.secondaryitem.number++;this.secondaryitem.name=`${this.secondaryitem.basename}(${this.secondaryitem.number})`,t||adduilabel(this.secondaryitem.name,this.pos,this.color,1,!0)}else{if(this.secondaryitem.name==this.unarmed.name&&this.itemSwap(),this.drop(),this.primaryitem=e,e.ammotype){this.secondaryitem.basename==e.ammotype&&this.drop("secondaryitem"),this.offhanditem.basename==e.ammotype&&this.drop("offhanditem");let l=this.ammunition[e.ammotype];l||(l=0),e.name=`${e.basename}(${l})`}t||adduilabel(this.primaryitem.name,this.pos,this.color,1,!0)}}itemSwap(){let e=this.primaryitem;this.primaryitem=this.secondaryitem,this.secondaryitem=e}drop(e="primaryitem"){let[t,i]=this.pos,s=this[e];s&&s.basename!=this.unarmed.basename&&(s.ammotype&&this.dropammo(s),grid[t][i].addObject(s),s.drop(),this[e]=this.unarmed)}dropammo(e){let[t,i]=this.pos,s=this.ammunition[e.ammotype];if(this.ammunition[e.ammotype]=0,s){let a=new e.ammoconstructor;a.number=s,grid[t][i].addObject(a),e.name=e.basename}}dropoffhand(){this.drop("offhanditem")}dropAll(){this.drop(),this.drop("secondaryitem"),this.drop("offhanditem")}removeItem(e){let t;this.primaryitem.basename==e.basename?t="primaryitem":this.secondaryitem.basename==e.basename?t="secondaryitem":this.offhanditem.basename==e.basename&&(t="offhanditem");let[i,s]=this.pos,a=this[t];a.number--,a.number<=0?(a.ammotype&&this.dropammo(a),this[t]=this.unarmed):adduilabel(a.number.toString(),[i,s],this.color,1,!0),1==a.number?a.name=a.basename:a.number>1&&(a.name=`${a.basename}(${a.number})`)}removeAmmo(e){this.ammunition[e]--,adduilabel(this.ammunition[e].toString(),this.pos,this.color,1,!0),this.updateAmmo()}addAmmo(e,t){!this.ammunition[e]||this.ammunition[e]<=0?this.ammunition[e]=t:this.ammunition[e]+=t,adduilabel(this.ammunition[e].toString(),this.pos,this.color,1,!0),this.updateAmmo()}updateAmmo(){let e=[this.primaryitem,this.secondaryitem,this.offhanditem],t=this;e.forEach(function(e){if(e.ammotype){let i=`${e.basename}`;t.ammunition[e.ammotype]||(t.ammunition[e.ammotype]=0),i+=`(${t.ammunition[e.ammotype]})`,e.reloading&&(verbose?e.reloaded?i+="(loaded)":i+="(unloaded)":e.reloaded||(i+="*")),e.name=i}})}getatkbonus(e=this.primaryitem){let t=e.bonus+this.stats[e.stat];return t}getdamage(){let e=this.primaryitem,t=e.bonus+this.stats[e.stat],i=roll(e.damagedie,t);return i}getavdamage(e=this.primaryitem){if(0==e.damagedie)return[0,0];let t=e.bonus+this.stats[e.stat],i=[1+t,e.damagedie+t];return i}getrange(e){return(e||(e=this.primaryitem),e.ammotype&&!this.ammunition[e.ammotype])?0:e.range}getminrange(e){return(e||(e=this.primaryitem),e.ammotype&&!this.ammunition[e.ammotype])?0:e.minrange}getvisibletiles(){let[e,t]=this.pos,i=this,s=[],a=[],n=new Set;a.push(grid[e][t]);let o=0;for(let l=0;l<this.visibletiles.length;l++){let c=this.visibletiles[l];c.removevisiblecharacter(i)}for(;a.length>0&&o<1e4;){o++;let h=a.pop(),[d,u]=h.pos;if(grid[d][u].readOpacity()>=1)continue;let $=dist([e,t],[d,u]);if($>enemysightrange)continue;let[p,f]=[0,0],[m,_]=[0,0],g=grid[e][t].elevation,b=grid[d][u].elevation;if(1>drawLine3D([e,t,g+1],[d,u,b])){s.push(h),h.addvisiblecharacter(i);let w=`${h.pos[0]},${h.pos[1]}`;if(i.knowntiles[w]=turncounter,$<enemysightrange)for(let v=0;v<8;v++){[p,f]=directions[v],[m,_]=[d+p,u+f];let k=`${m},${_}`;!n.has(k)&&grid[m]&&grid[m][_]&&(n.add(k),a.push(grid[m][_]))}}else if(g!==b&&1>drawline([e,t],[d,u],!0))for(let A=d-1;A<=d+1;A++)for(let S=u-1;S<=u+1;S++){let z=`${A},${S}`;!n.has(z)&&grid[A]&&grid[A][S]&&(n.add(z),a.push(grid[A][S]))}}this.visibletiles=s}getplayerviewold(){let[e,t]=this.pos,i=[e,t],s=[],a={},n=[];n.push(grid[e][t]);let o=0;class l{constructor(e,t,i){this.min=e,this.max=t,this.distance=i,this.left=null,this.right=null}}class c{constructor(){this.root=null}insert(e,t,i){let s=new l(e,t,i);null===this.root?this.root=s:this.root=this._insert(this.root,s)}_insert(e,t){return t.min<e.min?null===e.left?e.left=t:e.left=this._insert(e.left,t):null===e.right?e.right=t:e.right=this._insert(e.right,t),e}find(e){return this._find(this.root,e)}_find(e,t){return null===e?null:t>=e.min&&t<=e.max?e.distance:t<e.min?this._find(e.left,t):this._find(e.right,t)}findMaxDistanceInRange(e,t){return this._findMaxDistanceInRange(this.root,e,t)}_findMaxDistanceInRange(e,t,i){if(null===e||e.max<t||e.min>i)return -99;if(e.min>=t&&e.max<=i)return e.maxDistance;let s=-99;return e.min<=i&&e.max>=t&&(s=e.distance),s=Math.max(s,this._findMaxDistanceInRange(e.left,t,i),this._findMaxDistanceInRange(e.right,t,i))}}let h=Array(360).fill(99);function d(e,t){let[i,s]=e,[a,n]=t,o=[[a-.5,n-.5],[a+.5,n-.5],[a-.5,n+.5],[a+.5,n+.5]].map(([e,t])=>{let a=Math.atan2(t-s,e-i)*(180/Math.PI);return Math.round(a=(a+360)%360)}),l=Math.min(...o),c=Math.max(...o);return Math.abs(l-c)>270?[l,l,chebyshevDistance(e,t)]:[l,c,chebyshevDistance(e,t)]}function u(e){let[t,s]=e.pos,a=d(i,e.pos);console.log(h);let n=h.findMaxDistanceInRange(a[0],a[1]);return!!(n>=a[2])||-99===n}function $(e){let t=d(i,e.pos);for(let s=t[0];s<=t[1];s++)if(t[2]<=h[s])return!0;return!1}for(;n.length>0&&o<5e3;){let p=n.shift(),[f,m]=p.pos;if(o++,s.push(p),!1!=$(p)){if(1>p.readOpacity())for(let _=f-1;_<=f+1;_++)for(let g=m-1;g<=m+1;g++)a[_]||(a[_]={}),a[_][g]||(a[_][g]=1,n.push(grid[_][g]));if(p.readOpacity()>=1){let b=d(i,p.pos);for(let w=b[0];w<=b[1];w++)h[w]=Math.min(h[w],b[2])}}}return s.forEach(function(e){}),s}getplayerview(){let[e,t]=this.pos,i=[e,t];grid[e][t].elevation;let s=[],a={},n=[];n.push(grid[e][t]);let o=0,l=Array(360).fill(99);function c(e,t){let[i,s]=e,[a,n]=t,o=[[a-.5,n-.5],[a+.5,n-.5],[a-.5,n+.5],[a+.5,n+.5]],[l,c]=[0,0],h,d,u=[];for(let $=0;$<4;$++)[l,c]=o[$],d=((d=(h=Math.atan2(c-s,l-i))*(180/Math.PI))+360)%360,u[$]=Math.round(d);let p=Math.min(...u),f=Math.max(...u);return Math.abs(p-f)>270?[p,p,chebyshevDistance(e,t)]:[p,f,chebyshevDistance(e,t)]}function h(e){let t=c(i,e.pos);for(let s=t[0];s<=t[1];s++)if(t[2]<=l[s])return!0;return!1}for(;n.length>0;){let d=n.shift(),[u,$]=d.pos;if(o++,s.push(d),!1!=h(d)){if(1>d.readOpacity(void 0,i))for(let p=u-1;p<=u+1;p++)for(let f=$-1;f<=$+1;f++)a[p]||(a[p]={}),a[p][f]||(a[p][f]=1,n.push(grid[p][f]));if(d.readOpacity(void 0,i)>=1){let m=c(i,d.pos);for(let _=m[0];_<=m[1];_++)l[_]=Math.min(l[_],m[2])}}}return s}getplayerviewnew(){}}class playerCharacter extends character{constructor(e,t,i,s,a,n,o,l,c,h,d,u){super(e,t,i,s,a,n,o,l,c,h,d,u),this.reactions=[attackofop,overwatch,autopickup,block],this.level=1,this.recalculatehealth(),this.cantwohand=!0}levelup(){if(this.level++,3==this.level){let e=this.specialattack,t=function(t,i){let s=e.bind(this),a=extraattack.bind(this);return a(s(t,i),i)};this.specialattack=t}this.primarystat||(this.primarystat=0),this.secondarystat||(this.secondarystat=2),this.stats[this.primarystat]++,this.level%2==1&&this.stats[this.secondarystat]++,this.recalculatehealth()}recalculatehealth(){let e=this.maxhp;this.maxhp=2*this.stats[2],this.maxhp+=Math.max(this.stats[2],1)*this.level;let t=this.maxhp-e;t>0&&(this.hp+=t)}hear(e,t){if(t<1||this.dead&&!(!0==gameover&&deathcharacter==this)||!0===e.heard)return;let i=this,[s,a]=e.pos;e.heard=!0;let n=[];e.soundeffect&&(n=e.soundeffect.slice());let o=[];if(n.forEach(function(i,s){o[s]=[],o[s]=i.slice(),void 0===o[s][6]&&(o[s][6]=1),0!==o[s][6]&&(o[s][6]*=Math.max(Math.min((t/e.volume)**.5,1),.1))}),!0==e.origin.pc){playsoundeffect(o);return}if(!1==grid[s][a].visible){setTimeout(()=>{adduilabel("^",e.pos,i.color,0,!0,!1,!1,!0,1),playsoundeffect(o)},(e.volume-t)*50);return}playsoundeffect(o)}die(){super.die();let e=!0;for(let t=0;t<playercs.length;t++)!0!==playercs[t].dead&&(e=!1);e&&(gameover=!0,deathcharacter=this)}}class Fugitive extends playerCharacter{constructor(e){super(e,"Fugitive",statblocks.Exile,6,[4,1,1],!0,"@",[0,32,0],14,[],[],sneakattackpermute);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.primarystat=1,this.specialattack=i}}class Huntsman extends playerCharacter{constructor(e){super(e,"Huntsman",statblocks.Wanderer,6,[4,1,1],!0,"@",[128,96,64],14,[],[],sharpshooterpermute);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.primarystat=1,this.specialattack=i}}class Stalker extends playerCharacter{constructor(e){super(e,"Stalker",statblocks.Stalker,6,[4,1,2],!0,"@",[12,12,12],14,[],[],e=>e);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.primarystat=1,this.specialattack=i,this.reactions.push(ambush)}}class Skirmisher extends playerCharacter{constructor(e){super(e,"Skirmisher",statblocks.Skirmisher,6,[4,1,1],!0,"@",[0,16,32],14,[],[],disengagepermute);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this),n=jumpattack.bind(this);return n(a(s(e,i),i),i)};this.primarystat=1,this.specialattack=i,this.reactions.push(evade)}}class Deserter extends playerCharacter{constructor(e){super(e,"Deserter",statblocks.Deserter,9,[4,1,1],!0,"@",[128,128,128],14,[],[],torchbearerpermute),this.offhanditem=new Torch(300);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.specialattack=i}}class Berserker extends playerCharacter{constructor(e){super(e,"Berserker",statblocks.Berserker,9,[4,1,1],!0,"@",[160,64,32],14,[],[],savageattack);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.primarystat=2,this.secondarystat=0,this.specialattack=i}}class Hellion extends playerCharacter{constructor(e){super(e,"Hellion",statblocks.Hellion,9,[4,1,1],!0,"@",[64,0,8],14,[],[],chargeattackpermute);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.specialattack=i}}class Standard_Bearer extends playerCharacter{constructor(e){super(e,"Standard Bearer",statblocks.Standard_Bearer,6,[4,1,1],!0,"@",[64,64,16],14,[],[],inciteattack);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.specialattack=i}}class Sentinel extends playerCharacter{constructor(e){super(e,"Sentinel",statblocks.Sentinel,9,[4,1,1],!0,"@",[64,96,96],14,[],[],e=>e);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.specialattack=i,this.reactions=this.reactions.filter(e=>e!==block),this.primarystat=2,this.secondarystat=0,this.reactions.push(defender),this.reactions.push(riposte)}}class ShieldMaiden extends playerCharacter{constructor(e){super(e,"Shield Maiden",statblocks.ShieldMaiden,9,[4,1,2],!0,"@",[64,96,96],14,[],[],shieldbash);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.primarystat=2,this.secondarystat=0,this.specialattack=i,this.reactions.unshift(defender)}}class Ranger extends playerCharacter{constructor(e){super(e,"Ranger",statblocks.Ranger,6,[4,1,1],!0,"@",[64,128,64],14,[],[],e=>e);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpluspermute.bind(this);return a(s(e,i),i)};this.specialattack=i}}class Duelist extends playerCharacter{constructor(e){super(e,"Duelist",statblocks.Ranger,6,[4,1,1],!0,"@",[64,128,96],14,[],[],e=>e);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.reactions.push(parry),this.primaryitem=new Dagger,this.offhanditem=new Dagger,this.specialattack=i}}class Maledict extends playerCharacter{constructor(e){super(e,"Maledict",statblocks.Exile,6,[4,1,1],!0,"@",[32,0,0],14,[],[],bloodattack);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.specialattack=i}}class Prisoner extends playerCharacter{constructor(e){super(e,"Prisoner",statblocks.Prisoner,6,[4,1,1],!0,"@",[64,32,0],10,[],[],e=>e);let t=this.specialattack,i=function(e,i){let s=t.bind(this),a=dualwieldpermute.bind(this);return a(s(e,i),i)};this.specialattack=i}}class enemy extends character{constructor(e,t,i,s,a,n,o,l,c,h,d,u,$){super(e,t,i,s,a,n,o,l,c,h,d,$),this.startingpos=e.slice(),this.knowntiles={},this.tasks=[],this.knownenemies=[],this.activetask,this.huntmap,this.huntedcharacters={},this.knowncharacters={},this.visiblecharacters={},this.utilityfunctions=[],this.actions=[],this.reactions=u||[],this.reactions.push(moralecheck),this.hp+=Math.round(4*Math.random()),this.maxhp=this.hp,this.morale=3*this.maxhp,this.actions=[moveusecase,attackusecase,dashusecase,chatusecase,standgroundusecase,alertusecase],this.states=[new State("idle",defaultidle,null,[0,3]),new State("hostile",defaulthostile,defaulttemperment,[0,1]),new State("hunting",defaulthunting,null,[0]),new State("fleeing",defaultfleeing,null,[0,1,5])],this.updatestate(),this.deathsound=soundeffects.goblindeath,spot(this)}damage(e){super.damage(e),this.moraledamage(e)}moraledamage(e){this.morale-=e,this.morale<=0&&(this.state=this.states[3]),this.morale>0&&(this.state=this.states[1]);let t=this.maxhp-this.hp,i=3*this.maxhp-4*t;this.morale=Math.min(i,this.morale)}updatestate(){let e=this;this.state||(this.state=this.states[0]);let t=!1,i=!1;Object.values(e.visiblecharacters).forEach(function(s){let a=s.character;a.pc!=e.pc&&(t=!0,i=!0)}),!1==t&&Object.values(e.knowncharacters).forEach(function(t){let s=t.character;s.pc!=e.pc&&(console.log(t),console.log(t.lastseen),adduilabel("!",t.lastseen,[256,256,256],0,!0,!1,!1,!0),i=!0)}),this.state.name==this.states[0].name&&!0==i&&(this.state=this.states[1],this.actionqueue=[],addconditiondynamic(conditions.Surprised,!0,this)()),this.state.name==this.states[1].name&&!1==i?(this.huntmap=null,this.state=this.states[2],this.actionqueue=[]):this.state.name==this.states[2].name&&!0==t&&(this.state=this.states[1],this.actionqueue=[])}hear(e,t){let i=this;if(e.origin!=i){if(e.origin.pc!==this.pc)this.visiblecharacters[e.origin.index]=new CharacterMemory(e.origin,e.origin.pos.slice()),this.knowncharacters[e.origin.index]=new CharacterMemory(e.origin,e.origin.pos.slice()),this.updatestate();else if("Attack"==e.content||"Miss"==e.content){let[s,a]=e.pos,n;grid[s][a].character&&grid[s][a].character.pc!==this.pc&&(n=grid[s][a].character),n&&(this.visiblecharacters[n.index]=new CharacterMemory(n,n.pos.slice()),this.knowncharacters[n.index]=new CharacterMemory(n,n.pos.slice())),this.updatestate()}else if("Alert"==e.content||"Huh?"==e.content){if(e.origin.knowncharacters){let o=!1;Object.values(e.origin.knowncharacters).forEach(function(e){let t=e.character,s=e.lastseen;if((!i.visiblecharacters[t.index]||i.visiblecharacters[t.index].time<e.time)&&t.pc!==i.pc){let a=new CharacterMemory(t,s);i.visiblecharacters[t.index]=a,i.knowncharacters[t.index]=a,i.state.name==i.states[0].name&&(o=!0)}}),o&&i.updatestate()}else console.log("trying to alert, but don't know any enemies")}}}getrange(e=this.primaryitem){let t=super.getrange(e);return!0==e.throwable&&e.number<2&&(this.primaryitem.name==this.unarmed.name||this.secondaryitem.name==this.unarmed.name)&&(t=1.9),e.ammotype&&!this.ammunition[e.ammotype]&&(t=0),t}update(){if(this.state.name==this.states[3].name){let e=Object.values(this.visiblecharacters);for(let t=0;t<e.length;t++)e[t].character.pc==this.pc&&this.moraledamage(-1)}}}class Human extends enemy{constructor(e,t,i,s){super(e,t,statblocks.Goblin,4,[4,1,1],!1,"@",i,10,[],s,[spot,attackofop])}getvisibletiles(){let[e,t]=this.pos,i=this,s=[],a=[],n=new Set;a.push(grid[e][t]);let o=0;for(let l=0;l<this.visibletiles.length;l++){let c=this.visibletiles[l];c.removevisiblecharacter(i)}for(;a.length>0&&o<1e3;){o++;let h=a.shift(),[d,u]=h.pos;if(1>drawLine3D([e,t,grid[e][t].elevation+1],[d,u,grid[d][u].elevation])){let $=`${h.pos[0]},${h.pos[1]}`;if(grid[d][u].lightlevel>0&&(s.push(h),h.addvisiblecharacter(i),i.knowntiles[$]=turncounter),dist([e,t],[d,u])<enemysightrange)for(let p=d-1;p<=d+1;p++)for(let f=u-1;f<=u+1;f++){let m=`${p},${f}`;!n.has(m)&&grid[p]&&grid[p][f]&&(n.add(m),a.push(grid[p][f]))}}else if(drawline([e,t],[d,u],!0))for(let _=d-1;_<=d+1;_++)for(let g=u-1;g<=u+1;g++){let b=`${_},${g}`;!n.has(b)&&grid[_]&&grid[_][g]&&(n.add(b),a.push(grid[_][g]))}}this.visibletiles=s}}class Bandit extends Human{constructor(e){super(e,"Bandit",[64,64,32],[]),this.offhanditem=new Torch(25)}}class Goblin extends enemy{constructor(e,t,i,s){t||(t="Goblin"),i||(i=[150,125,0]),s||(s=Math.random()>.5?[new Shiv]:[new Club]),super(e,t,statblocks.Goblin,4,[5,1,1],!1,"g",i,8,[],s,[spot,attackofop,lightsensitive],darkattackpermute)}}class Goblin_Dagger extends Goblin{constructor(e){let t;super(e,"Goblin",[150,125,0],[t=Math.random()>.5?new Dagger(1):new Javelin(1)])}}class Goblin_Swordsman extends Goblin{constructor(e){let t=[];Math.random()>.5?t.push(new Shortsword):t.push(new Scimitar),Math.random()>.5&&t.push(new Dagger(randomNumber(2,1))),super(e,"Goblin Swordsman",[150,125,0],t),Math.random()>.5&&(this.offhanditem=new Shield,this.reactions.push(block))}}class Goblin_Spearman extends Goblin{constructor(e){super(e,"Goblin Spearman",[150,125,0],[new Spear]),Math.random()>.5&&(this.offhanditem=new Shield,this.reactions.push(block))}}class Hobgoblin extends Goblin{constructor(e){super(e,"Hobgoblin",[100,15,15],[]),.25>Math.random()?this.primaryitem=new Longsword:.33>Math.random()?(this.primaryitem=new Longbow,this.ammunition.Arrow=5+Math.ceil(5*Math.random())):.5>Math.random()?this.primaryitem=new Mace:this.primaryitem=new Battleaxe,this.maxhp+=7,this.hp=this.maxhp}}class Hobgoblin_Warlord extends Hobgoblin{constructor(e){super(e),this.name="Hobgoblin Warlord",this.primaryitem=this.unarmed,this.secondaryitem=this.unarmed,this.offhanditem=this.unarmed;let t=[[Handaxe,Shield],[]];this.primaryitem=new t[0][0],this.offhanditem=new t[0][1],this.maxhp+=7,this.hp=this.maxhp;let i=this.specialattack,s=function(e,t){let s=i.bind(this),a=dualwieldpermute.bind(this);return a(s(e,t),t)};this.specialattack=s,this.reactions.push(block)}}class Goblin_Longbow extends Goblin{constructor(e){super(e,"Goblin Archer",[100,150,0],[]),this.ammunition.Arrow=randomNumber(5,2),this.primaryitem=new Longbow}}class Goblin_Shortbow extends Goblin{constructor(e){super(e,"Goblin Archer",[100,150,0],[]),this.ammunition.Arrow=randomNumber(5,2),this.primaryitem=new Shortbow}}class Goblin_Wargmaster extends Goblin{constructor(e){let t;super(e,"Goblin",[150,125,0],[t=Math.random()>.5?new Dagger(1):new Javelin(1)]);let i=new Warg_Tame(e),s=new Leash;i.master=this,i.leash=s,grid[e[0]][e[1]].addCharacter(i),grid[e[0]][e[1]].addObject(s)}}class Goblin_Hivequeen extends Goblin{constructor(e){super(e,"Goblin Hive Queen",[128,128,128],[new Athame(1)]),this.ac=12,this.maxhp*=3,this.hp=this.maxhp,this.shriekcooldown=-3,this.offhanditem=new Light("Glowing Jade",".",[.6,.4,.6]),this.offhanditem.lightsources=[new lightsource(null,[256,164,256],[1,1,1],2)],this.deathsound=soundeffects.deathshriek}damage(e){super.damage(e),!0!=this.dead&&this.Shriek()}Shriek(){if(turncounter-this.shriekcooldown<3)return;this.shriekcooldown=turncounter;let e=this.color,[t,i]=this.pos;hear(new Sound([t,i],16,this,"Shriek",soundeffects.goblinshriek),16,0,[6,4,6]),adduilabel("Shriek",this.pos,e,1,!0);for(let s=t-10;s<t+10;s++)for(let a=i-10;a<i+10;a++)grid[s]&&grid[s][a]&&10>dist([t,i],[s,a])&&(grid[s][a].objects.length>0&&Math.random()>.5&&"Spawning Membrane"==grid[s][a].objects[0].name&&grid[s][a].objects[0].damage(1),null!==grid[s][a].character&&grid[s][a].character.pc!==this.pc&&addconditiondynamic(conditions.Stunned,!0,grid[s][a].character)())}die(){let[e,t]=this.pos;super.die();for(let i=e-25;i<e+25;i++)for(let s=t-25;s<t+25;s++)if(grid[i]&&grid[i][s]){let a=grid[i][s].character;null!=a&&(a instanceof Goblin||a instanceof Ogre||a instanceof Giant)&&(a.pc=Math.round(1e3*Math.random())+2)}won=!0}}class Necromancer extends enemy{constructor(e){super(e,"Necromancer",[0,0,0],16,[4,1,1],3,"@",[256,256,256],10,[],[new Athame],[spot,attackofop])}damage(e){super.damage(e),!0!==this.dead&&this.raiseDead()}raiseDead(){let[e,t]=this.pos;for(let i=e-5;i<e+5;i++)for(let s=t-5;s<t+5;s++)if(grid[i]&&grid[i][s]&&grid[i][s].objects.length>0){let a=grid[i][s].objects[0];a instanceof corpse&&!a.burning&&!a.burnt&&(a.break(),grid[i][s].addCharacter(new Zombie([i,s])))}}}class Zombie extends enemy{constructor(e){super(e,"Zombie",[0,0,0],8,[3,1,0],3,"z",[64,128,32],10,[],[],[])}}class ElderSpider extends enemy{constructor(e){super(e,"Elder Spider",[0,2,0],18,[5,1,1],2,"S",[48,0,16],14,[],[],[spot,attackofop]),this.primaryitem.specialeffect=conditionattackpermute(conditions.Poisoned),this.secondaryitem.name="Web",this.secondaryitem.ammotype="Web",this.ammunition.Web=10,this.secondaryitem.minrange=3,this.secondaryitem.range=10,this.secondaryitem.specialeffect=function(e,t){let[i,s]=t,a=function(){grid[i][s].addObject(new Spiderweb),grid[i][s].addObject(new Spiderweb),grid[i][s].addObject(new Spiderweb)};return e.onhiteffects.push(a),e.onmisseffects.push(a),e}}}class GiantSpider extends enemy{constructor(e){super(e,"Giant Spider",[0,0,0],9,[5,1,1],2,"s",[24,24,24],10,[],[],[spot,attackofop]),this.primaryitem.specialeffect=conditionattackpermute(conditions.Poisoned),this.secondaryitem.name="Web",this.secondaryitem.ammotype="Web",this.ammunition.Web=1,this.secondaryitem.minrange=3,this.secondaryitem.range=5,this.secondaryitem.specialeffect=function(e,t){let[i,s]=t,a=function(){grid[i][s].addObject(new Spiderweb),grid[i][s].addObject(new Spiderweb),grid[i][s].addObject(new Spiderweb)};return e.onhiteffects.push(a),e.onmisseffects.push(a),e}}}class SpiderBroodMother extends enemy{constructor(e){super(e,"Spider Brood Mother",[0,0,0],9,[5,1,1],2,"s",[64,24,64],10,[],[],[spot,attackofop]),this.secondaryitem.name="Web",this.secondaryitem.ammotype="Web",this.ammunition.Web=1,this.secondaryitem.minrange=3,this.secondaryitem.range=5,this.secondaryitem.specialeffect=function(e,t){let[i,s]=t,a=function(){grid[i][s].addObject(new Spiderweb),grid[i][s].addObject(new Spiderweb),grid[i][s].addObject(new Spiderweb)};return e.onhiteffects.push(a),e.onmisseffects.push(a),e}}die(){let[e,t]=this.pos;for(let i=0;i<4;i++)grid[e][t].addCharacter(new Spiderling([e,t]));super.die()}}class Spiderling extends enemy{constructor(e){super(e,"Spiderling",[0,0,0],3,[3,1,1],2,"s",[48,48,48],8,[],[],[spot,attackofop])}}class Ogre extends enemy{constructor(e){super(e,"Ogre",[3,0,4],12,[3,1,1],!1,"o",[150,125,0],8,[],[new Warhammer],[spot,attackofop],darkattackpermute),this.deathsound=soundeffects.ogredeath,this.large=!0}}class Giant extends enemy{constructor(e){super(e,"Giant",[3,0,4],24,[3,1,1],!1,"G",[150,125,0],8,[],[new Polehammer],[spot,attackofop],darkattackpermute),Math.random()>.33&&(Math.random()>.5?this.primaryitem=new Halberd:this.primaryitem=new Greatsword),this.deathsound=soundeffects.ogredeath,this.large=!0}}class Skulker extends enemy{constructor(e){super(e,"Skulker",[0,2,0],5,[10,1,1],!1,"s",[32,32,32],12,[],[new Bolas(randomNumber(3,1))],[spot,attackofop,lightsensitive],darkattackpermute),this.secondaryitem=new Kukri}}class Wolf extends enemy{constructor(e){super(e,"Wolf",[0,0,0],5,[8,2,1],2,"w",[64,64,64],8,[],[new Dagger],[spot,attackofop])}}class Warg extends enemy{constructor(e){super(e,"Warg",[0,0,0],5,[8,1,1],2,"w",[96,64,64],8,[],[],[spot,attackofop])}}class Warg_Tame extends enemy{constructor(e){super(e,"Warg",[0,0,0],5,[8,1,1],!1,"w",[96,64,64],8,[],[],[spot,attackofop])}}class Carrion_Insect extends enemy{constructor(e){super(e,"Carrion Insect",[0,0,0],5,[8,2,1],2,"c",[128,128,128],8,[],[],[spot,attackofop])}}class State{constructor(e,t,i,s){this.name=e,this.utilityfunction=t,this.temperment=i||function(){return 0},this.actions=[],s&&(this.actions=s.slice())}}class CharacterMemory{constructor(e,t){this.character=e,this.lastseen=t.slice(),this.time=turncounter}getage(){return turncounter-this.time}}class Statblock{constructor(e,t,i){this.strength=e,this.dexterity=t,this.constitution=i}}class lightsource{constructor(e,t,i,s){this.pos=e,this.color=t,this.lightpref=i,this.radiance=s||2}}class uielement{constructor(e,t,i,s,a,n,o){this.symbol=e||"",this.color=t,this.pos=i,this.animation=s||!1,this.symbol||(this.symbol="$"),this.ui=a||!1,this.lifespan=n||null,this.tooltip=o}}class PriorityQueue{constructor(e){this.array=[],this.comparator=e}enqueue(e){let t=0,i=this.array.length;for(;t<i;){let s=Math.floor((t+i)/2);0>this.comparator(this.array[s],e)?t=s+1:i=s}this.array.splice(t,0,e)}dequeue(){return this.array.shift()}isEmpty(){return 0===this.array.length}}class condition{constructor(e,t,i,s,a,n,o){this.name=e,this.starteffect=t||(()=>{}),this.turneffect=i||(()=>{}),this.duration=s,this.resistance=a,this.character=o||null,this.endeffect=n}}class trait{constructor(e,t,i,s,a,n){this.name=e,this.trigger=t,this.effect=i,this.character=n||null,this.passive=s||!1,this.active=a||!1}}class trigger{constructor(e,t,i){this.isactive=e,this.ispassive=t,this.cb=i}}class action{constructor(e,t,i,s,a,n,o,l,c,h){this.name=e,this.target=a.slice(),this.func=t,this.character=n,this.cost=i.slice(),this.range=s||1.9,this.pos=o||null,this.warnings=[],l&&(this.warnings=l.slice()),this.soundeffect=c,this.loudness=h||1,this.reactable=!0}}class Move extends action{constructor(e,t,i,s,a,n,o,l){super(e,t,i,s,a,n,o,l);let[c,h]=this.target;if(this.cost[0]=grid[c][h].moveCost,this.pos&&this.character&&this.target){checkforaoomove(this.pos,this.target,this.character)&&this.warnings.push("!");let d=grid[c][h].gethazards(n.pc);d.some(e=>e>0)&&this.warnings.push("!")}if(this.loudness=6,this.character.state&&(this.character.state.name,this.character.states[0].name),this.soundeffect=soundeffects.footstep,grid[c][h].absorbtionBase==materials.stone&&(this.soundeffect=soundeffects.footsteptap),!0==n.large&&(this.soundeffect=soundeffects.deepthud,this.loudness=12),"Maledict"==n.name&&grid[c][h].fluids.length>0)for(let u of grid[c][h].fluids)"Blood"==u.name&&(this.cost=[0,0,0])}}class Sneak extends Move{constructor(e,t,i,s,a,n,o,l){super(e,t,i,s,a,n,o,l),this.loudness=1}}class Fall extends action{constructor(e,t,i){super("Fall",movefunc,[0,0,0],1,e,t,i),this.reactable=!0,this.func=function(){let[i,s]=e;grid[i][s].character&&grid[i][s].character.damage(1);let a=!0;!1===movefunc.bind(this)(!0)?(a=!1,t.damage(1)):grid[i][s].moveCost>1&&addconditiondynamic(conditions.Prone,!0,t)(),grid[i][s].objects.length>0&&grid[i][s].objects.forEach(e=>e.damage(1))}}}class Attack extends action{constructor(e,t,i,s,a,n,o,l){if(super(e,t,i,s,a,n,o,l),!0==this.character.primaryitem.reloading){let c=this.func,h=this,d=this.character.primaryitem;!1==this.character.primaryitem.reloaded?(this.func=reloadfunc,!0==n.pc&&(verbose&&this.warnings.push("Click to reload"),this.warnings.push("Unloaded"))):this.func=function(e,t){!0!==e&&(d.reloaded=!1);let i=c.bind(h),s=i(e,t);return e||!1===s?d.reloaded=!0:d.reloaded=!1,s}}let[u,$]=this.target.slice();this.pos&&this.character&&this.target&&checkforaooattack(this.pos,this.target,this.character)&&this.warnings.push("!"),this.loudness=12}}class Jump extends action{constructor(e,t,i,s){chebyshevDistance(t,s),super("Jump",jumpfunc,[0,1,0],e,t,i,s);let a=grid[t[0]][t[1]].elevation-grid[s[0]][s[1]].elevation;a<-2&&this.warnings.push("fall")}}class Kick extends Attack{constructor(e,t,i){super("Attack",null,[0,1,0],1.9,e,t,i);let s=this,a=function(e,t){return attackfunc.apply(s,[e,new Foot])};this.func=a}}class Throw extends Attack{constructor(e,t,i,s){super("Attack",null,[0,1,0],3.5,e,t,i);let a=this;if(s.throwable)this.func=attackfunc;else{let n=function(e,t){return attackfunc.apply(a,[e,new Projectile(s)])};this.func=n}}}class Offhandattack extends Attack{constructor(e,t,i){super("Attack",null,[0,0,0],t.offhanditem.range,e,t,i);let s=this,a=function(e,i){return attackfunc.apply(s,[e,t.offhanditem])};this.func=a}}function jumpfunc(){let e=this.character,t=grid[e.pos[0]][e.pos[1]],[i,s]=this.target,a=grid[i][s].elevation-t.elevation;if(dist(e.pos,this.target,!1,!0)>this.range)return!1;let n=bresenhamLine(e.pos,this.target);if(0==n.length||1==n.length)return!1;for(let o=0;o<n.length;o++){let l=grid[n[o][0]][n[o][1]];if(!1==l.traversable&&!l.slope)return!1}if(!1!==grid[i][s].traversable&&null==grid[i][s].character){if(grid[e.pos[0]][e.pos[1]].character=null,e.pos=[i,s],grid[i][s].character=this.character,removecondition(e,"Prone"),a<-2){let c=0,h=Math.floor(a/2)**2;for(let d=0;d<h;d++)c+=randomNumber(3,1);this.soundeffect=soundeffects.deepthud,this.loudness=10,addconditiondynamic(conditions.Prone,!0,e)(),this.character.damage(c)}return}if(!1!==grid[i][s].traversable&&null!==grid[i][s].character&&a<-1){grid[e.pos[0]][e.pos[1]].character=null,e.pos=[i,s],grid[i][s].addCharacter(this.character),removecondition(e,"Prone");let u=0,$=Math.floor(a/2)**2;for(let p=0;p<$;p++)u+=randomNumber(3,1);this.soundeffect=soundeffects.deepthud,this.loudness=10,addconditiondynamic(conditions.Prone,!0,e)(),this.character.damage(u),grid[i][s].character.damage(u);return}return e.actionqueue=[],!1}class Get extends action{constructor(e,t,i,s,a,n,o,l,c,h){super(e,t,i,s,a,n,o,l,c,h),this.reactable=!1}}class endTurn extends action{constructor(e,t,i,s,a,n,o,l){if(super(e,t,i,s,a,n,o,l),this.reactable=!1,this.pos){let[c,h]=this.pos;grid[c][h].objects.length>0&&grid[c][h].objects[0].burning&&this.warnings.push("!")}}}class Tile{constructor(e,t,i,s,a,n,o){this.name,this.absorbtionBase=t,this.symbolBase=i,this.visible=!1,this.light=[0,0,0],this.lightlevel=0,this.objects=[],this.character=null,this.uiElements=[],this.traversable=s,this.moveCost=a,this.baseMoveCost=a,this.pos=o,this.transparancy=n,this.specularity=0,this.charactersinview=[],this.fluids=[],this.elevation=0}read(e=!1){let t=this.readOpacity();procgendebug&&(this.visible=!0,this.light=[64,64,64]);let[i,s]=this.pos,a=this.light;if(t>=1&&null==this.character){let n=[0,0,0],o=0;for(let l=0;l<8;l++){let[c,h]=directions[l],[d,u]=[i+c,s+h];if(d<0||d>=mapsizey||u<0||u>=mapsizex)continue;let $=grid[d][u];if(!1==$.visible)continue;let p=$.light;if(1>$.readOpacity()){let f=p[0]+p[1]+p[2];f>o&&(n[0]=p[0],n[1]=p[1],n[2]=p[2],o=f)}}a=n}let m=[0,0,0],_=[0,0,0],g="&nbsp",b=1;if(t>=1&&(b=.25),!1!==this.visible){let w=0;for(let v=0;v<3;v++)m[v]=256*(a[v]*this.absorbtionBase[v]*b*noisemap[i][s]/256)**(1/gamma),_[v]=128*(Math.max(a[v]*this.absorbtionBase[v]*b,0)*noisemap[i][s]/256)**(1/gamma),w+=m[v];if(w<3*memorytilebrightness){let k=3*memorytilebrightness/(w=Math.max(w,.5));for(let A=0;A<3;A++)m[A]*=k}g=this.symbolBase}if(this.fluids.length>0&&!1!==this.visible){let S=[1,1,1];this.fluids.forEach(function(e){if(e.symbol&&(g=e.symbol),null!==e.bgabsorbtion){let t=1;e.thickness&&(t=e.thickness);for(let i=0;i<t;i++)S=S.map((t,i)=>t*e.bgabsorbtion[i])}});for(let z=0;z<3;z++)m[z]=Math.max(m[z]*S[z],0),_[z]=m[z]/2}if(this.objects.length>0&&!1!==this.visible){let C=this.objects[0];if(C.symbol&&(g=C.symbol),C.absorbtion)for(let E=0;E<3;E++)m[E]=256*(Math.max(a[E]*C.absorbtion[E],0)/256);if(null!==C.bgabsorbtion)for(let j=0;j<3;j++)_[j]=a[j]*C.bgabsorbtion[j]*.5}if(null!==this.character&&!1!==this.visible){let q=this.character;if(!1!==q){let W=takeav(grid[i][s].light)/256;m=q.color.map(e=>Math.max(e/2,W*e)),_=_.map(e=>.75*e),g=q.symbol}}if(!0==this.seen&&!0!==this.visible&&(g=this.symbolBase,m=[memorytilebrightness,memorytilebrightness,memorytilebrightness]),!this.seen&&this.visible&&(this.seen=!0),this.uiElements.length>0)for(let F=0;F<this.uiElements.length;F++){let D=this.uiElements[F];if(!D.lifespan||!(D.lifespan[1]>=now)){if("$"===D.symbol)for(let R=0;R<3;R++)m[R]+=256*D.color[R],_[R]+=128*D.color[R];else if("^"===D.symbol){D.symbol="B7",g=D.symbol;for(let B=0;B<3;B++)m[B]=D.color[B]}else if("_"==D.symbol)for(let G=0;G<3;G++)m[G]=256*D.color[G],_[G]=256*D.color[G];else if(" "===D.symbol);else{g=D.symbol;for(let O=0;O<3;O++)m[O]=D.color[O]}!D.lifespan&&(this.uiElements.splice(F,1),F--)}}for(let M=0;M<3;M++)m[M]=Math.round(m[M]*brightnessadjust),_[M]=Math.round(_[M]*brightnessadjust);if(e)return[m,_,g];if("&nbsp"==g)return`<span 
                y = ${i}
                x = ${s}
                >&nbsp</span>`;let T=`<span 
            y=${i};
            x=${s};
            style="color: rgb(${m});background-color: rgb(${_});">${g}</span>`;return T}updateui(){for(let e=0;e<this.uiElements.length;e++){let t=this.uiElements[e];t.lifespan&&t.lifespan[0]<now&&(this.uiElements.splice(e,1),updatedsomething=!0,e--),!0==t.unrendered&&t.lifespan&&t.lifespan[1]>now&&(t.unrendered=!1,updatedsomething=!0)}}cursorread(e=!1){let t=this,i=0,s=this.character,a=!1;for(let n=0;n<this.uiElements.length;n++){let o=this.uiElements[n];if(void 0!==o.redirect&&(o.redirect.cursorread(!0),a=!0),o.tooltip&&verbose){let l=[],c=o.tooltip,h=-15+Math.min(c.length,15);for(;c.length>15;){let d=0;for(;" "!=c[15+d];){if(" "==c[15-d]){d=-d;break}d++}let u=c.slice(0,15+d);c=c.slice(15+d),l.push(u),h=Math.max(h,d)}l.push(c);let $=15+h,p=[viewportpos[0]+viewportsizey/2-2,viewportpos[1]-1];cursorpos[0],l.length,viewportpos[0];for(let f=-1;f<l.length+1;f++)adduilabel(repeatchar("_",$+2),p,[.1,.1,.1],(l.length-f)*1,!1,!1,!1,!0);for(let m=0;m<l.length;m++)adduilabel(l[m],p,o.color,(l.length-m)*1,!1,!1,!1,!0)}if(a)break}if(!a&&(this.fluids.length>0&&this.fluids.forEach(function(e){i++,adduilabel(e.name,t.pos,[64,64,64],i)}),this.objects.length>0&&this.objects.forEach(function(e){i++;let s=adduilabel(e.name,t.pos,[64,64,64],i);if(e instanceof Weapon){for(let a=0;a<s.length;a++)s[a].redirect=t;let n=[],o=0,l=`1-${e.damagedie.toString()}`;u("Damage Range"),l+=`+${activecharacternonindex.getatkbonus(e)}`,u("Bonus"),e.throwable&&(l+="(Thrown)",u()),e.twohanded&&(l+="(Two-handed)",u()),1==e.stat&&(l+="(Finnesse)",u("Bonus determined by dexterity")),e.versatile&&(l+="(Versatile)",u("Can be wielded with 1 or 2 hands")),e.light&&(l+="(Light)",u("Can be wielded in offhand")),!0==e.shove&&(l+=`(Shove${Math.max(activecharacternonindex.stats[0],1)})`,u("Shoves enemies using strength")),!0==e.trip&&(l+="(Trip)",u("Knocks enemies prone")),e.bleed&&(l+="(Bleed)",u()),e.disarm&&(l+="(Disarm)",u()),e.cleave&&(l+="(Cleave)",u("Hits multiple adjacent targets")),e.consumable&&(l+="(Consumable)",u()),i++;let c=adduilabel(l,t.pos,[64,64,64],i);for(let h=0;h<c.length;h++){let d=c[h];d.redirect=t,n[h]&&(d.tooltip=n[h])}function u(e){for(let t=o;t<l.length;t++)n.push(e);o=l.length}}if(e instanceof Shield){let $=`Dmg-${activecharacternonindex.stats[0]}`;i++,adduilabel($,t.pos,[64,64,64],i)}if(e.verbose){let p=e.verbose();i++,adduilabel(p,t.pos,[256,256,256],i)}}),null!==s)){let _=s.name,g=s.hp,b=s.pos,w=g.toString(),v=s.maxhp,k;i++,k=adduilabel(w+"/"+v,b,s.color,i);for(let A=0;A<k.length;A++)k[A].redirect=t;i++,k=adduilabel(_,b,s.color,i);for(let S=0;S<k.length;S++)k[S].redirect=t;for(let z=0;z<s.conditions.length;z++){i++;let C=s.conditions[z].name+"("+s.conditions[z].duration.toString()+")";k=adduilabel(C,b,s.color,i);for(let E=0;E<k.length;E++)k[E].redirect=t}let j=[s.primaryitem,s.secondaryitem,s.offhanditem];for(let q=0;q<3;q++){let W=j[q].name;if("Unarmed"!=W){i++,k=adduilabel(W,s.pos,s.color,i);for(let F=0;F<k.length;F++)k[F].redirect=t}}}}readOpacity(e,t){if(void 0!==e&&e<this.elevation)return 1;let i=this.transparancy;if(null!==this.character&&(void 0==e||e-1<=this.elevation)?lackscondition(conditions.Prone,this.character)&&(i=.75):this.objects.length>0&&(t&&"Fortification"==this.objects[0].name&&2>dist(t,this.pos)||(void 0==e||e<=this.elevation+1||!1==this.objects[0].traversable)&&(i-=this.objects[0].opacity)),this.fluids.length>0)for(let s=0;s<this.fluids.length;s++){let a=this.fluids[s],n=1;a.thickness&&(n=a.thickness),i*=1-a.opacity}return 1-i}addCharacter(e){if(null==this.character&&!0===this.traversable)this.character=e,e.pos=this.pos.slice();else{if(e.iterations||(e.iterations=0),e.iterations>50)return;e.iterations++;let t=shuffle(directions),i=[],[s,a]=this.pos;for(let n=0;n<t.length;n++){let[o,l]=t[n],[c,h]=[s+o,a+l];if(!grid[c]||!grid[c][h])continue;let d=grid[c][h];if(i.push(d),null==d.character&&!0==d.traversable){d.addCharacter(e);return}}i[0].addCharacter(e)}}addObject(e){if(e.number<=0)return;if(void 0!==e.number&&isNaN(e.number)){console.log("we tried to add this object to a tile, but it had a quantity that didn't make any sense"),console.log(e);return}if(e instanceof fluid){this.addFluid(e);return}if(!(e.number>1)||e instanceof Ammunition)e.number>1?e.name=`${e.basename}(${e.number})`:e.name=e.basename;else{e.name=e.basename,e.number--,this.addObject(new e.constructor),this.addObject(e);return}if(e.iterations>100)return;let t=this,i=!0;if((this.objects.length>0||!0!==this.traversable)&&(i=!1),!1==e.traversable&&null!==this.character&&(i=!1),!0==this.ramp){i=!1;let[s,a]=this.delta,[n,o]=this.pos,[l,c]=[n+s,o+a];e.iterations++,grid[l][c].addObject(e);return}if(i)e.iterations=0,e.pos=this.pos.slice(),this.objects.push(e),this.updateObjects(),e.initialize();else{e.iterations||(e.iterations=0),e.iterations++;let h=shuffle(directions),d=[];for(let u=0;u<h.length;u++){let[$,p]=h[u].map((e,i)=>e+t.pos[i]);if(!grid[$]||!grid[$][p])continue;let f=grid[$][p];if((f.traversable||!0==f.slope)&&f.elevation<=this.elevation&&(d.push(f),0==f.objects.length)){f.addObject(e);break}u==h.length-1&&d.length>0&&d[0].addObject(e)}}}removeObject(){this.objects=[],this.updateObjects()}updateObjects(){let e=this;if(this.traversable=!0,this.moveCost=this.baseMoveCost,this.objects.length>0){let t=this.objects[0];!1==t.traversable&&(this.traversable=!1),this.moveCost+=t.movecost,t.pos=this.pos.slice()}this.fluids.length>0&&this.fluids.forEach(function(t){e.moveCost+=t.movecost,t.pos=e.pos.slice()})}addFluid(e){if(e.iterations>20)return;if(this.ramp){e.iterations++;let[t,i]=this.pos,[s,a]=this.delta,[n,o]=[t+s,i+a];grid[n][o].addFluid(e);return}let l=this,c=!0,h=!1;if(this.fluids.forEach(function(t){t.basename==e.basename&&(c=!1,t instanceof gas&&Math.random()>.5&&t.thickness<3&&(t.addthickness(),h=!0))}),!h){if(c)e.pos=this.pos.slice(),this.fluids.push(e),this.updateObjects(),e.initialize();else{e.iterations||(e.iterations=0),e.iterations++;let d=shuffle(directions),u=[];for(let $=0;$<d.length;$++){let[p,f]=d[$].map((e,t)=>e+l.pos[t]);if(!grid[p]||!grid[p][f])continue;let m=grid[p][f];if(m.traversable&&(m.elevation<=l.elevation||e instanceof gas)&&(u.push(m),0==m.fluids.length)){m.addFluid(e);break}$==d.length-1&&u.length>0&&u[0].addFluid(e)}}}}removeFluid(e){e.destroyed=!0,this.fluids=this.fluids.filter(t=>t.basename!=e.basename)}readLightsource(){let e=[];if(this.templightsources&&this.templightsources.length>0){let t=this.templightsources[0][0];this.templightsources[0][1]--,this.templightsources[0][1]<=0&&this.templightsources.shift(),e.push(t)}if(null!==this.character){let i=[this.character.primaryitem,this.character.offhanditem];i.forEach(function(t){t.lightsources&&t.lightsources.length>0&&t.lightsources.forEach(function(t){e.push(t)})}),this.character.lightsources&&this.character.lightsources.length>0&&e.push(this.character.lightsources[0])}if(this.objects.length>0&&this.objects[0].lightsources.length>0&&e.push(this.objects[0].lightsources[0]),this.fluids.length>0)for(let s=0;s<this.fluids.length;s++)this.fluids[s].lightsources.length>0&&e.push(this.fluids[s].lightsources[0]);return e}addTempSource(e,t){this.templightsources||(this.templightsources=[]),this.templightsources.push([e,t])}addvisiblecharacter(e){let t=!1;this.charactersinview.forEach(function(i){i.index==e.index&&(t=!0)}),!1==t&&this.charactersinview.push(e)}removevisiblecharacter(e){for(let t=0;t<this.charactersinview.length;t++)if(this.charactersinview[t].index==e.index){this.charactersinview.splice(t,1);break}}gethazards(e){let t=[0,0];return this.objects.length>0&&this.objects.forEach(function(i){!1===i.revealed&&!0==e||(t=t.map((e,t)=>e+i.hazards[t]))}),this.fluids.length>0&&this.fluids.forEach(function(e){t=t.map((t,i)=>t+e.hazards[i])}),t}readdobject(){let e;this.objects.length>0&&(e=this.objects[0],this.objects=[],this.addObject(e));let t=[];for(let i=0;i<this.fluids.length;i++){let s=this.fluids[i];t.push(s)}this.fluids=[];for(let a=0;a<t.length;a++){let n=t[a];this.addFluid(n)}}}class object{constructor(e,t,i,s,a,n,o,l,c,h){this.name=e,this.symbol=t,this.absorbtion=i,this.bgabsorbtion=s||null,this.opacity=a||0,this.traversable=n,this.movecost=o||0,this.action=l||null,this.effects=c||[],this.lightsources=h||[],this.pos=[],this.ac=0,this.pc=!1,this.destructable=!1,this.durability=1,this.hp=1,this.basename=e,this.baseabsorbtion=i,this.basesymbol=t,this.burnduration=1,this.flammable=!1,this.hazards=[0,0],!1==this.traversable&&(this.immovable=!0)}damage(e){if(this.destructable&&!this.destroyed){let t=Math.floor(e/this.durability);this.hp-=t;adduilabel(t.toString(),this.pos,convertAbstoColor(this.baseabsorbtion),1,!0,!1,!1,!1),this.hp<=0&&this.break()}}break(){let[e,t]=this.pos;grid[e][t].objects.shift(),this.destroyed=!0,this.remnants&&this.remnants.forEach(function(i){i instanceof fluid?grid[e][t].addFluid(i):grid[e][t].addObject(i)}),this.burning&&this.spreadfire(),hear(new Sound(this.pos,10,this,null,soundeffects.woodbreaking)),grid[e][t].updateObjects()}addRemnants(){this.remnants=[];for(let e=0;e<2;e++){let t=new Wreckage(this);this.remnants.push(t)}}initialize(){this.destructable&&this.addRemnants();let e=directionsincl.slice();for(let t=0;t<e.length;t++){let[i,s]=e[t].map((e,t)=>e+this.pos[t]);if(!grid[i]||!grid[i][s])continue;let a=grid[i][s];a.objecttriggers||(a.objecttriggers=[]),a.objecttriggers.push(this)}}react(e,t,i,s){!this.destroyed&&"Miss"==i.soundcontent&&1>=chebyshevDistance(i.target,this.pos)&&Math.random()>.75&&this.damage(1),s||"Move"!=i.name&&"Attack"!=i.name||0!=chebyshevDistance(i.target,this.pos)||this.destroyed||!this.burning||0!=chebyshevDistance(t.pos,this.pos)||t.damage(1)}burn(){if(this.burning||this.burnt||!this.flammable)return;this.name=`Burning ${this.basename}`,this.hazards=this.hazards.map((e,t)=>e+[1,5][t]),this.burning=!0,this.lightsources.push(new lightsource(this.pos,[128,128,128],[2.5,1.5,1],2)),this.absorbtion=materials.fire,null!=this.bgabsorbtion&&(this.bgabsorbtion=materials.fire);let[e,t]=this.pos;grid[e][t].character&&!1==grid[e][t].character.dead&&grid[e][t].character.damage(5),envobjects.push(this)}update(){if(this.burning&&!this.destroyed){let[e,t]=this.pos;null!==grid[e][t].character&&grid[e][t].character.damage(5);for(let i=0;i<4;i++)grid[e][t].addFluid(new Smoke);this.spreadfire(),this.destructable&&(this.damage(1),this.destroyed||envobjects.push(this)),this.burnduration-=1,this.burnduration>0?envobjects.push(this):(this.lightsources=[],this.burning=!1,this.burnt=!0,this.name=`charred ${this.basename}`,this.hazards=[0,0],this.absorbtion=[0,0,0],null!=this.bgabsorbtion&&(this.bgabsorbtion=[.2,.2,.2]))}}spreadfire(){for(let e=0;e<directions.length;e++){let[t,i]=directions[e].map((e,t)=>e+this.pos[t]);if(!grid[t]||!grid[t][i])continue;let s=grid[t][i];s.objects.length>0&&!s.objects[0].burning&&s.objects[0].burn(),s.fluids&&s.fluids.length>0&&s.fluids.forEach(function(e){e.burning||e.burnt||e.burn()})}}move(e){let[t,i]=this.pos,[s,a]=this.pos.map((t,i)=>t-e[i]);if(!grid[s]||!grid[s][a])return;let n=grid[s][a].character;for(;!0==grid[s][a].slope;)[s,a]=[s,a].map((t,i)=>t-e[i]);let o=grid[s][a].elevation-grid[t][i].elevation,l=o**2,c=this.hp;!0==grid[s][a].traversable&&(grid[t][i].removeObject(),grid[s][a].addObject(this),o<-1&&this.damage(l)),null!==n&&(o<-1&&n.damage(Math.min(l,c)),this.movecost>0&&addconditiondynamic(conditions.Prone,!0,n)())}}class Item extends object{constructor(e,t,i){super(e,t,i,null,0,!0),this.name=e,this.symbol=t,this.absorbtion=i||[1,1,1]}stow(){}draw(){}drop(){}}class Weapon extends Item{constructor(e,t,i,s,a,n,o,l,c,h,d,u){super(e,t,i),this.range=a||1.9,this.bonus=n||0,this.damagedie=o||1,this.stat=l||0,this.minrange=c||0,this.drawsound=h||soundeffects.daggerdraw2,this.hitsound=d||soundeffects.swordhit,this.misssound=u||soundeffects.swordswing,this.stacksize=1,this.number=1,this.twohanded=!1}addRemnants(){this.remnants=[new BrokenWeapon(this)]}}class BrokenWeapon extends object{constructor(e){let t=`Broken ${e.name}`,i=e.symbol,s=e.absorbtion,a=e.bgabsorbtion,n=e.opacity;super(t,i,s,a,n,!0)}}class Unarmed extends Weapon{constructor(){super("Unarmed",null,null,null,1.9,0,1,0,0,null,null,null)}}class Foot extends Unarmed{constructor(){super("Unarmed",null,null,null,1.9,0,0,0,0,null,null,null),this.specialeffect=kickattackpermute}}class Projectile extends Weapon{constructor(e){super("Projectile",null,null,null,3.5,0,0,0,null,null,null),this.obj=e,this.specialeffect=throwattackpermute}}class Kukri extends Weapon{constructor(){super("Kukri","&#x0192",materials.metal,actions.Attack,1.9,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.light=!0,this.specialeffect=conditionattackpermute(conditions.Bleeding),this.bleed=!0}}class Dagger extends Weapon{constructor(e){super("Dagger","&#x2020",materials.metal,actions.Attack,3.5,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.throwable=!0,this.number=e||1,this.light=!0,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Runic_Dagger extends Weapon{constructor(e){super("Runic Dagger","&#x2020",materials.metal,actions.Attack,3.5,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.throwable=!0,this.number=e||1,this.light=!0,e>1&&(this.name=`${this.basename}(${this.number})`),this.lightsources.push(new lightsource([0,0],[256,256,256],[1.5,1.5,1.5],3))}}class Shiv extends Weapon{constructor(){super("Shiv","&#x2020",materials.metal,actions.Attack,1.9,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.light=!0}}class Athame extends Weapon{constructor(e){super("Athame","&#x2020",[.2,.2,.2],actions.Attack,3.5,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.throwable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=conditionattackpermute(conditions.Bleeding),this.light=!0,this.bleed=!0}}class Javelin extends Weapon{constructor(e){super("Javelin","-",materials.wood,actions.Attack,3.5,0,2,0,0,soundeffects.tap,soundeffects.arrowflight),this.stacksize=3,this.throwable=!0,this.number=e||1,this.light=!0,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Club extends Weapon{constructor(){super("Club","|",materials.wood,actions.Attack,1.9,0,2,0,null)}}class Greatclub extends Weapon{constructor(){super("Greatclub","|",materials.wood,actions.Attack,1.9,0,4,0,null),this.twohanded=!0}}class Longsword extends Weapon{constructor(){super("Longsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.versatile=!0}}class Runic_Longsword extends Weapon{constructor(){super("Runic Longsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.versatile=!0,this.lightsources.push(new lightsource([0,0],[256,256,256],[1.5,1.5,1.5],3))}}class Greatsword extends Weapon{constructor(){super("Greatsword","/",materials.metal,actions.Attack,1.9,0,10,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.twohanded=!0}}class Runic_Greatsword extends Weapon{constructor(){super("Runic Greatsword","/",materials.metal,actions.Attack,1.9,0,10,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.twohanded=!0,this.lightsources.push(new lightsource([0,0],[256,256,256],[1.5,1.5,2],3))}}class Speedsword extends Weapon{constructor(){super("Speedsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let i=function(){e.character.tc[2]>0&&(e.character.tc[2]--,e.character.tc[1]++)};return e.onhiteffects.push(i),e.onmisseffects.push(i),e}}}class Shortsword extends Weapon{constructor(){super("Shortsword","/",materials.metal,actions.Attack,1.9,0,4,1,null,soundeffects.shortsworddraw),this.light=!0}}class Scimitar extends Weapon{constructor(){super("Scimitar","/",materials.metal,actions.Attack,1.9,0,4,0,null,soundeffects.shortsworddraw),this.light=!0}}class Rapier extends Weapon{constructor(){super("Rapier","/",materials.metal,actions.Attack,1.9,0,6,1,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let i=function(e){if(e<=0)return;let[i,s]=t,a=grid[i][s].character;a&&(a.drop(),a.drop("offhanditem"))};return e.onhiteffects.push(i),e.modbreakdown.push("Disarm"),e},this.disarm=!0}}class Katana extends Weapon{constructor(){super("Katana","/",materials.metal,actions.Attack,1.9,0,1,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=conditionattackpermute(conditions.Bleeding),this.bleed=!0}}class Punching_Red_Glove_Expanding_Arm_Kapow extends Weapon{constructor(){super("Punching Red Glove Expanding Arm Kapow","/",materials.metal,actions.Attack,1.9,0,1,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let i=function(){let[i,s]=t,a=grid[i][s].character,n=e.pos.slice(),o=t.map((e,t)=>n[t]-e);if(a)for(let l=0;l<1;l++){let c=a.pos.map((e,t)=>e-o[t]);a.actionqueue.push(new action("Fall",movefunc,[0,0,0],1,c,a,t)),move(a)}};return e.onhiteffects.push(i),e}}}class Handaxe extends Weapon{constructor(){super("Handaxe","/",materials.metal,actions.Attack,1.9,0,2,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.light=!0,this.cleave=!0}}class Runic_Handaxe extends Weapon{constructor(){super("Runic Handaxe","/",materials.metal,actions.Attack,1.9,0,2,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.light=!0,this.cleave=!0,this.lightsources.push(new lightsource([0,0],[256,256,256],[1.5,1.5,1.5],3))}}class Battleaxe extends Weapon{constructor(){super("Battleaxe","/",materials.metal,actions.Attack,1.9,0,4,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.versatile=!0,this.cleave=!0}}class Greataxe extends Weapon{constructor(){super("Greataxe","/",materials.metal,actions.Attack,1.9,0,8,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.twohanded=!0,this.cleave=!0}}class Warhammer extends Weapon{constructor(){super("Warhammer","T",materials.metal,actions.Attack,1.9,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=conditionattackpermute(conditions.Prone),this.versatile=!0,this.trip=!0}}class Greathammer extends Weapon{constructor(){super("Greathammer","T",materials.metal,actions.Attack,1.9,0,8,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=conditionattackpermute(conditions.Prone),this.twohanded=!0,this.trip=!0}}class Mace extends Weapon{constructor(){super("Mace","T",materials.metal,actions.Attack,1.9,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=shoveattackpermute,this.versatile=!0,this.shove=!0}}class Maul extends Weapon{constructor(){super("Maul","T",materials.metal,actions.Attack,1.9,0,8,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=shoveattackpermute,this.twohanded=!0,this.shove=!0}}class Spear extends Weapon{constructor(){super("Spear","-",materials.wood,actions.Attack,2.5,0,2,0,0,soundeffects.tap),this.versatile=!0}}class Pike extends Weapon{constructor(){super("Pike","/",materials.metal,actions.Attack,2.5,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.twohanded=!0}}class Halberd extends Weapon{constructor(){super("Halberd","/",materials.metal,actions.Attack,2.5,0,4,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.twohanded=!0,this.cleave=!0,this.reach=!0}}class Glaive extends Weapon{constructor(){super("Glaive","/",materials.metal,actions.Attack,2.5,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=cleaveattack,this.twohanded=!0,this.cleave=!0,this.reach=!0}}class Polehammer extends Weapon{constructor(){super("Polehammer","T",materials.metal,actions.ProneAttack,2.5,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=conditionattackpermute(conditions.Prone),this.twohanded=!0,this.trip=!0}}class Ammunition extends Item{constructor(e,t,i){super(e,t,i,null,0,!0,0,null,null,null)}}class Arrow extends Ammunition{constructor(e){super("Arrow","&#x02D7",materials.wood),this.stacksize=15,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Bolt extends Ammunition{constructor(e){super("Bolt","&#x02D7",materials.wood),this.stacksize=15,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Longbow extends Weapon{constructor(){super("Longbow",")",materials.wood,actions.Attack,7.9,0,4,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.ranged=!0}}class Cleavebow extends Weapon{constructor(){super("Cleavebow",")",materials.wood,actions.Attack,7.9,0,4,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.specialeffect=cleaveattack}}class Recurve_Bow extends Weapon{constructor(){super("Recurve Bow","}",materials.wood,actions.Attack,8.9,0,6,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.ranged=!0,this.specialeffect=function(e,t){for(let i=e.modbreakdown.length-1;i>=0;i--){if("Half Cover-10"==e.modbreakdown[i]){e.modbreakdown.splice(i,1),e.extrinsmod+=2,e.percenthitchance+=10,e.avdamageac10+=.1*takeav(e.damagerange);continue}if("Three Quarters Cover-25"==e.modbreakdown[i]){e.modbreakdown.splice(i,1),e.extrinsmod+=5,e.percenthitchance+=25,e.avdamageac10+=.25*takeav(e.damagerange);continue}}e.percenthitchance=Math.min(e.percenthitchance,100);let s=function(){let i=bresenhamLine(e.pos,t),s=i.map(e=>grid[e[0]][e[1]]);s.forEach(function(t){if(t.character&&t.character.pc!==e.character.pc){let i=e,s=t.character;100*Math.random()<i.percenthitchance&&s?s.damage(randomNumber(i.damagerange[1],i.damagerange[0])):adduilabel("Miss",t.pos,[128,128,128],1,!0,!1)}})};return e.onhiteffects.push(s),e.onmisseffects.push(s),e}}}class Double_Recurve_Bow extends Weapon{constructor(){super("Recurve Bow","}",materials.wood,actions.Attack,8.9,0,8,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.specialeffect=function(e,t){for(let i=e.modbreakdown.length-1;i>=0;i--){if("Half Cover-10"==e.modbreakdown[i]){e.modbreakdown.splice(i,1),e.extrinsmod+=2,e.percenthitchance+=10,e.avdamageac10+=.1*takeav(e.damagerange);continue}if("Three Quarters Cover-25"==e.modbreakdown[i]){e.modbreakdown.splice(i,1),e.extrinsmod+=5,e.percenthitchance+=25,e.avdamageac10+=.25*takeav(e.damagerange);continue}}e.percenthitchance=Math.min(e.percenthitchance,100);let s=function(){let i=bresenhamLine(e.pos,t),s=i.map(e=>grid[e[0]][e[1]]);s.forEach(function(t){if(t.character&&t.character.pc!==e.character.pc){let i=e,s=t.character;100*Math.random()<i.percenthitchance&&s?s.damage(randomNumber(i.damagerange[1],i.damagerange[0])):adduilabel("Miss",t.pos,[128,128,128],1,!0,!1)}})},a=function(){let i=new Attack("Attack",attackfunc,[0,0,0,1],e.character.getrange(e.weapon),t,e.character,e.pos);e.character.actionqueue.push(i)};return e.onhiteffects.push(s),e.onmisseffects.push(s),e.onhiteffects.push(a),e.onmisseffects.push(a),e}}}class Shortbow extends Weapon{constructor(){super("Shortbow",")",materials.wood,actions.Attack,6.9,0,2,1,1.9,soundeffects.bowdraw),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.ranged=!0}}class Handcrossbow extends Weapon{constructor(){super("Hand Crossbow",")",materials.wood,actions.Attack,6.9,0,2,1,1.9,soundeffects.bowdraw),this.ammotype="Bolt",this.ammoconstructor=Bolt,this.light=!0,this.ranged=!0}}class Heavy_Crossbow extends Weapon{constructor(){super("Heavy Crossbow",")",materials.wood,actions.Attack.slice(),7.9,0,6,1,1.9,soundeffects.bowdraw),this.ammotype="Bolt",this.ammoconstructor=Bolt,this.ranged=!0,this.reloading=!0,this.reloaded=!1,this.specialeffect=conditionattackpermute(conditions.Prone),this.trip=!0}}class Bolas extends Weapon{constructor(e){super("Bolas","%",materials.wood,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){let[i,s]=t,a=function(e){e>=1&&addconditiondynamic(conditions.Prone,!0,grid[i][s].character)()};return e.onhiteffects.push(a),e.damagerange=[1,1],grid[i][s].character&&lackscondition(conditions.Prone,grid[i][s].character)&&(e.avdamageac10+=5),e},this.trip=!0}}class OilFlask extends Weapon{constructor(e){super("Oil Flask",",",materials.mud,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.woodbreaking),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){let[i,s]=t,a=function(){for(let e=0;e<9;e++)grid[i][s].addFluid(new oil);grid[i][s].fluids.forEach(e=>e.burn())};return e.onhiteffects.push(a),e.onmisseffects.push(a),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class SmokeBomb extends Weapon{constructor(e){super("Smoke Bomb",",",materials.mud,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){let[i,s]=t,a=function(){for(let e=0;e<200;e++)grid[i][s].addFluid(new Smoke)};return e.onhiteffects.push(a),e.onmisseffects.push(a),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class CaltropsBag extends Weapon{constructor(e){super("Caltrops Bag",".",materials.wood,actions.Attack,50.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){1==e.errors.length&&"No Target"==e.errors[0]&&(e.errors=[]);let[i,s]=t,a=function(){for(let e=0;e<8;e++)grid[i][s].addObject(new Caltrops)};return e.onhiteffects.push(a),e.onmisseffects.push(a),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class FlashPowder extends Weapon{constructor(e){super("Flash Powder",".",materials.wood,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){1==e.errors.length&&"No Target"==e.errors[0]&&(e.errors=[]);let[i,s]=t,a=function(){for(let e=1;e<10;e+=2)grid[i][s].addTempSource(new lightsource(this.pos,[256,256,256,],[e,.6*e,.4*e],3),1);for(let t=10;t>1;t-=2)grid[i][s].addTempSource(new lightsource(this.pos,[256,256,256,],[t,.6*t,.4*t],3),1);updatelightmap(),updatetraitspassive()};return e.onhiteffects.push(a),e.onmisseffects.push(a),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class Grenade extends Weapon{constructor(e){super("Grenade","&#x2020",materials.metal,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`);let t=this;this.specialeffect=function(e,i){let[s,a]=i,n=function(){[...directions,[0,0]].forEach(function(e){let[s,a]=e.map((e,t)=>e+i[t]),n=grid[s][a],o=n.character;n.objects.length>0&&n.objects.forEach(e=>e.damage(10)),rangedanimate(i,[s,a],convertAbstoColor(t.absorbtion)),o&&!0!==o.dead&&o.damage(10),n.addFluid(new Smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null))}),adduilabel("*",i,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)};return e.onhiteffects.push(n),e.onmisseffects.push(n),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class Bonfire extends object{constructor(){super("Fire Pit","*",[.2,.2,.2],null,.25,!1,null,null,null,null,null),this.destructable=!1}initialize(){super.initialize(),this.action=actions.Interact}interact(e){this.lit?e.heal(e.maxhp-e.hp):this.burn()}burn(){this.lit=!0,this.name="Bonfire",this.absorbtion=materials.fire,this.lightsources.push(new lightsource(this.pos,[256,256,256],[2.5,1.5,1],2))}}class Brazier extends object{constructor(){super("Brazier","o",materials.metal,null,.25,!1,null,null),this.flammable=!0,this.burnduration=1/0,this.immovable=!1}burn(){this.name=`Lit ${this.basename}`,this.basename=`Lit ${this.basename}`,this.burning=!0,this.lightsources.push(new lightsource(this.pos,[256,256,256],[2.5,1.5,1],2))}}class corpse extends object{constructor(e,t,i,s,a,n,o,l,c,h,d){super(e,t,i,s,a,n,o,l,c,h,d),this.flammable=!0}initialize(){super.initialize(),envobjects.push(this),grid[this.pos[0]][this.pos[1]].addFluid(new blood("Blood","",[0,0,0],materials.blood,0,!0,0))}update(){super.update();let[e,t]=this.pos;grid[e][t],Math.random()>.5&&grid[e][t].addFluid(new blood("Blood","",[0,0,0],[.5,.1,.1],0,!0,0)),Math.random()>.25&&envobjects.push(this)}}class explodingBarrel extends object{constructor(){super("Barrel","2022",materials.wood),this.destructable=!0}break(){super.break(),this.explode()}explode(){let e=this,[t,i]=this.pos;for(let s=1;s<10;s+=2)grid[t][i].addTempSource(new lightsource(this.pos,[256,256,256,],[s,.6*s,.4*s],3),1);for(let a=10;a>1;a-=2)grid[t][i].addTempSource(new lightsource(this.pos,[256,256,256,],[a,.6*a,.4*a],3),1);updatetraitspassive(),directions.forEach(function(t){let[i,s]=t.map((t,i)=>t+e.pos[i]),a=grid[i][s],n=a.character;a.objects.length>0&&a.objects.forEach(e=>e.damage(10)),rangedanimate(e.pos,[i,s],convertAbstoColor(e.absorbtion)),n&&!0!==n.dead&&n.damage(10)}),adduilabel("*",e.pos,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)}}class door extends object{constructor(e=!1){super("Door","+",materials.wood,null,1,!1,0,actions.Open),Math.random()>.6&&(this.locked=!0),this.locked=!1,this.durability=2,this.hp=2,this.destructable=!0,this.flammable=!0,this.immovable=!1}open(){if(this.locked)return!1;this.action=null,this.opacity=0,this.traversable=!0,this.movecost=0,this.symbol="/"}move(){this.open();let[e,t]=this.pos;grid[e][t].updateObjects()}}class Window extends object{constructor(){super("Window","=",materials.wood,null,0,!1,null)}}class Pit extends object{constructor(){super("","",null,null,0,!1,null)}initialize(){let[e,t]=this.pos;grid[e][t].elevation-=5,grid[e-1][t].elevation-=5,grid[e+1][t].elevation-=5,grid[e][t-1].elevation-=5,grid[e][t+1].elevation-=5}}class wolfCage extends object{constructor(e,t,i,s,a,n,o,l,c,h,d){super(e,t,i,s,a,n,o,l,c,h,d)}break(){this.freeWolf(),super.break()}freeWolf(){let[e,t]=this.pos;grid[e][t].addCharacter(new Wolf([e,t]))}}class WargPost extends object{constructor(){super("Post","2022",materials.wood,null,.25,!1,null,null,null,[])}initialize(){super.initialize();let[e,t]=this.pos;this.warg=new Warg([e,t]);for(let i=0;i<1;i++)grid[e][t].addCharacter(this.warg);envobjects.push(this)}update(){!0!==this.destroyed&&envobjects.push(this);for(let e=0;e<this.warg.conditions.length;e++){let t=this.warg.conditions[e];if("Restrained"==t.name){t.duration=1;return}}addconditiondynamic(conditions.Restrained,!1,this.warg)()}break(){removecondition(this.warg,"Restrained"),super.break()}}class Spawning_Membrane extends object{constructor(){super("Spawning Membrane","&#x03A9",[.5,.5,.5],null,.5,!1,null,null,null),this.creature=[Goblin_Dagger,Goblin_Shortbow,Ogre,Giant][randomNumber(4)],this.lightsources=[new lightsource(null,[128,8,64],[1,1,1],1)],this.destructable=!0,this.flammable=!0}initialize(){super.initialize();let[e,t]=this.pos;grid[e][t].addFluid(new LarvalFluid),grid[e][t].addFluid(new LarvalFluid),grid[e][t].addFluid(new LarvalFluid),grid[e][t].addFluid(new LarvalFluid)}addRemnants(){this.remnants=[new LarvalFluid,new LarvalFluid,new LarvalFluid,new LarvalFluid,new LarvalFluid]}damage(e){this.damageinit=e,this.break()}break(){this.freeCreature(),super.break()}freeCreature(){let[e,t]=this.pos,i=new this.creature([e,t]);i.primaryitem=i.unarmed,i.hp=Math.round(i.hp/(4/3)),Math.random()>.5&&addconditiondynamic(conditions.Bleeding,!0,i)(),grid[e][t].addCharacter(i),i.damage(this.damageinit)}}class Spawning_Membrane_Special extends object{constructor(e){super("Spawning Membrane","&#x03A9",[.5,.5,.5],null,.5,!1,null,null,null),this.creature=e,this.lightsources=[new lightsource(null,[128,8,64],[1,1,1],1)],this.destructable=!0,this.flammable=!0}verbose(){return playercs.length>3||!verbose?"":"Break to free ally"}getnewplayercharacter(){let e=[Fugitive,Huntsman,Berserker,Standard_Bearer,Ranger,Sentinel,Maledict,ShieldMaiden,Hellion,Skirmisher];for(let t=0;t<e.length;t++)for(let i=0;i<playercs.length;i++)e[t]&&playercs[i]instanceof e[t]&&(e.splice(t,1),t--);return playercs.length>3?Goblin:e.length>2*ngplus?e[2*ngplus]:Prisoner}initialize(){super.initialize();let[e,t]=this.pos;grid[e][t].addFluid(new LarvalFluid),grid[e][t].addFluid(new LarvalFluid),grid[e][t].addFluid(new LarvalFluid),grid[e][t].addFluid(new LarvalFluid)}addRemnants(){this.remnants=[new LarvalFluid,new LarvalFluid,new LarvalFluid,new LarvalFluid,new LarvalFluid]}damage(e){this.damageinit=e,this.break()}break(){this.freeCreature(),super.break()}freeCreature(){this.creature||(this.creature=this.getnewplayercharacter());let[e,t]=this.pos,i=new this.creature([e,t]);addconditiondynamic(conditions.Stunned,!0,i)(),grid[e][t].addCharacter(i)}}class spikeTrap extends object{constructor(){super("Spike Trap",";",materials.metal),this.destructable=!0,this.hp=2,this.flammable=!0,this.revealed=!1,this.hazards=[1,0]}react(e,t,i){if(super.react(e,t,i),!0!==this.destroyed){let[s,a]=this.pos,n=grid[s][a].lightlevel>2,o=!1==this.revealed,l=!0==t.pc,c=1>=chebyshevDistance(t.pos,[s,a]);n&&o&&l&&c&&(this.reveal(),!0==activecharacternonindex.pc&&(activecharacternonindex.actionqueue=[],bufferedinputs=[]));let h=grid[s][a].character;null!==h&&(this.break(),h.damage(roll(3,0)))}}reveal(){adduilabel("!",this.pos,[256,0,0],0,!0,!1,!1,!1),this.symbol=";",this.absorbtion=materials.metal,this.revealed=!0,this.name="Spike Trap"}initialize(){super.initialize();let[e,t]=this.pos;this.absorbtion=null,this.symbol="",this.name=""}}class Light extends Item{constructor(e,t,i){super(e,t,i)}}class oilLamp extends Light{constructor(){super("Oil Lamp","&#9827",materials.metal),this.lightsources.push(new lightsource(null,[256,256,256],[1,.5,.25],2)),this.destructable=!0,this.flammable=!0}break(){super.break(),this.setFire()}addRemnants(){super.addRemnants();let[e,t]=this.pos;grid[e][t];for(let i=0;i<1;i++){let s=new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null);s.destructable=!1,s.burnduration=5,this.remnants.push(s)}}setFire(){let[e,t]=this.pos,i=grid[e][t];i.fluids.forEach(e=>e.burn())}explode(){let e=this,[t,i]=this.pos;for(let s=1;s<10;s+=2)grid[t][i].addTempSource(new lightsource(this.pos,[256,256,256,],[s,.6*s,.4*s],3),1);for(let a=10;a>1;a-=2)grid[t][i].addTempSource(new lightsource(this.pos,[256,256,256,],[a,.6*a,.4*a],3),1);updatetraitspassive(),directions.forEach(function(t){let[i,s]=t.map((t,i)=>t+e.pos[i]),a=grid[i][s],n=a.character;a.objects.length>0&&a.objects.forEach(e=>e.damage(10)),rangedanimate(e.pos,[i,s],convertAbstoColor(e.absorbtion)),n&&!0!==n.dead&&n.damage(10)}),adduilabel("*",e.pos,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)}initialize(){super.initialize()}}class Shield extends Item{constructor(){super("Shield","&#x03B8",materials.wood)}}class Torch extends Weapon{constructor(e){super("Torch","|",materials.wood,null,5),this.lit=!0,this.lightsources=[],this.baselightsource=new lightsource([0,0],[256,256,256],[2.5,1.5,1],3),this.updatelight(),e&&(this.fuel=e),this.maxfuel=e,this.removeFuel(0),this.name=`Torch ${this.fuel}`,this.throwable=!0;let t=this;this.specialeffect=function(e,[i,s]){let a=function(){!0===t.lit&&(t.removeFuel(10),grid[i][s].objects.length>0&&grid[i][s].objects[0].burn())};return e.onhiteffects.push(a),e.onmisseffects.push(a),e},envobjects.push(this)}update(){!0===this.lit&&this.removeFuel(1),this.fuel>0&&envobjects.push(this)}removeFuel(e=1){this.fuel-=e,this.name=`Torch ${this.fuel}`,this.fuel<=0?this.extinguish():this.fuel<100&&(this.baselightsource.lightpref=[1.875,1.135,.75],this.baselightsource.radiance=2,this.updatelight())}updatelight(){!0===this.lit&&(this.lightsources[0]=this.baselightsource),!1===this.lit&&(this.lightsources=[])}extinguish(){this.lightsources=[],this.basename="Spent Torch",this.name=this.basename,this.lit=!1}stow(){!0==this.lit&&(this.removeFuel(5),this.lit=!1),this.updatelight()}drop(){this.removeFuel(5),this.updatelight()}draw(){this.fuel>0&&(this.lit=!0),this.updatelight()}}class Sarcophagus extends object{constructor(){super("Sarcophagus","I",materials.stone,null,.5,!1),this.destructable=!0}break(){let[e,t]=this.pos,i;i=Math.random()>.66?.5>Math.random()?.5>Math.random()?new Longsword:new Battleaxe:new Halberd:Math.random()>.5?.5>Math.random()?new Shortsword:new Athame:Math.random<.5?new Longbow:new Recurve_Bow,grid[e][t].addObject(i),super.break()}}class Chest extends object{constructor(){super("Chest","2022",materials.wood,null,.5,!1),this.destructable=!0}break(){let[e,t]=this.pos,i;i=Math.random()>.66?.5>Math.random()?.5>Math.random()?new Longsword:new Battleaxe:new Halberd:Math.random()>.5?.5>Math.random()?new Rapier:new Athame:new Longbow,grid[e][t].addObject(i),super.break()}}class Rock extends object{constructor(){super("Rock","2022",materials.stone,null,.25,!1,null,null),this.durability=10,this.destructable=!0}}class Leash extends object{constructor(){super("Rope","*",materials.wood,null,0,!0,null,null),this.durability=10,this.destructable=!0}}class oilBarrel extends object{constructor(){super("Barrel","2022",materials.wood),this.destructable=!0,this.flammable=!0}addRemnants(){super.addRemnants();let[e,t]=this.pos;grid[e][t];for(let i=0;i<10;i++){let s=new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null);s.destructable=!1,s.burnduration=5,this.remnants.push(s)}}}class Chair extends object{constructor(){super("Chair","&#X043F",materials.wood,null,.1,!0,2),this.destructable=!0,this.flammable=!0}}class Statue extends object{constructor(){super("Statue","&#X03A9",materials.marble,null,.5,!1)}}class Fortification extends object{constructor(){super("Fortification","#",materials.stone,null,1,!1)}}class WoodWall extends object{constructor(){super("","#",materials.wood,null,1,!1,null,null,[],[]),this.flammable=!0,this.destructable=!0,this.durability=1,this.hp=10,this.burnduration=99}}class Bed extends object{constructor(){super("Bed","0",materials.wood,null,.2,!0,2),this.destructable=!0,this.flammable=!0}}class Wreckage extends object{constructor(e){let t=e.absorbtion,i=e.flammable;super("Wreckage",randomSymbol(["/","\\"]),t,null,0,!0,0),this.flammable=i}}class TallGrass extends object{constructor(){super("Grass","&#x222B",materials.moss,null,.5,!0,1),this.flammable=!0,this.destructable=!0}}class GlowingMushroom extends object{constructor(){super("Mushroom",",",[1,0,1],null,.25,!0,1),this.flammable=!0,this.lightsources.push(new lightsource(this.pos,[64,64,64],[1,.75,1],1))}}class Table extends object{constructor(){super("Table","&#X20B8",materials.wood,null,.2,!0,2),this.destructable=!0,this.flammable=!0}}class Spiderweb extends object{constructor(){super("Spiderweb","*",[.6,.6,.6],null,0,!0,0,null,null,null),this.hazards=[1,0],this.durability=2,this.destructable=!0,this.immovable=!0}react(e,t,i){if(super.react(e,t,i),!0!==this.destroyed){let[s,a]=this.pos,n=grid[s][a].character;null!==n&&(addconditiondynamic(conditions.Restrained,!0,n)(),this.break())}}addRemnants(){this.remnants=[]}}class PitTrap extends object{constructor(){super("Pit Trap","*",[.6,.6,.6],null,0,!0,0,null,null,null),this.durability=2,this.hazards=[1,0]}react(e,t,i){if(super.react(e,t,i),!0!==this.destroyed){let[s,a]=this.pos;if(i.target[0]==s&&i.target[1]==a){for(let n=0;n<4;n++){let[o,l]=this.pos.map((e,t)=>e+cardinaldirections[n][t]);grid[o]&&grid[o][l]&&(grid[o][l].elevation=-1)}grid[s][a].elevation=-2,elevupdate(),this.break()}}}addRemnants(){this.remnants=[]}initialize(){super.initialize();let[e,t]=this.pos;this.absorbtion=grid[e][t].absorbtionBase,this.symbol="",this.name=""}}class PitTrapBig extends object{constructor(){super("Pit Trap","*",[.6,.6,.6],null,0,!0,0,null,null,null),this.durability=2,this.hazards=[1,0]}react(e,t,i){if(super.react(e,t,i),!0!==this.destroyed){let[s,a]=this.pos,[n,o]=this.pos;if(i.target[0]==s&&i.target[1]==a){for(let l=0;l<directionsextra.length;l++){let[c,h]=this.pos.map((e,t)=>e+directionsextra[l][t]);grid[c]&&grid[c][h]&&(grid[c][h].elevation=-2),chebyshevDistance([c,h],[n,o])>1&&(grid[c][h].elevation=-1)}grid[s][a].elevation=-2,elevupdate(),this.break()}}}addRemnants(){this.remnants=[]}initialize(){super.initialize();let[e,t]=this.pos;this.absorbtion=grid[e][t].absorbtionBase,this.symbol="",this.name=""}}class fluid extends object{constructor(e,t,i,s,a,n,o,l,c,h,d){super(e,t,i,s,a,n,o,l,c,h,d)}break(){let[e,t]=this.pos,i=this;grid[e][t].fluids=grid[e][t].fluids.filter(e=>e.basename!==i.basename),this.destroyed=!0}}class liquid extends fluid{constructor(e,t,i,s,a,n,o,l,c,h,d){super(e,t,i,s,a,n,o,l,c,h,d)}}class oil extends liquid{constructor(e,t,i,s,a,n,o,l,c,h,d){super("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null),this.flammable=!0,this.burnduration=4}burn(){this.burning||this.burnt||(super.burn(),this.spreadfire())}}class Water extends liquid{constructor(){super("Water","~",materials.water,materials.water,0,!0,1,null,null),this.flammable=!1,this.destructable=!1}}class LarvalFluid extends liquid{constructor(){super("Larval Fluid","~",null,[.5,.5,.5],0,!0,1,null,null),this.flammable=!0,this.destructable=!1}}class blood extends liquid{constructor(e,t,i,s,a,n,o,l,c,h,d){super("Blood","",[0,0,0],[.5,.1,.1],0,!0,0),this.destructable=!1,this.flammable=!1}}class Caltrops extends object{constructor(){super("Caltrops","%",materials.metal),this.hazards=[1,0],this.durability=2}react(e,t,i){if(!0!==this.destroyed){let[s,a]=this.pos,n=grid[s][a].character;null!==n&&(n.damage(1),this.break())}}addRemnants(){this.remnants=[]}}class gas extends fluid{constructor(e,t,i,s,a,n,o,l,c,h,d){super(e,t,i,s,a,n,o,l,c,h,d),this.thickness=1}addthickness(){this.thickness++,this.thickness>1&&(this.name=`Thick ${this.basename}`)}removeThickness(){if(!this.destroyed){if(this.thickness--,this.thickness<1){let[e,t]=this.pos,i=grid[e][t];i.removeFluid(this)}this.thickness<2&&(this.name=this.basename)}}}class Smoke extends gas{constructor(){super("Smoke","",[.1,.1,.1],[.2,.2,.2],.3,!0,0,null,null,null),this.flammable=!1}update(){if(super.update(),Math.random()>.75&&this.removeThickness(),!0!==this.destroyed&&envobjects.push(this),this.thickness>1){this.choking=!0,this.hazards=[1,0];let[e,t]=this.pos,i=grid[e][t],s=i.character;s&&s.damage(1),Math.random()>.5&&(this.removeThickness(),grid[e][t].addFluid(new Smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null)))}else this.choking=!1}initialize(){super.initialize(),envobjects.push(this)}removeThickness(){super.removeThickness(),this.thickness<2&&(this.hazards=[0,0],this.choking=!1)}}class AttackRoll{constructor(e,t,i,s,a){this.character=e,this.weapon=s,this.target=t,s instanceof Weapon||(this.weapon=e.unarmed),this.action=a;let n=e.getavdamage(s);s||(s=e.primaryitem);let[o,l]=t,c=0,h=e.getatkbonus(s),d=[],u=[],$=grid[o][l].character;$&&$.pc==e.pc&&($=null),(null==$||$.pc==e.pc)&&($=grid[o][l].objects[0]);let p=dist(i,t,!1,!0);s.ammotype&&!e.ammunition[s.ammotype]&&(u.push(`No ${s.ammotype}s`),this.action.warnings.push(`No ${s.ammotype}s`)),s.twohanded&&e.offhanditem&&e.offhanditem.basename!==e.unarmed.basename&&(u.push("Need two free hands"),this.action.warnings.push("Need two free hands")),s instanceof Weapon||(u.push("Not a Weapon"),this.action.warnings.push("Not a Weapon"));let f=grid[t[0]][t[1]].elevation,m=grid[i[0]][i[1]].elevation,_=[t[0],t[1],f],g=[i[0],i[1],m+1],b=drawLine3D(g,_);if(b>=1?u.push("Something in the way"):e.getrange(s)<p&&u.push("Out of range"),$){if(s.versatile&&e.offhanditem&&e.offhanditem.basename==e.unarmed.basename&&e.cantwohand&&(n[1]+=2,d.push("two handed+2max")),1===chebyshevDistance(i,[o,l])){let w=[o,l].map((e,t)=>e-(i[t]-e)),v=grid[w[0]][w[1]];v&&v.character&&v.character.pc==e.pc&&v.character!==e&&(d.push("Flanked+10"),c+=2)}!1!=$.pc||$.visiblecharacters&&$.visiblecharacters[e.index]||(d.push("Unaware+50"),c+=10),!0==$.pc&&!1==grid[i[0]][i[1]].visible&&(d.push("Unaware+50"),c+=10),s.range>1.9&&b>0&&(b>=.5?(d.push("Three Quarters Cover-25"),c-=5):(d.push("Half Cover-10"),c-=2)),grid[o][l].lightlevel<2&&(d.push("Dim Light-10"),c-=2),dist(i,t)<s.minrange&&(d.push("Too Close-25"),c-=5),!1==lackscondition(conditions.Stunned,$)&&(d.push("Stunned+25"),c+=5),!1==lackscondition(conditions.Prone,$)&&(d.push("Prone+25"),c+=5),!1==lackscondition(conditions.Restrained,$)&&(d.push("Restrained+30"),c+=6),!1==lackscondition(conditions.Asleep,$)&&(d.push("Asleep+50"),c+=10),!1==lackscondition(conditions.Surprised,$)&&(d.push("Surprised+10"),c+=2);let k=grid[i[0]][i[1]],A=grid[o][l],S=k.elevation-A.elevation;S>0&&(d.push("High Ground+10"),c+=2),S<0&&(d.push("Low Ground-10"),c-=2)}this.defender=$;let z;$&&(z=$.ac);let C=Math.min((1-(z-(h+c))/20)*100,100),E=h+c,j=takeav(n)*(10+E)/20;if(this.pos=i,this.percenthitchance=C,this.damagerange=n,this.avdamageac10=j,this.intrinsmod=h,this.extrinsmod=c,this.defenderac=z,this.modbreakdown=d,this.errors=u,this.onhiteffects=[],this.aftereffects=[],s.onhiteffects&&(this.onhiteffects=s.onhiteffects.slice()),this.onmisseffects=[],s.onmisseffects&&(this.onmisseffects=s.onmisseffects.slice()),!0==s.throwable){let q=this.character,W=this,F=function(){if(dist(q.pos,W.target)>1.9){e.removeItem(s);let t=grid[o][l],[a,n]=[o,l],[c,h]=i,[d,u]=[o-c,l-h];for(;!1==t.traversable&&!1==t.slope;)t=grid[a][n],Math.abs(d)>0&&(a-=Math.sign(d)),Math.abs(u)>0&&(n-=Math.sign(u));s.number>0?t.addObject(new s.constructor):(s.number=1,t.addObject(s))}};this.onhiteffects.push(F),this.onmisseffects.push(F),p>1.9&&(this.action.internalwarning=!0)}if(!0==s.consumable){let D=()=>e.removeItem(s);this.onhiteffects.push(D),this.onmisseffects.push(D)}if(s.ammotype){let R=[()=>e.removeAmmo(s.ammotype)];this.onhiteffects.push(...R),this.onmisseffects.push(...R)}}}function attackfunc(e=!1,t=null,i){t||(t=this.character.primaryitem);let s=e=>e;if(null!=this.character.specialattack&&(s=this.character.specialattack),!0==e){let a=s(new AttackRoll(this.character,this.target,this.pos,t,this),this.target);return null!=t.specialeffect&&(a=t.specialeffect(a,this.target)),a}let[n,o]=this.target,l=[];grid[n][o].character&&grid[n][o].character.pc!==this.character.pc&&l.push(grid[n][o].character),grid[n][o].objects.length&&l.push(grid[n][o].objects[0]);let c=0,h=l[0],d=s(new AttackRoll(this.character,this.target,this.pos,t,this),this.target);if(i&&(d=i(d,[n,o])),null!=t.specialeffect&&(d=t.specialeffect(d,this.target)),0!==d.errors.length&&!1==e){for(let u=0;u<d.errors.length;u++)c++,adduilabel(d.errors[u],this.character.pos,[128,128,128],c,!0,!1,!1,!1);return this.character.actionqueue=[],!1}if(0===d.errors.length&&!1==e){let $;if($=!!(100*Math.random()<d.percenthitchance)&&!!h,d.prehitpermute&&d.prehitpermute.length)for(let p=0;p<d.prehitpermute.length;p++){let f=d.prehitpermute[p];[d,$]=f(d,$)}if(rangedanimate(this.character.pos,this.target,convertAbstoColor(t.absorbtion)),$){let m=randomNumber(d.damagerange[1]+1,d.damagerange[0]);for(let _=0;_<d.onhiteffects.length;_++)d.onhiteffects[_](m);c++,h&&h.damage(m);for(let g=0;g<d.aftereffects.length;g++)d.aftereffects[g](m);t.hitsound&&(this.soundeffect=t.hitsound),this.soundcontent="Attack",this.hit=!0,h&&!0==h.dead&&(this.killingblow=!0)}else{c++,this.soundcontent="Miss",t.misssound&&(this.soundeffect=t.misssound);for(let b=0;b<d.onmisseffects.length;b++)d.onmisseffects[b]()}if(!h||!(h instanceof character))return;for(let w=0;w<d.modbreakdown.length;w++){c++;let v=d.modbreakdown[w],k=[128,128,128];for(let A=0;A<v.length;A++)"+"==v.charAt(A)&&(k=[0,64,0]),"-"==v.charAt(A)&&(k=[64,0,0]);v.length>5&&"react"==v.slice(0,5)&&(v=v.slice(5,v.length),k=[32,32,64]),adduilabel(v,[n,o],k,c,!0,!1)}}}class Sound{constructor(e,t,i,s,a){this.pos=e,this.volume=t,this.origin=i,this.content=s||null,this.soundeffect=a}}function updatecharacters(){characters=[...playercs,...nonpcs]}function updatecharactershere(){nonpcshere=[],objectshere=[];for(let e=viewportpos[0]-dontcaredistance;e<=viewportpos[0]+dontcaredistance;e++)for(let t=viewportpos[1]-dontcaredistance;t<=viewportpos[1]+dontcaredistance;t++){if(e<0||e>=mapsizey||t<0||t>=mapsizex)continue;null!==grid[e][t].character&&!0!==grid[e][t].character.pc&&nonpcshere.push(grid[e][t].character);let i=grid[e][t].objects;for(let s=0;s<i.length;s++){let a=i[s];objectshere.push(a)}}}function lightcheck(e,t){return function(){let[i,s]=this.character.pos;return!0==e?grid[i][s].lightlevel>=t:grid[i][s].lightlevel<=t}}function hostileallycheck(){let[e,t]=this.character.pos;for(let i=0;i<nonpcshere.length;i++){let s=nonpcshere[i];if("idle"!==s.state&&1>drawline([e,t],s.pos)&&(e!==s.pos[0]||t!==s.pos[1]))return this.character.target=s.target,console.log(`${this.character.target} is the new target of this character, it should be the same as ${s.target}`),!0}}function hostilecheck(){}function addcondition(e,t){return function(){let i=new condition(e.name,e.starteffect,e.turneffect,e.duration,e.resistance,e.endeffect,this.character);!0==lacksresistance(i,this.character)&&!0==lackscondition(i,this.character)&&(this.character.conditions.push(i),this.character.conditions[this.character.conditions.length-1].starteffect(),t&&adduilabel(i.name,i.character.pos,[128,128,0],1,!0),i.resistance>0&&this.character.condresists.push([i.name,i.resistance+turncounter]),updateGrid())}}function addconditiondynamic(e,t,i){return function(){if(!(i instanceof character))return;let s=new condition(e.name,e.starteffect,e.turneffect,e.duration,e.resistance,e.endeffect,i);!0==lacksresistance(s,i)&&!0==lackscondition(s,i)&&(i.conditions.push(s),i.conditions[i.conditions.length-1].starteffect(),t&&adduilabel(s.name,s.character.pos,s.character.color,1,!0,!1,!1),s.resistance>0&&i.condresists.push([s.name,s.resistance+turncounter]))}}function lacksresistance(e,t){for(let i of t.condresists)if(i[0]==e.name&&i[1]>turncounter)return!1;return!0}function lackscondition(e,t){if(!t.conditions)return!0;for(let i of t.conditions)if(i.name==e.name)return!1;return!0}function skipturn(){let[e,t]=this.character.pos;adduilabel("!",[e,t],[128,128,0],0,!0,!1,!1,!1),this.character.tc=[0,0,0]}function skipturnandyelp(){let[e,t]=this.character.pos;if(adduilabel("!",[e,t],[128,128,0],0,!0,!1,!1,!1),!0!==this.character.pc){let i=new action("Huh?",chatfunc,[0,0,1],0,this.character.pos,this.character,this.character.pos,null,soundeffects.goblinyelp);i.loudness=15,this.character.actionqueue.push(i),move(this.character)}this.character.tc=[0,0,0]}function moralecheck(e,t,i,s){if(s||!i)return;let[a,n]=i.target;if("Attack"==i.name){let o=1;t.pc==e.pc?o=-3:!0==i.hit&&e.moraledamage(1*o)}"Die"==i.name&&t.pc==e.pc&&e.moraledamage(5)}function losemove(){let[e,t]=this.character.pos;adduilabel("+",[e,t],[128,128,0],0,!0,!1,!1,!1),this.character.tc[0]=0,this.character.tc[2]=0,this.character.actionqueue=[]}function takedamage(e=1){return function(){this.character.damage(e)}}function movefunc(e=!1){let t=this.character,i=grid[t.pos[0]][t.pos[1]],[s,a]=this.target,n=grid[s][a].elevation-i.elevation;if(!1!==grid[s][a].traversable&&null==grid[s][a].character){if(n<=1&&(grid[t.pos[0]][t.pos[1]].character=null,t.pos=[s,a],grid[s][a].character=this.character,e||removecondition(t,"Prone"),n<-1||!0==e&&n<0)){let o=0,l=Math.floor(n/2)**2;for(let c=0;c<l;c++)o+=randomNumber(3,1);this.soundeffect=soundeffects.deepthud,this.loudness=5,addconditiondynamic(conditions.Prone,!0,t)(),this.character.damage(o)}return}if(!1!==grid[s][a].traversable&&null!==grid[s][a].character&&n<-1){if(grid[t.pos[0]][t.pos[1]].character=null,t.pos=[s,a],grid[s][a].addCharacter(this.character),removecondition(t,"Prone"),n<-1){let h=0,d=Math.floor(n/2)**2;for(let u=0;u<d;u++)h+=randomNumber(3,1);this.soundeffect=soundeffects.deepthud,this.loudness=10,addconditiondynamic(conditions.Prone,!0,t)(),this.character.damage(h),grid[s][a].character.damage(h)}return}return t.actionqueue=[],!1}function endturnfunc(){this.character.tc[0]=0,this.character.tc[1]=0}function digfunc(){let[e,t]=this.target;grid[e][t]=new Tile(...tiletypes.RoughStoneFloor,[e,t]),Math.random()>.95&&grid[e][t].addCharacter(new Dwarf([e,t]))}function chatfunc(){}function switchweapon(){char=this.character;let e=char.primaryitem;char.primaryitem=char.secondaryitem,char.secondaryitem=e,e.stow(),char.primaryitem.draw(),adduilabel(char.primaryitem.name,char.pos,char.color,1,!0,!1),char.primaryitem.drawsound&&(this.soundeffect=char.primaryitem.drawsound),this.loudness=1}function switchweaponalt(){char=this.character;let e=char.offhanditem;if(char.offhanditem=char.primaryitem,char.primaryitem=e,adduilabel(char.primaryitem.name,char.pos,char.color,1,!0,!1),char.primaryitem.drawsound&&(this.soundeffect=char.primaryitem.drawsound),this.loudness=1,char.offhanditem.number>1){let t=new char.offhanditem.constructor;char.offhanditem.number--,char.drop("offhanditem"),char.offhanditem=t}}function getfunc(){char=this.character;let e=grid[char.pos[0]][char.pos[1]].objects.shift();e.drawsound&&(this.soundeffect=e.drawsound),char.addItem(e)}function leavefunc(){let e=this.character;e.drop()}function leavefuncoffhand(){let e=this.character;e.dropoffhand()}function darkattackpermute(e){let t=e;for(let i=0;i<e.modbreakdown.length;i++)"Dim Light-10"==e.modbreakdown[i]&&(t.extrinsmod+=4,t.percenthitchance+=20,e.modbreakdown[i]="Dim Light+10",t.avdamageac10=takeav(t.damagerange)*((10+(t.intrinsmod+t.extrinsmod))/20));return t}function sneakattackpermute(e){return 1!==e.weapon.stat?(verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Sneak attack requires finnesse weapon"),e):!0!==e.weapon.throwable&&e.weapon.range>1.9?(verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Sneak attack requires melee or thrown weapon"),e):e.character.offhanditem&&e.character.offhanditem.basename!==e.character.unarmed.basename?(verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Sneak attack requires free offhand"),e):(e.damagerange=e.damagerange.map(t=>t+Math.max(0,e.extrinsmod)),e.extrinsmod>0&&(e.modbreakdown.push(`Sneak Attack+${e.extrinsmod}dmg`),e.action.loudness=3),e)}function torchbearerpermute(e){let t=e.character,i=t.offhanditem,s=e.weapon;return i.lightsources.length>0&&!0==s.versatile||s.lightsources.length>0?(e.damagerange[1]+=1,e.modbreakdown.push("Torchbearer+1max"),e):0==i.lightsources.length?(verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Torchbearer requires lightsource"),e):(!0!==s.versatile&&verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Torchbearer requires versatile"),e)}function shoveattackpermute(e,t){let i=e.character.stats[0],s=Math.max(i,1),a=function(i){if(i<=0)return;let[a,n]=e.action.target.slice(),o=grid[a][n].character,l=e.pos.slice(),c=e.action.target.map((e,t)=>l[t]-e);if(c=c.map((e,t)=>Math.sign(e)),o)for(let h=0;h<s;h++){let d=o.pos.map((e,t)=>e-c[t]);for(;!0==grid[d[0]][d[1]].slope;)c=grid[d[0]][d[1]].delta,d=d.map((e,t)=>e-c[t]);o.actionqueue.unshift(new Fall(d,o,t)),move(o)}else(obj=grid[a][n].objects[0])&&!obj.immovable&&obj.move(c)};return e.modbreakdown.push(`Shove(${s})`),e.onhiteffects.push(a),e}function kickattackpermute(e,t){let i=e.character,s=function(){let[i,s]=t,a=grid[i][s].character,n=e.pos.slice(),o=t.map((e,t)=>n[t]-e);if(o=o.map((e,t)=>Math.sign(e)),a)for(let l=0;l<Math.max(e.character.stats[0],1);l++){let c=a.pos.map((e,t)=>e-o[t]);for(;!0==grid[c[0]][c[1]].slope;)o=grid[c[0]][c[1]].delta,c=c.map((e,t)=>e-o[t]);a.actionqueue.unshift(new Fall(c,a,t)),move(a)}else(obj=grid[i][s].objects[0])&&!obj.immovable&&obj.move(o)},a=function(e,s){let[a,n]=t;return grid[a][n].character&&grid[a][n].character==i?[e,s]:grid[a][n].character&&grid[a][n].character.pc==i.pc?[e,!0]:[e,s]};return e.damagerange=[0,0],e.onhiteffects.push(s),e.prehitpermute||(e.prehitpermute=[]),e.prehitpermute.push(a),e}function throwattackpermute(e,t){let i=e.character,s=i.primaryitem;if(s.name==i.unarmed.name)return e.errors.push("nothing to throw"),e.action.warnings.push("nothing to throw"),e;let[a,n]=t.slice(),o=function(){if(dist(i.pos,[a,n])>1.9){i.removeItem(s);let e=grid[a][n],[t,o]=[a,n],[l,c]=i.pos,[h,d]=[a-l,n-c];for(;!1==e.traversable&&!1==e.slope;)e=grid[t][o],Math.abs(h)>0&&(t-=Math.sign(h)),Math.abs(d)>0&&(o-=Math.sign(d));s.number>0?e.addObject(new s.constructor):(s.number=1,e.addObject(s))}};return e.damagerange=[0,0],e.onhiteffects.push(o),e.onmisseffects.push(o),e}function reloadfunc(e,t){let i=this.character;this.target,this.pos,t||(t=i.primaryitem);let s=this;if(e){let a=attackfunc.bind(s),n=a(e,t);return n}if(!0!==t.reloading){let o=attackfunc.bind(s),l=o(e,t);return l}return s.soundeffect=soundeffects.bowdraw,s.target=s.character.pos.slice(),t.reloaded=!0,adduilabel("Reload",i.pos,i.color,1,!0,!1,!1,!0),i.updateAmmo(),!0}function dualwieldpermute(e,t){let[i,s]=t;if(!grid[i][s].character||grid[i][s].character.pc==e.character.pc||e.action.cost[1]<1)return e;let a=e.character,n=e.weapon,o=e.character.offhanditem,[l,c]=e.character.pos;if(o instanceof Weapon&&!(o instanceof Unarmed)&&n instanceof Weapon&&!(n instanceof Unarmed)&&!0==o.light){let h=new Offhandattack(t,a,e.pos),d=t.slice(),u=findtarget(a,o,t,h,[l,c]);u[0]&&(d=u[0]),h.target=d;let $=function(){let i=new Offhandattack(t,a,e.character.pos),s=t.slice(),n=findtarget(a,o,t,i,[l,c]);n[0]&&(s=n[0]),i.target=s;0==i.func(!0).errors.length&&e.character.actionqueue.unshift(i)},p=h.func(!0);e.aftereffects.push($),e.onmisseffects.push($),0==p.errors.length&&(e.avdamageac10+=p.avdamageac10,e.modbreakdown.push("Offhand Attack"))}return e}function dualwieldpluspermute(e,t){if(e.action.cost[1]<1&&!e.action.specialtag)return e;let i=!0;(e.action.specialtag||!0!==e.weapon.light)&&(i=!1);let s=e.character,a=e.weapon,n=e.character.offhanditem,[o,l]=e.character.pos;if(n instanceof Weapon&&!(n instanceof Unarmed)&&a instanceof Weapon&&!(a instanceof Unarmed)&&!0==n.light){let c=new Offhandattack(t,s,e.pos),h=t.slice(),d=findtarget(s,n,t,c,[o,l]);d[0]&&(h=d[0]),c.target=h;let u=function(){let a=new Offhandattack(t,s,e.pos),c=t.slice(),h=findtarget(s,n,t,a,[o,l]);h[0]&&(c=h[0]),a.target=c;let d=a.func(!0);!0==i&&(a.specialtag=!0),0==d.errors.length&&e.character.actionqueue.unshift(a)},$=c.func(!0);e.aftereffects.push(u),e.onmisseffects.push(u),0==$.errors.length&&(e.avdamageac10+=$.avdamageac10,e.modbreakdown.push("Offhand Attack"))}return e}function cleaveattack(e,t){let[i,s]=t;if(activecharacternonindex!==e.character||!grid[i][s].character||grid[i][s].character.pc==e.character.pc||e.action.specialtag_cleave)return e;let a=e.character,n=e.weapon,[o,l]=e.character.pos,c=[],h=new Attack("Attack",attackfunc,[0,0,0],n.range,t,a,[o,l]);h.specialtag_cleave=!0,c=findtarget(a,n,void 0,h,[o,l]);for(let d=0;d<c.length;d++){let[u,$]=c[d];u==t[0]&&$==t[1]&&(c.splice(d,1),d--),chebyshevDistance([u,$],t)>1&&(c.splice(d,1),d--)}let p=function(){let i=e.character,s=e.weapon,[a,n]=e.character.pos,o=[],l=new Attack("Attack",attackfunc,[0,0,0],s.range,t,i,[a,n]);l.specialtag_cleave=!0,o=findtarget(i,s,void 0,l,[a,n]);for(let c=0;c<o.length;c++){let[h,d]=o[c];h==t[0]&&d==t[1]&&(o.splice(c,1),c--),chebyshevDistance([h,d],t)>1&&(o.splice(c,1),c--)}for([ly,lx]of o){let u=new Attack("Attack",attackfunc,[0,0,0],s.range,[ly,lx],i,[a,n]);u.specialtag_cleave=!0,e.character.actionqueue.unshift(u)}};if(e.action.specialtag_cleave)e.modbreakdown=[];else if(e.aftereffects.push(p),e.onmisseffects.push(p),c.length>0){for(let f=0;f<c.length;f++){let m=c[f],_=new Attack("Attack",attackfunc,[0,0,0],1.9,m,e.character,e.action.pos);_.specialtag_cleave=!0;let g=_.func(!0);0==g.errors.length&&(e.avdamageac10+=g.avdamageac10)}e.modbreakdown.push(`${c.length+1}targets`)}return e}function extraattack(e,t){let[i,s]=t;if(e.action.cost[1]<1)return e;let a=e.character,n=e.weapon,[o,l]=e.character.pos.slice();if((!grid[i][s].character||grid[i][s].character.pc==e.character.pc)&&!1!==n.reloaded)return e;let c=new Attack("Attack",attackfunc,[0,0,0],n.range,t,e.character,e.character.pos),h=findtarget(a,n,t,c),d=t.slice();h[0]&&(d=h[0]),c.target=d.slice();let u=function(){let i=e.character,s=e.weapon,[a,n]=e.character.pos.slice(),o=new Attack("Attack",attackfunc,[0,0,0],s.range,t,i,[a,n]),l=findtarget(i,s,t,o),c=t.slice();l[0]&&(c=l[0]),o.target=c.slice();0==o.func(!0).errors.length&&e.character.actionqueue.unshift(o)};return e.aftereffects.push(u),e.onmisseffects.push(u),e.modbreakdown.push("Extra Attack"),e}function inciteattack(e,t){let i=e.character,s=function(){i.actionqueue.unshift(new action("Warcry",warcry,[0,0,0],0,i.pos,i,i.pos))};return e.onhiteffects.push(s),e}function warcry(){let e=this.character,t=getsquare(e.pos,10),i=gettiles(t),s=[];for(let a=0;a<i.length;a++){let n=i[a];!(dist(e.pos,n.pos)>10)&&n.character&&n.character.pc==e.pc&&s.push(n.character)}adduilabel("Warcry",e.pos,e.color,1,!0,!1,!1,!0);for(let o=0;o<s.length;o++){let l=s[o];if(l==e)continue;let c=new action("Incite",incite,[0,0,0],10,l.pos,e,e.pos);e.actionqueue.unshift(c)}}function incite(){let[e,t]=this.target,i=this.character,s=grid[e][t].character;if(!(s.tc[2]<1)&&(adduilabel("*",s.pos,i.color,0,!0,!1,!1,!1),s&&s.pc==i.pc)){let a=findtarget(s);if(a.length>0){let n=new Attack("Attack",attackfunc,[0,0,1],s.getrange(),a[0],s,s.pos);0==n.func(!0).errors.length&&canAffordAction(n,s)&&(s.actionqueue=[n],move(s))}}}function findtarget(e,t,i,s,a){void 0===t&&(t=e.primaryitem);let n=t.range,o=Math.ceil(n);void 0===a&&(a=e.pos);let[l,c]=a.slice(),h=[l,c],d=[];i&&(h=i.slice());let u=grid[h[0]][h[1]].character,$=new Attack("Attack",attackfunc,[0,1,0],n,h,e,[l,c]);void 0!==s&&($=s);let p=$.func(!0),f=p.avdamageac10;if(u&&u.pc!=e.pc&&!(p.errors.length>0))return[i];f=0;for(let m=l-o;m<=l+o;m++)if(!(m<0)&&!(m>=mapsizey))for(let _=c-o;_<=c+o;_++){if(_<0||_>=mapsizex)continue;let g=grid[m][_].character;if(!g||g.pc==e.pc)continue;$.target=[m,_];let b=$.func(!0,t);0==b.errors.length&&d.push([[m,_],b.avdamageac10])}d.sort((e,t)=>t[1]-e[1]);for(let w=0;w<d.length;w++)d[w]=d[w][0];return d}function chargeattackpermute(e,t){if(!0==e.weapon.ranged||e.action.cost[1]<1||1!==e.errors.length||"Out of range"!==e.errors[0])return e;let i=e.action.character,[s,a]=e.action.pos,[n,o]=i.pos;if(s!==n||a!==o)return e;let l=2*e.action.character.tcmax[0]+2;if(dist(e.action.pos,t)>l)return e;let c=bresenhamLine(e.action.pos,t),h=!1,d=0,u=2*e.character.tc[0];for(let $=1;$<c.length-1;$++){let[p,f]=c[$];if(d++,!1==grid[p][f].traversable||null!==grid[p][f].character||isNaN(d)||d>u)break;$==c.length-2&&(h=!0)}if(c.length<6&&(h=!1),!1==h)return e;if(1==e.errors.length&&"Out of range"==e.errors[0]){e.errors=[];let m=function(i,s){let[a,n]=e.character.pos,[o,l]=t,h=!0;for(;1!==chebyshevDistance([a,n],t);){if(0==c.length){h=!1;break}let[d,u]=c.shift(),$=new Move("Move",movefunc,[0,0,0],1,[d,u],e.action.character,e.action.character.pos);$.reactable=!1,$.cost[0]=0,e.character.actionqueue=[$],move(e.character),[a,n]=e.character.pos.slice()}return!0!==h?(console.log("we failed somewhere"),[i,!1]):(e.action.character.tc[0]=0,[i,s])};e.prehitpermute||(e.prehitpermute=[]),e.prehitpermute.push(m)}return c.length<6&&(e.action.internalwarning=!0),e.modbreakdown.push("Charge+2dmg"),e.damagerange[0]+=2,e.damagerange[1]+=2,e}function jumpattack(e,t){let i=1==e.errors.length&&"Out of range"==e.errors[0],s=!0==e.weapon.throwable&&dist(e.action.pos,t)>1.9;if(i||s&&(0==e.errors.length||i)){let a=e.character,n=Math.max(e.character.stats[0],2),o=getsquare(e.action.pos,n);for(let l=o.length-1;l>=0;l--){let c=o[l];(dist(e.action.pos,c)>n||!1==grid[c[0]][c[1]].traversable||null!==grid[c[0]][c[1]].character)&&o.splice(l,1)}let h=gettiles(o),d,u=99,$=bresenhamLine(e.action.pos,t),[p,f]=$[$.length-2];for(let m=0;m<h.length;m++){let _=h[m],[g,b]=_.pos;if(g==p&&b==f){d=_;break}let w=dist(_.pos,t);!(w<1)&&w<u&&(d=_,u=w)}if(1>=chebyshevDistance(d.pos,t)&&dist(e.action.pos,d.pos)<=n){s&&(e.action.internalwarning=!1),e.errors=[],e.modbreakdown.push("Jump attack");for(let v=0;v<e.modbreakdown.length;v++){let k=e.modbreakdown[v];"High Ground+10"==k&&(e.modbreakdown.splice(v,1,"Plunging Attack +25"),e.extrinsmod+=3),"Low Ground-10"==k&&(e.modbreakdown.splice(v,1),e.extrinsmod+=2)}let A=function(e,t){let i=new Jump(n,d.pos,a,a.pos);return i.cost=[0,0,0],a.actionqueue=[i],move(a),[e,t]};e.prehitpermute||(e.prehitpermute=[]),e.prehitpermute.push(A)}}return e}function disengagepermute(e,t){if(e.action.cost[1]<1&&!0!==e.action.specialdisengagetag)return e;let i=function(){let i=e.character,[s,a]=i.pos,[n,o]=t;if(!grid[n][o].character||grid[n][o].character.pc==e.character.pc||chebyshevDistance([s,a],[n,o])>1)return;let[l,c]=[n-s,o-a],[h,d]=[s-l,a-c];if(!grid[h]||!grid[h][d])return;grid[h][d];let u=Math.min(Math.max(i.stats[1],1),3),$=[];for(let p=0;p<u;p++){let f=new Move("Move",movefunc,[0,0,0],1.9,[h,d],i,[s,a]);f.func=function(){let e=movefunc.bind(f),t=e();return!1!==t&&(i.tc[0]+=1),t},f.reactable=!1,f.cost=[0,0,0],$.unshift(f),h-=l,d-=c}for(let m=0;m<u;m++)i.actionqueue.unshift($[m])};return e.onhiteffects.push(i),e.onmisseffects.push(i),e}function sharpshooterpermute(e){return e.weapon.range>1.9&&!0==e.weapon.ranged&&!e.weapon.throwable&&(e.modbreakdown.some(e=>"Half Cover-10"==e||"Three Quarters Cover-25"==e)?verbose&&e.action.cost[1]>0&&e.modbreakdown.push("Clear Shot requires no cover"):(e.extrinsmod+=3,e.percenthitchance+=15,e.percenthitchange=Math.min(e.percenthitchance,100),e.damagerange=e.damagerange.map(e=>e+2),e.avdamageac10+=1,e.modbreakdown.push("Clear Shot+15+2dmg"))),e}function savageattack(e,t){let i=!1,s=e.character;(e.weapon.twohanded||e.weapon.versatile)&&s.offhanditem.basename==s.unarmed.basename&&0==e.weapon.stat?(i=!0,e.percenthitchance+=e.damagerange[1],e.percenthitchance=Math.min(e.percenthitchance,100),e.modbreakdown.push(`Savage Attack+${e.damagerange[1]}`)):verbose&&e.modbreakdown.push("Savage Attack Requires Two-Handed Weapon");let a=grid[t[0]][t[1]].character,n=function(t){a&&a.hp<=t&&(e.character.tc[0]+=2)};return i&&e.onhiteffects.push(n),e}function bloodattack(e,t){if(e.action.cost[1]<1)return e;if(!0!==e.weapon.bleed)return verbose&&e.modbreakdown.push("Exsanguinate requires bleed weapon"),e;let[i,s]=t,a=grid[i][s].character;if(!a)return e;let n=function(t){for(let n=0;n<3;n++)a.bleed();let o=[[i,s]];for(let l=0;l<o.length;l++){let[c,h]=o[l];for(let d=0;d<8;d++){let[u,$]=directions[d],[p,f]=[c+u,h+$],m=!1,_;if(grid[p][f].fluids.length>0)for(let g=0;g<grid[p][f].fluids.length;g++){let b=grid[p][f].fluids[g];"Blood"==b.name&&!0!=b.electrified&&(m=!0,_=grid[p][f].fluids[g])}m&&(o.push([p,f]),_.electrified=!0)}}for(let w=0;w<o.length;w++){let[v,k]=o[w],A=grid[v][k];for(let S=0;S<A.fluids.length;S++)A.fluids[S].electrified&&(A.fluids[S].electrified=!1);if(A.character&&A.character.pc!==e.character.pc&&A.character!=a){let z=Math.ceil(t/2);A.character.damage(z),addconditiondynamic(conditions.Bleeding,!0,A.character)(),adduilabel("*",A.pos,e.character.color,0,!0,!0,!1,!1)}}};return e.modbreakdown.push("Exsanguinate"),e.onhiteffects.push(n),e}function shieldbash(e,t){let i=e.action.character,[s,a]=t,n=e.weapon;if(!(i.offhanditem instanceof Shield)||chebyshevDistance(e.action.pos,t)>1)return e;if(0==n.stat){let o=advanceattack.bind(e.action);return o(e,t)}if(1==n.stat){let l=feintattack.bind(e.action);return l(e,t)}return e}function advanceattack(e,t){if(e.action.cost[1]<1)return e;let i=e.action.character,s=i.stats[0],a=grid[t[0]][t[1]].character;if(!a)return e;e.modbreakdown.push(`Advance(${s})`);let n=function(e,t){if(t)for(let n=0;n<s;n++){let[o,l]=i.pos,[c,h]=a.pos,[d,u]=[c-o,h-l],[$,p]=[c+d,h+u],f=new Fall([$,p],a,[c,h]);a.actionqueue=[f],move(a);let m=new Move("Move",movefunc,[0,0,0],1.9,[c,h],i,[o,l]);m.cost=[0,0,0],m.reactable=!1,i.actionqueue=[m],i.actionqueue.unshift(m),move(i),e.target=a.pos.slice(),e.action.target=a.pos.slice(),e.action.pos=e.character.pos.slice(),e.pos=e.character.pos.slice()}return[e,t]};return e.prehitpermute||(e.prehitpermute=[]),e.prehitpermute.push(n),e}function feintattack(e,t){let i=e.action.character,s=i.stats[1],a=grid[t[0]][t[1]],n=a.character,o=grid[i.pos[0]][i.pos[1]];if(!n)return e;e.modbreakdown.push(`Feint(${s})`);let l=function(e,t){if(t){o.character=n,n.pos=o.pos.slice(),a.character=i,i.pos=a.pos.slice();for(let l=0;l<s;l++){let[c,h]=i.pos,[d,u]=n.pos,[$,p]=[d-c,u-h],[f,m]=[d+$,u+p],_=new Fall([f,m],n,[d,u]);n.actionqueue=[_],move(n);let g=new Move("Move",movefunc,[0,0,0],1.9,[d,u],i,[c,h]);g.cost=[0,0,0],g.reactable=!1,i.actionqueue=[g],i.actionqueue.unshift(g),move(i),e.target=n.pos.slice(),e.action.target=n.pos.slice(),e.action.pos=e.character.pos.slice(),e.pos=e.character.pos.slice()}}return[e,t]};return e.prehitpermute||(e.prehitpermute=[]),e.prehitpermute.push(l),e}function cleavespecial(e,t){if(!e.weapon.cleave)return e;e.action.specialtag_cleave=!0;let[i,s]=t;if(activecharacternonindex!==e.character||!grid[i][s].character||grid[i][s].character.pc==e.character.pc||e.action.specialtag_cleave_special)return e;let a=e.character,n=e.weapon,[o,l]=e.character.pos,c=[],h=new Attack("Attack",attackfunc,[0,0,0],n.range,t,a,[o,l]);h.specialtag_cleave_special=!0,c=findtarget(a,n,void 0,h,[o,l]);for(let d=0;d<c.length;d++){let[u,$]=c[d];u==t[0]&&$==t[1]&&(c.splice(d,1),d--)}let p=function(){let i=e.character,s=e.weapon,[a,n]=e.character.pos,o=[],l=new Attack("Attack",attackfunc,[0,0,0],s.range,t,i,[a,n]);l.specialtag_cleave_special=!0,o=findtarget(i,s,void 0,l,[a,n]);for(let c=0;c<o.length;c++){let[h,d]=o[c];h==t[0]&&d==t[1]&&(o.splice(c,1),c--)}for([ly,lx]of o){let u=new Attack("Attack",attackfunc,[0,0,0],s.range,[ly,lx],i,[a,n]);u.specialtag_cleave_special=!0,e.character.actionqueue.unshift(u)}};if(e.action.specialtag_cleave_special)e.modbreakdown=[];else if(e.aftereffects.push(p),e.onmisseffects.push(p),c.length>0){for(let f=0;f<c.length;f++){let m=c[f],_=new Attack("Attack",attackfunc,[0,0,0],1.9,m,e.character,e.action.pos);_.specialtag_cleave_special=!0;let g=_.func(!0);0==g.errors.length&&(e.avdamageac10+=g.avdamageac10)}e.modbreakdown.push(`${c.length+1}targets`)}return e}function rangedanimate([e,t],[i,s],a){let n=linecharacter([e,t],[i,s]),o=bresenhamLine([e,t],[i,s]);o.shift(),addanimation(o,[n],a)}function linecharacter([e,t],[i,s]){let a=Math.abs(t-s),n=Math.abs(e-i);return symbol=a>2*n?"-":n>2*a?"|":Math.sign(t-s)==Math.sign(e-i)?"\\":"/"}function linecharacterdiagonalpreference([e,t],[i,s]){let a=Math.abs(t-s),n=Math.abs(e-i);return symbol=a==2*n?"-":n==2*a?"|":Math.sign(t-s)==Math.sign(e-i)?"\\":"/"}function conditionattackpermute(e){return function(t,[i,s]){return(target=grid[i][s].character)&&t.onhiteffects.push(function(t){!(t<=0)&&addconditiondynamic(e,!0,target)()}),t}}function grenadeattack(){let[e,t]=this.target,i=Math.floor(1);for(let s=e-i;s<=e+i;s++)for(let a=t-i;a<=t+i;a++)null!==grid[s][a].character&&grid[s][a].character.pc!==this.character.pc&&grid[s][a].character.damage(10)}function restfunc(){let e=this.character,[t,i]=e.pos;!0===e.pc&&(addconditiondynamic(conditions.Resting,!0,e)(),restcheck(),!0==e.pc&&(e.actionqueue=[],playerendturn()))}function dashfunc(){let e=this.character;e.tc[0]+=e.tcmax[0];let[t,i]=e.pos;adduilabel("Dash",e.pos,e.color,1,!0)}function standgroundfunc(){let e=this.character;e.tc[1]+=e.tcmax[1];let[t,i]=e.pos;adduilabel("Stand Ground",e.pos,e.color,1,!0)}function checkforaoomove([e,t],[i,s],a){for(let n=e-1;n<=e+1;n++)for(let o=t-1;o<=t+1;o++)if(grid[n][o]&&grid[n][o].character&&grid[n][o].character.pc!==a.pc&&dist([i,s],[n,o])>1.8&&grid[n][o].character.tc[2]>0)return!0;return!1}function checkforaooattack([e,t],[i,s],a){let n=a.primaryitem;if(!n.ranged)return!1;for(let o=e-1;o<=e+1;o++)for(let l=t-1;l<=t+1;l++)if(grid[o][l]&&grid[o][l].character&&grid[o][l].character.pc!==a.pc&&dist([e,t],[i,s])>1.8&&grid[o][l].character.tc[2]>0)return!0;return!1}function startoverwatch(){let e=this.character;if(e.tc[2]<1)return!1;e.tc[0]=0,e.tc[1]=0,addconditiondynamic(conditions.Overwatch,!0,e)(),this.soundeffect=this.character.primaryitem.drawsound}function overwatch(e,t,i,s){if(s||lackscondition(conditions.Overwatch,e)||!t||t.pc==e.pc)return;let a=e,[n,o]=a.pos,l=a.getrange(),[c,h]=t.pos,d=grid[c][h].character;if(null!==d&&d.pc!==a.pc&&!0==grid[c][h].visible){let u=actions.Attack,$=new Attack(...u,l,[c,h],a,a.pos);if($.cost=[0,0,1],$.func(!0).errors.length>0)return;canAffordAction($,a)&&(removecondition(e,"Overwatch"),a.actionqueue.push($),move(a)),canAffordAction($,a);return}}function ambush(e,t,i,s){if(!s||!indarkness||!i||"Attack"!=i.name||!(t.pc!==e.pc))return;let a=e,[n,o]=a.pos,l=a.getrange(),[c,h]=t.pos,d=grid[c][h].character;if(null!==d&&d.pc!==a.pc&&!0==grid[c][h].visible){let u=actions.Attack,$=new Attack(...u,l,[c,h],a,a.pos);if($.cost=[0,0,1],$.func(!0).errors.length>0)return;canAffordAction($,a)&&(adduilabel("Ambush",a.pos,a.color,1,!0,!1,!1,!0),a.actionqueue.push($),move(a)),canAffordAction($,a);return}}function indarkness(){return!0}function removecondition(e,t){for(let i=e.conditions.length-1;i>=0;i--)e.conditions[i].name==t&&e.conditions.splice(i,1)}function open(){let[e,t]=this.target,i=grid[e][t].objects[0];if(i.open){if(!1===i.open())return adduilabel("Locked",this.character.pos,this.character.color,1,!0,!1),!1;adduilabel("Open",this.character.pos,this.character.color,1,!0,!1),grid[e][t].updateObjects()}}function interact(){let[e,t]=this.target,i=grid[e][t].objects[0];i.interact(this.character)}function canAffordAction(e,t){return!t.tc.some((t,i)=>t<e.cost[i])}function burn(){let e=this.character;e.damage(1)}function objectburn(e){let[t,i]=e.pos,s=grid[t][i].character;null!==s&&addconditiondynamic(conditions.Burning,!0,s)()}function generatehuntmap(e,t,i=5){class s{constructor(e,t,i){this.pos=e.slice(),this.parent=t,this.utility=i}}let[a,n]=e,o=new PriorityQueue((e,t)=>t.utility-e.utility);o.enqueue(new s([a,n],null,30));let l={},c=0,h=0;for(;!o.isEmpty()&&h<5e3;){h++;let d=o.dequeue();c=Math.abs(d.utility-10);let u=d.pos,[$,p]=u;l[$]||(l[$]={}),!l[$][p]&&(l[$][p]=d.utility,directions.forEach(function(i){let a=u.map((e,t)=>e+i[t]);if(grid[a[0]]&&void 0!==grid[a[0]][a[1]]){let n=grid[a[0]][a[1]],c=n.moveCost;t.knowntiles[`${a[0]},${a[1]}`]&&(t.knowntiles[`${a[0]},${a[1]}`],chebyshevDistance(a,e)>1&&(c+=10)),!0==n.traversable?o.enqueue(new s(n.pos,d,d.utility-c)):(l[a[0]]||(l[a[0]]={}),l[a[0]][a[1]]||(l[a[0]][a[1]]=-100))}else l[a[0]]||(l[a[0]]={}),l[a[0]][a[1]]||(l[a[0]][a[1]]=-100)}))}return l}function updatehuntmap(e,t){t.visibletiles.forEach(function(t){let[i,s]=t.pos;grid[i][s].traversable&&e[i]&&void 0!==e[i][s]&&(e[i][s]=0)})}function generatefleemap(e,t,i){class s{constructor(e,t,i){this.pos=e.slice(),this.parent=t,this.distance=i}}let a=new PriorityQueue((e,t)=>e.distance-t.distance);Object.values(e).forEach(function(e){let t=new s(e.lastseen,null,0);a.enqueue(t)});let n={};for(;!a.isEmpty()&&!((thisnode=a.dequeue()).distance>i);){let o=thisnode.pos,[l,c]=o;void 0===n[`${l},${c}`]&&(directions.forEach(function(e){let t=o.map((t,i)=>t+e[i]);if(grid[t[0]]&&grid[t[0]][t[1]]){let i=grid[t[0]][t[1]];if(!0==i.traversable&&void 0===n[`${t[0]},${t[1]}`]){let l=new s(t,thisnode,thisnode.distance+i.moveCost+.1*Math.random());a.enqueue(l)}}}),n[`${l},${c}`]=thisnode.distance)}return n}function moveusecase(e,t,i){e.tc[0],e.tc[1];let s=[],[a,n]=e.pos;for(let o=0;o<8;o++){let[l,c]=directions[o],[h,d]=[a+l,n+c],u;if(!grid[h]||!grid[h][d]||null!==(u=grid[h][d]).character)continue;let $=grid[a][n].elevation-grid[h][d].elevation;if(Math.abs($)>1)continue;if(grid[h][d].objects.length>0&&null!=grid[h][d].objects[0].action){let p=grid[h][d].objects[0],f=p.action,m=new action(...f,[h,d],t,e.pos);if("Open"==m.name&&!p.locked){let _=new ActionNode(e.pos,m,e.tc.slice(),e.hazards,e.damagepotential,e,i),g=new Move("Move",movefunc,[1,0,0],1,[h,d],t,e.pos),b=subtractcost(g,e.tc),w=g.warnings.length;s.push(new ActionNode([h,d],g,b,e.hazards+w,e.damagepotential,_,i))}continue}if(!grid[h][d].traversable)continue;let v=new Move("Move",movefunc,[1,0,0],null,[h,d],t,e.pos),k=subtractcost(v,e.tc),A=v.warnings.length;s.push(new ActionNode([h,d],v,k,e.hazards+A,e.damagepotential,e,i))}return s}function alertusecase(e,t,i){e.tc[0];let s=e.tc[1],a=[],[n,o]=e.pos,l=new action("Alert",chatfunc,[0,1,0],0,e.pos,t,e.pos,[],soundeffects.goblinyelp);l.loudness=20;let c=new ActionNode(e.pos,l,subtractcost(l,e.tc),e.hazards,e.damagepotential,e,i);return s>=1&&a.push(c),a}function chatusecase(e,t,i){e.tc[0];let s=e.tc[1],a=[],[n,o]=e.pos,l=new action("Chat",chatfunc,[0,1,0],0,e.pos,t,e.pos,[],soundeffects.goblinchat);l.loudness=20;let c=new ActionNode(e.pos,l,subtractcost(l,e.tc),e.hazards,e.damagepotential,e,i);return s>=1&&a.push(c),a}function attackusecase(e,t,i){e.tc[0],e.tc[1];let s=e.activeweapon,a=[],[n,o]=e.pos;if(!t.knownenemies||0==t.knownenemies.length)return a;for(let l=0;l<t.knownenemies.length;l++){let c=t.knownenemies[l],h=c.character,d=c.lastseen,[u,$]=e.pos,p=grid[u][$].elevation,[f,m]=d,_=grid[f][m].elevation;if(1>drawLine3D([u,$,p+1],[f,m,_])&&!1==h.dead&&dist(e.pos,d,!0)<t.getrange(s)){let g=new Attack("Attack",attackfunc,[0,1,0],t.getrange(s),d,t,e.pos),b=g.func(!0,e.activeweapon),w=subtractcost(g,e.tc),v=g.warnings.length;0==b.errors.length&&a.push(new ActionNode(e.pos,g,w,e.hazards+v,e.damagepotential+b.avdamageac10,e,i))}let k=new action("Switch Weapon",switchweapon,[0,0,0],0,e.pos,t,e.pos),A=t.secondaryitem,S=new ActionNode(e.pos,k,e.tc.slice(),e.hazards,e.damagepotential,e,e.parentutility,A);if(1>drawLine3D([u,$,p+1],[f,m,_])&&!1==h.dead&&dist(e.pos,h.pos,!0)<t.getrange(A)){let z=new Attack("Attack",attackfunc,[0,1,0],t.getrange(A),h.pos,t,e.pos),C=z.func(!0,A),E=subtractcost(z,e.tc),j=z.warnings.length;0==C.errors.length&&a.push(new ActionNode(e.pos,z,E,e.hazards+j,e.damagepotential+C.avdamageac10,S,i,A))}}return a}function dashusecase(e,t,i){let s=e.tc[0],a=e.tc[1],n=[],[o,l]=e.pos;if(a>0&&s<=0){let c=new action("Dash",dashfunc,[0,t.tcmax[1],0],0,t.pos,t,e.pos),h=subtractcost(c,e.tc);h[0]+=t.tcmax[0];let d=new ActionNode(e.pos,c,h,e.hazards,e.damagepotential,e,i);n.push(d)}return n}function standgroundusecase(e,t,i){let s=e.tc[0],a=e.tc[1],n=[],[o,l]=e.pos;if(0==a&&s==t.tcmax[0]){let c=new action("Stand Ground",standgroundfunc,[t.tcmax[0],0,0],0,t.pos,t,e.pos),h=subtractcost(c,e.tc);h[1]+=t.tcmax[1];let d=new ActionNode(e.pos,c,h,e.hazards,e.damagepotential,e,i);n.push(d)}return n}function defaultidle(e,t){return(t.spawnpoint||(t.spawnpoint=t.pos),Math.random()>.99)?1e3:0}function defaulthostile(e,t){let[i,s]=e.pos;grid[i][s],null==e.parentnode&&(t.knownenemies=[],Object.values(t.visiblecharacters).forEach(function(e){e.character.pc!==t.pc&&t.knownenemies.push(e)}),t.hostilemap=generatefleemap(t.knownenemies,t,80));let a=0,n=e.hazards;grid[i][s].gethazards()[1]>0&&n++;let o=e.damagepotential,l=defaulttemperment(e,t);return a-=100*n,a+=10*o,a+=l}function defaulthunting(e,t){let[i,s]=e.pos,a=0;if(null!==e.parentnode&&(a=e.parentutility),null!=e.parentnode||t.huntmap)null==e.parentnode&&updatehuntmap(t.huntmap,t);else{let n=99,o;Object.values(t.huntedcharacters).forEach(function(t){let i=t.lastseen;t.character;let s=chebyshevDistance(e.pos,i)+4*t.getage();s<n&&(n=s,o=t)}),o&&(t.hunted=o,t.huntmap=generatehuntmap(o.lastseen,t,20))}return t.huntmap&&t.huntmap[i]&&t.huntmap[i][s]?t.huntmap[i][s]:chebyshevDistance([i,s],t.pos)+3*Math.random()}function defaultfleeing(e,t){let[i,s]=e.pos,a=0;return(null==e.parentnode&&(t.knownenemies=[],Object.values(t.visiblecharacters).forEach(function(e){e.character.pc!==t.pc&&t.knownenemies.push(e)}),t.fleemap=generatefleemap(t.knownenemies,t,80)),t.fleemap&&t.fleemap[`${i},${s}`])?(a+=t.fleemap[`${i},${s}`],e.hazards>0&&(a-=e.hazards),e.damagepotential>0&&(a+=e.damagepotential),a>10&&e.action&&"Alert"==e.action.name&&(a+=20),a):1e3}function defaulttemperment(e,t){let i=e.activeweapon,[s,a]=e.pos,n=9999,o=Math.floor(t.getrange(i)),l,c;for(let h=0;h<t.knownenemies.length;h++){(l=t.knownenemies[h]).character;let d=l.lastseen;(c=Math.floor(dist(d,[s,a])))<n&&(n=c)}let u=Math.abs(c-o);n<=t.getminrange(i)&&(u=50);let $=t.hostilemap[`${s},${a}`];return void 0===$&&($=99),-(u=Math.max(u,$-o))}function fleeingtemperment(e,t){let[i,s]=e.pos,a=9999;return t.knownenemies.forEach(function(e){e.character;let t=e.lastseen,n=Math.floor(dist(t,[i,s]));n<a&&(a=n)}),-a}function spot(e,t,i){if(t&&t.index==e.index||t&&t.pc==e.pc)return;e.getvisibletiles(),e.visiblecharacters={};for(let s=0;s<e.visibletiles.length;s++){let a=e.visibletiles[s],[n,o]=a.pos;if(null!==a.character&&!a.character.dead){let l=a.character,c=l.pos.slice();t&&l.index==t.index&&"Move"==i.name&&(c=i.target),e.visiblecharacters[l.index]=new CharacterMemory(l,c.slice()),!0==l.pc&&e.knowncharacters[l.index]&&(e.knowncharacters[l.index].lastseen[0]!=e.visiblecharacters[l.index].lastseen[0]||e.knowncharacters[l.index].lastseen[1]!=e.visiblecharacters[l.index].lastseen[1])&&(e.actionqueue=[]),e.knowncharacters[l.index]||!0!=l.pc||(e.actionqueue=[]),e.knowncharacters[l.index]=new CharacterMemory(l,c.slice())}}let h=Object.keys(e.knowncharacters);for(let d=0;d<h.length;d++){let u=h[d];if(!e.visiblecharacters[u]&&e.knowncharacters[u].character.pc!==e.pc){if(drawline(e.pos,e.knowncharacters[u].lastseen)>=1){let $=e.knowncharacters[u].character,p=e.knowncharacters[u].lastseen;e.visiblecharacters[u]=new CharacterMemory($,p)}else{let f=e.knowncharacters[u].character,m=e.knowncharacters[u].lastseen;e.huntedcharacters[u]=new CharacterMemory(f,m),delete e.knowncharacters[u],e.actionqueue=[]}}}e.updatestate()}function attackofop(e,t,i){if(!t||t.pc==e.pc)return;let s=!1,a=!1;if(1==chebyshevDistance(t.pos,e.pos)&&"Move"==i.name&&chebyshevDistance(i.target,e.pos)>1?s=!0:1==chebyshevDistance(t.pos,e.pos)&&"Attack"==i.name&&chebyshevDistance(i.target,t.pos)>1&&!0==t.primaryitem.ranged&&(a=!0),!s&&!a)return;let n=new Attack("Attack",attackfunc,[0,0,1],e.getrange(),t.pos,e,e.pos);e.actionqueue.length>0&&(console.log("this enemy is making a reaction, and their action queue wasn't empty"),console.log(e),e.actionqueue=[]),canAffordAction(n,e)&&(e.actionqueue.push(n),move(e))}function defender(e,t,i){let[s,a]=e.pos;if(t&&t.pc!=e.pc&&"Attack"===i.name&&e.offhanditem instanceof Shield&&1===chebyshevDistance([s,a],i.target)){if(1==chebyshevDistance([s,a],t.pos)){let n=i.target.slice();i.target=[s,a],adduilabel("*",n,[32,32,64],0,!0,!1,!1,!1);return}{let o=function(t,i){return t.prehitpermute||(t.prehitpermute=[]),t.prehitpermute.push(function(i,s){return e.tc[2]>0&&!0==s&&(t.damagerange[0]-=e.stats[0],t.damagerange[0]=Math.max(t.damagerange[0],0),t.damagerange[1]-=e.stats[0],t.damagerange[1]=Math.max(t.damagerange[1],0),t.modbreakdown=[`reactBlocked-${e.stats[0]}dmg`],adduilabel("*",e.pos,[32,32,64],0,!0,!1,!1,!1),e.tc[2]--),[i,s]}),t};i.func=function(e,t){return attackfunc.apply(i,[e,t,o])}}}}function riposte(e,t,i){let[s,a]=e.pos;if(!t||t.pc==e.pc||"Attack"!==i.name||!(e.offhanditem instanceof Shield)||chebyshevDistance([s,a],i.target)>0)return;let n=function(i,n){return i.prehitpermute||(i.prehitpermute=[]),i.prehitpermute.push(function(n,o){if(e.tc[2]>0&&!0==o){i.damagerange[0]-=e.stats[0],i.damagerange[0]=Math.max(i.damagerange[0],0),i.damagerange[1]-=e.stats[0],i.damagerange[1]=Math.max(i.damagerange[1],0),i.modbreakdown=[`reactBlocked-${e.stats[0]}dmg`],e.tc[2]--;let l=new Attack("Attack",attackfunc,[0,0,0],e.getrange,t.pos,e,[s,a]);0==l.func(!0).errors.length&&(e.actionqueue.unshift(l),move(e))}return[n,o]}),i};i.func=function(e,t){return attackfunc.apply(i,[e,t,n])}}function block(e,t,i){let[s,a]=e.pos;if(!t||t.pc==e.pc||"Attack"!==i.name||!(e.offhanditem instanceof Shield)||chebyshevDistance([s,a],i.target)>0)return;let n=function(t,i){return t.prehitpermute||(t.prehitpermute=[]),t.prehitpermute.push(function(i,s){if(e.tc[2]>0&&!0==s){let a=Math.max(1,e.stats[0]);t.damagerange[0]-=a,t.damagerange[0]=Math.max(t.damagerange[0],0),t.damagerange[1]-=a,t.damagerange[1]=Math.max(t.damagerange[1],0),t.modbreakdown=[`reactBlocked-${a}dmg`],e.tc[2]--}return[i,s]}),t};i.func=function(e,t,s){return attackfunc.apply(i,[e,t,n])}}function parry(e,t,i){let[s,a]=e.pos;if(!t||t.pc==e.pc||"Attack"!==i.name||!(e.offhanditem instanceof Weapon)||!e.offhanditem.light||chebyshevDistance([s,a],i.target)>0)return;let n=function(t,i){return t.prehitpermute||(t.prehitpermute=[]),t.prehitpermute.push(function(i,s){if(e.tc[2]>0&&!0==s){let a=Math.max(1,e.stats[1]);t.damagerange[0]-=a,t.damagerange[0]=Math.max(t.damagerange[0],0),t.damagerange[1]-=a,t.damagerange[1]=Math.max(t.damagerange[1],0),t.modbreakdown=[`reactParry-${a}dmg`],e.tc[2]--}return[i,s]}),t};i.func=function(e,t){return attackfunc.apply(i,[e,t,n])}}function evade(e,t,i,s=!1){if(!s)return;let[a,n]=e.pos;if(!t||t.pc==e.pc||"Attack"!==i.name||i.target[0]!==a||i.target[1]!==n||e.tc[2]<1)return;let[o,l]=t.pos,[c,h]=[Math.sign(o-a),Math.sign(l-n)],[d,u]=[a-c,n-h],$=new Move("Move",movefunc,[0,0,1],1,[d,u],e,[a,n]);$.reactable=!1,$.cost=[0,0,1],e.actionqueue=[$],move(e)}function lightsensitive(e,t,i){let[s,a]=e.pos;grid[s][a].lightlevel>2&&addconditiondynamic(conditions.Stunned,!0,e)()}function autopickup(e,t,i){let[s,a]=e.pos;if(grid[s][a].objects.length>0&&(grid[s][a].objects[0]instanceof Weapon||grid[s][a].objects[0]instanceof Ammunition)){let n=grid[s][a].objects[0],o=[e.primaryitem,e.secondaryitem],l=!1;o.forEach(function(t){!0!=l&&(t.number<t.stacksize&&n.basename==t.basename||t.ammotype==n.basename)&&(0==e.actionqueue.length?(l=!0,e.actionqueue.unshift(new Get("Get",getfunc,[0,0,0],0,e.pos,e,e.pos)),move(e)):e.actionqueue.length>0&&"Get"!==e.actionqueue[0].name&&(l=!0,e.actionqueue.unshift(new Get("Get",getfunc,[0,0,0],0,e.pos,e,e.pos))))})}}function spot2([e,t]){let i=grid[e][t],s=[];s.push(i);let a={};visiblecharacters=[];let n=0;for(;s.length>0&&n<400;){n++;let o=s.shift(),[l,c]=o.pos;if(!1!==drawline([l,c],[e,t])){null!==o.character&&(l!==e||c!==t)&&visiblecharacters.push(o.character);for(let h=l-1;h<=l+1;h++)for(let d=c-1;d<=c+1;d++)a[h]||(a[h]={}),a[h][d]||(a[h][d]=1,s.push(grid[h][d]))}}return visiblecharacters}function hear(e,t=!0,i=0,s){if(chebyshevDistance(e.pos,viewportpos)>e.volume+20)return[];class a{constructor(e,t){this.pos=e,this.volume=t}}let[n,o]=e.pos,l=[],c=new a(e.pos,e.volume),h=new PriorityQueue((e,t)=>t.volume-e.volume);h.enqueue(c);let d=new Set,u=0,$=!1;!0==e.origin.pc&&($=!0);let p=[];for(i=0,!0==grid[n][o].visible&&($=!0);!h.isEmpty()&&u<900;){u++;let f=h.dequeue(),[m,_]=f.pos,g=grid[m][_],b=g.character,w=`${m},${_}`;if(!d.has(w)&&(d.add(w),f.volume>=1))for(let v of(p.push([m,_,f.volume]),null!==b&&(!0==b.pc&&($=!0,0==i&&(i=(e.volume-f.volume)*50)),l.push(b),t&&b.hear(e,f.volume)),directions)){let[k,A]=[f.pos[0]+v[0],f.pos[1]+v[1]],S=`${k},${A}`;if(grid[k]&&grid[k][A]&&!d.has(S)){let z=1;!1==grid[k][A].traversable&&grid[k][A].readOpacity()>=1&&!grid[k][A].slope&&(z=5),0!==Math.abs(k-m)&&0!==Math.abs(A-_)&&(z*=1.4),h.enqueue(new a([k,A],f.volume-z))}}}if(!0==grid[n][o].visible&&(i=0),!0==$){if(!0!==e.heard&&t){let C;for(let E=0;E<playercs.length;E++)!1==playercs[E].dead||!0==gameover&&playercs[E]==deathcharacter?C||(C=playercs[E]):C&&dist(C.pos,[n,o])<dist(playercs[E].pos,[n,o])&&(C=playercs[E]),void 0!=C&&C.hear(e,1)}for(let j=0;j<p.length;j++){let[q,W,F]=p[j];if(!0==grid[q][W].visible){let D=[F/100,F/100,F/100];s&&(D=[s[0]*F/100,s[1]*F/100,s[2]*F/100]),adduilabel("$",[q,W],D,0,!0,!1,!1,!1,.2,(e.volume-F)*50+i),updatedsomething=!0}}}return performance.now(),l}function evaluateposition(e){let[t,i]=[0,0];for(let s=0;s<e.length;s++)[t,i]=e[s]}function dist(e,t,i=!1,s=!1){let a=Math.abs(e[0]-t[0]),n=Math.abs(e[1]-t[1]),o=0;return(void 0===grid[t[0]]||void 0===grid[t[0]][t[1]]||void 0===grid[e[0]]||void 0===grid[e[0]][e[1]])&&console.trace(),i||(o=grid[t[0]][t[1]].elevation-grid[e[0]][e[1]].elevation),s&&(o=Math.max(o,0)),Math.sqrt(a**2+n**2+o**2)}function eudist([e,t],[i,s]){return Math.sqrt(Math.abs(s-t)**2+Math.abs(i-e)**2)}function repeatchar(e,t){let i="";for(let s=0;s<t;s++)i+=e;return i}function addLineBreaks(e,t){let i="";for(let s=0;s<e.length;s++)i+=e[s],(s+1)%t==0&&s!==e.length-1&&(i+="<br>");return i}function roll(e,t){return randomNumber(e,1)+t}function randomNumber(e,t=0){return Math.floor(Math.random()*(e-t)+t)}function bresenhamLine([e,t],[i,s]){let a=[],n=Math.abs(i-e),o=Math.abs(s-t),l=e<i?1:-1,c=t<s?1:-1,h=n-o;for(;a.push([e,t]),e!==i||t!==s;){let d=2*h;d>-o&&(h-=o,e+=l),d<n&&(h+=n,t+=c)}return a}function shuffle(e){let t=e.length,i,s=e.slice();for(;t>0;)i=Math.floor(Math.random()*t),t--,[s[t],s[i]]=[s[i],s[t]];return s}function deepCopy3D(e){return e.map(e=>e.map(e=>e.map(e=>e)))}function deepCopySubArray3D(e,t,i,s,a){let n=[];for(let o=i;o<=a;o++){n[o-i]=[];for(let l=t;l<=s;l++){n[o-i][l-t]=[];for(let c=0;c<e[0][0].length;c++)n[o-i][l-t][c]=e[o][l][c]}}return n}function deepCopySubArray2D(e,t,i,s,a){let n=[];for(let o=i;o<=a;o++){n[o-i]=[];for(let l=t;l<=s;l++)n[o-i][l-t]=e[o][l]}}function deepCopy2D(e){let t=[];for(let i=0;i<e.length;i++){t[i]=[];for(let s=0;s<e[0].length;s++)t[i][s]=e[i][s]}return t}function partialFill(e,t,i,s,a,n){for(let o=i;o<a;o++)for(let l=s;l<n;l++)e[l][o]=t}function shadowslope([e,t],[i,s]){let a=-Math.abs(s-t)/Math.abs(i-e);chebyshevDistance([e,t],[i,s]);let n=[i+a/Math.sqrt(1+a**2),s+1/Math.sqrt(1+a**2)];n[1],n[0]}function randomSymbol(e){let t=e.length,i=randomNumber(t+1,1)-1;return e[i]}function takeav(e){return e.reduce((e,t)=>e+t)/e.length}function manhattanDistance(e,t){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])}function convertColortoAbs(e){let t=e.map(e=>e/256);return t}function convertAbstoColor(e){let t=e.map(e=>256*e);return t}function getsquare([e,t],i){let s=0,a=0,n=2*i+1,o=[];for(let l=0;l<n*n;l++)a=l%n,o.push([e+a-i,t+(s=Math.floor(l/n))-i]);return o}function gettiles(e){let t=[],i=0,s=0;for(let a=0;a<e.length;a++)[i,s]=e[a],!(i<0)&&!(i>=mapsizey)&&(s<0||s>=mapsizex||t.push(grid[i][s]));return t}function randomint(e,t){return e>t&&([e,t]=[t,e]),Math.floor(Math.random()*(t-e+1))+e}function chebyshevDistance(e,t){let[i,s]=e,[a,n]=t;return Math.max(Math.abs(a-i),Math.abs(n-s))}function combineFunctions(e,t){let i=e.bind(this),s=t.bind(this);return()=>{i(),s()}}const conditions={Stunned:new condition("Stunned",skipturn,skipturn,1,25),Stunnedlite:new condition("Stunned",skipturn,skipturn,1,!1),Surprised:new condition("Surprised",skipturnandyelp,skipturn,1,!0),Prone:new condition("Prone",losemove,losemove,1,!1),Poisoned:new condition("Poisoned",()=>{},takedamage(1),2,!1),Bleeding:new condition("Bleeding",()=>{},takedamage(1),3,!1),Overwatch:new condition("Overwatch",null,null,0,!1,null),Resting:new condition("Resting",()=>{},()=>{},0,!1,()=>{}),Restrained:new condition("Restrained",skipturn,skipturn,1,!1),Asleep:new condition("Asleep",skipturn,skipturn,1,!1)},keybindings=["c - Credits","m - open map","ctrl+click - move all","D - toggle auto-dash","S - toggle auto-stand-ground","A - toggle auto-advance-turn","V - toggle verbose tool-tips","k - kick","j - jump","X - switch hands","L - leave offhand Item","l - leave item","x - switch weapons","g - get Item","o - overwatch","s - stand ground","d - dash","a - aim attack","1,2,3 - switch characters","space - advance turn","click - move",],keytooltips=["","","move all party members in order toward the cursor","automatically use the dash action when running out of move","automatically use the stand-ground action when out of actions","automatically advance turn to the next party member when out of move and actions","enables in-depth tool-tips","shove a character a number of tiles equal to the attacking character's strength","jump to a tile within a distance dependant on the jumping character's strength","switch primary and offhand items","leave the item in the character's offhand","leave the item in the character's main hand","switch primary and secondary items","get an item on the ground underneath a character","use an action to prepare an attack as a reaction during enemy turn (reaction required)","trade a character's max move for an additonal action","trade an action to add a character's max move","aim an attack - displays modifiers to the attack and allows the use of thrown or consumable weapons","switch active character to a particular character","advance from one party member's turn to the next or from the last party member's turn to the enemy turn","move the active character to the location of the cursor",];let procgendebug=!1,characterindex=0,cornershadows=!1,partiallos=!1,memorytilebrightness=6;const dontcaredistance=50,enemysightrange=30,playersightrange=30,mapsizex=400,mapsizey=208;let shrink=1,mult=1,viewportsizex=48*mult,viewportsizey=30*mult,fontsize=26;const enemypool=[Goblin,Goblin_Dagger,Goblin_Swordsman,Goblin_Spearman,Hobgoblin,Ogre,Skulker,Giant,],clickfuncs={Raise:function([e,t]){let i=grid[e][t].elevation;grid[e][t]=new Tile(...tiletypes.RoughStoneFloor,[e,t]),grid[e][t].elevation=i+1},Lower:function([e,t]){let i=grid[e][t].elevation;grid[e][t]=new Tile(...tiletypes.RoughStoneFloor,[e,t]),grid[e][t].elevation=i-1},Clear:([e,t])=>grid[e][t]=new Tile(...tiletypes.DirtFloor,[e,t]),Wall:([e,t])=>grid[e][t]=new Tile(...tiletypes.CavernWall,[e,t])};let clickfunc=clickfuncs.Lower;const directionsincl=[[0,0],[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],],directions=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],],cardinaldirections=[[-1,0],[1,0],[0,-1],[0,1],],directionsextra=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],[2,0],[2,1],[2,-1],[-2,0],[-2,1],[-2,-1],[0,2],[1,2],[-1,2],[0,-2],[1,-2],[-1,-2],],directionsextraincl=[[0,0],[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],[2,0],[2,1],[2,-1],[-2,0],[-2,1],[-2,-1],[0,2],[1,2],[-1,2],[0,-2],[-1,-2],[-1,-2],],materials={metal:[.5,.5,.5],water:[.1,.25,.35],stone:[.6,.6,.6],dirt:[.7,.5,.4],mud:[.3,.2,.2],abyss:[0,0,0],crystal:[3,3,3],brick:[1,1,1],moss:[.3,.6,.2],wood:[.5,.25,.2],fire:[1,.25,.1],marble:[1,1,1],bone:[1,1,1],blood:[1,0,0]},tiletypes={Water:["Water",materials.water,"~",!0,2,1],DirtFloor:["Dirt Floor",materials.dirt,"B7",!0,1,1],StoneFloor:["Stone Floor",materials.stone,"B7",!0,1,1],CavernWall:["Cavern Wall",materials.stone,"#",!1,null,0],MossFloor:["Moss Floor",materials.moss,"201D",!0,1,1],RoughStoneFloor:["Rough Stone Floor",materials.stone,"B7",!0,1,1],RoughStoneWall:["Rough Stone Wall",materials.stone,"=",!1,null,0],SmoothstoneFloor:["Smooth Stone Floor",materials.stone,"0060",!0,1,1],MossyWall:["Mossy Wall",materials.moss,"#",!1,null,0],WoodFloor:["Wood Floor",materials.wood,"B7",!0,1,1],WoodWall:["Wood Wall",materials.wood,"#",!1,null,0],MudFloor:["Mud Floor",materials.mud,"B7",!0,1,1],MudWall:["Mud Wall",materials.mud,"#",!1,null,0]},tiletypesarr=[tiletypes.Water,tiletypes.DirtFloor,tiletypes.StoneFloor,tiletypes.CavernWall,tiletypes.MossFloor,tiletypes.RoughStoneFloor,tiletypes.RoughStoneWall],actions={SwitchWeapon:["Switch Weapon",switchweapon,[0,0,0],],HalfAttack:["Attack",attackfunc,[0,.5,0]],Attack:["Attack",attackfunc,[0,1,0]],Open:["Open",open,[0,0,0],1.9],Dash:["Dash",dashfunc,[0,1,0]],Interact:["Interact",interact,[0,0,0],1.9]},statblocks={Deserter:[3,0,3],Hellion:[3,0,3],Ranger:[2,2,2],Standard_Bearer:[2,2,2],Exile:[1,2,2],Wanderer:[1,2,2],Skirmisher:[1,2,2],Stalker:[1,2,2],Maledict:[1,2,2],Berserker:[3,0,3],Sentinel:[3,0,3],ShieldMaiden:[2,2,3],Prisoner:[1,1,1],Goblin:[0,0,0]};let baselightrange=6,invlightrange=1/baselightrange,brightnessadjust=2,viewportoffsety=0,viewportoffsetx=0,throttleRate=33,lastCall=0,enemyturnstart=0,soundoffset=2.5,now=0,lastframe=0,frameticker=20,timeticker=0,checkedframe=!1,noiseupdateticker=0;const noiseupdaterate=100,noisethreshold=.5,waterthreshhold=.6,noiseamount=.1,lightflickerthreshhold=.8,tileabsorbs=[materials.water,materials.dirt,materials.stone,materials.stone,materials.moss,materials.stone,materials.stone,materials.crystal,materials.abyss,];let diffgens=2;const cdiff=.05;let gamma=1.4,ticktimer=100,renderedlastframe=!0,updatedlighting=!0,updatedsomething=!0,renderqueue=[];function updatelightmap(){let[e,t,i,s]=getlightingsize();updatelos(e,t,i,s),updatelighting(e,t,i,s),updatediffusion(e,t,i,s)}function getlightingsize(){let e=viewportpos[1]-viewportsizex/2-4,t=viewportpos[0]-viewportsizey/2-4,i=viewportpos[1]+viewportsizex/2+4,s=viewportpos[0]+viewportsizey/2+4;return t<0&&(t=0,s=viewportsizey+4),s>mapsizey&&(s=mapsizey,t=mapsizey-(viewportsizey+4)),e<0&&(e=0,i=viewportsizex+4),i>mapsizex&&(i=mapsizex,e=mapsizex-(viewportsizex+4)),[e,t,i,s]}function updatelos(e,t,i,s){for(let a=t;a<s;a++)for(let n=e;n<i;n++)grid[a][n].visible=!1;for(let o=t;o<s;o++)for(let l=e;l<i;l++){if(grid[o][l].readOpacity()>=1){grid[o][l].visible=!0;continue}grid[o][l].los=!1;for(let c=0;c<playercs.length;c++){if(!0==playercs[c].dead&&!1==gameover||!0==gameover&&!playercs[c]==deathcharacter)continue;let h=drawLine3D([...playercs[c].pos,grid[playercs[c].pos[0]][playercs[c].pos[1]].elevation+1],[o,l,grid[o][l].elevation]);if(h<1){grid[o][l].visible=!0;for(let d=o-1;d<=o+1;d++)if(d>0&&d<mapsizey)for(let u=l-1;u<=l+1;u++)u>0&&u<mapsizex&&2>Math.abs(grid[o][l].elevation-grid[d][u].elevation)&&(grid[d][u].visible=!0)}h&&(grid[o][l].los=!0)}}}function updatelighting(e,t,i,s,a=!1){let n=[],o=[];for(let l=t;l<s;l++)for(let c=e;c<i;c++){let h=[];h=grid[l][c].readLightsource();for(let d=0;d<h.length;d++){let u=h[d];u.pos=[l,c],n.push(u)}}let $;for(let p=t;p<s;p++)for(let f=e;f<i;f++){if($=grid[p][f],!1==a&&($.light=null),$.lightlevel=0,!1!==$.visible){for(let m=0;m<n.length;m++){let _=n[m],[g,b]=_.pos;if(Math.abs(g-p)>_.radiance*baselightrange+2||Math.abs(b-f)>_.radiance*baselightrange+2)continue;let[w,v]=getlighting(p,f,n[m]);if(v=Math.max(v,grid[p][f].lightlevel),$.lightlevel=v,!a){if(null===$.light){$.light=w;continue}$.light[0]+=w[0],$.light[1]+=w[1],$.light[2]+=w[2]}}0==$.lightlevel&&o.push($)}null===$.light&&($.light=[0,0,0])}if(a)return;let k=[];for(let A=0;A<o.length;A++)($=o[A]).lightlevel<1&&($.visible=!1,k.push($));let[S,z]=[0,0],[C,E]=[0,0],j=[];for(let q=0;q<k.length;q++){let[W,F]=($=k[q]).pos;for(let D=0;D<20;D++){if([S,z]=directionsextra[D],[C,E]=[W+S,F+z],C<0||C>=mapsizey||E<0||E>=mapsizex)continue;let R=0;D>7&&(R=drawline([W,F],[C,E])),!(R>=1)&&!0==grid[C][E].visible&&1>grid[C][E].readOpacity()&&j.push($)}}for(let B=0;B<j.length;B++)($=j[B]).visible=!0;for(let G=0;G<playercs.length;G++){let O=playercs[G];if(O.dead)continue;let[M,T]=O.pos;for(let L=0;L<20;L++){let[P,N]=directionsextraincl[L],[H,I]=[M+P,T+N];if(H>s||H<t||I>i||I<e||grid[H][I].lightlevel>=1)continue;let U=Math.max(1,Math.round(dist([H,I],O.pos))),K=0;L>8&&(K=drawline(O.pos,[H,I],!1,!0)),K<1&&(grid[H][I].visible=!0,grid[H][I].light[0]+=16/U,grid[H][I].light[1]+=16/U,grid[H][I].light[2]+=16/U)}}}function prunesightmap(e,t,i,s){for(let a=t;a<s;a++)for(let n=e;n<i;n++){if(grid[a][n].lightlevel<1&&!1!==grid[a][n].visible){procgendebug||(grid[a][n].visible=!1);for(let o=a-2;o<=a+2;o++)if(o>0&&o<mapsizey){for(let l=n-2;l<=n+2;l++)if(grid[o]&&grid[o][l]&&!(grid[o][l].lightlevel<1)&&l>0&&l<mapsizex){let c=drawline([a,n],[o,l]);if(1>grid[o][l].readOpacity()&&c<1){grid[a][n].visible=!0;break}}}}if(grid[a][n].lightlevel<1||!1==grid[a][n].visible)for(let h=0;h<playercs.length;h++){let d=playercs[h];if(d.dead)continue;let u=dist([a,n],d.pos);if(u>=3.5)continue;let $=Math.max(1,Math.round(u));1>drawline(d.pos,[a,n],!1,!0)&&(grid[a][n].visible=!0,grid[a][n].light[0]+=16/$,grid[a][n].light[1]+=16/$,grid[a][n].light[2]+=16/$)}}}function updatediffusion(e,t,i,s){let a=directions.length,n=[0,0,0],o=[0,0,0],l=0,c=[];for(let h=0;h<diffgens;h++){c=[];for(let d=t;d<s;d++)for(let u=e;u<i;u++){let $=grid[d][u].light,p=grid[d][u].absorbtionBase,f=grid[d][u].elevation,m=[0,0,0];if(!(grid[d][u].readOpacity()>=1)){for(let _=0;_<a;_++){let g=directions[_],[b,w]=[g[0]+d,g[1]+u];if(grid[b]&&grid[b][w]){if(!1==grid[b][w].visible||grid[b][w].readOpacity()>=1)continue;let v=grid[b][w].light,k=grid[b][w].absorbtionBase;for(let A=0;A<3;A++)n[A]=.05*v[A]*k[A],o[A]=.05*$[A]*p[A];if(l=(o[0]+o[1]+o[2])/3,f<=grid[b][w].elevation)for(let S=0;S<3;S++)m[S]+=n[S]}}c.push(grid[d][u]),c.push(m)}}for(let z=0;z<c.length;z+=2){let C=c[z],E=c[z+1];C.light[0]+=E[0],C.light[1]+=E[1],C.light[2]+=E[2]}}}function getlighting(e,t,i){let s=[i.color[0],i.color[1],i.color[2]],[a,n]=i.pos,o=i.lightpref,l=i.pos,c=grid[i.pos[0]][i.pos[1]],h=c.elevation+1,d=dist([e,t],[a,n]),u=grid[e][t].elevation;h!==grid[e][t].elevation&&(d=Math.sqrt(d**2+Math.abs(h-u)**2));let $=Math.min(Math.round(i.radiance-(d-1)/baselightrange),i.radiance);if($<=0)return[[0,0,0],0];let p=drawLine3D([...l,h],[e,t,u]);if(p>=1)return[[0,0,0],0];$=Math.round(i.radiance-(d-1)*(1+p)/baselightrange);for(let f=0;f<3;f++)s[f]=Math.round(s[f]*noisemap[a][n]*(1/((d/o[f])**2+.5))*(1-p));return[s,$]}function generate(){if(tutorial){tutorialgen();return}playercs=[],nonpcs=[];let[e,t]=region2gen(mapsizey,mapsizex,30,160),i=perlinNoise(mapsizex,mapsizey,5),s=!1;for(let a=0;a<t.length;a++){s=!1;let n=t[a];if(n.hotdepth>0)continue;let[o,l]=n.pos,c=n.roomgrid;for(let h=0;h<c.length;h++)for(let d=0;d<c[0].length;d++){let[u,$]=[h+o,d+l];n.boss||n.bossbuffer||n.origin?((1==c[h][d]||2==c[h][d]||3==c[h][d]||4==c[h][d])&&(grid[u][$]=new Tile(...tiletypes.MudFloor,[u,$])),!1==grid[u][$].traversable&&0==grid[u][$].objects.length&&5==c[h][d]&&(grid[u][$]=new Tile(...tiletypes.MudWall,[u,$]))):((1==c[h][d]||2==c[h][d]||3==c[h][d]||4==c[h][d])&&(4==e[u][$]&&i[u][$]>.1?(grid[u][$]=new Tile(...tiletypes.DirtFloor,[u,$]),i[u][$]>.2&&(grid[u][$]=new Tile(...tiletypes.MossFloor,[u,$])),i[u][$]>.3&&Math.random()<i[u][$]?grid[u][$].addObject(new TallGrass):i[u][$]>.4&&grid[u][$].addFluid(new Water)):(n.dungeon?grid[u][$]=new Tile(...tiletypes.SmoothstoneFloor,[u,$]):grid[u][$]=new Tile(...tiletypes.StoneFloor,[u,$]),i[u][$]>.3&&(grid[u][$]=new Tile(...tiletypes.MossFloor,[u,$])))),!0===s&&0!==c[h][d]&&6!==c[h][d]&&(grid[u][$].elevation=2,(2==c[h][d]||3==c[h][d]||4==c[h][d])&&(grid[u][$]=new Tile(...tiletypes.DirtFloor,[u,$]),grid[u][$].elevation=1)),!1==grid[u][$].traversable&&0==grid[u][$].objects.length&&i[u][$]>.3&&(grid[u][$]=new Tile(...tiletypes.MossyWall,[u,$])))}for(let p=0;p<n.doors.length;p++){let[f,m]=n.doors[p],[_,g]=[f+o,m+l];grid[_][g].addObject(new door([_,g]))}let[b,w]=n.pos;for(let v=0;v<n.spawnpoints.length;v++){let[k,A]=n.spawnpoints[v],[S,z]=[k+b,A+w],C=n.enemies[v];switch(C){case 0:grid[S][z].addCharacter(new Deserter([S,z]));break;case 1:grid[S][z].addCharacter(new Goblin([S,z]));break;case 2:Math.random()>.33?grid[S][z].addCharacter(new Goblin_Dagger([S,z])):grid[S][z].addCharacter(new Goblin_Shortbow([S,z]));break;case 3:switch(Math.floor(4*Math.random())){case 1:grid[S][z].addCharacter(new Goblin_Shortbow([S,z]));break;case 2:grid[S][z].addCharacter(new Goblin_Spearman([S,z]));break;case 3:grid[S][z].addCharacter(new Goblin_Swordsman([S,z]))}break;case 4:switch(Math.floor(4*Math.random())){case 0:grid[S][z].addCharacter(new Skulker([S,z]));break;case 1:grid[S][z].addCharacter(new Ogre([S,z]));break;default:grid[S][z].addCharacter(new Hobgoblin([S,z]))}break;case 5:grid[S][z].addCharacter(new Goblin_Hivequeen([S,z]));break;case 6:grid[S][z].addObject(new Spawning_Membrane([S,z]));break;case 7:grid[S][z].addObject(new Chest([S,z]));break;case 8:grid[S][z].addCharacter(new Giant([S,z]));break;case 9:grid[S][z].addObject(new spikeTrap([S,z]));break;case 10:grid[S][z].addCharacter(new Hobgoblin_Warlord([S,z]));break;case 11:grid[S][z].addObject(new Spawning_Membrane_Special)}}if(n.pittiles&&n.pittiles.length>0){let E=Math.random()>.5;n.dungeon&&(E=!1);let j=-1;E&&(j=1);for(let q=0;q<n.pittiles.length;q++){let[W,F]=n.pittiles[q],[D,R]=[W+b,F+w];!1==grid[D][R].traversable&&0==grid[D][R].objects.length&&(grid[D][R]=new Tile(...tiletypes.StoneFloor,[D,R])),grid[D][R].elevation=2*j}for(let B=0;B<n.pittiles.length;B++){let[G,O]=n.pittiles[B],[M,T]=[G+b,O+w];for(let L=0;L<4;L++){let[P,N]=cardinaldirections[L],[H,I]=[M+P,T+N];0==grid[H][I].elevation&&!0==grid[H][I].traversable&&(grid[H][I].elevation=1*j,grid[H][I].readdobject())}}}}activecharacternonindex=playercs[0]}function tutorialgen(){grid[100][200].addCharacter(new Deserter([100,200])),grid[90][200].addCharacter(new Goblin([90,200])),activecharacternonindex=playercs[0]}let successes=0,failures=0;function region1gen(...e){return generatenoise(...e,[[10,1]])}function region2gen(...e){return generatenoise(...e,[[5,1],[9,1]])}function generatenoise(e,t,i,s=50,a){class n{constructor(e){this.noisegrid=e,this.enemies=[],this.neighborsnonindex=[],this.neighbors=[],this.spawnpoints=[],this.walls=[],this.walltiles=[],this.pittiles=[],this.doors=[],this.maxhotdepth=0}generategrid(){let e=[],t=this.tiles.concat(this.walltiles),[i,s]=[999,0],[a,n]=[999,0];for(let o=0;o<t.length;o++){let[l,c]=t[o];c<i&&(i=c),c>s&&(s=c),l<a&&(a=l),l>n&&(n=l)}let h=s-i+1,d=n-a+1;for(let u=0;u<d;u++){e[u]=[];for(let $=0;$<h;$++)e[u][$]=0}for(let p=0;p<this.tiles.length;p++){let[f,m]=this.tiles[p];e[f-a][m-i]=1}for(let _=0;_<this.walltiles.length;_++){let[g,b]=this.walltiles[_];e[g-a][b-i]=5}this.pos=[a,i],this.roomgrid=e}updateneighbors(){let e=this.roomgrid,[t,i]=this.pos;for(let s=0;s<this.neighborsnonindex.length;s++){let a=this.edges[this.neighbors[s]],n=this.neighborsnonindex[s],o=!1,l=!1,c=1;n.depth<=this.depth&&(o=!0),n.depth>=this.depth&&(l=!0),o&&(c+=1),l&&(c+=2);let[h,d]=[0,0];for(let u=0;u<a.length;u++)d+=a[u][1],h+=a[u][0];let[$,p]=[h/a.length,d/a.length];a=a.sort(([e,t],[i,s])=>v([e,t],[$,p])-v([i,s],[$,p]));for(let f=0;f<1;f++){let[m,_]=a[f];e[m-t][_-i]=c}}let g=!0;for(let b=0;b<this.roomgrid.length;b++)for(let w=0;w<this.roomgrid[0].length;w++)(3==this.roomgrid[b][w]||4==this.roomgrid[b][w])&&(g=!1);function v([e,t],[i,s]){return Math.sqrt((e-i)**2+(t-s)**2)}this.deadend=g}findspawnpoints(){let e=this.depth,t=3,i=0;if(e<4)for(t=Math.min(3,e);i<t;){let s=Math.ceil(2*Math.random());this.enemies.push(s),i+=s}else if(e<8)for(t=Math.min(6,e);i<t;){let a=Math.ceil(3*Math.random());this.enemies.push(a),i+=a}else for(t=6;i<t;){let n=Math.ceil(4*Math.random());this.enemies.push(n),i+=n}if(this.dungeon&&!this.ruins){this.enemies.push(Math.min(4,e)),this.enemies.push(Math.min(4,e)),Math.random()>.5&&this.enemies.push(7);for(let o=0;o<4;o++)this.enemies.push(9)}this.boss&&(this.enemies=[5,6,6,6,6,6,6,6,6,6,6,6,6,6]),this.bossbuffer&&(this.enemies.push(6),this.enemies.push(6),this.enemies.push(6),this.enemies.push(6),this.enemies.push(6)),this.miniboss&&this.enemies.push(Math.min(4,e)),this.halfboss&&(this.enemies.push(8),this.enemies.push(7),this.enemies.push(11)),this.origin&&(this.enemies=[0,11,11]);let l=[],c=[],h=this.roomgrid.length,d=this.roomgrid[0].length;for(let u=0;u<h;u++){l[u]=[];for(let $=0;$<d;$++)(2==this.roomgrid[u][$]||4==this.roomgrid[u][$])&&c.push([u,$]),l[u][$]=null}let p=0;for(let f=0;f<c.length;f++){let m=c[f];for(let _=0;_<m;_++){let[g,b]=c.shift();if(void 0!==l[g]&&void 0!==l[g][b]&&null===l[g][b]&&1===this.roomgrid[g][b]){l[g][b]=p;for(let w=0;w<4;w++){let[v,k]=directions[w],[A,S]=[g+v,b+k];c.push([A,S])}}}p++}for(let z=0;z<this.enemies.length;z++){this.enemies[z];let C,E;for(let j=0;j<h;j++)for(let q=0;q<d;q++){if(1!==this.roomgrid[j][q]||void 0===l[j][q])continue;let W=0;W=Math.abs(l[j][q]-5);let F=!1,D;for(let R=0;R<this.spawnpoints.length;R++){let[B,G]=this.spawnpoints[R];G==q&&B==j&&(F=!0),W+=D=Math.max(-4,-Math.sqrt(Math.max(Math.abs(G-q),Math.abs(B-j))))}!F&&((W=Math.random())<E||void 0===E)&&(C=[j,q],E=W)}C&&this.spawnpoints.push(C)}}getrandomtile(){let e=Math.floor(Math.random()*this.roomgrid.length),t=Math.floor(Math.random()*this.roomgrid[0].length);return 0==this.roomgrid[e][t]?this.getrandomtile():[e,t]}evaluate([e,t]){let i=999,s=[[e,t]],a=this.roomgrid,n={};for(;s.length>0;){let[o,l]=s.shift();if(n[`${o},${l}`]||!a[o]||!a[o][l])continue;let c=Math.abs(o-e)+Math.abs(l-t);0!==a[o][l]&&(2!=a[o][l]||i<c||(i=c),n[`${o},${l}`]=1,s.push([o+1,l]),s.push([o-1,l]),s.push([o,l+1]),s.push([o,l-1]))}return-Math.abs(i-3)}restructure(){let e=this;this.walls=[];let t=this.roomgrid,i=[],s=0,a=0;t.length,t[0].length;let n=[],o=[],l=[];for(let c=0;c<this.roomgrid.length;c++){n[c]=[];for(let h=0;h<this.roomgrid[0].length;h++)n[c][h]=0}for(let d=0;d<this.roomgrid.length;d++)for(let u=0;u<this.roomgrid[0].length;u++)if(0==n[d][u]){l=[],(o=[]).push([d,u]);let $=!0;for(;o.length>0&&!0==$;){let[p,f]=o.shift();for(let m=0;m<4;m++){let[_,g]=cardinaldirections[m],[b,w]=[p+_,f+g];if(void 0===t[b]||void 0===t[b][w]){$=!1;continue}Math.abs(this.noisegrid[b+this.pos[0]][w+this.pos[1]])>.2&&0==n[b][w]&&(o.push([b,w]),l.push([b,w]),n[b][w]=1),(5!==t[b][w]&&1!==t[b][w]||2==n[b][w])&&($=!1)}}if(!0==$&&l.length>10)for(let v=0;v<l.length;v++){let[k,A]=l[v];n[k][A]=2,this.pittiles.push([k,A])}else for(let S=0;S<l.length;S++){let[z,C]=l[S];n[z][C]=2}}if((this.dungeon||this.miniboss)&&!this.boss&&!this.bossbuffer&&!this.origin){for(let E=0;E<this.roomgrid.length;E++)for(let j=0;j<this.roomgrid[0].length;j++)2==t[E][j]||3==t[E][j]||4==t[E][j]?i.push([E,j]):1==t[E][j]?(s++,a++,t[E][j]=0):5==t[E][j]?(a++,t[E][j]=0):0==t[E][j]&&(t[E][j]=6);let[q,W]=i.shift(),F=[[q,W]],D=[],R=[],B=0;for(;F.length>0||i.length>0||B<s/2;){let G=!1;for(;0==F.length&&R.length>0;){i.length>0&&(i[0],R=es(R));Y(R.shift()),F.length>0&&successes++}if(0==F.length&&D.length>0){let O=i[0];void 0!==O&&D.sort(([e,t],[i,s])=>ea([e,t],O)-ea([i,s],O));let M=D.shift();Y(M),F.push(M),F.length>0?(failures++,G=!0):successes++}let[T,L]=F.shift();if(1==t[T][L])continue;t[T][L]=1,B++;for(let P=0;P<i.length;P++){let[N,H]=i[P];if(N==T&&H==L){i.splice(P,1);break}}let I=es(cardinaldirections);for(let U=0;U<4;U++){let[K,Q]=I[U],[J,V]=[T+K,L+Q],[X,Z]=[T+2*K,L+2*Q];if(void 0!==t[J]&&void 0!==t[J][V]&&6!=t[J][V]){if(0!==t[J][V]&&1!==t[J][V]&&5!==t[J][V])F.push([J,V]);else if(0==t[J][V]||5==t[J][V]){if(D.push([J,V,[K,Q]]),void 0===t[X]||void 0===t[X][Z]||6==t[X][Z])continue;1==t[X][Z]&&Math.random()>.5&&this.ruins?F.push([J,V,[K,Q]]):R.push([J,V,[K,Q]])}}}}function Y([i,s,[a,n]]){let o=2,l=2;Math.random()>.5&&(l++,o++);let c=4,h=!1;Math.random()>.5&&(c=5,h=!0);let d=!0,u=[],$=[],p=!0;for(;!0==d&&Math.max(o,l)<=c;){!0==h&&(l=o=Math.max(o,l));let[f,m]=[i+a*l,s+n*o],_=[],g=[];for(let b=f-l;b<=f+l;b++){for(let w=m-o;w<=m+o;w++){if(h&&ea([b,w],[f,m])>=l)continue;let v=Math.abs(w-m),k=Math.abs(b-f);if(void 0===t[b]||void 0===t[b][w]||1==t[b][w]){d=!1;break}if(v>=o||k>=l)6!==t[b][w]&&g.push([b,w]);else{if(6==t[b][w]){d=!1;break}_.push([b,w])}}if(!d)break}Math.random()>.5?(o++,l++):Math.random()>.5?o++:l++,d&&(p=!1,$=g.slice(),u=_.slice())}if(!p){for(let A=0;A<u.length;A++){let[S,z]=u[A];t[S][z]=2}for(let C=0;C<$.length;C++){let[E,j]=$[C];t[E][j]=5}let q=[],W=[[i,s]];for(;W.length>0;){let[D,R]=W.shift(),[B,G]=[D+a,R+n],[O,M]=[D-a,R-n];if(D<2||D>t.length-2||R<2||R>t[0].length-2||void 0===t[D]||void 0===t[D][R])continue;let T=!1;if(2==t[B][G]&&1==t[O][M]&&(T=!0),!T)continue;let L=!1;for(let P=0;P<q.length;P++){let N=q[P];N[0]==D&&N[1]==R&&(L=!0)}if(!L){q.push([D,R]);for(let H=0;H<4;H++){let[I,U]=cardinaldirections[H],[K,Q]=[D+I,R+U];W.push([K,Q])}}}let J=(q=es(q)).length,V=5>Math.max(o,l);V||(J=1),0==q.length&&(q=[[i,s]]);for(let X=0;X<J;X++){let Z=q[X];F.push(Z),V||e.ruins||e.doors.push(Z)}}}}function ee([e,t],[i,s]){let a=[],n=Math.abs(i-e),o=Math.abs(s-t),l=e<i?1:-1,c=t<s?1:-1,h=n-o;for(;a.push([e,t]),e!==i||t!==s;){let d=2*h;d>-o&&(h-=o,e+=l),d<n&&(h+=n,t+=c)}return a}function et(e,t){let[i,s]=e,[a,n]=t;return Math.max(Math.abs(a-i),Math.abs(n-s))}function ei(e,t){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])}function es(e){let t=e.length,i,s=e.slice();for(;t>0;)i=Math.floor(Math.random()*t),t--,[s[t],s[i]]=[s[i],s[t]];return s}function ea([e,t],[i,s]){return Math.sqrt((e-i)**2+(t-s)**2)}}}let o=[];for(let l=0;l<a.length;l++){let[c,h]=a[l],d=perlinNoise(t,e,c);o.push(d)}let u=[],$=[],p=[],f=[];for(let m=0;m<e;m++){p[m]=[],u[m]=[],$[m]=[];for(let _=0;_<t;_++){u[m][_]=0;let g=0;g+=Math.max(_-(t-i),0)/i,g+=Math.max(m-(e-i),0)/i,g+=Math.max(-_+i,0)/i,g+=Math.max(-m+i,0)/i;let b=0;b+=Math.max(_-(t-4*i),0)/(4*i),b+=Math.max(m-(e-4*i),0)/(4*i),b+=Math.max(-_+4*i,0)/(4*i),b+=Math.max(-m+4*i,0)/(4*i),p[m][_]=0;for(let w=0;w<o.length;w++){let[v,k]=a[w];u[m][_]+=o[w][m][_]*k+g+b/16}$[m][_]=null}}let A=0,S=(e-2*i)*(t-2*i)/2.5,[z,C]=[e/2,t/2],[E,j]=[z,C];for(;u[E][j]>.15;){let q=em(cardinaldirections);for(let W=0;W<1;W++)E+=q[W][0],j+=q[W][1]}let F=[[E,j]],D=[],R=!1,B=0;for(;(A<S||!1==R)&&A<9999999;){let G;if(D.length>B)G=D[B],B++;else{let O=1,M=0;for(let T=0;T<F.length;T++){let[L,P]=F[T],N=u[L][P];if(N<.15){G=F.splice(T,1)[0];break}N<O&&(O=N,M=T),T==F.length-1&&(G=F.splice(M,1)[0])}}if(!G)break;let[H,I]=G;function U([i,s]){if(0!=i&&!(i>=e-1)&&0!=s&&!(s>=t-1)&&0==p[i][s]){p[i][s]=1,u[i][s]>.15?(R=!0,p[i][s]=1):R=!1,u[i][s]<.15-.1&&(p[i][s]=4);let a=em(cardinaldirections);for(let n=0;n<4;n++){let[o,l]=a[n],[c,h]=[i+o,s+l];0==p[c][h]&&(u[c][h]<.15?D.push([c,h]):F.push([c,h]))}A++}}U(G)}[$,[tx,ty]]=ep([[E,j]]);let[K,Q]=[tx,ty],[J,[V,X]]=ep([[tx,ty]]),Z=[];!function i(s,a){for(let l=0;l<e;l++){f[l]=[];for(let c=0;c<t;c++)f[l][c]=null}let h=[...s],d=ep(h),u=d[0],$=d[1],m=d[2],_=d[3];for(;h.length<=a;){let g=ef(u,[$],m,_);u=g[0],$=g[1],m=g[2],_=g[3],h.push($)}let b=[];for(let w=0;w<h.length;w++){let[v,k]=h[w];f[v][k]=w,Z[w]=new n(o[1]),Z[w].grid=p,Z[w].tiles=[[v,k]],b.push([v,k])}let A=b.slice(),S=[];for(let z=0;z<A.length;z++){let[C,E]=A[z],j=f[C][E],q=em(cardinaldirections);for(let W=0;W<4;W++){let[F,D]=q[W],[R,B]=[C+F,E+D],G=f[R][B];null===G&&(0!==p[R][B]?(f[R][B]=j,Z[j].tiles.push([R,B]),A.push([R,B])):(f[R][B]=j,Z[j].walltiles.push([R,B]),S.push([R,B]))),0===p[R][B]||null===f[R][B]||f[R][B]===j||(Z[j].edgetiles||(Z[j].edgetiles=[]),Z[j].edgetiles.push([C,E]),Z[j].edges||(Z[j].edges={}),Z[j].edges[G]||(Z[j].edges[G]=[]),Z[j].edges[G].push([C,E]),Z[j].neighbors||(Z[j].neighbors=[]),Z[j].neighbors.includes(G)||(Z[j].neighbors.push(G),Z[j].neighborsnonindex.push(Z[G])),Z[G].neighbors.includes(j)||(Z[G].neighbors.push(j),Z[G].neighborsnonindex.push(Z[j])))}}let O=S.slice();for(let M=0;M<O.length;M++){let[T,L]=O[M],P=f[T][L];for(let N=0;N<4;N++){let[H,I]=cardinaldirections[N],[U,K]=[T+H,L+I];void 0!==f[U]&&void 0!==f[U][K]&&f[U][K]!==P&&null===f[U][K]&&(f[U][K]=P,Z[P].walltiles.push([U,K]),Z[P].walltiles.length<Z[P].tiles.length&&O.push([U,K]))}}for(let Q=0;Q<Z.length;Q++)Z[Q].generategrid()}([[K,Q],[V,X]],s);let Y=function e([t,i],[s,a],n,o){let l=0,c=[];for(;c.length<o;){c=[];let h=[[s,a]],d=[];for(let u=0;u<n.length;u++){d[u]=[];for(let $=0;$<n[0].length;$++)d[u][$]=n[u][$]}for(;h.length>0;){let[p,f]=h.shift();c.push([p,f]);for(let m=0;m<4;m++){let[_,g]=cardinaldirections[m],[b,w]=[p+_,f+g];9999!==d[b][w]&&(d[b][w]<d[p][f]||Math.random()<l)&&h.push([b,w])}d[p][f]=null}l<.4?l+=.1:l+=.01}return c}([K,Q],[V,X],J,A/3),ee,et;for(let ei=0;ei<Y.length;ei++){let[es,ea]=Y[ei];Z[f[es][ea]].onhotpath=!0,ei==Y.length-1&&(Z[f[es][ea]].origin=!0,ee=Z[f[es][ea]]),0==ei&&(Z[f[es][ea]].boss=!0,et=Z[f[es][ea]])}(function e(t,i,s){t.depth=i;for(let a=0;a<t.neighbors.length;a++){let n=Z[t.neighbors[a]];(void 0===n.depth||n.depth>i+1)&&e(n,i+1,t)}})(ee,0),function e(t,i,s){t.hotdepth=0,!0==t.onhotpath&&(t.hotdepth=0);for(let a=0;a<t.neighbors.length;a++){let n=Z[t.neighbors[a]];(void 0===n.hotdepth||n.hotdepth>t.hotdepth+1)&&e(n,t.hotdepth+1,t)}}(ee,0),function e(){let t=!0,i=0;for(;!0==t&&i<100;){t=!1;for(let s=0;s<Z.length;s++){let a=Z[s];a.maxhotdepth<a.hotdepth&&(a.maxhotdepth=a.hotdepth,t=!0);for(let n=0;n<a.neighbors.length;n++){let o=Z[a.neighbors[n]];o.maxhotdepth<a.maxhotdepth&&0!==o.maxhotdepth&&(o.maxhotdepth=a.maxhotdepth,t=!0)}}i++}}();let er=et.depth,en=Math.ceil(er/2);for(let eo=0;eo<Z.length;eo++){let el=Z[eo];el.depth==en&&!0==el.onhotpath?el.halfboss=!0:1==Math.abs(el.depth-en)&&!0==el.onhotpath&&(el.halfbossbuffer=!0),el.depth>er*(3/4)&&!0==el.onhotpath&&(el.bossbuffer=!0)}for(let ec=0;ec<Z.length;ec++){let eh=Z[ec];eh.dungeon=Math.random()>.8,!0===eh.halfboss&&(eh.dungeon=!0),!0===eh.halfbossbuffer&&(eh.dungeon=!0),eh.dungeon&&!eh.halfboss&&!eh.halfbossbuffer&&(Math.random()>.5||eh.depth<er/3)&&(eh.ruins=!0),eh.miniboss=eh.hotdepth>2&&eh.maxhotdepth==eh.hotdepth,eh.dungeon&&Math.random()>.75&&(eh.miniboss=!0),eh.updateneighbors(),eh.restructure(),eh.findspawnpoints()}for(let ed=0;ed<Z.length;ed++)Z[ed].updateneighbors();function eu([e,t],[i,s],a){let[n,o]=[i,s],l=[];for(;0!==a[n][o];){l.push([n,o]);for(let c=0;c<4;c++){let[h,d]=directions[c],[u,$]=[n+h,o+d];if(9999!==a[u][$]&&a[u][$]<a[n][o]){[n,o]=[u,$];break}}}return l}function e$([e,t],[i,s],a){let n=[],o=[[i,s]];for(;o.length>0;){let[l,c]=o.shift();n.push([l,c]);for(let h=0;h<4;h++){let[d,u]=cardinaldirections[h],[$,p]=[l+d,c+u];9999!==a[$][p]&&a[$][p]<a[l][c]&&o.push([$,p])}a[l][c]=null}return n}function ep(i){let s=[];for(let a=0;a<e;a++)s[a]=new Uint16Array(t).fill(9999);return ef(s,i)}function ef(i,s,a,n){dtiles=s.slice(),steps=0;let[o,l]=[0,0],[c,h]=[0,0],d=0,u=0;for(;;){let $=dtiles.length;for(;u<$;){if([c,h]=dtiles[u],!n&&0==p[c][h]||(d=i[c][h],n&&9999==d)){u++;continue}d>steps&&(i[c][h]=steps,n&&(a[n[c][h]+2]=steps),dtiles.push([c,h+1]),dtiles.push([c,h-1]),dtiles.push([c+1,h]),dtiles.push([c-1,h])),u++}if(steps++,dtiles.length==$)break}if(!a){a=[],n=[];let f,m=e,_=t;for(let g=0;g<m;g++){n[g]=[],f=i[g];for(let b=0;b<_;b++)9999!=(d=f[b])&&(n[g][b]=a.length,a.push(g),a.push(b),a.push(i[g][b]))}}performance.now();let w=0,v=0,k=0,A=a.length;for(let S=2;S<A;S+=3)(d=a[S])>w&&(h=a[S-1],c=a[S-2],w=d,v=c,k=h);return performance.now(),[i,[v,k],a,n]}function em(e){let t=e.length,i,s=e.slice();for(;t>0;)i=Math.floor(Math.random()*t),t--,[s[t],s[i]]=[s[i],s[t]];return s}return[p,Z]}function perlinNoise(e,t,i){let s={rand_vect:function(){let e=2*Math.random()*Math.PI;return{x:Math.cos(e),y:Math.sin(e)}},dot_prod_grid:function(e,t,i,s){let a,n={x:e-i,y:t-s};this.gradients[i]||(this.gradients[i]=[]);let o=this.gradients[i][s];return o?a=o:(a=this.rand_vect(),this.gradients[i][s]=a),n.x*a.x+n.y*a.y},smootherstep:function(e){return 6*e**5-15*e**4+10*e**3},smoothstep:function(e){return -2*e**3+3*e**2},interp:function(e,t,i){return t+this.smoothstep(e)*(i-t)},seed:function(){this.gradients={}},get:function(e,t){let i=Math.floor(e),s=Math.floor(t),a=this.dot_prod_grid(e,t,i,s),n=this.dot_prod_grid(e,t,i+1,s),o=this.dot_prod_grid(e,t,i,s+1),l=this.dot_prod_grid(e,t,i+1,s+1),c=this.interp(e-i,a,n),h=this.interp(e-i,o,l);return this.interp(t-s,c,h)}},a=Math.random();s.seed(a);let n=[];for(let o=0;o<t;o++){n[o]=[];for(let l=0;l<e;l++)n[o][l]=s.get((o+a)/i,(l+a)/i)}return n}gameText=document.getElementById("game-text"),canvas=document.getElementById("myCanvas");let vmode=!1;canvas||(vmode=!0);let viewportpos=[0,0],gameover=!1,won=!1,deathcharacter=null,cursorpos=[0,0],keyglossary=!1;const grid=[];let noisemap=Array(mapsizey).fill(null).map(()=>Array(mapsizex).fill(1)),nonpcshere=[],objectshere=[],envobjects=[],playercs=[],nonpcs=[],turncounter=0,activecharacter=0,activecharacternonindex=null,tickcounter=0,ctrl=!1,autodash=!1,autosg=!1,autoadv=!1,bufferedinputs=[],controllock=!1,uilock=!1,uilocktype="",map=[],ngplus=0,traversemap=[],xstep=2,ystep=2,viewfinderpos=[0,0],tutorial=!1,verbose=!0,lightsources=[],messageQueue=[],isProcessing=!1,ctx;const ratio=window.devicePixelRatio;let width=window.innerWidth,height=window.innerHeight,offscreen,offCtx;if(!vmode){function e(e,t){var i=e.getBoundingClientRect();return[t.clientY-i.top,t.clientX-i.left]}ctx=canvas.getContext("2d"),canvas.width=width*ratio,canvas.height=height*ratio,canvas.style.width=width+"px",canvas.style.height=height+"px",offCtx=(offscreen=document.createElement("canvas")).getContext("2d"),canvas.addEventListener("mousemove",function(t){updatedsomething=!0;let i=e(canvas,t);if(!i)return;let s=viewportpos[0]+Math.floor(i[0]/fontsize)-viewportsizey/2,a=viewportpos[1]+Math.floor(i[1]/fontsize)-viewportsizex/2,n=[s,a];!(s>mapsizey-1)&&!(s<0)&&(a>mapsizex-1||a<0||n[0]===cursorpos[0]&&n[1]===cursorpos[1]||(cursorpos[0]=n[0],cursorpos[1]=n[1]))}),canvas.addEventListener("mousedown",e=>{if(keyglossary=!1,!0!=controllock&&0==e.button){if(e.ctrlKey){moveallplayers();return}if(!1==controllock&&!1==uilock&&moveplayer(),!1==controllock&&!0==uilock){let t=activecharacternonindex;if("attack"==uilocktype){let i=new Attack(...actions.Attack,t.getrange(),cursorpos,t,t.pos),s=i.func(!0);canAffordAction(i,t)&&0==s.errors.length&&(t.actionqueue.push(i),playertick(t)),uilock=!1}if("jump"==uilocktype){let a=Math.max(t.stats[0]+.5,2),n=new Jump(a,cursorpos,t,t.pos);t.actionqueue.push(n),canAffordAction(t.actionqueue[0],t)&&playertick(t),uilock=!1}if("kick"==uilocktype){let o=new Kick(cursorpos,t,t.pos);t.actionqueue.push(o),canAffordAction(t.actionqueue[0],t)&&playertick(t),uilock=!1}if("throw"==uilocktype){let l=new Throw(cursorpos,t,t.pos,t.primaryitem);t.actionqueue.push(l),canAffordAction(l,t)&&playertick(t),uilock=!1}}}}),document.addEventListener("keydown",function(e){if(!0==uilock&&"map"==uilocktype&&("<"===e.key&&xstep<4&&(xstep+=.5,ystep+=.5,updatemap()),">"===e.key&&xstep>1&&(xstep-=.5,ystep-=.5,updatemap()),"ArrowLeft"===e.key&&viewfinderpos[1]>4*xstep&&(viewfinderpos[1]-=Math.ceil(4*xstep),updatemap()),"ArrowRight"===e.key&&viewfinderpos[1]<mapsizex-4*xstep&&(viewfinderpos[1]+=Math.ceil(4*xstep),updatemap()),"ArrowUp"===e.key&&viewfinderpos[0]>4*ystep&&(viewfinderpos[0]-=Math.ceil(4*ystep),updatemap()),"ArrowDown"===e.key&&viewfinderpos[0]<mapsizey-4*ystep&&(viewfinderpos[0]+=Math.ceil(4*ystep),updatemap())),e.repeat)return;("r"===e.key&&gameover||won)&&(won&&ngplus++,won=!1,gameover=!1,gridinit(),activecharacter=0,activecharacternonindex=playercs[0],uilock=!1,controllock=!1,generatetraversemap(),updatelighting());let t=activecharacternonindex;if(!0==controllock){!0==activecharacternonindex.pc&&(activecharacternonindex.actionqueue=[],bufferedinputs=[]);return}if("Space"===e.code||" "===e.key){if(e.ctrlKey&&!1==controllock)for(;!1==controllock;)playerendturn();else!1==controllock&&playerendturn()}if("Control"==e.key&&(ctrl=!0),"m"==e.key&&(!1==uilock?(uilock=!0,uilocktype="map",updatedsomething=!0):(uilock=!1,updatedsomething=!0)),"c"==e.key&&(!1==uilock?(uilock=!0,uilocktype="credits",updatedsomething=!0):(uilock=!1,updatedsomething=!0)),"o"==e.key&&(uilock&&(uilock=!1),!1==controllock&&!1==uilock&&t.tc[1]>=1&&(t.actionqueue=[],t.actionqueue.push(new action("Overwatch",startoverwatch,[0,1,0],0,t.pos,t,t.pos)),move(t))),"j"==e.key&&(r=playercs[activecharacter],t.tc[1]>=1&&(!1==uilock?(uilock=!0,updatedsomething=!0):(uilock=!1,updatedsomething=!0)),uilocktype="jump"),"k"==e.key&&(t.tc[1]>=1&&(uilock=!1==uilock,updatedsomething=!0),uilocktype="kick"),"t"==e.key&&(t.tc[1]>=1&&(uilock=!1==uilock,updatedsomething=!0),uilocktype="throw"),"d"===e.key&&!1==controllock&&t.tc[1]>=1&&(t.actionqueue.push(new action("Dash",dashfunc,[0,1,0],0,t.pos,t,t.pos)),playertick(t)),"s"===e.key&&!1==controllock&&t.tc[0]>=t.tcmax[0]&&(t.actionqueue.push(new action("Stand Ground",standgroundfunc,[t.tcmax[0],0,0],0,t.pos,t,t.pos)),playertick(t)),"a"===e.key&&!1==controllock){let i=playercs[activecharacter];i.tc[1]>=1&&(!1==uilock?(uilock=!0,updatedsomething=!0):(uilock=!1,updatedsomething=!0)),uilocktype="attack"}if("D"===e.key&&((autodash=!autodash)?adduilabel("auto-dash enabled",activecharacternonindex.pos,[128,128,128],0,!0):adduilabel("auto-dash disabled",activecharacternonindex.pos,[128,128,128],0,!0)),"S"===e.key&&((autosg=!autosg)?adduilabel("auto-stand-ground enabled",activecharacternonindex.pos,[128,128,128],0,!0):adduilabel("auto-stand-ground disabled",activecharacternonindex.pos,[128,128,128],0,!0)),"V"===e.key&&((verbose=!verbose)?adduilabel("verbose tool-tips enabled",activecharacternonindex.pos,[128,128,128],0,!0):adduilabel("verbose tool-tip disabled",activecharacternonindex.pos,[128,128,128],0,!0)),"A"===e.key&&((autoadv=!autoadv)?adduilabel("auto-advance enabled",activecharacternonindex.pos,[128,128,128],0,!0):adduilabel("auto-advance disabled",activecharacternonindex.pos,[128,128,128],0,!0)),"x"===e.key&&!1===controllock){let s=playercs[activecharacter],a=new action(...actions.SwitchWeapon,0,s.pos,s,s.pos);s.actionqueue.push(a),playertick()}if("X"===e.key&&!1===controllock){let n=playercs[activecharacter],o=[0,0,0];"Unarmed"!==n.primaryitem.name&&(o=[0,1,0]);let l=new action("Switch Weapon",switchweaponalt,o,0,n.pos,n,n.pos);n.actionqueue.push(l),playertick()}if("g"===e.key&&!1===controllock&&!1===uilock){let c=playercs[activecharacter];grid[c.pos[0]][c.pos[1]].objects.length>0&&grid[c.pos[0]][c.pos[1]].objects[0]instanceof Item&&(c.actionqueue.push(new action("Get",getfunc,[0,0,0],0,c.pos,c,c.pos)),playertick())}if("l"===e.key&&!1===controllock&&!1===uilock){let h=playercs[activecharacter];h.actionqueue.push(new action("Leave",leavefunc,[0,0,0],0,h.pos,h,h.pos)),playertick()}if("L"===e.key&&!1===controllock&&!1===uilock){let d=playercs[activecharacter];d.actionqueue.push(new action("Leave",leavefuncoffhand,[0,0,0],0,d.pos,d,d.pos)),playertick()}if("+"===e.key&&brightnessadjust<3&&(brightnessadjust+=.1,console.log(brightnessadjust),updatedsomething=!0),"-"===e.key&&brightnessadjust>1&&(brightnessadjust-=.1,console.log(brightnessadjust),updatedsomething=!0),"?"===e.key?(keyglossary=!keyglossary,updatedsomething=!0):"Shift"!=e.key&&(keyglossary=!1,updatedsomething=!0),!isNaN(e.key)){let u=e.key-1;u>-1&&playercs.length>0&&playercs.length>u&&playercs[u]&&!1==playercs[u].dead&&(uilock=!1,activecharacter=u,activecharacternonindex=playercs[u],updateGrid())}}),document.addEventListener("keyup",function(e){"Control"==e.key&&(ctrl=!1)}),gridinit(),updateGrid()}function gridinit(){for(let e=0;e<mapsizey;e++){grid[e]=[];for(let t=0;t<mapsizex;t++)grid[e][t]=0}envobjects=[];for(let i=0;i<mapsizey;i++)for(let s=0;s<mapsizex;s++)grid[i][s]||(grid[i][s]=new Tile(...tiletypesarr[3],[i,s])),tutorial&&(grid[i][s]=new Tile(...tiletypesarr[2],[i,s]));generate(),updatecharacters();for(let a=0;a<mapsizey;a++)for(let n=0;n<mapsizex;n++);let[o,l]=[mapsizey/2,mapsizex/2];elevupdate(),updateGrid(),updatecharactershere(),updateGrid(),0==ngplus&&adduilabel("Press ? for controls",viewportpos,[256,256,256],0,!0,!1,!1,!0,5),ngplus>0&&adduilabel(`Party number ${ngplus+1}`,viewportpos,[256,256,256],0,!0,!1,!1,!0,5),drawGrid(!0),nonpcs.forEach(function(e){spot(e)}),updatemap()}function updatemap(){traversemap.length||generatetraversemap();let e=[];for(let t=0;t<viewportsizey;t++){map[t]=[];for(let i=0;i<viewportsizex;i++){map[t][i]=[.02,.02,.02];let s=!1,a=[0,0,0],n=[],o=!1,l=!1;for(let c=0;c<ystep;c++)for(let h=0;h<xstep;h++){let[d,u]=[viewfinderpos[0]-ystep*viewportsizey/2,viewfinderpos[1]-xstep*viewportsizex/2],[$,p]=[d+t*ystep+c,u+i*xstep+h];if([$,p]=[Math.floor($),Math.floor(p)],grid[$]&&grid[$][p]){if(!grid[$][p].seen)continue;if(1==traversemap[$][p]&&(l=!0),!0==grid[$][p].traversable&&(!o||l)){if(s=!0,n.push(grid[$][p].absorbtionBase.slice()),symbol=grid[$][p].symbolBase,grid[$][p].character&&!0==grid[$][p].visible){let f=grid[$][p].character,m=!1;for(let _=0;_<e.length;_++)if(e[_]==f){m=!0;break}m||e.push(grid[$][p].character)}}else if(!l){o=!0;let g=grid[$][p].absorbtionBase.slice();for(let b=0;b<3;b++)g[b]=g[b]/4;n=[g]}}}for(let w=0;w<n.length;w++)for(let v=0;v<3;v++)a[v]+=n[w][v]/(2*n.length);a[0]*=.9,a[1]*=.7,a[2]*=.5,s&&(map[t][i]=a.slice()),o&&(map[t][i]=a.slice())}}for(let k=0;k<e.length;k++){let A=e[k],[S,z]=[A.pos[0]-viewfinderpos[0],A.pos[1]-viewfinderpos[1]];S=Math.floor(S/ystep)+viewportsizey/2,z=Math.floor(z/xstep)+viewportsizex/2;let C=A.color.slice();C.push(A.symbol),map[S][z][3]=C}let[E,j]=viewfinderpos,[q,W]=[viewportsizey/2,viewportsizex/2]}function generatetraversemap(){for(let e=0;e<mapsizey;e++){traversemap[e]=[];for(let t=0;t<mapsizex;t++)traversemap[e][t]=0}let[i,s]=playercs[0].pos;for(let a=0;a<mapsizey;a++)for(let n=0;n<mapsizex;n++)!0==grid[a][n].traversable&&(traversemap[a][n]=1),!0==grid[a][n].slope&&(traversemap[a][n]=1),grid[a][n].objects.length>0&&(traversemap[a][n]=1);let o=0;for(;;){o++;let l=!1,c=[];for(let h=0;h<mapsizey;h++)for(let d=0;d<mapsizex;d++)if(1==traversemap[h][d])for(let u=0;u<4;u++){let[$,p]=directions[u],[f,m]=[h+$,d+p];void 0!==traversemap[f]&&void 0!==traversemap[f][m]&&0==traversemap[f][m]&&c.push([h,d])}for(let _=0;_<c.length;_++){let[g,b]=c[_],w=[];for(let v=0;v<8;v++){let[k,A]=directions[v],[S,z]=[g+k,b+A];void 0!==traversemap[S]&&void 0!==traversemap[S][z]&&0!==traversemap[S][z]&&w.push([z,S])}if(w.length>1){let[C,E]=w.shift(),j=[[C,E]];for(;j.length>0&&w.length>0;){let[q,W]=j.shift();for(let F=0;F<4;F++){let[D,R]=directions[F],[B,G]=[q+D,W+R];for(let O=0;O<w.length;O++){let[M,T]=w[O];if(B==M&&G==T){w.splice(O,1),j.push([B,G]);break}}}}w.length>0||(traversemap[g][b]=0,l=!0)}else 0==w.length&&(traversemap[g][b]=0,l=!0)}if(!l)break}}function elevupdate(){for(let e=0;e<mapsizey;e++)for(let t=0;t<mapsizex;t++){if(!grid[e][t].traversable)continue;let i=[e,t],s=[],a=[],n=[],o=[];if(cardinaldirections.forEach(function(n){let[o,l]=n.map((e,t)=>e+i[t]);grid[o]&&grid[o][l]&&grid[o][l].traversable&&grid[e][t].elevation-grid[o][l].elevation<=-2&&(s.push(o),a.push(l))}),directions.forEach(function(s){let[a,l]=s.map((e,t)=>e+i[t]);grid[a]&&grid[a][l]&&grid[a][l].traversable&&grid[e][t].elevation-grid[a][l].elevation<=-2&&(n.push(a),o.push(l))}),s.length>0){if(!0==grid[e][t].ramp)break;let l=[takeav(n),takeav(o)];grid[e][t].traversable=!1,grid[e][t].slope=!0,grid[e][t].symbolBase=linecharacter([e,t],l);let c=Math.ceil(Math.abs(l[0]-e))*Math.sign(l[0]-e),h=Math.ceil(Math.abs(l[1]-t))*Math.sign(l[1]-t);grid[e][t].delta=[c,h]}}for(let d=0;d<mapsizey;d++)for(let u=0;u<mapsizex;u++){let $=grid[d][u],p=$.elevation,f=[],m=[];if(cardinaldirections.forEach(function(e){let[t,i]=e.map((e,t)=>e+[d,u][t]);grid[t]&&grid[t][i]&&(grid[t][i].elevation==p-1&&f.push([t,i]),grid[t][i].elevation==p+1&&m.push([t,i]))}),m.length>0&&f.length>0){let _=!1;if(grid[d][u].traversable){grid[d][u].ramp=!0,m.forEach(function([e,t]){f.forEach(function([i,s]){let a=e-i,n=t-s;2==a&&0==n&&(grid[d][u].traversable=!0,grid[d][u].symbolBase="&#25B2",_=!0),-2==a&&0==n&&(grid[d][u].traversable=!0,grid[d][u].symbolBase="&#25BC",_=!0),2==n&&0==a&&(grid[d][u].traversable=!0,grid[d][u].symbolBase="&#25C0",_=!0),-2==n&&0==a&&(grid[d][u].traversable=!0,grid[d][u].symbolBase="&#25B6",_=!0)})});let[g,b]=[0,0];for(let w=0;w<f.length;w++){let[v,k]=f[w],[A,S]=[v-d,k-u];g+=A/f.length,b+=S/f.length}let z=Math.ceil(Math.abs(g))*Math.sign(g),C=Math.ceil(Math.abs(b))*Math.sign(b);grid[d][u].delta=[z,C],!1==_&&(grid[d][u].traversable=!0,grid[d][u].symbolBase="*")}}}}function alinedraw(e,t,i){if(!playercs[activecharacter]||!e||0==e.length)return;let s=translateAStoAQ(e,i),a=i.tc.slice(),n=i.pos,o=0;for(let l=0;l<s.length;l++){let[c,h]=s[l].target;for(l>0&&(n=s[l-1].target);a[0]-s[l].cost[0]<0&&a[1]>0&&!0==autodash;)a[0]+=i.tcmax[0],a[1]-=1,o++;if(!(a[0]>=s[l].cost[0])||!(a[1]>=s[l].cost[1]))return a;{if("Move"==s[l].name){let d=[.25*(cost=s[l].cost[0])**2,.25,.25];o>0&&(d[0]=d[0],d[1]=d[1],d[2]=d[2]/2),adduilabel("$",[c,h],d,0,!1,!1,!1,!0)}if("Attack"==s[l].name){let u=bresenhamLine(n,s[l].target),$=linecharacter(n,s[l].target);for(let p=1;p<u.length;p++){let[f,m]=u[p];adduilabel($,[f,m],[1,1,1],0,!1)}}let _=32*Math.sin(now/100)+96;0!==s[l].warnings.length&&adduilabel(s[l].warnings[0],s[l].pos,[_,0,0],1,!1,!1),a=a.map((e,t)=>e-s[l].cost[t])}if(l==s.length-1)return a}}function addanimation(e,t,i,s=.5,a=!0,n=!1,o=0){let l=e.length;for(let c=0;c<l;c++){let[h,d]=e[c];if(!grid[h]||!grid[h][d])continue;let u=t[c%t.length];(!0==grid[h][d].visible||!0==n)&&grid[h][d].uiElements.push(new uielement(u,i,e[c],a,n,[now+o+1e3*s,now+o]))}updatedsomething=!0}function noiseupdate(){if(procgendebug)return;let e=viewportpos[1]-Math.floor(viewportsizex/2),t=viewportpos[0]-Math.floor(viewportsizey/2),i=viewportpos[1]+Math.floor(viewportsizex/2),s=viewportpos[0]+Math.floor(viewportsizey/2);t<0&&(t=0,s=viewportsizey),s>mapsizey&&(s=mapsizey,t=mapsizey-viewportsizey),e<0&&(e=0,i=viewportsizex),i>mapsizex&&(i=mapsizex,e=mapsizex-viewportsizex);let a=!1;for(let n=t;n<s;n++)for(let o=e;o<i;o++)if(!1!==grid[n][o].visible){let l=takeav(grid[n][o].light)/256,c=grid[n][o].readLightsource();if(Math.random()>.5+l**.05*.5){let h=.9+.2*Math.random();noisemap[n][o]=h}for(let d=0;d<c.length;d++){let u=c[d];if(u&&(Math.random()>.8||1==u.radiance&&Math.random()>.5)){a=!0;let $=.9+.2*Math.random();noisemap[n][o]=$}}}a?updatedlighting=!0:updatedsomething=!0,updateambientsound()}function updateGrid(e=!1){if(gameover)return;let t=function e(){let t=[],i=[],s=[];for(let a=0;a<playercs.length;a++)if(!1==playercs[a].dead){i.push(playercs[a].pos[0]),s.push(playercs[a].pos[1]);break}if(0!=i.length)return[Math.round(takeav(i)),Math.round(takeav(s))]}();if(t&&(dist(t,viewportpos)>2||e)){let i=viewportpos[0],s=viewportpos[1];viewportpos[0]=t[0],viewportpos[1]=t[1],updatedsomething=!0,viewportpos[0]-viewportsizey/2<0&&(viewportpos[0]=viewportsizey/2),viewportpos[1]-viewportsizex/2<0&&(viewportpos[1]=viewportsizex/2),viewportpos[0]+viewportsizey/2>=mapsizey&&(viewportpos[0]=mapsizey-viewportsizey/2-1),viewportpos[1]+viewportsizex/2>=mapsizex&&(viewportpos[1]=mapsizex-viewportsizex/2-1);let a=i-viewportpos[0],n=s-viewportpos[1];cursorpos[0]-=a,cursorpos[1]-=n}viewfinderpos=viewportpos.slice(),updatemap()}function updateconditions(e){for(let t=e.conditions.length-1;t>=0;t--)e.conditions[t].duration--,e.conditions[t].duration<=-1?(null!=e.conditions[t].endeffect&&e.conditions[t].endeffect(),e.conditions.splice(t,1)):e.conditions[t].turneffect()}function updatetraitspassive(){for(let e=0;e<nonpcshere.length;e++){let t=nonpcshere[e];if(!0!==t.dead)for(let i=0;i<t.traits.length;i++){let s=t.traits[i];!0==s.passive&&!0==s.trigger()&&s.effect()}}for(let a=0;a<playercs.length;a++){let n=playercs[a];if(!0!=n.dead)for(let o=0;o<n.traits.length;o++){let l=n.traits[o];!0==l.passive&&!0==l.trigger()&&l.effect()}}for(let c=0;c<objectshere.length;c++){let h=objectshere[c];for(let d=0;d<h.effects.length;d++){let u=h.effects[d];u(h)}}}function updatetraitsactive(e){for(let t=0;t<e.traits.length;t++){let i=e.traits[t];!0==i.active&&!0==i.trigger()&&i.effect()}}function startplayerturn(){if(won)controllock=!0;else if(gameover){enemyturn();return}let e,t=!1;for(let i=0;i<playercs.length;i++)!1==(e=playercs[i]).dead&&(t=!0),e.tc=e.tcmax.slice(),updateconditions(e);t?playerturn():(controllock=!0,gameover=!0)}function playerturn(){0==activecharacter&&turncounter++,!0==(pc=playercs[activecharacter]).dead&&playerendturn(),controllock=!1,activecharacternonindex=playercs[activecharacter]}function playertick(){if(gameover)return;controllock=!0;let e=playercs[activecharacter];if(e.hp<=0&&(e.dead=!0),!0==e.dead){playerendturn();return}if(e.actionqueue.length>0){let t=1;canAffordAction(e.actionqueue[0],e)?(e.actionqueue[1]&&e.actionqueue[1].cost[1]>0&&"Dash"!==e.actionqueue[1].name&&(t=2.5),e.actionqueue[0].cost[1]>0&&"Dash"!==e.actionqueue[0].name&&(t=2.5),move(e),updatetraitspassive()):e.actionqueue=[],setTimeout(playertick,ticktimer*t),updateGrid();return}playercs[activecharacter].actionqueue=[],0==playercs[activecharacter].actionqueue.length&&(0==playercs[activecharacter].tc[0]&&0==playercs[activecharacter].tc[1]&&0==bufferedinputs.length&&autoadv?playerendturn():releasecontrollock())}function releasecontrollock(){controllock=!1,triggerbufferedinput()}function playerendturn(){if(updatetraitspassive(),updatecharactershere(),uilock=!1,!1==gameover&&++activecharacter<playercs.length){if(!0==playercs[activecharacter].dead){playerendturn();return}playerturn();return}activecharacter=0,controllock=!0,updateEnvironment(),setTimeout(enemyturn,ticktimer)}function restcheck(){let e=0;playercs.forEach(function(t){(!0!==lackscondition(conditions.Resting,t)||!0==t.dead||!0!==lackscondition(conditions.Overwatch,t))&&e++}),e==playercs.length&&playercs.forEach(function(e){!e.dead&&e.hp<e.maxhp&&(e.heal(e.maxhp-e.hp),directions.forEach(function(t){let[i,s]=t.map((t,i)=>t+e.pos[i]);if(grid[i][s].objects.length>0){let a=grid[i][s].objects[0];a instanceof bonfire&&a.extinguish()}}))})}function updateEnvironment(){let e=envobjects.slice();for(envobjects=[];e.length>0;){let t=e.shift();t.update()}}function enemyturn(){if(0==activecharacter&&(enemyturnstart=performance.now()),activecharacter>=nonpcshere.length){activecharacter=0,startplayerturn();return}let e=nonpcshere[activecharacter];if(activecharacternonindex=e,activecharacter++,manhattanDistance(e.pos,viewportpos)<dontcaredistance&&!1==e.dead){e.tc=e.tcmax.slice(),tickcounter=0,updateconditions(e),e.update(),updatetraitsactive(e),function e(t){let i=1;if(++tickcounter>20){t.actionqueue=[],enemyturn();return}if(t.hp<=0&&(t.dead=!0),!0==t.dead){enemyturn();return}if(t.tc[0]>0||t.tc[1]>0){if(t.actionqueue.length>0){if(canAffordAction(t.actionqueue[0],t)){t.actionqueue[1]&&"End Turn"==t.actionqueue[1].name&&!0==gameover&&(i=Math.round(50*Math.random())),t.actionqueue[0].cost[1]>0&&"Dash"!=t.actionqueue[0].name&&(i=5),(!t.actionqueue[1]||t.actionqueue[1].cost[1]>0&&"Dash"!=t.actionqueue[1].name)&&(i=5);let[s,a]=t.actionqueue[0].target;!0!==grid[t.pos[0]][t.pos[1]].visible&&!0!==grid[s][a].visible&&(i=0),move(t)}else{t.actionqueue=[],enemyturn();return}}else{let n=planturn(t);if(n.length>0){if(t.actionqueue=n.slice(),t.actionqueue.push(new endTurn("End Turn",endturnfunc,[0,0,0],0,t.pos,t,t.pos)),t.actionqueue.length<2){enemyturn();return}}else{t.actionqueue=[],enemyturn();return}}}t.tc[0]>0||t.tc[1]>0?(!0!==grid[t.pos[0]][t.pos[1]].visible&&(i=0),t.actionqueue[0]&&t.actionqueue[0].loudness&&t.actionqueue[0].loudness>=chebyshevDistance(viewportpos,t.pos)&&(i=Math.max(1,i)),setTimeout(function(){e(t),updateGrid()},ticktimer*i)):(t.actionqueue=[],enemyturn())}(e);return}enemyturn()}function pathfind([e,t],[i,s],a=50,n=0){let o=[],l=[];for(let c=i-a;c<=i+a;c++)if(!(c<0)&&!(c>=mapsizey)){o[c]=[],l[c]=[];for(let h=s-a;h<=s+a;h++)h<0||h>=mapsizex||(o[c][h]=2*a,l[c][h]=null,!1!=grid[c][h].traversable&&(null===grid[c][h].character||c===e&&h===t||c===i&&h===s)&&!0===grid[c][h].seen||(o[c][h]=9999))}if(!1==grid[i][s].traversable&&0==grid[i][s].objects.length)return;let d=[[i,s,0]],u=!1;for(let $=0;$<d.length;$++)if([y,x,cost]=d[$],!(void 0===o[y]||void 0===o[y][x]||o[y][x]<=cost)){if(o[y][x]=cost,y==e&&x==t){u=!0;break}for(let p=0;p<8;p++){let[f,m]=directions[p],[_,g]=[y+f,x+m];if(void 0===grid[_]||void 0===grid[_][g])continue;let b=grid[_][g].moveCost;if(!(grid[_][g].gethazards()[0]>0))!(Math.abs(grid[_][g].elevation-grid[y][x].elevation)>1)&&9999!==o[_][g]&&cost+b<o[_][g]&&d.push([_,g,cost+b])}}if(9999==o[i][s]||9999==o[e][t]||!u)return;let w=[[e,t]],v=[];for(let k=0;k<w.length;k++){let[A,S]=w[k];if(void 0==o[A]||void 0==o[A][S])continue;let z=o[A][S];v.push([A,S,z]);let C=9999,E=[];for(let j=0;j<8;j++){let[q,W]=directions[j],[F,D]=[A+q,S+W];if(void 0==o[F]||void 0==o[F][D])continue;let R=Math.abs(grid[F][D].elevation-grid[A][S].elevation);!(R>1)&&(o[F][D]<C?((E=[]).push([F,D]),C=o[F][D]):o[F][D]==C&&E.push([F,D]),C>z&&(E=[]))}for(let B=0;B<E.length;B++)w.push(E[B]);o[A][S]=null}let G=[];w=v.slice(),l[e][t]=0;for(let O=0;O<v.length;O++){let[M,T]=w[O];for(let L=0;L<v.length;L++){let[P,N]=v[L];if(!0==I([M,T],[P,N])){let H=eudist([M,T],[P,N])+l[M][T];(null==l[P][N]||l[P][N]>H)&&(l[P][N]=H)}}}function I([e,t],[i,s]){let a=bresenhamLine([e,t],[i,s]);for(let n=0;n<a.length;n++){let[l,c]=a[n];if(null!==o[l][c])return!1;if(n>0){let[h,d]=a[n-1];if(Math.abs(grid[l][c].elevation-grid[h][d].elevation)>1)return!1}if(n<a.length-1){let[u,$]=a[n+1];if(Math.abs(grid[l][c].elevation-grid[u][$].elevation)>1)return!1}}return!0}G.push([i,s]);for(let U=0;U<G.length;U++){let[K,Q]=G[U],J,V;for(let X=0;X<v.length;X++){let[Z,Y]=v[X];if(!1==I([Z,Y],[K,Q]))continue;let ee=eudist([K,Q],[Z,Y])+l[Z][Y];(void 0===J||ee<J)&&(J=ee,V=[Z,Y])}if(G.push(V),0==J||V[0]==e&&V[1]==t)break}let et=[];for(let ei=0;ei<G.length-1;ei++){let es=bresenhamLine(G[ei+1],G[ei]);ei>0&&es.pop(),es=es.reverse(),et=et.concat(es)}et.pop(),et=et.reverse();for(let ea=0;ea<et.length;ea++){let[er,en]=et[ea];et[ea]=[er-e,en-t]}return et}function translateAStoAQ(e,t,i=!1){let s=[],a=[];if(e)for(let n=0;n<e.length;n++)a.push(e[n].map((e,i)=>e+t.pos[i])),0==n?s.push(e[n]):s.push(e[n].map((t,i)=>t-e[n-1][i]));let[o,l]=t.pos;a.length>0&&([o,l]=a[a.length-1]);let c=grid[o][l].character,h=grid[cursorpos[0]][cursorpos[1]].objects[0],d=!1,u=!1;null!==c&&c.pc!==t.pc&&!1==i&&(d=!0),h&&!1==d&&null!==h.action&&(u=!0);let $=[];if(d&&(t.primaryitem.consumable||t.primaryitem.ammotype&&!t.ammunition[t.primaryitem.ammotype]))return $;let p=t.pos,f;u&&dist(p,h.pos)<h.action[3]&&$.push(new action(...h.action,h.pos,t,p));for(let m=0;m<s.length;m++){m>0&&(p=a[m-1]),f=a[m];let _,g;if(d&&(g=(_=new Attack("Attack",attackfunc,[0,1,0],t.getrange(),c.pos,t,p)).func(!0)),d&&0==g.errors.length&&!_.internalwarning){$.push(_);break}if(u&&dist(p,h.pos)<h.action[3]){$.push(new action(...h.action,h.pos,t,p));break}{let b=[grid[a[m][0]][a[m][1]].moveCost,0,0];t.specialmove?$.push(new t.specialmove("Move",movefunc,b,1,a[m],t,p)):$.push(new Move("Move",movefunc,b,1,a[m],t,p))}}return $}function moveplayer(e=!1,t=[0,0]){let[i,s]=cursorpos;e&&([i,s]=t);let a=grid[i][s];if(a.character&&!0==a.character.pc&&!e){activecharacternonindex=a.character;for(let n=0;n<playercs.length;n++)playercs[n].index==activecharacternonindex.index&&(activecharacter=n);return!1}if(!1==a.seen)return!1;let o=pathfind(playercs[activecharacter].pos,[i,s],50);if(!o)return!1;playercs[activecharacter].actionqueue=translateAStoAQ(o,playercs[activecharacter]).slice();let l=0;for(let c=0;c<playercs[activecharacter].actionqueue.length;c++)l+=playercs[activecharacter].actionqueue[c].cost[0];let h=0;for(let d=0;d<playercs[activecharacter].actionqueue.length;d++)h+=playercs[activecharacter].actionqueue[d].cost[1];if(!0==autodash){let u=playercs[activecharacter].tc[1];for(;l>playercs[activecharacter].tc[0]&&u>0;)playercs[activecharacter].actionqueue.unshift(new action("Dash",dashfunc,[0,1,0],0,playercs[activecharacter].pos,playercs[activecharacter])),u--}if(!0==autosg&&h>playercs[activecharacter].tc[1]&&l<=playercs[activecharacter].tc[0]-playercs[activecharacter].tcmax[0]&&playercs[activecharacter].tc[0]>=playercs[activecharacter].tcmax[0]&&playercs[activecharacter].actionqueue.unshift(new action("Stand Ground",standgroundfunc,[playercs[activecharacter].tcmax[0],0,0],0,playercs[activecharacter].pos,playercs[activecharacter])),playercs[activecharacter].actionqueue.length>0)return playertick(),!0}function moveallplayers(){for(let e=0;e<playercs.length;e++){let t=playercs[e],i=cursorpos.slice();!1==t.dead&&bufferedinputs.push(function(){activecharacter=e,activecharacternonindex=playercs[e];moveplayer(!0,i)||(bufferedinputs=[])})}triggerbufferedinput()}function triggerbufferedinput(){let e=bufferedinputs.shift();e&&e()}function move(e){if(!0==e.dead)return;let[t,i]=e.pos,s=e.actionqueue.shift(),[a,n]=s.target;if(!s)return;let o=e.tc.slice();if(!(e.tc[2]<s.cost[2])){if(e.tc[2]-=s.cost[2],s instanceof Attack&&s.func(!0).errors.length>0&&(s.reactable=!1),s.reactable&&c(grid[t][i],e,s,!0),!(e.tc[0]<s.cost[0])&&!(e.tc[1]<s.cost[1])&&(!e.tc[3]||!s.cost[3]||!(e.tc[3]<s.cost[3]))){if(e.tc[0]-=s.cost[0],e.tc[1]-=s.cost[1],s.cost[3]&&(e.tc[3]-=s.cost[3]),!0==e.dead);else if(!1!==s.func()){if(s.reactable&&c(grid[a][n],e,s,!1),s.loudness){let l=new Sound(s.target,s.loudness,e,s.name);s.soundcontent&&(l.content=s.soundcontent),s.soundeffect&&(l.soundeffect=s.soundeffect),hear(l)}}else e.tc=o.slice();updatedsomething=!0,updatedlighting=!0}}function c(e,t,i,s=!1){let[a,n,o,l]=getlightingsize();updatelighting(a,n,o,l,!0);let c=[],h=[],d=[e,grid[i.target[0]][i.target[1]]],u=d.length;for(let $=0;$<u;$++){let p=d[$];for(let f=0;f<p.charactersinview.length;f++){let m=p.charactersinview[f];if(!0==m.pc||!0==m.dead);else{let _=!1;for(let g=0;g<c.length;g++)if(c[g]==m){_=!0;break}_||c.push(m)}}if(!0==p.visible){let b=playercs.length;for(let w=0;w<b;w++){if(!0==playercs[w].dead)continue;let v=playercs[w],k=!1;for(let A=0;A<c.length;A++)if(c[A]==v){k=!0;break}k||c.push(v)}}if(p.objecttriggers)for(let S=0;S<p.objecttriggers.length;S++){let z=p.objecttriggers[S],C=!1;for(let E=0;E<h.length;E++)if(h[E]==z){C=!0;break}C||h.push(z)}}for(let j=0;j<c.length;j++){let q=c[j];for(let W=0;W<q.reactions.length;W++)(0,q.reactions[W])(q,t,i,s)}for(let F=0;F<h.length;F++)h[F].react(null,t,i,s);for(let D=0;D<t.reactions.length;D++)(0,t.reactions[D])(t,null,null,s)}}function adduilabel(e,t,i,s,a=!1,n=!1,o=!1,l,c=1,h=0,d){let[u,$]=t,p=[];if(!grid[u]||!grid[u][$])return p;let f=!0;if(!0===grid[u][$].visible||l){let m=Math.ceil(e.length/2-1);o&&(m=0),!0==n&&(m=0);let _=!0;e.length&&0!=e.length&&" "!=e[0]&&"$"!=e[0]&&"^"!=e[0]||(f=!1),(!0!==a||!1==l)&&(f=!1);let g=0;for(;!0==_&&g<10;){for(let b=0;b<e.length;b++){let[w,v]=[u-s,$-m+b];if(!grid[w]||!grid[w][v])break;for(let k=0;k<grid[w][v].uiElements.length;k++){let A=grid[w][v].uiElements[k];if(f&&A.canbeblocked){let S=Math.sign(w-viewportpos[0]);0==S&&(S=1),_=!0,s+=1}}if(!0!==a||!0==l){if(w>viewportpos[0]+viewportsizey/2){_=!0,s++;break}if(v>viewportpos[1]+viewportsizex/2-1){_=!0,m++;break}if(w<viewportpos[0]-viewportsizey/2){_=!0,s--;break}if(v<viewportpos[1]-viewportsizex/2){_=!0,m--;break}}}g++}if(!1==a){let z;for(let C=0;C<e.length;C++){let[E,j]=[u-s,$-m+C];grid[E]&&grid[E][j]&&!(viewportpos[0]+viewportsizey/2-1<E)&&!(viewportpos[1]+viewportsizex/2-1<j)&&!(viewportpos[0]-viewportsizey/2>E)&&(viewportpos[1]-viewportsizex/2>j||(z=new uielement(e.charAt(C),i,[E,j],!1,!1,null,d),p.push(z),grid[E][j].uiElements.push(z)))}}else if(!0==a){line=[],updatedsomething=!0;for(let q=0;q<e.length;q++)line.push([u-s,$-m+q]);let W=line.length,F;for(let D=0;D<W;D++){let[R,B]=line[D];if(!grid[R]||!grid[R][B])continue;let G=e[D%e.length],O=now+h,M=now+h+1e3*c;F=new uielement(G,i,line[D],a,l,[M,O]),grid[R][B].uiElements.push(F),h>0&&(F.unrendered=!0),p.push(F)}}}return p.length>0&&p.forEach(e=>e.canbeblocked=f),p}function drawGrid(e=!1){if(now=performance.now(),requestAnimationFrame(function(){drawGrid(!0),!(renderqueue.length>0)&&now-noiseupdateticker>100&&(noiseupdate(),noiseupdateticker=performance.now())}),now-lastCall<throttleRate)return;Math.floor(now/1e3)>lastframe&&(frameticker=0,lastframe=now/1e3),lastCall=now;let t=!1;e&&updatedlighting&&(updatelightmap(),updatedlighting=!1,t=!0);let i=viewportpos[1]-viewportsizex/2,s=viewportpos[0]-viewportsizey/2,a=viewportpos[1]+viewportsizex/2,n=viewportpos[0]+viewportsizey/2;for(let o=s;o<n;o++)if(!(o<0)&&!(o>=mapsizey))for(let l=i;l<a;l++)!(l<0)&&!(l>=mapsizex)&&grid[o][l].updateui();if(!1==updatedsomething&&!1==t)return;if(keyglossary){let c,h,d;for(d=0;d<keybindings.length;d++)c=keybindings[d],keytooltips[d]&&verbose&&(h=keytooltips[d]),adduilabel(c,[viewportpos[0],viewportpos[1]-viewportsizex/2],[128,128,128],-(viewportsizey/2)+d+2,!1,!1,!0,!0,void 0,void 0,h);ngplus>0&&adduilabel(`party number ${ngplus+1}`,[viewportpos[0],viewportpos[1]-viewportsizex/2],[128,128,128],-(viewportsizey/2)+d+2,!1,!1,!0,!0,void 0,void 0,h)}width=window.innerWidth,height=window.innerHeight,offscreen.width=window.innerWidth*ratio,offscreen.height=window.innerHeight*ratio,offscreen.style.width=width+"px",offscreen.style.height=height+"px",offscreen.getContext("2d").scale(ratio,ratio);let u;if(!1==controllock){let $=activecharacternonindex;if(adduilabel("$",$.pos,[0,.25,0],0,!1,!1,!1,!0),grid[cursorpos[0]]&&grid[cursorpos[0]][cursorpos[1]]&&!0==grid[cursorpos[0]][cursorpos[1]].seen&&!1==uilock){for(let p=0;p<playercs.length;p++)!0!=playercs[p].dead&&ctrl&&p!==activecharacter&&alinedraw(pathfind(playercs[p].pos,cursorpos),playercs[p].tc,playercs[p]);u=alinedraw(pathfind(playercs[activecharacter].pos,cursorpos),playercs[activecharacter].tc,playercs[activecharacter])}}if(!0==uilock){if("attack"==uilocktype||"kick"==uilocktype||"throw"==uilocktype){let f=!1,m=activecharacternonindex;m.tc[1]<1&&(uilock=!1);let _=20,g=20,b=m.getminrange();for(let w=m.pos[0]-g;w<=m.pos[0]+g;w++)for(let v=m.pos[1]-g;v<=m.pos[1]+g;v++){if(void 0===grid[w]||void 0===grid[w][v])continue;let k=new Attack(...actions.Attack,m.getrange(),[w,v],m,m.pos);"kick"==uilocktype&&(k=new Kick([w,v],m,m.pos)),"throw"==uilocktype&&(k=new Throw([w,v],m,m.pos,m.primaryitem)),!(k.func(!0).errors.length>0)&&dist(m.pos,[w,v],!1,!0)<=_&&adduilabel("$",[w,v],[.2,.2,.1],0,!1,!1,!1,!0)}let A=new Attack(...actions.Attack,m.getrange(),cursorpos,m,m.pos);"kick"==uilocktype&&(A=new Kick(cursorpos,m,m.pos)),"throw"==uilocktype&&(A=new Throw(cursorpos,m,m.pos,m.primaryitem));if(A.func(!0).errors.length,A.warnings.length>0){let S=A.warnings[0],z=[64,64,64];if("!"==S){let C=32*Math.sin(now/100)+96;z=[C,0,0]}adduilabel(S,m.pos,z,1,!1,!1,!1,!0)}_=A.range,g=Math.ceil(A.range);let E=A.func(!0);if(E.errors&&0==E.errors.length){let j=bresenhamLine(m.pos,cursorpos),q=linecharacter([j[0][0],j[0][1]],[j[j.length-1][0],j[j.length-1][1]]);if(dist(m.pos,cursorpos,!0)<=_&&dist(m.pos,cursorpos,!0)>b){j.shift();for(let W=0;W<j.length;W++){let[F,D]=j[W],R=[0,0,0];grid[F][D].readOpacity(void 0,m.pos)>0&&(R=[128,0,0]),!0==grid[F][D].visible&&adduilabel(q,[F,D],R,0)}}}if(grid[cursorpos[0]][cursorpos[1]].character&&grid[cursorpos[0]][cursorpos[1]].character.pc!==activecharacternonindex.pc){if((hypoattack=A.func(!0)).errors.length>0)for(let B=0;B<hypoattack.errors.length;B++);else{f=!0;let G=hypoattack.damagerange[0].toString()+"-"+hypoattack.damagerange[1].toString(),O=Math.round(hypoattack.percenthitchance).toString()+"%";adduilabel(O,cursorpos,[(1-hypoattack.percenthitchance/100)*128,hypoattack.percenthitchance/100*128,0],2,!1,!1),adduilabel(G,cursorpos,[128,0,0],1,!1,!1),ek(m.tc.map((e,t)=>e-A.cost[t]));for(let M=0;M<hypoattack.modbreakdown.length;M++){let T=hypoattack.modbreakdown[M];adduilabel(T,cursorpos,[128,128,128],M+3,!1)}}}!1==f&&ek()}if("jump"==uilocktype){let L=activecharacternonindex;L.tc[1]<1&&(uilock=!1);let P=new Jump(Math.max(L.stats[0]+.5,2),cursorpos,L,L.pos),N=P.range,H=Math.ceil(P.range);for(let I=0;I<P.warnings.length;I++){let U=32*Math.sin(now)+96;adduilabel(P.warnings[I],P.target,[U,0,0],I+1,!1,!1)}for(let K=L.pos[0]-H;K<=L.pos[0]+H;K++)for(let Q=L.pos[1]-H;Q<=L.pos[1]+H;Q++){let J=dist(L.pos,[K,Q],!1,!0);J<=Math.min(N,H)&&adduilabel("$",[K,Q],[.2,.2,.1],0,!1,!1,!1,!0)}}if("map"==uilocktype)for(let V=0;V<viewportsizex*viewportsizey;V++){let[X,Z]=[s+V%viewportsizey,i+Math.floor(V/viewportsizey)],[Y,ee]=[X-s,Z-i],et=[0,0,0],ei=[0,0,0],es=!1;map[Y][ee]&&(et=map[Y][ee],map[Y][ee][3]&&(ei=map[Y][ee][3],es=!0)),adduilabel("_",[X,Z],et,0,!1,!1,!1,!0),es&&adduilabel(ei[3],[X,Z],ei,0,!1,!1,!1,!0)}if("credits"==uilocktype){for(let ea=0;ea<viewportsizex*viewportsizey;ea++){let[er,en]=[s+ea%viewportsizey,i+Math.floor(ea/viewportsizey)];adduilabel("_",[er,en],[0,0,0],0,!1,!1,!1,!0)}let eo=["Torchlight's Shadow","","","a game by Jake Stellman",'Font - "Press Start 2p" Open Font License 2012',"","All other content, programming, audio,","visuals, and design by Jake Stellman","","For questions or feedback, contact:","jake.stellman@gmail.com",];for(let el=0;el<eo.length;el++)adduilabel(eo[el],viewportpos,[64,64,64],5-el,!1,!1,!1,!0)}}else activecharacternonindex&&ek(u);!0==activecharacternonindex.pc&&!1==controllock&&!1==uilock&&grid[cursorpos[0]][cursorpos[1]].cursorread(),adduilabel("x",cursorpos,[128,128,128],0,!1,!1,!1,!0),offCtx.clearRect(0,0,offscreen.width,offscreen.height),offCtx.font=`${fontsize}px 'Press Start 2P'`;let ec="",eh,ed,eu,e$=[];for(let ep=s;ep<n;ep++)for(let ef=i;ef<a;ef++){eh=(ed=grid[ep][ef]).read(!0),e$.push(eh);let em=(ef-i)*fontsize,e_=(ep-s)*fontsize;eu&&eu[0]===eh[1][0]&&eu[1]===eh[1][1]&&eu[2]===eh[1][2]||(offCtx.fillStyle=`rgb(${eh[1]})`),offCtx.fillRect(em,e_,fontsize,fontsize),eu=eh[1]}let eg=0;for(let eb=s;eb<n;eb++)for(let ew=i;ew<a;ew++){for(ec=(eh=e$[eg])[2];ec.length>1&&("&"==ec[0]||"#"==ec[0]||"x"==ec[0]);)ec=ec.slice(1);let ev=(ew-i)*fontsize,e0=(eb-s)*fontsize;eu&&eu[0]===eh[0][0]&&eu[1]===eh[0][1]&&eu[2]===eh[0][2]||(offCtx.fillStyle=`rgb(${eh[0]})`),ec.length>1?offCtx.fillText(String.fromCharCode(parseInt(ec,16)),ev,e0+fontsize,fontsize):offCtx.fillText(ec,ev,e0+fontsize,fontsize),eg++,eu=eh[0]}function ek(e=activecharacternonindex.tc){if(keyglossary)return;let t=activecharacternonindex,o=t.tc.slice(),l="",c="",h="";for(let d=0;d<o[0];d++)d<e[0]?c+="o":c+="x";for(let u=o[0];u<t.tcmax[0];u++)c+=".";for(let $=0;$<o[1];$++)$<e[1]?l+="o":l+="x";for(let p=o[1];p<t.tcmax[1];p++)l+=".";for(let f=0;f<t.conditions.length;f++)h+=t.conditions[f].name;let m=viewportsizex/2,_=viewportsizey/2-1;if(won){let g=32*Math.sin(now/1e3)+96;adduilabel("The Scourge has been beaten back...",viewportpos,[g,g/2,0],0,!1,!1,!1,!0),adduilabel("New party unlocked",[viewportpos[0]+8,viewportpos[1]],[g,g/2,0],0,!1,!1,!1,!0),adduilabel("Press r to start",[viewportpos[0]+9,viewportpos[1]],[g,g/2,0],0,!1,!1,!1,!0);return}if(gameover){adduilabel("Nothing but ash remains...",viewportpos,[64,64,64],0,!1,!1,!1,!0),adduilabel("Press r to restart",[viewportpos[0]+9,viewportpos[1]],[64,64,64],0,!1,!1,!1,!0);return}if(!0===t.pc){adduilabel(l,[viewportpos[0]+_,viewportpos[1]-m],[64,12,12],1,!1,!1,!0,!0,void 0,void 0,"Actions"),adduilabel(c,[viewportpos[0]+_,viewportpos[1]-m],[12,64,18],0,!1,!1,!0,!0,void 0,void 0,"Move"),adduilabel(h,[viewportpos[0]+_,viewportpos[1]-m],[64,12,12],2,!1,!1,!0,!0);let b=t.primaryitem.name.toString(),w=[128,128,128];t.primaryitem.absorbtion&&(w=convertAbstoColor(t.primaryitem.absorbtion)),adduilabel(b,[viewportpos[0]+_,viewportpos[1]+m-b.length],w,0,!1,!1,!0,!0,void 0,void 0,"Main Hand");let v=t.secondaryitem.name.toString();w=[64,64,64],t.secondaryitem.absorbtion&&(w=convertAbstoColor(t.secondaryitem.absorbtion).map(e=>e/2)),"Unarmed"!==v&&adduilabel(v,[viewportpos[0]+_,viewportpos[1]+m-v.length],w,1,!1,!1,!0,!0,void 0,void 0,"Secondary");let k=t.offhanditem.name.toString();w=[64,64,64],t.offhanditem.absorbtion&&(w=convertAbstoColor(t.offhanditem.absorbtion).map(e=>e/2)),"Unarmed"!==k&&adduilabel(k,[viewportpos[0]+_,viewportpos[1]+m-k.length],w,2,!1,!1,!0,!0,void 0,void 0,"Offhand")}let A=playercs.slice();for(let S=s;S<n;S++)if(!(S<0)&&!(S>=mapsizey))for(let z=i;z<a;z++)z<0||z>=mapsizex||!grid[S][z].character||!0===grid[S][z].character.pc||!0!=grid[S][z].visible||A.push(grid[S][z].character);for(let C=0;C<A.length&&C<10;C++){let E=A[C],j=E.color,q=E.name,W=E.tc[1],F=E.tc[0],D=E.tc[2],R=1;if(activecharacternonindex===E?q+="<":(j=j.map(e=>e/2),R=.5),!0==E.dead)j=j.map(e=>e/2);else{let B=1,G=adduilabel(E.hp.toString()+"/"+E.maxhp.toString(),[viewportpos[0]-_,viewportpos[1]-m+B],j,-(2*C)-1,!1,!0,!1,!0,void 0,void 0,"Health");B+=G.length;let O=adduilabel(W.toString()+"/"+E.tcmax[1].toString(),[viewportpos[0]-_,viewportpos[1]-m+B],[32*R,0,0],-(2*C)-1,!1,!0,!1,!0,void 0,void 0,"Actions");B+=O.length;let M=adduilabel(F.toString()+"/"+E.tcmax[0],[viewportpos[0]-_,viewportpos[1]-m+B],[0,32*R,0],-(2*C)-1,!1,!0,!1,!0,void 0,void 0,"Move");B+=M.length;for(let T=0;T<M.length;T++){let[L,P]=activecharacternonindex.pos;M[T].redirect=grid[L][P]}let N=adduilabel(D.toString()+"/"+E.tcmax[2],[viewportpos[0]-_,viewportpos[1]-m+B],[16*R,16*R,32*R],-(2*C)-1,!1,!0,!1,!0,void 0,void 0,"Reactions");B+=N.length}let H=adduilabel(q,[viewportpos[0]-_,viewportpos[1]-m+1],j,-(2*C),!1,!0,!1,!0);for(let I=0;I<H.length;I++){let[U,K]=E.pos;H[I].redirect=grid[U][K]}}}renderqueue.push(offscreen),renderedlastframe=!1,renderqueue.length>0&&requestAnimationFrame(()=>{for(width=window.innerWidth,fontsize=Math.floor((height=window.innerHeight)/viewportsizey);viewportsizex*fontsize<width-2*fontsize;)viewportsizex+=2,updateGrid(!0);for(;viewportsizex*fontsize>width;)viewportsizex-=2,updateGrid(!0);canvas.width=width*ratio,canvas.height=height*ratio,canvas.style.width=width+"px",canvas.style.height=height+"px",ctx.drawImage(renderqueue.shift(),0,0),renderedlastframe=!0,frameticker++,updatedsomething=!1,performance.now()-noiseupdateticker>100&&(noiseupdate(),noiseupdateticker=performance.now())}),uielements=[]}function drawline(e,t,i=!1){let[s,a]=e,[n,o]=t,l=grid[s][a].elevation,c=grid[n][o].elevation;if(l!==c&&!i)return drawLine3D([s,a,l],[n,o,c]);let h=Math.abs(o-a),d=Math.abs(n-s),u=a<o?1:-1,$=s<n?1:-1,p=h-d,f=a,m=s,_=0;for(;;){if(f===o&&m===n)return _;if((f!=a||m!=s)&&(_+=grid[m][f].readOpacity(l,e)),_>=1)return 1;let g=2*p;g>-d&&(p-=d,f+=u),g<h&&(p+=h,m+=$),g>-d&&g<h&&cornershadows&&(1==grid[m][f-u].readOpacity()&&(_+=.5*grid[m][f-u].readOpacity()),1==grid[m-$][f].readOpacity()&&(_+=.5*grid[m-$][f].readOpacity()))}}function drawLine3D(e,t){let[i,s,a]=e,[n,o,l]=t,c=Math.abs(l-a),h=Math.abs(o-s),d=Math.abs(n-i),u=a<l?1:-1,$=s<o?1:-1,p=i<n?1:-1,f=0,m=i,_=s,g=a,b,w;if(h>=d&&h>=c){b=2*d-h,w=2*c-h;for(let v=0;v<=h;v++){if(m==n&&_==o)return f;if((_!=s||m!=i)&&(f+=grid[m][_].readOpacity(g,e)),f>=1)return 1;b>0&&(m+=p,b-=2*h),w>0&&(g+=u,w-=2*h),b+=2*d,w+=2*c,_+=$}}else if(d>=h&&d>=c){b=2*h-d,w=2*c-d;for(let k=0;k<=d;k++){if(m==n&&_==o)return f;if((_!=s||m!=i)&&(f+=grid[m][_].readOpacity(g,e)),f>=1)return 1;b>0&&(_+=$,b-=2*d),w>0&&(g+=u,w-=2*d),b+=2*h,w+=2*c,m+=p}}else{b=2*d-c,w=2*h-c;for(let A=0;A<=c;A++){if(m==n&&_==o)return f;if((_!=s||m!=i)&&(f+=grid[m][_].readOpacity(g,e)),f>=1)return 1;b>0&&(m+=p,b-=2*c),w>0&&(_+=$,w-=2*c),b+=2*d,w+=2*h,g+=u}}}const turndiscountrate=.5,maxturndepth=1,softturndepthcap=0;function planturn(e){performance.now(),spot(e);let t=e.state.utilityfunction,i=new ActionNode(e.pos,null,e.tc,0,0,null,-1/0,e.primaryitem),s=[i],a=i,n=t(i,e),o=0,l=0,c=Math.min(dontcaredistance,1*e.tcmax[0]+Math.ceil(e.getrange())),h=Math.max(e.pos[0]-c,0),d=Math.min(e.pos[0]+c,mapsizey),u=Math.max(e.pos[1]-c,0),$,p=Math.min(e.pos[1]+c,mapsizex)-u,f=p*(d-h),m=[];for(let _=0;_<s.length;_++){o++;let g=s[_],[b,w]=g.pos,{tc:v,utility:k,damagepotential:A,hazards:S}=g,[z,C]=v,E=!1,j=0;if(!0==g.skip||g.parentnode&&!0==g.parentnode.skip||(C<0&&(j=Math.max(1,Math.ceil(Math.abs(C/e.tcmax[1])),j)),z<0&&(j=Math.max(1,Math.ceil(Math.abs(z/e.tcmax[0])),j)),j>1)||(j>0&&(z=Math.min((1-j)*e.tcmax[0],z),C=Math.min((1-j)*e.tcmax[1],C),g.tc[0]=z,g.tc[1]=C),j>0&&g.action.cost[1]>0))continue;let q=(b-h)*p+(w-u);if(q>f||q<0)continue;m[q]||(m[q]=[]);let W=m[q],F;for(let D=0;D<W.length;D++){if(F=W[D],l++,C<=F.tc[1]&&z<=F.tc[0]&&A<=F.damagepotential&&S>=F.hazards&&Math.floor(k)<=F.utility){E=!0;break}C>=F.tc[1]&&z>=F.tc[0]&&A>=F.damagepotential&&S<=F.hazards&&Math.ceil(k)>=F.utility&&(W.splice(D,1),W=[],D--,F.skip=!0)}if(E)continue;W.push(g),k>n&&(a=g,n=k);let R=[];for(let B=0;B<e.state.actions.length;B++)R.push(e.actions[e.state.actions[B]]);let G,O;for(let M=0;M<R.length;M++){O=(G=R[M])(g,e,k);for(let T=0;T<O.length;T++){let L=O[T];L.turndepth=j;let P=t(L,e);if(j>0){let N=P-k;P=k+N*.5**j}L.utility=P,s.push(L)}}if(_>1e6){console.log("too many iterations"),console.log(e),console.log(s);break}}return performance.now(),function e(t){let i=[];for(;t.tc&&t.tc[0]<0;)t=t.parentnode;for(;null!=t.action;)i.unshift(t.action),t=t.parentnode;return i}(a)}function subtractcost(e,t){let i=e.cost,s=[t[0]-i[0],t[1]-i[1],t[2]-i[2]];return s}class ActionNode{constructor(e,t,i,s,a,n,o,l){this.pos=e,this.action=t,i?this.tc=i.slice():this.tc=[],this.hazards=s,this.damagepotential=a,this.parentnode=n,this.parentutility=o,this.activeweapon=l||this.parentnode.activeweapon}}